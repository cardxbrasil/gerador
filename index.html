<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerador de Roteiros Virais — Wizard</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Serif+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ===== Colors & base (small adaptation of your theme) ===== */
:root{
  --primary:#6366f1; --primary-dark:#4f46e5; --secondary:#10b981;
  --bg:#f8fafc; --surface:#ffffff; --muted:#64748b; --text:#334155;
  --danger:#ef4444; --success:#10b981;
  --shadow: 0 6px 20px rgba(16,24,40,0.06);
  --transition: all .18s ease;
}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased;}
.container{max-width:1200px;margin:0 auto;padding:24px;}
.app{display:grid;grid-template-columns:260px 1fr;gap:20px;align-items:start;min-height:80vh;}
.header{display:flex;align-items:center;justify-content:space-between;padding:14px 24px;background:var(--surface);border-radius:10px;box-shadow:var(--shadow);margin-bottom:18px;}
.logo{display:flex;align-items:center;gap:10px;font-weight:700;color:var(--primary);}
.progress-wrap{margin:12px 0;}
.progress-info{display:flex;justify-content:space-between;font-size:13px;color:var(--muted);margin-bottom:6px;}
.progress-bar{height:10px;background:#f1f5f9;border-radius:999px;overflow:hidden;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--primary),var(--primary-dark));width:0%;transition:width .35s ease;}
/* Sidebar */
.sidebar{background:var(--surface);padding:16px;border-radius:10px;box-shadow:var(--shadow);}
.step{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;cursor:pointer;transition:var(--transition);border:1px solid transparent;}
.step:hover{background:#fafafa;}
.step.active{background:linear-gradient(90deg,#eef2ff,white);border-color:rgba(99,102,241,0.12);}
.step .badge{width:36px;height:36px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:#fff;border:1px solid #eef2ff;color:var(--primary);font-weight:700;}
.step .meta{font-size:14px;}
.step.completed .badge{background:var(--primary);color:white;}
.small-muted{font-size:12px;color:var(--muted);}
/* Content */
.content{background:var(--surface);padding:18px;border-radius:10px;box-shadow:var(--shadow);}
.card{background:#fff;border-radius:8px;padding:14px;border:1px solid #f1f5f9;margin-bottom:14px;}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.input-group{margin-bottom:12px;}
.input-group label{display:block;font-weight:600;margin-bottom:6px;font-size:13px;color:var(--text);}
.input, textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;font-size:14px;background:transparent;}
textarea{min-height:80px;resize:vertical;}
.btn{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700;}
.btn-primary{background:var(--primary);color:#fff;box-shadow:0 6px 16px rgba(99,102,241,0.12);}
.btn-ghost{background:transparent;border:1px solid #e6eef8;color:var(--text);}
.controls{display:flex;gap:8px;flex-wrap:wrap;}
.output{background:#fafafa;padding:12px;border-radius:8px;border:1px dashed #eaeef6;font-size:14px;color:var(--text);white-space:pre-wrap;}
.toast{position:fixed;right:18px;bottom:18px;padding:12px 18px;border-radius:8px;background:var(--surface);box-shadow:var(--shadow);border-left:5px solid var(--primary);display:flex;gap:12px;align-items:center;transform:translateY(24px);opacity:0;transition:all .25s ease;z-index:90;}
.toast.show{transform:translateY(0);opacity:1;}
.spinner{width:18px;height:18px;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* responsive */
@media (max-width:900px){
  .app{grid-template-columns:1fr; padding-bottom:60px;}
  .sidebar{order:2}
  .content{order:1}
}
</style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo"><i class="fas fa-video"></i> Gerador de Roteiros Virais v4.0</div>
      <div style="display:flex;gap:12px;align-items:center">
        <div class="small-muted">Versão Teste • Integração Worker</div>
        <button id="toggleTheme" class="btn btn-ghost"><i class="fas fa-adjust"></i> Tema</button>
      </div>
    </header>

    <div class="progress-wrap">
      <div class="progress-info">
        <div>Progresso do Projeto</div>
        <div id="progressText">0%</div>
      </div>
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
    </div>

    <div class="app" id="appRoot">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div style="font-weight:700;margin-bottom:8px">Etapas</div>

        <div class="step active" data-step="investigate" id="step-investigate">
          <div class="badge">1</div>
          <div>
            <div class="meta">Investigar Tema</div>
            <div class="small-muted">Pesquise e valide fatos</div>
          </div>
        </div>

        <div class="step" data-step="ideas" id="step-ideas">
          <div class="badge">2</div>
          <div>
            <div class="meta">Gerar Ideias</div>
            <div class="small-muted">Transforme fatos em ideias</div>
          </div>
        </div>

        <div class="step" data-step="strategy" id="step-strategy">
          <div class="badge">3</div>
          <div>
            <div class="meta">Definir Estratégia</div>
            <div class="small-muted">Tom, público e estrutura</div>
          </div>
        </div>

        <div class="step" data-step="script" id="step-script">
          <div class="badge">4</div>
          <div>
            <div class="meta">Criar Roteiro</div>
            <div class="small-muted">Gerar introdução, desenvolvimento e conclusão</div>
          </div>
        </div>

        <div class="step" data-step="export" id="step-export">
          <div class="badge">5</div>
          <div>
            <div class="meta">Exportar</div>
            <div class="small-muted">Salvar / baixar / imprimir</div>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid #f1f5f9" />
        <div style="font-size:13px;color:var(--muted);">Projeto:</div>
        <div id="projectSummary" style="margin-top:8px;font-size:14px;color:var(--text)">— vazio —</div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="saveLocalBtn" class="btn btn-ghost">Salvar local</button>
          <button id="loadLocalBtn" class="btn btn-ghost">Carregar</button>
        </div>
      </aside>

      <!-- CONTENT -->
      <section class="content" id="contentArea">
        <!-- INVESTIGAR -->
        <div class="card" id="pane-investigate">
          <h3 style="margin:0 0 10px 0">1 — Investigar Tema</h3>
          <div class="input-group">
            <label for="languageSelect">Idioma da pesquisa</label>
            <select id="languageSelect" class="input">
              <option value="pt-br">Português (Brasil)</option>
              <option value="en">English</option>
            </select>
          </div>

          <div class="input-group">
            <label for="factCheckQuery">Tema / pergunta / fato</label>
            <textarea id="factCheckQuery" class="input" placeholder="Ex: A Arca da Aliança foi encontrada?"></textarea>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="investigateBtn" class="btn btn-primary"><i class="fas fa-search-plus"></i> Investigar</button>
            <button id="clearInvestigationBtn" class="btn btn-ghost"><i class="fas fa-trash"></i> Limpar</button>
            <div id="investigateLoading" style="display:none;margin-left:8px"><div class="spinner"></div></div>
          </div>

          <div style="margin-top:12px">
            <div class="small-muted">Relatório da IA</div>
            <div id="factCheckOutput" class="output" style="min-height:90px">Nenhum relatório gerado.</div>
          </div>
        </div>

        <!-- IDEIAS -->
        <div class="card" id="pane-ideas" style="display:none">
          <h3 style="margin:0 0 10px 0">2 — Gerar Ideias</h3>

          <div class="input-group">
            <label>Gênero</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap" id="genreButtons">
              <button data-genre="documentario" class="btn btn-ghost">Documentário</button>
              <button data-genre="inspiracional" class="btn btn-ghost">Inspiracional</button>
              <button data-genre="scifi" class="btn btn-ghost">Ficção científica</button>
              <button data-genre="terror" class="btn btn-ghost">Terror</button>
              <button data-genre="enigmas" class="btn btn-ghost">Enigmas (Bíblico)</button>
              <button data-genre="geral" class="btn btn-ghost">Geral</button>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <button id="generateIdeasBtn" class="btn btn-primary"><i class="fas fa-magic"></i> Gerar ideias</button>
            <div id="ideasLoading" style="display:none;margin-left:8px"><div class="spinner"></div></div>
          </div>

          <div style="margin-top:12px">
            <div class="small-muted">Ideias geradas</div>
            <div id="ideasOutput" class="output">Nenhuma ideia ainda.</div>
          </div>
        </div>

        <!-- STRATEGY -->
        <div class="card" id="pane-strategy" style="display:none">
          <h3 style="margin:0 0 10px 0">3 — Definir Estratégia</h3>

          <div class="grid-2">
            <div>
              <div class="input-group"><label for="channelName">Nome do Canal</label><input id="channelName" class="input" value="The Biblical Unveiling"></div>
              <div class="input-group"><label for="videoTheme">Tema do Vídeo</label><input id="videoTheme" class="input" placeholder="Ex: A Arca da Aliança foi encontrada?"></div>
              <div class="input-group"><label for="videoDuration">Duração desejada</label>
                <select id="videoDuration" class="input">
                  <option value="">-- selecione --</option>
                  <option value="short">Curto (1-3 min)</option>
                  <option value="medium">Médio (4-7 min)</option>
                  <option value="long">Longo (8-12 min)</option>
                </select>
              </div>
              <div class="input-group"><label for="visualPacing">Ritmo visual</label>
                <select id="visualPacing" class="input">
                  <option value="" selected>-- selecione --</option>
                  <option value="dinamico">Dinâmico (3-8s)</option>
                  <option value="normal">Normal (8-15s)</option>
                  <option value="contemplativo">Contemplativo (15-25s)</option>
                </select>
              </div>
            </div>

            <div>
              <div class="input-group"><label for="targetAudience">Público-alvo</label><input id="targetAudience" class="input" placeholder="Descreva seu espectador ideal"></div>
              <div class="input-group"><label for="narrativeTheme">Tema narrativo</label><input id="narrativeTheme" class="input" placeholder="Qual a grande ideia?"></div>
              <div class="input-group"><label for="emotionalHook">Gancho emocional (opcional)</label><textarea id="emotionalHook" class="input"></textarea></div>
            </div>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <button id="suggestStrategyBtn" class="btn btn-ghost"><i class="fas fa-magic"></i> Sugerir estratégia (IA)</button>
            <button id="applyStrategyBtn" class="btn btn-primary"><i class="fas fa-check"></i> Aplicar e continuar</button>
            <div id="strategyLoading" style="display:none;margin-left:8px"><div class="spinner"></div></div>
          </div>

          <div style="margin-top:12px">
            <div class="small-muted">Resumo da estratégia</div>
            <div id="strategySummary" class="output">Nenhuma estratégia definida.</div>
          </div>
        </div>

        <!-- SCRIPT -->
        <div class="card" id="pane-script" style="display:none">
          <h3 style="margin:0 0 10px 0">4 — Criar Roteiro</h3>

          <div style="display:flex;gap:8px;margin-bottom:8px">
            <button id="generateOutlineBtn" class="btn btn-ghost"><i class="fas fa-stream"></i> Criar esboço</button>
            <button id="generateScriptBtn" class="btn btn-primary"><i class="fas fa-pen-fancy"></i> Gerar roteiro completo</button>
            <div id="scriptLoading" style="display:none;margin-left:8px"><div class="spinner"></div></div>
          </div>

          <div style="margin-top:8px">
            <div class="small-muted">Esboço estratégico</div>
            <div id="outlineContent" class="output">Nenhum esboço gerado.</div>
          </div>

          <div style="margin-top:12px">
            <div class="small-muted">Seções do roteiro</div>
            <div id="scriptSections" class="output">Nenhum roteiro gerado.</div>
          </div>
        </div>

        <!-- EXPORT -->
        <div class="card" id="pane-export" style="display:none">
          <h3 style="margin:0 0 10px 0">5 — Exportar / Gerenciar</h3>

          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
            <button id="exportProjectBtn" class="btn btn-ghost"><i class="fas fa-download"></i> Exportar JSON</button>
            <button id="importProjectBtn" class="btn btn-ghost"><i class="fas fa-upload"></i> Importar JSON</button>
            <button id="exportPdfBtn" class="btn btn-primary"><i class="fas fa-file-pdf"></i> Exportar PDF / Imprimir</button>
            <button id="exportTranscriptBtn" class="btn btn-ghost"><i class="fas fa-file-alt"></i> Exportar .rtf</button>
            <input type="file" id="importFileInput" accept=".json" style="display:none" />
          </div>

          <div class="small-muted">Status</div>
          <div id="exportStatus" class="output">Aguardando ações de exportação.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" aria-live="polite"><div id="toastIcon" class="spinner" style="display:none"></div><div id="toastMessage">Mensagem</div></div>

<script>
/* ================== Config & Estado ================== */

const WORKER_ENDPOINT = 'https://royal-bird-81cb.david-souzan.workers.dev/'; // fornecido por você
const LOCAL_KEY = 'viralScriptGeneratorProject_v1';

const AppState = {
  inputs: {
    language: 'pt-br',
    factQuery: '',
    genre: 'geral',
    channelName: 'The Biblical Unveiling',
    videoTheme: '',
    videoDuration: '',
    visualPacing: '',
    targetAudience: '',
    narrativeTheme: '',
    emotionalHook: ''
  },
  generated: {
    investigationReport: null,
    ideas: [],
    outline: null,
    script: null,
    titles: null,
    description: null,
    soundtrack: null
  },
  progress: {
    investigate: false,
    ideas: false,
    strategy: false,
    script: false,
    export: false
  }
};

/* ================== Utilities ================== */
function qs(sel, root=document) { return root.querySelector(sel); }
function qsa(sel, root=document) { return Array.from(root.querySelectorAll(sel)); }

function showToast(message, type='info', timeout=4500) {
  const toast = qs('#toast'); const msg = qs('#toastMessage'); const icon = qs('#toastIcon');
  msg.textContent = message;
  if (type === 'loading') { icon.style.display='inline-block'; } else { icon.style.display='none'; }
  if (type === 'error') toast.style.borderLeftColor = 'var(--danger)';
  else if (type === 'success') toast.style.borderLeftColor = 'var(--success)';
  else toast.style.borderLeftColor = 'var(--primary)';
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), timeout);
}

/* Simple fetch wrapper to your Worker */
async function callWorker(prompt, maxTokens=1400) {
  try {
    const res = await fetch(WORKER_ENDPOINT, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ prompt, maxTokens })
    });
    if (!res.ok) {
      const t = await res.text();
      throw new Error('Erro Worker: ' + t);
    }
    const data = await res.json();
    // The worker returns the model response; we try to extract text from common fields
    // Common providers -> data.choices[0].message.content or data.choices[0].text or data.output
    if (data.choices && data.choices[0]) {
      return data.choices[0].message?.content ?? data.choices[0].text ?? JSON.stringify(data.choices[0]);
    }
    if (data.output) return Array.isArray(data.output)? data.output.join('\n') : data.output;
    return JSON.stringify(data);
  } catch (err) {
    throw err;
  }
}

/* Progress computation */
function computeProgress() {
  const keys = Object.keys(AppState.progress);
  const done = keys.filter(k=>AppState.progress[k]).length;
  const pct = Math.round((done / keys.length) * 100);
  qs('#progressFill').style.width = pct + '%';
  qs('#progressText').textContent = pct + '%';
}

/* Mark step as completed */
function markStepDone(step) {
  AppState.progress[step]=true;
  const el = qs('#step-' + step);
  if (el) el.classList.add('completed');
  computeProgress();
}

/* Switch panes */
function showPane(slug) {
  // hide all
  ['investigate','ideas','strategy','script','export'].forEach(s=>{
    const p = qs('#pane-' + s);
    const stepEl = qs('#step-' + s);
    if (p) p.style.display = 'none';
    if (stepEl) stepEl.classList.remove('active');
  });
  const pane = qs('#pane-' + slug);
  const stepEl = qs('#step-' + slug);
  if (pane) pane.style.display = 'block';
  if (stepEl) stepEl.classList.add('active');
}

/* Save/Load local */
function saveLocal() {
  try {
    localStorage.setItem(LOCAL_KEY, JSON.stringify(AppState));
    showToast('Projeto salvo localmente', 'success');
  } catch (err) { showToast('Erro ao salvar: '+err.message,'error'); }
}
function loadLocal() {
  try {
    const raw = localStorage.getItem(LOCAL_KEY);
    if (!raw) { showToast('Nenhum projeto salvo', 'info'); return; }
    const loaded = JSON.parse(raw);
    Object.assign(AppState, loaded);
    // sync UI minimal
    if (AppState.generated.investigationReport) qs('#factCheckOutput').textContent = AppState.generated.investigationReport;
    if (AppState.generated.ideas && AppState.generated.ideas.length) qs('#ideasOutput').textContent = AppState.generated.ideas.join('\n\n');
    if (AppState.generated.outline) qs('#outlineContent').textContent = AppState.generated.outline;
    if (AppState.generated.script) qs('#scriptSections').textContent = AppState.generated.script;
    computeProgress();
    showToast('Projeto carregado', 'success');
  } catch(err){ showToast('Erro ao carregar: '+err.message,'error'); }
}

/* Export/Import */
function exportProject() {
  const blob = new Blob([JSON.stringify(AppState, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='project_viral_generator.json'; a.click();
  URL.revokeObjectURL(url);
  showToast('Projeto exportado (.json)', 'success');
}
function importProjectFromFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const loaded = JSON.parse(e.target.result);
      Object.assign(AppState, loaded);
      loadLocal(); // reuse sync
      showToast('Projeto importado', 'success');
    } catch(err){ showToast('Arquivo inválido','error'); }
  };
  reader.readAsText(file);
}

/* Export PDF (open print) */
function exportPdf() {
  // We simply open print dialog — the user can salvar como PDF
  window.print();
}

/* Export transcription (basic RTF) */
function exportTranscript() {
  const text = AppState.generated.script || AppState.generated.outline || AppState.generated.ideas.join('\n\n') || '';
  const rtf = "{\\rtf1\\ansi\\deff0 " + text.replace(/\n/g,'\\par ') + "}";
  const blob = new Blob([rtf], {type:'application/rtf'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='transcript.rtf'; a.click();
  URL.revokeObjectURL(url);
  showToast('Transcrição exportada (.rtf)', 'success');
}

/* ================== UI Wiring ================== */

document.addEventListener('DOMContentLoaded', ()=>{
  computeProgress();
  setupSidebarClicks();
  setupButtons();
  loadStateFromLocalStorageOnInit();
  // apply step clicks
  showPane('investigate');
  updateProjectSummary();
});

/* if there's a saved project, load at start (non-blocking) */
function loadStateFromLocalStorageOnInit() {
  try {
    const raw = localStorage.getItem(LOCAL_KEY);
    if (raw) {
      const parsed = JSON.parse(raw);
      Object.assign(AppState, parsed);
      if (AppState.generated.investigationReport) qs('#factCheckOutput').textContent = AppState.generated.investigationReport;
      if (AppState.generated.ideas && AppState.generated.ideas.length) qs('#ideasOutput').textContent = AppState.generated.ideas.join('\n\n');
      if (AppState.generated.outline) qs('#outlineContent').textContent = AppState.generated.outline;
      if (AppState.generated.script) qs('#scriptSections').textContent = AppState.generated.script;
      computeProgress();
      showToast('Projeto anterior carregado', 'success', 3000);
    }
  } catch(e){}
}

/* Sidebar clicks */
function setupSidebarClicks() {
  qsa('.step').forEach(el=>{
    el.addEventListener('click', ()=> {
      const step = el.dataset.step;
      if (step) showPane(step);
    });
  });
}

/* Buttons and actions wiring */
function setupButtons() {
  // INVESTIGATE
  qs('#investigateBtn').addEventListener('click', async ()=>{
    const q = qs('#factCheckQuery').value.trim();
    const lang = qs('#languageSelect').value;
    if (!q) { showToast('Digite o tema a investigar','error'); return; }
    AppState.inputs.factQuery = q; AppState.inputs.language = lang;
    qs('#investigateLoading').style.display='inline-block';
    showToast('Investigando...','loading', 90000);
    try {
      const prompt = `Investigue o seguinte tema e gere um relatório objetivo, com fontes e linhas principais:\n[IDIOMA:${lang}]\nPergunta: ${q}\nForneça: resumo, 3 fontes potenciais, e 5 pontos chave para roteiro.`;
      const res = await callWorker(prompt, 1200);
      AppState.generated.investigationReport = res;
      qs('#factCheckOutput').textContent = res;
      markStepDone('investigate');
      showToast('Relatório gerado', 'success');
      // enable ideas pane
      qs('#step-ideas').classList.remove('disabled');
    } catch(err){ showToast('Erro: '+err.message,'error'); }
    qs('#investigateLoading').style.display='none';
  });

  qs('#clearInvestigationBtn').addEventListener('click', ()=>{
    qs('#factCheckQuery').value=''; qs('#factCheckOutput').textContent='Nenhum relatório gerado.'; AppState.generated.investigationReport=null;
    AppState.progress.investigate=false; computeProgress(); showToast('Relatório limpado');
  });

  // GENRE selection for ideas
  qsa('#genreButtons button').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      qsa('#genreButtons button').forEach(b=>b.classList.remove('btn-primary'));
      btn.classList.add('btn-primary');
      AppState.inputs.genre = btn.dataset.genre;
    });
  });

  // GENERATE IDEAS
  qs('#generateIdeasBtn').addEventListener('click', async ()=>{
    const report = AppState.generated.investigationReport || qs('#factCheckOutput').textContent;
    const genre = AppState.inputs.genre || 'geral';
    if (!report || report.includes('Nenhum relatório')) {
      showToast('Primeiro gere/investigue um relatório', 'error'); return;
    }
    qs('#ideasLoading').style.display='inline-block';
    showToast('Gerando ideias...', 'loading', 90000);
    try {
      const prompt = `Com base neste relatório, gere 6 ideias concisas de vídeos no gênero ${genre}. Relatório:\n${report}\nFormato: cada ideia em 1-2 frases.`;
      const res = await callWorker(prompt, 700);
      // split by lines reasonably
      const ideas = res.split(/\n{1,}/).filter(s=>s.trim()).slice(0,12);
      AppState.generated.ideas = ideas;
      qs('#ideasOutput').textContent = ideas.join('\n\n');
      markStepDone('ideas');
      showToast('Ideias geradas', 'success');
    } catch(err){ showToast('Erro: '+err.message,'error'); }
    qs('#ideasLoading').style.display='none';
  });

  // SUGGEST STRATEGY
  qs('#suggestStrategyBtn').addEventListener('click', async ()=>{
    const theme = qs('#videoTheme').value || AppState.inputs.factQuery || 'tema não informado';
    qs('#strategyLoading').style.display='inline-block';
    showToast('Sugerindo estratégia...', 'loading', 90000);
    try {
      const prompt = `Sugira uma estratégia narrativa para um vídeo com o tema: ${theme}. Inclua: público-alvo, tom, ritmo, estrutura em 3 atos e gancho inicial.`;
      const res = await callWorker(prompt, 700);
      AppState.generated.strategy = res;
      qs('#strategySummary').textContent = res;
      markStepDone('strategy');
      showToast('Estratégia sugerida', 'success');
    } catch(err){ showToast('Erro: '+err.message,'error'); }
    qs('#strategyLoading').style.display='none';
  });

  // APPLY STRATEGY (simplesmente atualiza estado e move para script)
  qs('#applyStrategyBtn').addEventListener('click', ()=>{
    // read some fields into AppState
    AppState.inputs.channelName = qs('#channelName').value;
    AppState.inputs.videoTheme = qs('#videoTheme').value;
    AppState.inputs.videoDuration = qs('#videoDuration').value;
    AppState.inputs.visualPacing = qs('#visualPacing').value;
    AppState.inputs.targetAudience = qs('#targetAudience').value;
    AppState.inputs.narrativeTheme = qs('#narrativeTheme').value;
    AppState.inputs.emotionalHook = qs('#emotionalHook').value;
    markStepDone('strategy');
    updateProjectSummary();
    showPane('script');
  });

  // GENERATE OUTLINE
  qs('#generateOutlineBtn').addEventListener('click', async ()=>{
    const base = AppState.generated.investigationReport || '';
    const theme = AppState.inputs.videoTheme || AppState.inputs.factQuery || 'tema';
    qs('#scriptLoading').style.display='inline-block';
    showToast('Criando esboço...', 'loading', 90000);
    try {
      const prompt = `Crie um esboço estratégico para um vídeo sobre: ${theme}. Use o relatório como referência:\n${base}\nForneça: título sugerido, 3-5 bullets de estrutura (introdução, desenvolvimento, clímax, conclusão).`;
      const res = await callWorker(prompt, 900);
      AppState.generated.outline = res;
      qs('#outlineContent').textContent = res;
      showToast('Esboço criado', 'success');
      markStepDone('script');
    } catch(err){ showToast('Erro: '+err.message,'error'); }
    qs('#scriptLoading').style.display='none';
  });

  // GENERATE SCRIPT
  qs('#generateScriptBtn').addEventListener('click', async ()=>{
    const outline = AppState.generated.outline || '';
    const details = {
      title: qs('#channelName').value,
      theme: qs('#videoTheme').value || AppState.inputs.factQuery
    };
    qs('#scriptLoading').style.display='inline-block';
    showToast('Gerando roteiro completo...', 'loading', 90000);
    try {
      const prompt = `Gere um roteiro narrativo completo para o vídeo com base no esboço abaixo e nas preferências fornecidas.\nEsboço:\n${outline}\nPreferências:\nChannel: ${details.title}\nTema: ${details.theme}\nDuração: ${qs('#videoDuration').value}\nRitmo visual: ${qs('#visualPacing').value}\nGere: Introdução (hook), Desenvolvimento (com cenas), Clímax, Conclusão, CTA.\nFormato: texto corrido com títulos de seção.`;
      const res = await callWorker(prompt, 1600);
      AppState.generated.script = res;
      qs('#scriptSections').textContent = res;
      showToast('Roteiro gerado', 'success');
      markStepDone('script'); // ensure script step completed
      updateProjectSummary();
    } catch(err){ showToast('Erro: '+err.message,'error'); }
    qs('#scriptLoading').style.display='none';
  });

  // EXPORT / IMPORT wiring
  qs('#saveLocalBtn').addEventListener('click', saveLocal);
  qs('#loadLocalBtn').addEventListener('click', loadLocal);
  qs('#exportProjectBtn').addEventListener('click', exportProject);
  qs('#exportPdfBtn').addEventListener('click', exportPdf);
  qs('#exportTranscriptBtn').addEventListener('click', exportTranscript);
  qs('#importProjectBtn').addEventListener('click', ()=>qs('#importFileInput').click());
  qs('#importFileInput').addEventListener('change', (ev)=>{
    const file = ev.target.files[0];
    if (file) importProjectFromFile(file);
  });

  // STEP navigation via sidebar buttons (also mark completed)
  qsa('.step').forEach(s=>{
    s.addEventListener('click', ()=> {
      const step = s.dataset.step;
      if (step) showPane(step);
    });
  });

  // small theme toggle
  qs('#toggleTheme').addEventListener('click', ()=> {
    document.documentElement.classList.toggle('dark');
    showToast('Alternado tema', 'info');
  });

  // convenience: update inputs to AppState live
  ['channelName','videoTheme','videoDuration','visualPacing','targetAudience','narrativeTheme','emotionalHook'].forEach(id=>{
    const el = qs('#'+id);
    if (!el) return;
    el.addEventListener('input', ()=> {
      AppState.inputs[id] = el.value;
    });
  });

  // update project summary (sidebar)
  function updateProjectSummary() {
    const el = qs('#projectSummary');
    const t = AppState.inputs.videoTheme || AppState.inputs.factQuery || '— vazio —';
    const ch = AppState.inputs.channelName || '— canal —';
    el.textContent = `${ch} • ${t}`;
  }
}

/* Mark step done externally (helper usage) */
function markStepDone(step) {
  const el = qs('#step-' + step);
  if (el) el.classList.add('completed');
  AppState.progress[step] = true;
  computeProgress();
}

/* computeProgress defined earlier; re-declare here to be safe */
function computeProgress() {
  const keys = Object.keys(AppState.progress);
  const done = keys.filter(k=>AppState.progress[k]).length;
  const pct = Math.round((done / keys.length) * 100);
  qs('#progressFill').style.width = pct + '%';
  qs('#progressText').textContent = pct + '%';
}

/* quick selector fallback */
function qs(s,r=document){ return r.querySelector(s); }
function qsa(s,r=document){ return Array.from((r||document).querySelectorAll(s)); }

</script>
</body>
</html>
