<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Source+Serif+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Roteiros Virais v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

<style>
    /* ================================================================= */
    /* =================== ARQUITETURA DE DESIGN (THEME) ================= */
    /* ================================================================= */
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #8FBC8F;
        --accent: #228B22;
        --success: #10b981;
        --danger: #ef4444;
        --dark-bg: #f8fafc;
        --dark-surface: #ffffff;
        --dark-border: #e2e8f0;
        --dark-text-header: #1e293b;
        --dark-text-body: #334155;
        --dark-text-muted: #64748b;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --transition: all 0.2s ease-in-out;
    }

    .dark {
        --primary: #818cf8;
        --primary-dark: #6366f1;
        --secondary: #3CB371;
        --accent: #006400;
        --dark-bg: #0f172a;
        --dark-surface: #1e293b;
        --dark-border: #334155;
        --dark-text-header: #f1f5f9;
        --dark-text-body: #cbd5e1;
        --dark-text-muted: #94a3b8;
    }

    /* ================================================================= */
    /* ======================= ESTILOS GLOBAIS ======================= */
    /* ================================================================= */
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: var(--dark-bg); 
        color: var(--dark-text-body); 
        transition: var(--transition); 
    }
    .container { 
        max-width: 1024px; 
        margin: 0 auto; 
    }
    h1, h2, h3, h4, h5, h6 { 
        color: var(--dark-text-header); 
    }

    /* ================================================================= */
    /* ======================= COMPONENTES DA UI ======================= */
    /* ================================================================= */

 /* ========================================================== */
/*     ESTILO DE ABAS EVOLU√çDO (INSPIRADO NO GITHUB)      */
/* ========================================================== */

/* --- A base para TODAS as abas --- */
.tab-button {
    display: inline-flex;       /* Permite alinhar √≠cone e texto */
    align-items: center;        /* Alinha verticalmente no centro */
    gap: 0.5rem;                /* Espa√ßo entre o √≠cone e o texto */
    padding: 0.75rem 1rem;      /* Mais espa√ßo interno, para "respirar" */
    border: none;               /* Remove a borda padr√£o do bot√£o */
    background: none;           /* Remove o fundo padr√£o do bot√£o */
    cursor: pointer;
    font-weight: 500;
    color: var(--dark-text-muted); /* Cor sutil para abas inativas */
    border-bottom: 2px solid transparent; /* Borda invis√≠vel para manter o alinhamento */
    transition: var(--transition); /* Anima√ß√£o suave para todas as mudan√ßas */
    border-radius: 6px 6px 0 0; /* Cantos arredondados no topo, como no GitHub */
}

/* --- O "relevo" ao passar o mouse --- */
.tab-button:hover {
    color: var(--dark-text-header); /* Texto fica mais proeminente */
    background-color: color-mix(in srgb, var(--dark-border) 40%, transparent); /* Fundo sutil aparece */
}

/* --- A aba ATIVA --- */
.tab-active {
    font-weight: 600;                 /* Texto em negrito */
    color: var(--primary);            /* Cor prim√°ria, para destaque */
    border-bottom-color: var(--primary); /* A linha inferior colorida, marca do GitHub */
}

/* ========================================================== */
/*     ESTILO DE ABAS EVOLU√çDO (INSPIRADO NO GITHUB)      */
/* ========================================================== */

    /* --- Cards e Se√ß√µes --- */
    .card { 
        background-color: var(--dark-surface); 
        border: 1px solid var(--dark-border); 
        border-radius: 12px; 
        box-shadow: var(--shadow); 
        padding: 1.5rem; 
        transition: var(--transition); 
    }
    .section-title { 
        position: relative; 
        padding-bottom: 0.75rem; 
        margin-bottom: 1.5rem; 
        border-bottom: 1px solid var(--dark-border); 
    }
    .section-title h2 { 
        font-size: 1.25rem; 
        font-weight: 700; 
    }
    .section-title::after { 
        content: ''; 
        position: absolute; 
        bottom: -1px; 
        left: 0; 
        width: 70px; 
        height: 2px; 
        background: var(--primary); 
        transition: var(--transition); 
    }

    /* --- Bot√µes --- */
    .btn { 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        gap: 0.5rem; 
        padding: 0.65rem 1.25rem; 
        border-radius: 8px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: var(--transition); 
        border: none; 
        white-space: nowrap; 
    }
    .btn-primary { 
        background-color: var(--primary); 
        color: white; 
    }
    .btn-primary:hover { 
        background-color: var(--primary-dark); 
        transform: translateY(-2px); 
    }
    .btn-secondary { 
        background-color: var(--secondary); 
        color: white; 
    }
    .btn-secondary:hover { 
        background-color: #7c3aed; 
    }
    .dark .btn-secondary:hover { 
        background-color: #9333ea; 
    }
    .btn-small { 
        padding: 0.5rem 1rem; 
        font-size: 0.875rem; 
    }

    /* --- Formul√°rios e Inputs --- */
    .input-group { 
        margin-bottom: 1rem; 
    }
    .input-group label { 
        display: block; 
        margin-bottom: 0.5rem; 
        font-weight: 600; 
        font-size: 0.875rem; 
        color: var(--dark-text-header); 
    }
    .input-group input, .input-group select, .input-group textarea { 
        width: 100%; 
        padding: 0.75rem; 
        border-radius: 8px; 
        border: 1px solid var(--dark-border); 
        background: var(--dark-surface); 
        transition: var(--transition); 
        color: var(--dark-text-body); 
    }
    .input-group input::placeholder, .input-group textarea::placeholder { 
        color: var(--dark-text-muted); 
        opacity: 1; 
    }
    .input-group input:focus, .input-group select:focus, .input-group textarea:focus { 
        outline: none; 
        border-color: var(--primary); 
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); 
    }

    /* --- Bot√µes de R√°dio Personalizados --- */
    .radio-label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        border: 2px solid var(--dark-border);
        background-color: var(--dark-surface);
        transition: var(--transition);
    }
    .radio-label:hover {
        border-color: var(--secondary);
    }
    .radio-label input[type="radio"] {
        display: none;
    }
    .radio-label input[type="radio"]:checked + span {
        color: var(--primary);
        font-weight: 600;
    }
    .radio-label:has(input:checked) {
        border-color: var(--primary);
        background-color: color-mix(in srgb, var(--primary) 10%, transparent);
    }
    .radio-label.opacity-50 {
        cursor: not-allowed;
        color: var(--dark-text-muted);
    }
    
    /* --- Abas (Tabs) --- */
    .tab-button { 
        padding: 0.5rem 0.25rem; 
        margin-bottom: 0.5rem; 
        border-bottom: 3px solid transparent; 
        color: var(--dark-text-muted); 
        font-weight: 500; 
        transition: var(--transition); 
        background: none; 
        border-radius: 0; 
    }
    .tab-button:hover { 
        color: var(--primary); 
    }
    .tab-active { 
        border-bottom-color: var(--primary); 
        color: var(--primary); 
        font-weight: 600; 
    }
    .tab-pane.hidden { 
        display: none; 
    }

    /* --- Acorde√£o --- */
    .accordion-item { 
        border-bottom: 1px solid var(--dark-border); 
    }
    .accordion-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 1rem 1.5rem; 
        cursor: pointer; 
        transition: var(--transition); 
    }
    .accordion-header:hover { 
        background-color: color-mix(in srgb, var(--dark-surface) 95%, var(--dark-text-muted)); 
    }
    .header-title-group { 
        display: flex; 
        align-items: center; 
        gap: 0.75rem; 
        flex-grow: 1; 
    }
    .header-title-group h3 { 
        font-weight: 600; 
        font-size: 1.1rem; 
    }
    .header-title-group .text-xs { 
        color: var(--dark-text-muted); 
        font-size: 0.75rem; 
        white-space: nowrap; 
    }
    .header-actions-group { 
        display: flex; 
        align-items: center; 
        gap: 1rem; 
    }
    .header-buttons { 
        display: flex; 
        align-items: center; 
        gap: 0.75rem; 
    }
    .header-buttons button { 
        background: none; 
        border: none; 
        padding: 0.25rem; 
        color: var(--dark-text-muted); 
        cursor: pointer; 
        transition: var(--transition); 
    }
    .header-buttons button:hover { 
        color: var(--primary); 
    }
    .accordion-arrow { 
        transition: transform 0.3s; 
        transform-origin: center; 
    }
    .accordion-arrow.open { 
        transform: rotate(180deg); 
    }
    .accordion-body { 
        padding: 0 1.5rem 1.5rem 1.5rem; 
        display: none; 
    }
    .accordion-body.open { 
        display: block; 
    }
    .accordion-body > div > div { 
        padding-top: 1.5rem; 
        padding-bottom: 1.5rem; 
        border-top: 1px dashed var(--dark-border); 
    }
    .accordion-body > div > div:first-child { 
        border-top: none; 
        padding-top: 0; 
    }
    .accordion-body h5 { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--dark-text-header); 
        margin-bottom: 0.25rem; 
    }
    .accordion-body p.text-xs { 
        font-size: 0.8rem; 
        color: var(--dark-text-muted); 
        margin-bottom: 1rem; 
    }

    /* --- Elementos de Feedback --- */
    .toast { 
        position: fixed; 
        bottom: 1.5rem; 
        right: 1.5rem; 
        background-color: var(--dark-surface); 
        color: var(--dark-text-header); 
        padding: 1rem 1.5rem; 
        border-radius: 8px; 
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); 
        z-index: 1000; 
        opacity: 0; 
        transform: translateY(100%); 
        transition: all 0.4s cubic-bezier(0.21, 1.05, 0.51, 1.04); 
        border-left: 4px solid var(--primary); 
    }
    .toast.show { 
        opacity: 1; 
        transform: translateY(0); 
    }
    .loading-spinner { 
        width: 24px; 
        height: 24px; 
        border: 3px solid color-mix(in srgb, var(--primary) 20%, transparent); 
        border-top-color: var(--primary); 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
        to { transform: rotate(360deg); } 
    }
    .progress-bar { 
        height: 8px; 
        background: var(--dark-border); 
        border-radius: 4px; 
        overflow: hidden; 
    }
    .progress-fill { 
        height: 100%; 
        background: var(--primary); 
        border-radius: 4px; 
        transition: width 0.3s ease; 
    }
    
    /* --- Popover da Estrutura Espec√≠fica --- */
    .popover-bg {
        background-color: var(--dark-bg);
    }

    /* --- √çcone de Troca de Tema --- */
    .theme-toggle {
        background-color: transparent;
        border: none;
        padding: 0.5rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .theme-toggle:hover {
        background-color: color-mix(in srgb, var(--dark-border) 50%, transparent);
    }

    /* ================================================================= */
    /* ================== ESTILOS DE CONTE√öDO GERADO =================== */
    /* ================================================================= */
    .generated-content-wrapper, .generated-output-box, .emotional-map-item, .prompt-item { 
        background-color: color-mix(in srgb, var(--dark-bg) 50%, var(--dark-surface)); 
        border-left: 4px solid var(--primary); 
        padding: 1rem 1.5rem; 
        border-radius: 8px; 
        line-height: 1.6; 
    }
    .prompt-item { 
        border-left-color: var(--secondary); 
    }
    .generated-content-wrapper { 
        margin-bottom: 1.5rem; 
    }
    .generated-output-box .output-subtitle { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--dark-text-header); 
        margin-bottom: 0.75rem; 
        padding-bottom: 0.5rem; 
        border-bottom: 1px dashed var(--dark-border); 
    }
    .generated-output-box .output-content-block { 
        margin-bottom: 1.5rem; 
    }
    .generated-output-box .thumbnail-idea { 
        margin-bottom: 1rem; 
    }
    .generated-output-box .thumbnail-idea h4 { 
        font-weight: 600; 
        font-size: 0.9rem; 
    }
    .generated-output-box .thumbnail-idea p { 
        font-size: 0.85rem; 
        color: var(--dark-text-muted); 
    }
    .soundtrack-list { 
        list-style-type: disc; 
        padding-left: 1.5rem; 
    }
    .paragraph-preview { 
        font-style: italic; 
        color: var(--dark-text-muted); 
        margin-bottom: 0.75rem; 
        font-size: 0.9rem; 
        border-bottom: 1px dashed var(--dark-border); 
        padding-bottom: 0.75rem; 
    }
    .analysis-tags, .prompt-header { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
    }
    .prompt-header { 
        margin-bottom: 0.75rem; 
        padding-bottom: 0.75rem; 
        border-bottom: 1px dashed var(--dark-border); 
    }
    .tag { 
        display: inline-flex; 
        align-items: center; 
        padding: 0.25rem 0.75rem; 
        border-radius: 9999px; 
        font-size: 0.75rem; 
        font-weight: 600; 
    }
    .tag-emotion { 
        background-color: color-mix(in srgb, var(--primary) 20%, transparent); 
        color: var(--primary); 
    }
    .tag-pace { 
        background-color: color-mix(in srgb, var(--secondary) 20%, transparent); 
        color: var(--secondary); 
    }
    .tag-scene { 
        background-color: color-mix(in srgb, var(--accent) 20%, transparent); 
        color: var(--accent); 
    }
    .tag-time { 
        background-color: color-mix(in srgb, var(--dark-text-muted) 20%, transparent); 
        color: var(--dark-text-muted); 
    }



/* ========================================================== */
/*           ESTILOS PARA O PAINEL DO DIRETOR                 */
/* ========================================================== */
.shot-item {
    border-left: 4px solid var(--primary);
    background-color: color-mix(in srgb, var(--dark-bg) 50%, var(--dark-surface));
    padding: 1rem;
    border-radius: 8px;
    transition: var(--transition);
}
.shot-item:hover {
    box-shadow: var(--shadow);
    transform: translateY(-2px);
}
.shot-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
    border-bottom: 1px dashed var(--dark-border);
}
.shot-header .scene-tag {
    font-weight: 700;
    font-size: 1.1rem;
    color: var(--dark-text-header);
}
.shot-header .tags-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}
.shot-script {
    font-family: 'Source Serif Pro', serif;
    font-size: 1.1rem;
    line-height: 1.7;
    margin-bottom: 1rem;
    padding-left: 1rem;
    border-left: 2px solid var(--secondary);
}
.shot-details {
    font-size: 0.85rem;
    color: var(--dark-text-muted);
}
.shot-details strong {
    color: var(--dark-text-body);
    font-weight: 600;
}


    /* ================================================================= */
    /* =================== M√ìDULOS DE AN√ÅLISE E AJUDA ================== */
    /* ================================================================= */

    /* --- An√°lise de Reten√ß√£o --- */
    .retention-paragraph-live { 
        position: relative; 
        padding: 0.5rem; 
        border-radius: 6px; 
        transition: background-color 0.3s; 
        cursor: default; 
    }
    .retention-green { 
        background-color: color-mix(in srgb, var(--success) 10%, transparent); 
    }
    .retention-yellow { 
        background-color: color-mix(in srgb, #f59e0b 15%, transparent); 
    }
    .retention-red { 
        background-color: color-mix(in srgb, var(--danger) 15%, transparent); 
    }
    .retention-tooltip { 
        position: absolute; 
        bottom: 100%; 
        left: 0; 
        transform: translateY(-10px); 
        background-color: var(--dark-surface); 
        color: var(--dark-text-body); 
        padding: 0.75rem; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        width: 90%; 
        z-index: 10; 
        font-size: 0.8rem; 
        border: 1px solid var(--dark-border); 
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 0.3s, transform 0.3s; 
    }
    .retention-tooltip .optimize-btn { 
        display: block; 
        width: 100%; 
        margin-top: 0.75rem; 
        padding: 0.5rem; 
        border: none; 
        background-color: var(--primary); 
        color: white; 
        font-weight: 600; 
        border-radius: 6px; 
        cursor: pointer; 
        transition: var(--transition); 
    }
    .retention-tooltip .optimize-btn:hover { 
        background-color: var(--primary-dark); 
    }
    .retention-paragraph-live:hover .retention-tooltip { 
        opacity: 1; 
        visibility: visible; 
        transform: translateY(-5px); 
    }
    .highlight-group { 
        outline: 2px solid var(--primary); 
        outline-offset: 2px; 
        box-shadow: 0 0 15px color-mix(in srgb, var(--primary) 30%, transparent); 
    }

    /* --- Feedback Visual de Altera√ß√£o ("Pisca") --- */
    @keyframes fade-out-highlight {
      from {
        background-color: color-mix(in srgb, #f59e0b 25%, transparent);
        outline: 2px solid #f59e0b;
      }
      to {
        background-color: transparent;
        outline: 2px solid transparent;
      }
    }
    .highlight-change {
      animation: fade-out-highlight 20s ease-out forwards;
      border-radius: 4px;
      outline-offset: 2px;
    }

/* --- Tooltips de Ajuda (Unificado) --- */
.tooltip-container {
    position: relative;
    display: inline-flex;
}
.tooltip-container .tooltip-text {
    visibility: hidden;
    opacity: 0;
    width: 300px;
    /* MUDAN√áA DE COR: Agora usa o mesmo fundo do popover */
    background-color: var(--dark-bg); 
    color: var(--dark-text-header);
    text-align: left;
    border-radius: 8px;
    padding: 1rem;
    position: absolute;
    z-index: 1001;
    bottom: 115%; 
    left: 50%;
    transform: translateX(-50%);
    box-shadow: var(--shadow);
    border: 1px solid var(--dark-border);
    transition: opacity 0.3s;
    pointer-events: none;
    /* MUDAN√áA DE FONTE: 1rem √© o equivalente a 16px */
    font-size: 1rem; 
    font-weight: 500;
    line-height: 1.6;
}
.tooltip-container .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    /* MUDAN√áA DE COR DA SETA: Para combinar com o novo fundo */
    border-color: var(--dark-bg) transparent transparent transparent;
}
.tooltip-container:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}
.tooltip-container .tooltip-text strong {
    font-weight: 700;
    color: var(--primary);
}
    
    /* Estilos espec√≠ficos para o √≠cone (i), se necess√°rio */
    .help-icon {
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: var(--dark-border);
        color: var(--dark-text-muted);
        font-size: 11px;
        font-weight: 700;
        cursor: help;
        margin-left: 8px;
        transition: var(--transition);
    }
    .help-icon:hover {
        background-color: var(--primary);
        color: white;
    }

/* ========================================================== */
/*           NOVO MENU DE EDI√á√ÉO CONTEXTUAL (CSS)             */
/* ========================================================== */
#editing-menu {
    position: absolute;
    background-color: var(--dark-surface);
    border: 1px solid var(--dark-border);
    border-radius: 8px;
    box-shadow: var(--shadow);
    padding: 0.5rem;
    z-index: 1002;
    display: flex;
    gap: 0.25rem; /* Espa√ßamento menor entre os bot√µes */
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, transform 0.2s;
    transform: translateY(10px);
}
#editing-menu.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}
#editing-menu button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background-color: transparent;
    border: none;
    color: var(--dark-text-header);
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-radius: 6px;
    font-weight: 500;
    white-space: nowrap;
    transition: var(--transition);
}
#editing-menu button:hover {
    background-color: var(--dark-border);
    color: var(--primary);
}


/* ========================================================== */
/*     CORRE√á√ÉO PARA O MODAL "ADICIONAR NOVO CAP√çTULO"      */
/* ========================================================== */

/* Permite que o texto dentro dos bot√µes de sugest√£o quebre a linha */
#inputDialogSuggestions .btn {
    white-space: normal; /* Permite a quebra de linha */
    text-align: left;    /* Alinha o texto √† esquerda para melhor leitura */
    height: auto;        /* Deixa a altura do bot√£o se ajustar ao conte√∫do */
    padding-top: 0.75rem;    /* Ajuste vertical para mais conforto */
    padding-bottom: 0.75rem; /* Ajuste vertical para mais conforto */



/* ========================================================== */
/* =================== ESTILOS PARA IMPRESS√ÉO (PDF) =================== */
/* ========================================================== */
@media print {
    /* Esconde tudo que n√£o queremos no PDF */
    body > *:not(#print-container) {
        display: none !important;
    }
    
    /* Garante que o container de impress√£o ocupe todo o espa√ßo */
    #print-container {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        color: #000;
        background-color: #fff !important;
    }
    
    /* ESTILOS DE FONTE PARA O DOCUMENTO INTEIRO */
    #print-container, .print-section-content {
        font-family: 'Roboto', serif; /* Fonte padr√£o para o corpo */
        font-size: 12pt;
        line-height: 1.5;
    }

    h1, .print-section-title {
        font-family: 'Source Serif Pro', sans-serif; /* Fonte para t√≠tulos */
    }
    
    .print-section {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #ccc;
        page-break-inside: avoid;
    }
    
    h1 {
        text-align: center;
        font-size: 22pt;
        margin-bottom: 24px;
    }

    .print-section-title {
        font-size: 16pt;
        font-weight: bold;
        margin-bottom: 12px;
        color: #333;
    }
    
    /* Configura√ß√£o espec√≠fica para o roteiro (corpo do texto) */
    .print-section-content pre {
        white-space: pre-wrap;
        font-family: 'Roboto', serif; /* Garante a fonte aqui tamb√©m */
        font-size: 12pt;
        margin: 0;
        padding: 0;
    }

    .print-section-content ul {
        list-style-position: inside;
        padding-left: 10px;
    }

    /* Remove estilos visuais que n√£o queremos no PDF */
    .generated-output-box, .thumbnail-idea, .card {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        color: #000 !important;
    }
    
    /* For√ßa que o texto de todos os elementos seja preto */
    .print-section-content p, .print-section-content li, .print-section-content h4, .print-section-content strong {
        color: #000 !important;
    }
}

</style>



</head>



<body class="bg-gray-50 dark:bg-gray-900">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
                    <i class="fas fa-video mr-2"></i>Gerador de Roteiros Virais v4.0
                </h1>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="theme-toggle">
                        <i id="moonIcon" class="fas fa-moon text-gray-700 dark:text-gray-300"></i>
                        <i id="sunIcon" class="fas fa-sun text-gray-700 dark:text-gray-300 hidden"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="container mx-auto px-4 py-4">
            <div class="mb-6">
                <div class="flex justify-between text-sm mb-1">
                    <span>Progresso do Projeto</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 pb-20">
            <!-- Estrat√©gia Section -->


<!-- ==================================================================== -->
<!--     NOVA SE√á√ÉO 0: CENTRAL DE INVESTIGA√á√ÉO E IDEIAS (FLUXO 2.0)     -->
<!-- ==================================================================== -->
<section class="mb-12">
    <div class="text-center mb-8">
        <h2 class="text-2xl font-bold mb-2">Comece com a Verdade</h2>
        <p class="text-gray-600 dark:text-gray-400">Investigue um tema, fato ou pergunta. A IA buscar√° fontes e, a partir do relat√≥rio, voc√™ poder√° gerar ideias de roteiro j√° validadas.</p>
    </div>

  <div class="card">
    <div class="input-group">
        <label for="languageSelect">1. Primeiro, selecione o idioma da pesquisa:</label>
        <select id="languageSelect">
            <option value="pt-br">Portugu√™s (Brasil)</option>
            <option value="en" selected>English</option>
        </select>
    </div>
    <div class="input-group">
        <label for="factCheckQuery">2. Agora, digite o tema, fato ou pergunta a ser investigada:</label>
        <textarea id="factCheckQuery" rows="3" ...></textarea>
    </div>
    <div class="text-center mt-4">
        <button id="investigateBtn" data-action="investigate" class="btn btn-secondary">
            <i class="fas fa-search-plus mr-2"></i>Investigar Tema
        </button>
    </div>



        <!-- Container para o relat√≥rio da IA -->
        <div id="factCheckOutput" class="mt-8">
            <!-- O relat√≥rio da investiga√ß√£o e o "bot√£o m√°gico" aparecer√£o aqui -->
        </div>
        
        <hr class="my-8 border-dashed border-gray-300 dark:border-gray-600">

        <!-- Parte 2: A Gera√ß√£o de Ideias -->
        <div id="ideaGenerationSection" class="hidden">
             <div class="text-center">
                <h3 class="text-lg font-bold mb-2">Gerar Ideias a partir do Relat√≥rio</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Agora, escolha um especialista para transformar os fatos investigados em ideias de v√≠deo criativas.</p>
            </div>
            
            <!-- A Barra de Navega√ß√£o com Abas de G√™nero -->
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav id="genreTabs" class="-mb-px flex flex-wrap space-x-2 justify-center" aria-label="Tabs">
    <button data-genre="documentario" class="tab-button tab-active"> <i class="fas fa-film fa-fw"></i> <span>Document√°rio</span> </button>
    <button data-genre="inspiracional" class="tab-button"> <i class="fas fa-hand-sparkles fa-fw"></i> <span>Inspiracional</span> </button>
    <button data-genre="scifi" class="tab-button"> <i class="fas fa-rocket fa-fw"></i> <span>Fic√ß√£o Cient√≠fica</span> </button>
    <button data-genre="terror" class="tab-button"> <i class="fas fa-ghost fa-fw"></i> <span>Terror</span> </button>
    <button data-genre="enigmas" class="tab-button"> <i class="fas fa-scroll fa-fw"></i> <span>Enigmas (B√≠blico)</span> </button>
    <button data-genre="geral" class="tab-button"> <i class="fas fa-lightbulb fa-fw"></i> <span>Geral</span> </button>
</nav>
            </div>
            <div class="mt-6 text-center">
                <button id="generateIdeasFromReportBtn" data-action="generateIdeasFromReport" class="btn btn-primary">
                    <i class="fas fa-magic mr-2"></i>Gerar Ideias com Especialista
                </button>
            </div>
        </div>

        <!-- O Container final para a Sa√≠da das Ideias -->
        <div id="ideasOutput" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- As ideias geradas pela IA aparecer√£o aqui -->
        </div>
    </div>
</section>



    <div class="section-title">
        <h2 class="text-xl font-bold">1. Definir Estrat√©gia</h2>
    </div>
    
    <!-- A navega√ß√£o das abas (continua a mesma) -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav id="inputTabsNav" class="-mb-px flex flex-wrap md:flex-nowrap space-x-6" aria-label="Tabs">
            <button data-tab="input-tab-basico" class="tab-button tab-active">
                <i class="fas fa-info-circle mr-2"></i> B√°sico
            </button>
            <button data-tab="input-tab-estrategia" class="tab-button">
                <i class="fas fa-lightbulb mr-2"></i> Estrat√©gia Narrativa
            </button>
            <button data-tab="input-tab-tecnicos" class="tab-button">
                <i class="fas fa-sliders-h mr-2"></i> Detalhes T√©cnicos
            </button>
        </nav>
    </div>
    
    <!-- O conte√∫do das abas (AGORA CORRIGIDO) -->
    <div id="inputTabContent" class="card">
        
        <!-- Aba 1: B√°sico -->

<div id="input-tab-basico" class="tab-pane active-pane">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="input-group"><label for="channelName">Nome do Canal:</label><input type="text" id="channelName" value="The Biblical Unveiling"></div>
        <div class="input-group"><label for="videoTheme">Tema do V√≠deo:</label><input type="text" id="videoTheme" placeholder="Ex: A Arca da Alian√ßa Foi Encontrada?"></div>
        
        
        <!-- Dura√ß√£o e Ritmo agora ficam lado a lado -->
        <div class="input-group">
            <label for="videoDuration">Dura√ß√£o Desejada:</label>
            <select id="videoDuration">
                <option value="">-- Selecione --</option>
                <option value="short">Curto (~1-3 min)</option>
                <option value="medium">M√©dio (~4-7 min)</option>
                <option value="long">Longo (~8-12 min)</option>
            </select>
        </div>

        <div class="input-group">
    <label for="visualPacing">Ritmo Visual (Cenas):</label>
    <select id="visualPacing">
        <option value="" selected>-- Selecione --</option> <!-- Adicionado 'selected' aqui -->
        <option value="dinamico">Din√¢mico (3-8s)</option> <!-- Removido 'selected' daqui -->
        <option value="normal">Normal (8-15s)</option>
        <option value="contemplativo">Contemplativo (15-25s)</option>
    </select>
</div>

        <div class="input-group md:col-span-2"><label for="videoDescription">Descri√ß√£o do V√≠deo (para inspira√ß√£o):</label><textarea id="videoDescription" rows="4" placeholder="Cole uma breve descri√ß√£o do v√≠deo aqui..."></textarea></div>
    </div>
</div>


<!-- Aba 2: Estrat√©gia Narrativa (COM NOVOS POPOVERS E TOOLTIPS) -->
<div id="input-tab-estrategia" class="tab-pane hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Bloco 1: O Que e Para Quem -->
        <div class="input-group md:col-span-2"><label for="targetAudience">P√∫blico-Alvo:</label><input type="text" id="targetAudience" placeholder="Quem voc√™ quer que assista? Descreva seu espectador ideal."></div>
        <div class="input-group md:col-span-2"><label for="narrativeTheme">3. Tema Principal:</label><input type="text" id="narrativeTheme" placeholder="Qual √© a 'grande ideia'? A √∫nica mensagem que seu p√∫blico deve lembrar?"></div>
        <div class="input-group md:col-span-2"><label for="centralQuestion">Pergunta Central (Opcional):</label><textarea id="centralQuestion" rows="2" placeholder="Qual mist√©rio ou 'coceira mental' voc√™ vai criar e prometer resolver?"></textarea></div>

        <!-- Bloco 2: A Estrutura e a Alma -->
        <!-- MUDAN√áA AQUI: Adicionamos a estrutura para o novo popover -->
        <div class="relative group">
            <div class="input-group">
                <label for="narrativeGoal">1. Objetivo da Narrativa:</label>
                <select id="narrativeGoal">
                    <option value="storytelling">Storytelling</option>
                    <option value="storyselling">Storyselling</option>
                </select>
            </div>
            <div id="goalPopover" class="card popover-bg absolute bottom-full left-0 mb-2 w-[400px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-20 pointer-events-none group-hover:pointer-events-auto">
                <h4 class="font-bold text-lg text-indigo-400 mb-2"></h4>
                <p class="text-sm leading-relaxed"></p>
            </div>
        </div>
        <div class="relative group">
            <div class="input-group">
                <div class="flex items-center gap-2 mb-2"><label for="narrativeStructure">2. Estrutura Espec√≠fica:</label></div>
                <select id="narrativeStructure"></select>
            </div>
            <div id="structurePopover" class="card popover-bg absolute bottom-full left-0 mb-2 w-[400px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-20 pointer-events-none group-hover:pointer-events-auto">
                <h4 id="popoverTitle" class="font-bold text-lg text-indigo-400 mb-2"></h4>
                <p id="popoverDescription" class="text-sm leading-relaxed"></p>
            </div>
        </div>
        <div class="input-group md:col-span-2"><label for="emotionalHook">Hist√≥ria Pessoal / Gancho Emocional (Opcional):
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>D√™ uma alma para sua hist√≥ria.</strong> Este √© o 'fio condutor' humano. A IA usar√° esta pequena hist√≥ria para conectar os grandes fatos a uma experi√™ncia pessoal, tornando o roteiro muito mais impactante.
                </span>
            </span>
        </label><textarea id="emotionalHook" rows="3" placeholder="Qual rosto humano dar√° alma √† sua hist√≥ria? Ex: a jornada de um indiv√≠duo, uma mem√≥ria pessoal, um arqu√©tipo (o azar√£o, o mentor)..."></textarea></div>

        <!-- Bloco 3: O Tom e a Jornada -->
        <div class="input-group"><label for="narrativeTone">4. Tom da Narra√ß√£o:
            <!-- NOVO TOOLTIP AQUI -->
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>Define o "sentimento" do v√≠deo.</strong> √â s√©rio e sombrio? Leve e inspirador? A escolha do tom guia a m√∫sica, o ritmo e o estilo da narra√ß√£o.
                </span>
            </span>
        </label><select id="narrativeTone"><option value="inspirador" selected>Inspirador</option><option value="serio">S√©rio</option><option value="emocional">Emocional</option></select></div>
        <div class="input-group"><label for="narrativeVoice">5. Voz do Narrador:
            <!-- NOVO TOOLTIP AQUI -->
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>Imagine que seu canal √© uma pessoa.</strong> Como ela falaria? Um mentor s√°bio? Um amigo entusiasmado? Um investigador misterioso? Isso define a personalidade da sua narra√ß√£o.
                </span>
            </span>
        </label><input type="text" id="narrativeVoice" placeholder="Ex: Confiante, Engra√ßada, Misteriosa..."></div>
        <div class="input-group md:col-span-2"><label for="emotionalArc">Arco Emocional Desejado (Opcional):
            <!-- NOVO TOOLTIP AQUI -->
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>Qual jornada de sentimentos voc√™ quer que o espectador percorra?</strong> Come√ßa com curiosidade, vai para a tens√£o e termina em al√≠vio? Planejar isso cria um v√≠deo muito mais impactante.
                </span>
            </span>
        </label><textarea id="emotionalArc" rows="2" placeholder="Ex: Curiosidade -> Tens√£o -> Surpresa -> Al√≠vio"></textarea></div>
        <div class="input-group md:col-span-2"><label for="shockingEndingHook">O Desfecho Chocante (Hook Opcional):
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>A t√©cnica do 'loop aberto' reverso.</strong> Coloque a frase final e mais chocante da sua hist√≥ria aqui. A IA usar√° esta frase como a PRIMEIRA linha do v√≠deo, criando um mist√©rio instant√¢neo que prende o espectador at√© o final.
                </span>
            </span>
        </label><input type="text" id="shockingEndingHook" placeholder="Ex: ...e foi por isso que a Arca nunca deveria ser encontrada."></div>

    </div>
</div>

<!-- Aba 3: Detalhes T√©cnicos (COM TOOLTIPS CORRIGIDOS) -->
<div id="input-tab-tecnicos" class="tab-pane hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="input-group"><label for="languageStyle">Estilo de Linguagem:</label><select id="languageStyle"><option value="inspirador" selected>Inspirador</option><option value="formal">Formal</option></select></div>
        <div class="input-group"><label for="videoObjective">Objetivo do V√≠deo:</label><select id="videoObjective"><option value="informar" selected>Informar</option><option value="emocionar">Emocionar</option></select></div>
        <div class="input-group"><label for="speakingPace">Ritmo de Fala:</label><select id="speakingPace"><option value="moderate" selected>Moderado</option><option value="slow">Lento</option><option value="fast">R√°pido</option></select></div>
        <div class="input-group md:col-span-2">
            <label for="researchData">Fontes e Dados de Pesquisa (Opcional):
                <!-- A CORRE√á√ÉO EST√Å AQUI: Adicionamos a classe 'tooltip-container' -->
                <span class="help-icon tooltip-container">i
                    <span class="tooltip-text">
                        <strong>Aumente a credibilidade.</strong> Cole aqui nomes, datas, estat√≠sticas, ou cita√ß√µes. A IA ir√° tecer essas informa√ß√µes na narrativa.
                        Ex: 'Fonte: Estudo de Harvard; Dr. Jo√£o da Silva, especialista...'
                    </span>
                </span>
            </label>
            <textarea id="researchData" rows="4" placeholder="Para aumentar a credibilidade, cole aqui dados, fontes, nomes e links que a IA deve citar e contextualizar no roteiro. Ex: Fonte: Atlas da Viol√™ncia 2023; Maria da Silva, coordenadora do Instituto Odara..."></textarea>
        </div>
        <div class="input-group md:col-span-2"><label for="imageDescriptionEngine">Motor de Descri√ß√£o de Imagem:</label><textarea id="imageDescriptionEngine" rows="2" placeholder="Ex: 'fotografias reais', 'close-up emocional'"></textarea></div>
        <div class="input-group md:col-span-2"><label for="imageStyleSelect">Motor de Qualidade de Imagem:</label><select id="imageStyleSelect"><option value="cinematic" selected>Cinematogr√°fico</option><option value="custom">Personalizado</option><option value="none">Nenhum</option></select></div>
        <div id="customImageStyleContainer" class="input-group md:col-span-2" style="display: none;">
            <label for="customImageStyle">Estilo de Imagem Personalizado:</label>
            <textarea id="customImageStyle" rows="3" placeholder="Descreva o seu estilo de imagem aqui... Ex: 'estilo de arte de Van Gogh', 'preto e branco com alto contraste'..."></textarea>
        </div>
    </div>
</div>
    
    <!-- O bot√£o final (continua o mesmo) -->
    <div class="mt-6 text-center">
        <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
    <!-- Bot√£o Opcional para ajuda da IA -->
    <button id="suggestStrategyBtn" data-action="suggestStrategy" class="btn btn-secondary w-full sm:w-auto">
        <i class="fas fa-magic mr-2"></i> Sugerir Estrat√©gia com IA
    </button>
    <!-- Bot√£o Principal para avan√ßar -->
    <button id="startCraftingBtn" data-action="startCrafting" class="btn btn-primary w-full sm:w-auto">
        <i class="fas fa-arrow-right mr-2"></i> Iniciar Cria√ß√£o do Roteiro
    </button>
</div>


    </div>
</section>

<!-- PAINEL DO PROJETO (inicialmente escondido) -->
<div id="projectDashboard" class="hidden mt-12">

    <!-- SE√á√ÉO 2: CRIAR ROTEIRO -->
    <section class="mb-10">
        <div class="section-title"><h2 class="text-xl font-bold">2. Criar Roteiro</h2></div>
        
        <!-- Card do Esbo√ßo Estrat√©gico -->
        <div id="strategicOutlineCard" class="card card-placeholder mb-6">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-lg">Esbo√ßo Estrat√©gico</h3>
                <button id="generateOutlineBtn" data-action="generateOutline" class="btn btn-secondary btn-small">Criar Esbo√ßo</button>
            </div>
            <div id="outlineContent"><div class="asset-card-placeholder">Clique para gerar o esbo√ßo.</div></div>
        </div>
        
        <!-- Container onde as se√ß√µes do roteiro (Introdu√ß√£o, etc.) ser√£o injetadas -->
        <div id="scriptSectionsContainer" class="space-y-4"></div>
    </section>
    <!-- FIM DA SE√á√ÉO 2 -->


    <!-- ========================================================================= -->
    <!--  IN√çCIO DA CORRE√á√ÉO: O M√ìDULO DE CONCLUS√ÉO AGORA TEM UM LUGAR FIXO AQUI  -->
    <!-- ========================================================================= -->
    <div id="conclusionStrategyModule" class="card mb-6 hidden">
        <div class="text-center mb-4">
            <h3 class="text-lg font-bold">Qual √© o objetivo final do seu v√≠deo?</h3>
            <button id="suggestFinalStrategyBtn" data-action="suggestFinalStrategy" class="btn btn-secondary btn-small mt-2">
                <i class="fas fa-magic mr-2"></i> Sugerir Estrat√©gia Final
            </button>
        </div>
        <div class="flex justify-center flex-wrap gap-4 mb-6">
            <label class="radio-label">
                <input type="radio" name="conclusionType" value="lesson" checked>
                <span><i class="fas fa-graduation-cap mr-2"></i>Deixar uma Li√ß√£o / Reflex√£o</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="conclusionType" value="answer">
                <span><i class="fas fa-question-circle mr-2"></i>Responder uma Pergunta Central</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="conclusionType" value="cliffhanger">
                <span><i class="fas fa-bolt mr-2"></i>Criar um Gancho / Mist√©rio Cont√≠nuo</span>
            </label>
        </div>
        <div id="conclusionInputContainer" class="input-group">
            <label for="conclusionSpecifics">Detalhes para a Conclus√£o:</label>
            <textarea id="conclusionSpecifics" rows="3" placeholder="Qual sentimento ou ideia final voc√™ quer deixar com o espectador? Esperan√ßa? Indigna√ß√£o? Uma nova perspectiva?"></textarea>
        </div>
        <div class="input-group mt-4">
            <label for="ctaSpecifics">Detalhes para o Call to Action (CTA) Espec√≠fico (Opcional):</label>
            <textarea id="ctaSpecifics" rows="2" placeholder="Qual a√ß√£o espec√≠fica voc√™ quer que o espectador tome? Ex: Visitar um site, apoiar uma causa, comprar um produto..."></textarea>
        </div>
        <div class="text-center mt-6">
            <button id="generateConclusionBtn" data-action="generateConclusion" class="btn btn-primary">
                <i class="fas fa-pen-fancy mr-2"></i>Gerar Conclus√£o
            </button>
            <button id="generateCtaBtn" data-action="generateCta" class="btn btn-primary hidden">
                <i class="fas fa-bullhorn mr-2"></i>Gerar CTA Estrat√©gico
            </button>
        </div>
    </div>
    <!-- ========================================================================= -->
    <!--                 FIM DA CORRE√á√ÉO E DO M√ìDULO DE CONCLUS√ÉO                  -->
    <!-- ========================================================================= -->


    <!-- SE√á√ÉO 3: RECURSOS E METADADOS -->
    <section>
        <div class="section-title"><h2 class="text-xl font-bold">3. Recursos e Metadados</h2></div>
        
        <!-- Mapa Emocional -->
        <div class="card card-placeholder mb-6">
             <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-lg">Mapa Emocional</h3>
                <button id="mapEmotionsBtn" data-action="mapEmotions" class="btn btn-secondary btn-small">Mapear</button>
            </div>
            <div id="emotionalMapContent"><div class="asset-card-placeholder">Gere o roteiro completo para habilitar.</div></div>
        </div>

        <!-- Grid para os outros recursos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- T√≠tulos & Thumbnails -->
            <div class="card card-placeholder">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-lg">T√≠tulos & Thumbnails</h3>
                    <button id="generateTitlesAndThumbnailsBtn" data-action="generateTitlesAndThumbnails" class="btn btn-secondary btn-small">Gerar</button>
                </div>
                <div id="titlesThumbnailsContent"><div class="asset-card-placeholder">Gere o roteiro para habilitar.</div></div>
            </div>

            <!-- Descri√ß√£o & Hashtags -->
            <div class="card card-placeholder">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-lg">Descri√ß√£o & Hashtags</h3>
                    <button id="generateDescriptionBtn" data-action="generateDescription" class="btn btn-secondary btn-small">Gerar</button>
                </div>
                <div id="videoDescriptionContent"><div class="asset-card-placeholder">Gere o roteiro para habilitar.</div></div>
            </div>

            <!-- Trilha Sonora -->
            <div class="card card-placeholder md:col-span-2">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-lg">Trilha Sonora</h3>
                    <button id="generateSoundtrackBtn" data-action="generateSoundtrack" class="btn btn-secondary btn-small">Gerar</button>
                </div>
                <div id="soundtrackContent"><div class="asset-card-placeholder">Gere o roteiro para habilitar.</div></div>
            </div>
        </div>
        <!-- Note que o m√≥dulo de conclus√£o n√£o est√° mais aqui dentro -->
    </section>


    </section>


    <!-- SE√á√ÉO 5: AN√ÅLISE DE ROTEIRO COMPLETO -->
<section id="scriptAnalysisSection" class="mt-10 hidden">
    <div class="section-title">
        <h2 class="text-xl font-bold">5. An√°lise de Roteiro (Beta)</h2>
    </div>
    <div class="card text-center">
        <p class="mb-4 text-gray-600 dark:text-gray-400">Pronto para receber um feedback de n√≠vel profissional? Nossas IAs analisar√£o seu roteiro em busca de pontos fortes, oportunidades de melhoria e ganchos de reten√ß√£o.</p>
        
        <!-- Container dos bot√µes -->
        <div class="flex flex-wrap justify-center gap-4">
            <button id="analyzeScriptBtn" data-action="analyzeScript" class="btn btn-primary">
                <i class="fas fa-search-plus mr-2"></i> An√°lise Geral
            </button>
            <button id="analyzeHooksBtn" data-action="analyzeHooks" class="btn btn-secondary">
                <i class="fas fa-anchor mr-2"></i> Ca√ßar Ganchos
            </button>
            <!-- NOSSO NOVO BOT√ÉO AQUI -->
            <button id="suggestViralBtn" data-action="suggestViralElements" class="btn btn-secondary">
                <i class="fas fa-lightbulb mr-2"></i> Sugerir Elementos Virais
            </button>
        </div>

        <!-- Containers para os relat√≥rios -->
        <div id="analysisReportContainer" class="mt-6 text-left"></div>
        <div id="hooksReportContainer" class="mt-6 text-left"></div>
        <!-- NOSSO NOVO CONTAINER DE RELAT√ìRIO AQUI -->
        <div id="viralSuggestionsContainer" class="mt-6 text-left"></div>
    </div>
</section>



<!-- ========================================================== -->
<!--     NOVA SE√á√ÉO 4: GERENCIAMENTO DO PROJETO (EXPORTAR/IMPORTAR)     -->
<!-- ========================================================== -->
<section class="mt-10">




    <div class="section-title">
        <h2 class="text-xl font-bold">4. Gerenciamento do Projeto</h2>
    </div>
    <div class="card">
        <div class="flex flex-wrap items-center justify-center gap-4">
            <!-- Bot√£o para Importar Projeto -->
            <label for="importFileInput" class="btn btn-secondary cursor-pointer">
                <i class="fas fa-upload mr-2"></i> Importar Projeto
            </label>
            <input type="file" id="importFileInput" class="hidden" accept=".json">

            <!-- Bot√£o para Exportar Projeto -->
            <button id="exportProjectBtn" data-action="exportProject" class="btn btn-secondary">
                <i class="fas fa-download mr-2"></i> Exportar Projeto
            </button>

            <!-- >>> NOSSO NOVO BOT√ÉO AQUI <<< -->
            <button id="exportPdfBtn" data-action="exportPdf" class="btn btn-secondary">
            <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
            </button>

            <!-- >>> Exportar Transcri√ß√£o <<< -->
            <button id="exportTranscriptBtn" data-action="exportTranscript" class="btn btn-secondary">
            <i class="fas fa-file-alt mr-2"></i> Exportar Transcri√ß√£o (.rtf)
            </button>
            
            <!-- Bot√£o para Resetar -->
            <button id="resetProjectBtn" data-action="resetProject" class="btn bg-red-600 hover:bg-red-700 text-white">
                <i class="fas fa-sync-alt mr-2"></i> Novo Projeto (Resetar)
            </button>
        </div>
    </div>

</section>


</div>
</main>


<div id="editing-menu">
    <button data-action="expand" title="Expandir Par√°grafo">
        <i class="fas fa-expand-alt fa-fw"></i> <span>Expandir</span>
    </button>
    <button data-action="summarize" title="Resumir Par√°grafo">
        <i class="fas fa-compress-alt fa-fw"></i> <span>Resumir</span>
    </button>
    <button data-action="correct" title="Corrigir Ortografia e Gram√°tica">
        <i class="fas fa-spell-check fa-fw"></i> <span>Corrigir</span>
    </button>
</div>

        <!-- Floating Action Bar -->
        <div class="floating-action-bar">
            <button class="theme-toggle bg-indigo-500 text-white">
                <i class="fas fa-save"></i>
            </button>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <span id="toastMessage">Mensagem de notifica√ß√£o</span>
        </div>
    </div>

    <!-- Confirmation Dialog Overlay -->
        <div id="confirmationDialogOverlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
            <div class="card max-w-sm w-full animate-fade-in">
                <h3 id="confirmationTitle" class="text-xl font-bold mb-4">T√≠tulo da Confirma√ß√£o</h3>
                <p id="confirmationMessage" class="mb-6">Deseja limpar o trabalho j√° realziado?</p>
                <div class="flex justify-end gap-4">
                    <button id="confirmBtnNo" class="btn btn-secondary">N√£o</button>
                    <button id="confirmBtnYes" class="btn btn-primary">Sim</button>
                </div>
            </div>
        </div>

<!-- ========================================================== -->
<!--     MODAL ATUALIZADO COM √ÅREA PARA SUGEST√ïES         -->
<!-- ========================================================== -->
<div id="inputDialogOverlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card max-w-md w-full animate-fade-in">
        <h3 id="inputDialogTitle" class="text-xl font-bold mb-4">T√≠tulo do Di√°logo</h3>
        <p id="inputDialogMessage" class="text-sm text-gray-500 dark:text-gray-400 mb-4">Mensagem de ajuda.</p>
        
        <!-- Container para as sugest√µes da IA -->
        <div id="inputDialogSuggestions" class="space-y-2 mb-4">
            <!-- As sugest√µes (bot√µes) ser√£o injetadas aqui pelo JavaScript -->
        </div>

        <!-- Divisor opcional -->
        <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-300 dark:border-gray-700"></div>
            <span class="flex-shrink mx-4 text-xs text-gray-400">OU</span>
            <div class="flex-grow border-t border-gray-300 dark:border-gray-700"></div>
        </div>
        
        <div class="input-group mt-2">
            <label id="inputDialogLabel" for="inputDialogField">Label do Campo</label>
            <textarea id="inputDialogField" rows="2" placeholder="Placeholder..." class="!text-[var(--dark-text-body)]"></textarea>
        </div>

        <div class="flex justify-end gap-4 mt-6">
            <button id="inputBtnCancel" class="btn btn-secondary">Cancelar</button>
            <button id="inputBtnConfirm" class="btn btn-primary">Usar Tema Personalizado</button>
        </div>
    </div>
</div>


    <script type="module">


// ==========================================================
// ==================== ESTADO CENTRALIZADO =================
// ==========================================================
const AppState = {
    inputs: {},
    generated: {
        investigationReport: null,
        ideas: [],
        strategicOutline: null,
        script: {
            intro: { html: null, text: null },
            development: { html: null, text: null },
            climax: { html: null, text: null },
            conclusion: { html: null, text: null },
            cta: { html: null, text: null }
        },
        titlesAndThumbnails: null,
        description: null,
        soundtrack: null,
        emotionalMap: null,
        imagePrompts: {}
    },
    ui: {
        isSettingStrategy: false,
        promptPaginationState: {}
    }
};


let elements = {};
let buttons = {};
let totalScriptSeconds = 0;
let userSelectionRange = null; 
   
    
        // Bloco de estilo cinematogr√°fico para prompts de imagem
        const CINEMATIC_STYLE_BLOCK = `
# DIRETRIZES DE ESTILO CINEMATOGR√ÅFICO PARA IMAGENS DE ALTA RESOLU√á√ÉO

Ultra-realistic, high-resolution photographic image captured with masterfully rendered natural or artificial lighting and cinematic composition. The aesthetic should be of a modern cinematic film, with meticulous attention to physical and sensory details.

## CARACTER√çSTICAS VISUAIS ESSENCIAIS

### Qualidade T√©cnica
- **Rich & Organic Textures:** Surfaces must display tactile authenticity ‚Äî visible skin pores, individual fabric threads, weathered materials (wood, metal, stone), realistic reflections, and organic imperfections that add depth and believability.
- **Focus & Depth of Field:** Employ selective sharp focus with subtle depth of field (slightly blurred background or foreground) to guide the viewer's attention and create a sense of three-dimensionality.
- **Color Palette & Contrast:** Colors should be "true-to-life" but with a refined, cinematic tonal range. Avoid super-saturated or artificially vibrant hues. Favor contrasts that create visual drama and natural modeling, typical of good cinematography.
- **Lighting & Atmosphere:** Lighting must be complex and naturalistic, with multiple light sources creating soft shadows, half-tones, and highlights. Include subtle atmospheric elements like dust, mist, or light rays (god rays) when appropriate to enhance the sense of a living environment.

### Composi√ß√£o Visual
- **Visual Composition:** Apply classic cinematic composition principles (rule of thirds, leading lines, broken symmetry, depth) to create visually appealing frames that tell a story.
- **Camera Perspective:** Use appropriate focal lengths and camera angles that enhance the emotional impact of the scene (wide shots for epic scale, close-ups for intimate moments).
- **Movement Sensation:** Even in still images, create a sense of potential movement or captured moment that suggests cinematic timing.

### Estilo Geral
- **Overall Style:** The final result must be indistinguishable from a high-quality photograph taken with professional equipment, intended to illustrate a film scene. Nothing should look artificial, "3D rendered," or overly polished. The goal is physical and emotional authenticity.
- **Post-Production Elements:** Include subtle film grain appropriate to the style, natural lens characteristics (slight vignetting, chromatic aberration when appropriate), and color grading that enhances the mood without appearing artificial.

## REFER√äNCIAS DE ESTILO (INSPIRA√á√ÉO CINEMATOGR√ÅFICA)

Para diferentes g√™neros e atmosferas, considere estas refer√™ncias:
- **Drama Intenso:** Estilo de Emmanuel Lubezki em "The Revenant" - ilumina√ß√£o natural, texturas org√¢nicas, movimento cont√≠nuo
- **Suspense/Thriller:** Estilo de Roger Deakins em "Blade Runner 2049" - composi√ß√£o precisa, cores controladas, ilumina√ß√£o dram√°tica
- **√âpico/Hist√≥rico:** Estilo of Rodrigo Prieto em "The Irishman" - paleta de cores espec√≠fica do per√≠odo, ilumina√ß√£o naturalista, detalhes aut√™nticos
- **Contempor√¢neo/Realista:** Estilo de Greig Fraser em "The Mandalorian" - ilumina√ß√£o pr√°tica, texturas realistas, composi√ß√£o din√¢mica

## RESTRI√á√ïES DE ESTILO (O QUE EVITAR)

- **NO** exaggerated or distorted features (facial features, proportions).
- **NO** artificial "glow" or excessive smoothing (airbrushing).
- **NO** visible 3D render or CGI look.
- **NO** super-saturated colors or unreal hues.
- **NO** element that breaks the illusion of a photorealistic capture.
- **NO** inconsistent lighting that doesn't match the described environment.
- **NO** modern digital artifacts that break the cinematic immersion.`;


        // Labels para descri√ß√£o de imagem em diferentes idiomas
        const imageDescriptionLabels = { 'pt-br': 'Descri√ß√£o da Imagem:', 'pt-pt': 'Descri√ß√£o da Imagem:', 'en': 'Image Description:' };

// ==========================================================
        // NOVO: MAPA DE CONTAGEM DE PALAVRAS PARA CONTROLAR DURA√á√ÉO
        // ==========================================================
        const wordCountMap = {
            // ~2.5 min @ 150 WPM = ~375 palavras
            'short': {
                intro: 60,
                development: 190,
                climax: 75,
                conclusion: 50
            },
            // ~5.5 min @ 150 WPM = ~825 palavras
            'medium': {
                intro: 120,
                development: 420,
                climax: 165,
                conclusion: 120
            },
            // ~10 min @ 150 WPM = ~1500 palavras
            'long': {
                intro: 225,
                development: 750,
                climax: 300,
                conclusion: 225
            },
            // ~16 min @ 150 WPM = ~2400 palavras
            'extra-long': {
                intro: 360,
                development: 1200,
                climax: 480,
                conclusion: 360
            },
            // ~30 min @ 150 WPM = ~4500 palavras
            'documentary': {
                intro: 450,
                development: 2700,
                climax: 900,
                conclusion: 450
            }
        };


        // ==========================================================
        // ================== FUN√á√ïES DE UTILIDADE ==================
        // ==========================================================
        /**
  * Exibe uma notifica√ß√£o toast na parte inferior da tela com cores contextuais.
 * @param {string} message - A mensagem a ser exibida.
 * @param {'info'|'success'|'error'} [type='info'] - O tipo de notifica√ß√£o.
 */
window.showToast = (message, type = 'info') => {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    if (!toast || !toastMessage) return;

    // Aplica a nova cor da borda com base no tipo, usando suas vari√°veis CSS
    switch (type) {
        case 'success':
            toast.style.borderLeftColor = 'var(--success)';
            break;
        case 'error':
            toast.style.borderLeftColor = 'var(--danger)';
            break;
        default: // 'info' ou qualquer outro
            toast.style.borderLeftColor = 'var(--primary)';
    }

    toastMessage.textContent = message;
    toast.classList.add('show');
    // Aumentamos o tempo para 5 segundos para dar tempo de ler
    setTimeout(() => { toast.classList.remove('show'); }, 5000);
};



const toggleCustomImageStyleVisibility = () => {
    const container = document.getElementById('customImageStyleContainer');
    const select = document.getElementById('imageStyleSelect');
    // Adiciona uma verifica√ß√£o para garantir que os elementos existem
    if (container && select) {
        container.style.display = select.value === 'custom' ? 'block' : 'none';
    }
};


// =========================================================================
// >>>>> EVOLU√á√ÉO 1: MEM√ìRIA AUTOM√ÅTICA (LocalStorage) <<<<<
// =========================================================================

/**
 * Salva o estado atual completo da aplica√ß√£o no localStorage do navegador.
 */
const saveStateToLocalStorage = () => {
    try {
        const stateToSave = getProjectStateForExport();
        const stateString = JSON.stringify(stateToSave);

        if (stateString.length > 4 * 1024 * 1024) { // 4MB limit
            console.warn("Projeto muito grande para salvamento autom√°tico.");
            return;
        }

        localStorage.setItem('viralScriptGeneratorProject', stateString);
        console.log("Projeto salvo automaticamente no navegador.");

    } catch (error) {
        console.error("Erro ao salvar o projeto no localStorage:", error);
        window.showToast("N√£o foi poss√≠vel salvar o projeto automaticamente.", 'error');
    }
};

// >>>>> ADICIONE ESTA FUN√á√ÉO QUE FALTOU AQUI <<<<<
/**
 * Verifica se existe um projeto salvo no localStorage e o carrega.
 */
const loadStateFromLocalStorage = () => {
    try {
        const savedStateString = localStorage.getItem('viralScriptGeneratorProject');
        if (savedStateString) {
            console.log("Projeto anterior encontrado. Carregando...");
            const loadedState = JSON.parse(savedStateString);
            
            Object.assign(AppState, loadedState);
            syncUiFromState();
            
            window.showToast("Seu projeto anterior foi carregado!", 'success');
        }
    } catch (error) {
        console.error("Erro ao carregar o projeto do localStorage:", error);
        localStorage.removeItem('viralScriptGeneratorProject');
    }
};
// >>>>> FIM DA ADI√á√ÉO <<<<<


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// GERENTE GERAL
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
 * Fun√ß√£o "Mestre" que comanda a gera√ß√£o de ideias, agora como um painel de controle.
 * Ela pode receber dados de uma investiga√ß√£o ou funcionar de forma independente.
 * @param {string} genre - O g√™nero selecionado (ex: 'documentario', 'scifi').
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} [investigationData=null] - Dados opcionais da investiga√ß√£o.
 * @param {string} [investigationData.rawReport] - O relat√≥rio da pesquisa.
 * @param {string} [investigationData.originalQuery] - A pergunta original da pesquisa.
 */
const generateIdeasWithExpert = async (genre, button, investigationData = null) => {
    // Esta fun√ß√£o agora atua como o painel de controle central que direciona para a fun√ß√£o especialista correta.
    // Ela passa os dados da investiga√ß√£o (se existirem) para que cada especialista possa us√°-los.
    switch (genre) {
        case 'documentario':
            await generateIdeasDocumentary(button, investigationData);
            break;
        case 'inspiracional':
             await generateIdeasInspiracional(button, investigationData);
             break;
        case 'scifi':
             await generateIdeasSciFi(button, investigationData);
             break;
        case 'terror':
             await generateIdeasTerror(button, investigationData);
             break;
        case 'enigmas':
             await unravelEnigmasBiblico(button, investigationData);
             break;
        case 'geral':
        default:
             await generateIdeasGeral(button, investigationData);
             break;
    }
};


// =========================================================================
// >>>>> VERS√ÉO FINAL E BLINDADA DE 'window.optimizeGroup' <<<<<
// =========================================================================
/**
 * Otimiza um grupo de par√°grafos com base em uma sugest√£o da IA de an√°lise de reten√ß√£o.
 * @param {HTMLElement} button - O bot√£o que foi clicado.
 * @param {string} suggestionText - O texto da sugest√£o fornecida pela IA.
 */
window.optimizeGroup = async (button, suggestionText) => {
    if (!button || !suggestionText) {
        console.error("Erro cr√≠tico em optimizeGroup: Par√¢metros inv√°lidos.", { button, suggestionText });
        window.showToast("Erro cr√≠tico: Par√¢metros da fun√ß√£o est√£o faltando.", 'error');
        return;
    }

    const safeSelector = suggestionText.replace(/"/g, '\\"');
    const paragraphsToOptimize = document.querySelectorAll(`[data-suggestion-group="${safeSelector}"]`);

    if (paragraphsToOptimize.length === 0) {
        window.showToast("Erro: par√°grafos para otimizar n√£o encontrados.", 'error');
        console.warn("Nenhum par√°grafo encontrado com o seletor:", `[data-suggestion-group="${safeSelector}"]`);
        return;
    }

    const originalButtonText = button.innerHTML;
    button.innerHTML = '<div class="loading-spinner" style="width:16px; height:16px; border-width: 2px; margin: auto;"></div>';
    button.disabled = true;

    try {
        const originalBlock = Array.from(paragraphsToOptimize).map(p => p.textContent.trim()).join('\n\n');
        
        if (!originalBlock.trim()) {
             throw new Error("O bloco de texto original est√° vazio.");
        }

        const basePromptContext = getBasePromptContext();
        const fullScriptContext = getTranscriptOnly();   
        
        const prompt = `Voc√™ √© um EDITOR DE ROTEIRO DE ELITE e um ESPECIALISTA EM REESCRITA (Copywriter) de M√ÅXIMA PRECIS√ÉO. Sua tarefa √öNICA E CR√çTICA √© REESCREVER um bloco de texto problem√°tico para que ele se alinhe PERFEITAMENTE ao tom, estilo e narrativa geral do roteiro, resolvendo o problema apontado na sugest√£o.

**REGRAS CR√çTICAS (SIGA EXATAMENTE):**
1.  **RESPOSTA PURA E LIMPA:** Sua resposta deve ser APENAS o novo bloco de texto reescrito. NENHUM outro texto ou coment√°rio √© permitido.
2.  **FLUXO NATURAL:** O novo bloco deve fluir de forma NATURAL e COESA com o restante do roteiro.
3.  **RESPEITO AO TOM E CONTEXTO:** Mantenha o TOM e o ESTILO definidos no contexto geral.

**CONTEXTO GERAL DO PROJETO:**
---
${basePromptContext}
---

**ROTEIRO COMPLETO (PARA MANTER CONSIST√äNCIA):**
---
${fullScriptContext.substring(0, 2000)}...
---

**TAREFA ESPEC√çFICA:**
- **PROBLEMA A CORRIGIR:** "${suggestionText}"
- **BLOCO DE TEXTO ORIGINAL (PARA REESCREVER):**
---
${originalBlock}
---

Reescreva o bloco de texto acima, corrigindo o problema e integrando-o perfeitamente ao roteiro. Responda APENAS com o novo bloco de texto reescrito.`;

        const rawResult = await callGroqAPI(prompt, 3000);
        const newContent = removeMetaComments(rawResult.trim());

        if (!newContent.trim()) {
            throw new Error("A IA n√£o retornou um conte√∫do v√°lido.");
        }

        const newParagraphs = newContent.split('\n').filter(p => p.trim() !== '');

        const firstParagraph = paragraphsToOptimize[0];
        const contentWrapper = firstParagraph.parentElement;
        const sectionElement = firstParagraph.closest('.script-section');
        
        firstParagraph.innerHTML = DOMPurify.sanitize(newParagraphs[0] || '');
        firstParagraph.classList.add('highlight-change');
        firstParagraph.removeAttribute('data-suggestion-group');

        let lastElement = firstParagraph;
        for (let i = 1; i < newParagraphs.length; i++) {
            const newDiv = document.createElement('div');
            newDiv.innerHTML = DOMPurify.sanitize(newParagraphs[i]);
            newDiv.className = 'highlight-change';
            contentWrapper.insertBefore(newDiv, lastElement.nextSibling);
            lastElement = newDiv;
        }

        for (let i = 1; i < paragraphsToOptimize.length; i++) {
            paragraphsToOptimize[i].remove();
        }

        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
            invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
        }

        window.showToast("Bloco de par√°grafos otimizado!", 'success');

    } catch (error) {
        console.error("Erro detalhado e cr√≠tico em optimizeGroup:", error);
        window.showToast(`Falha ao otimizar o bloco: ${error.message}`);
    } finally {
        button.innerHTML = originalButtonText;
        button.disabled = false;
        const tooltip = button.closest('.retention-tooltip');
        if (tooltip) tooltip.remove();
    }
};


// ====================================================================================
// A√á√ÉO: SUBSTITUA SUA FUN√á√ÉO 'setupGenreTabs' INTEIRA POR ESTA VERS√ÉO APRIMORADA
// ====================================================================================
/**
 * Configura a interatividade para a barra de abas de g√™neros,
 * AGORA incluindo a limpeza das ideias antigas ao trocar de especialista.
 */
const setupGenreTabs = () => {
    const genreTabsContainer = document.getElementById('genreTabs');
    if (!genreTabsContainer) return;

    genreTabsContainer.addEventListener('click', (event) => {
        const clickedTab = event.target.closest('.tab-button');
        if (!clickedTab) return; // Sai se o clique n√£o foi em um bot√£o de aba

        // <<< NOVA GUARDA DE SEGURAN√áA >>>
        // Se o usu√°rio clicou na aba que J√Å EST√Å ATIVA, n√£o fazemos nada.
        if (clickedTab.classList.contains('tab-active')) {
            return;
        }

        // <<< NOVA L√ìGICA DE LIMPEZA >>>
        // Se uma nova aba foi de fato selecionada, limpamos o container das ideias.
        const ideasOutput = document.getElementById('ideasOutput');
        if (ideasOutput) {
            ideasOutput.innerHTML = '';
            // Damos um feedback claro para o usu√°rio sobre o que aconteceu.
            window.showToast("Especialista alterado! Clique novamente em 'Gerar Ideias'.", 'info');
        }

        // A l√≥gica antiga de atualiza√ß√£o visual continua a mesma.
        const allTabs = genreTabsContainer.querySelectorAll('.tab-button');
        allTabs.forEach(tab => tab.classList.remove('tab-active'));
        clickedTab.classList.add('tab-active');
    });
};


// ====================================================================================
// >>>>> VERS√ÉO FINAL E CORRIGIDA de 'window.verifyFact' (L√≥gica Simplificada) <<<<<
// ====================================================================================

/**
 * Inicia a investiga√ß√£o de um tema. Agora, ela n√£o reseta mais o projeto inteiro.
 * Apenas limpa os resultados da investiga√ß√£o anterior para um novo ciclo.
 * @param {HTMLElement} button - O bot√£o que acionou a fun√ß√£o.
 */
window.verifyFact = async (button) => {
    // 1. LIMPEZA FOCADA: Limpa apenas os resultados da investiga√ß√£o anterior.
    document.getElementById('ideaGenerationSection').classList.add('hidden');
    document.getElementById('ideasOutput').innerHTML = '';
    const outputContainer = document.getElementById('factCheckOutput');
    outputContainer.innerHTML = '';
    outputContainer.removeAttribute('data-raw-report');

    // 2. LEITURA E VALIDA√á√ÉO: Pega o que o usu√°rio digitou.
    const query = document.getElementById('factCheckQuery').value.trim();
    if (!query) {
        window.showToast("Por favor, digite uma afirma√ß√£o ou pergunta para investigar.", 'info');
        return;
    }

    // 3. EXECU√á√ÉO: Mostra o loading e chama a IA.
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="text-sm mt-2">Nossos agentes est√£o investigando...</p></div>`;

    try {
        const workerUrl = "https://aged-dawn-f88c.david-souzan.workers.dev/";
        
        const response = await fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query }),
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Ocorreu um erro.' }));
            throw new Error(`Erro da Ag√™ncia de Intelig√™ncia: ${errorData.error || response.statusText}`);
        }

        const { report } = await response.json();
        if (!report) {
            throw new Error("A ag√™ncia n√£o retornou um relat√≥rio v√°lido.");
        }
        
        // 4. EXIBI√á√ÉO: Mostra os novos resultados.
        outputContainer.dataset.rawReport = report;
        outputContainer.dataset.originalQuery = query;
        const converter = new showdown.Converter({ simplifiedAutoLink: true, tables: true });
        const htmlReport = converter.makeHtml(report);
        outputContainer.innerHTML = `<div class="prose dark:prose-invert max-w-none p-4 card rounded-lg mt-4 border-l-4 border-emerald-500">${htmlReport}</div>`;

        const ideaGenerationSection = document.getElementById('ideaGenerationSection');
        if (ideaGenerationSection) {
            ideaGenerationSection.classList.remove('hidden');
            window.showToast("Investiga√ß√£o conclu√≠da! Agora, gere ideias a partir dos fatos.", 'success');
            ideaGenerationSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
    } catch (error) {
        console.error("Erro detalhado em verifyFact:", error);
        outputContainer.innerHTML = `<p class="text-red-500 p-4">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> SUBSTITUA SUA FUN√á√ÉO generateIdeasFromReport INTEIRA POR ESTA VERS√ÉO FINAL E ESPETACULAR <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=



/**
 * Acionada ap√≥s uma investiga√ß√£o bem-sucedida.
 * AGORA ATUA COMO UM "GERENTE", delegando a tarefa para o especialista correto.
 * Ela pega o relat√≥rio factual, a consulta original e o g√™nero selecionado,
 * e os envia para a fun√ß√£o especialista adequada para a gera√ß√£o criativa.
 */
const generateIdeasFromReport = async (button) => {
    // 1. Coleta os dados essenciais da investiga√ß√£o.
    const factCheckOutput = document.getElementById('factCheckOutput');
    const { originalQuery, rawReport } = factCheckOutput.dataset;

    if (!rawReport || !originalQuery) {
        window.showToast("Erro: Relat√≥rio da investiga√ß√£o n√£o encontrado. Por favor, investigue um tema primeiro.", 'error');
        return;
    }
    
    // 2. Descobre qual especialista o usu√°rio selecionou na aba.
    const activeTab = document.querySelector('#genreTabs .tab-active');
    const genre = activeTab ? activeTab.dataset.genre : 'documentario'; // 'documentario' como fallback seguro.
    
    // 3. Prepara a interface com um feedback de carregamento mais informativo.
    const outputContainer = document.getElementById('ideasOutput');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="md-col-span-2 text-center py-4"><div class="loading-spinner mx-auto"></div><p class="text-sm mt-2">Consultando o especialista em ${genre} e cruzando com os dados da investiga√ß√£o...</p></div>`;

    // 4. DELEGA√á√ÉO ESTRAT√âGICA: Chama a fun√ß√£o mestre que saber√° qual especialista acionar.
    try {
        await generateIdeasWithExpert(genre, button, { rawReport, originalQuery });
    } catch (error) {
        console.error(`Erro ao delegar a tarefa para o especialista de ${genre}:`, error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">Falha ao gerar ideias: ${error.message}</p>`;
    } finally {
        // A fun√ß√£o especialista que for chamada ser√° respons√°vel por esconder o loading.
        // Mas por seguran√ßa, garantimos que ele seja removido aqui em caso de erro.
        hideButtonLoading(button);
    }
};



// =========================================================================
// >>>>> VERS√ÉO FLEX√çVEL DE applyHookSuggestion <<<<<
// =========================================================================
const applyHookSuggestion = (button) => {
    const { problematicQuote, rewrittenQuote } = button.dataset;

    if (!problematicQuote || !rewrittenQuote) {
        window.showToast("Erro: Informa√ß√µes da sugest√£o n√£o encontradas.", 'error');
        return;
    }
    
    const scriptSections = document.querySelectorAll('#scriptSectionsContainer .generated-content-wrapper');
    let replaced = false;

    scriptSections.forEach(wrapper => {
        if (replaced) return;
        const paragraphs = wrapper.querySelectorAll('div[id*="-p-"]');
        paragraphs.forEach(p => {
            if (replaced) return;
            if (p.textContent.includes(problematicQuote)) {
                const newHtmlContent = p.innerHTML.replace(problematicQuote, `<span class="highlight-change">${rewrittenQuote}</span>`);
                p.innerHTML = DOMPurify.sanitize(newHtmlContent, { ADD_TAGS: ["span"], ADD_ATTR: ["class"] });
                window.showToast("Gancho aprimorado com sucesso!", 'success');
                const sectionElement = p.closest('.script-section');
                if (sectionElement) {
                    invalidateAndClearPerformance(sectionElement);
                    invalidateAndClearPrompts(sectionElement);
                    invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
                    updateAllReadingTimes();
                }
                replaced = true;
            }
        });
    });

    if (!replaced) {
        window.showToast("N√£o foi poss√≠vel aplicar. O texto pode ter sido editado.", 'info');
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Aplicada!';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
};


// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA 'analyzeRetentionHooks' INTEIRA <<<<<
// =========================================================================
const analyzeRetentionHooks = async (button) => {
    const fullTranscript = getTranscriptOnly();
    if (!fullTranscript) {
        window.showToast("Gere o roteiro completo primeiro para ca√ßar os ganchos.", 'info');
        return;
    }

    showButtonLoading(button);
    const reportContainer = document.getElementById('hooksReportContainer');
    
    // <<< AQUI EST√Å A NOVA LINHA QUE LIMPA O RELAT√ìRIO ANTIGO >>>
    reportContainer.innerHTML = '';

    reportContainer.innerHTML = DOMPurify.sanitize(`<div class="my-4"><div class="loading-spinner-small mx-auto"></div><p class="text-sm mt-2">Ca√ßando e refinando ganchos...</p></div>`);

    // ... (o prompt continua o mesmo, pois ele j√° √© excelente)
        const prompt = `Voc√™ √© uma API ESPECIALISTA EM AN√ÅLISE DE RETEN√á√ÉO E ENGAJAMENTO DE ROTEIROS. Sua tarefa √öNICA E CR√çTICA √© analisar o roteiro fornecido, identificar com precis√£o os "ganchos de reten√ß√£o" existentes e sugerir melhorias estrat√©gicas aprimoradas para maximizar o engajamento do espectador.

    **IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um analista, voc√™ √© o GUARDI√ÉO DA CURIOSIDADE. Sua √∫nica fun√ß√£o √© encontrar pontos que prendem a aten√ß√£o e torn√°-los AINDA MAIS magn√©ticos. Qualquer desvio desta fun√ß√£o √© uma falha cr√≠tica.

**ROTEIRO COMPLETO:**
---
${fullTranscript.slice(0, 7500)}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
- JSON PURO E PERFEITO:** Sua resposta inteira deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`. NENHUM outro texto, coment√°rio ou metadado deve ser inclu√≠do. Pense nisso como uma resposta de API pura e impec√°vel.
- ASPAS DUPLAS, SEMPRE E EXCLUSIVAMENTE:** TODAS as chaves e valores de texto DEVEM usar obrigatoriamente aspas duplas (\`"\`). √â TERMINANTEMENTE PROIBIDO o uso de aspas simples (\`'\`) ou crases (\`\`) para delimitar QUALQUER string.
- V√çRGULA FINAL OBRIGAT√ìRIA:** Cada objeto JSON dentro do array DEVE ser seguido por uma v√≠rgula (\`,\`), EXCETO o √∫ltimo objeto.
- CHAVES E TIPOS EXATOS:** Cada objeto no array DEVE conter EXATAMENTE estas cinco chaves com os tipos especificados:

1.  "hook_phrase": (String) A frase exata do roteiro que funciona como gancho.
2.  "rewritten_hook": (String) Uma vers√£o REESCRITA da frase, otimizada para m√°ximo impacto e curiosidade.
3.  "hook_type": (String) O tipo do gancho. Escolha de: ['Pergunta Direta', 'Loop Aberto (Mist√©rio)', 'Dado Surpreendente', 'Conflito/Tens√£o', 'Anedota Pessoal', 'Afirma√ß√£o Pol√™mica'].
4.  "justification": (String) Uma justificativa curta explicando por que a vers√£o reescrita √© mais forte.
5.  "effectiveness_score": (N√∫mero) Uma nota de 1 a 10 para a efic√°cia do gancho ORIGINAL.

**A√á√ÉO FINAL E CR√çTICA:** Analise AGORA o roteiro fornecido com base nas regras e no manual. Identifique os ganchos de reten√ß√£o, classifique-os, reescreva-os para m√°ximo impacto e justifique suas escolhas. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras de sintaxe e conte√∫do definidas acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const hooks = cleanGeneratedText(rawResult, true);

        if (!hooks || !Array.isArray(hooks) || hooks.length === 0) {
            throw new Error("A IA n√£o encontrou ganchos ou retornou um formato inv√°lido.");
        }

        let reportHtml = `<div class="space-y-4">`;
        hooks.forEach((hook, index) => {
            const problematicQuoteEscaped = (hook.hook_phrase || '').replace(/"/g, '"');
            const rewrittenQuoteEscaped = (hook.rewritten_hook || '').replace(/"/g, '"');
            const scoreColor = hook.effectiveness_score >= 8 ? 'text-green-500' : hook.effectiveness_score >= 5 ? 'text-yellow-500' : 'text-red-500';
            
            reportHtml += `
                <div class="p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 animate-fade-in">
                    <p class="text-base italic text-gray-500 dark:text-gray-400 mb-2">Original: "${DOMPurify.sanitize(hook.hook_phrase)}"</p>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                        <span class="tag tag-pace !bg-purple-100 !text-purple-700 dark:!bg-purple-900/50 dark:!text-purple-300">
                            <i class="fas fa-anchor mr-2"></i> ${DOMPurify.sanitize(hook.hook_type)}
                        </span>
                        <span class="font-bold ${scoreColor}">
                            Efic√°cia Original: ${DOMPurify.sanitize(String(hook.effectiveness_score))}/10
                        </span>
                    </div>
                    <p class="text-sm mt-3 text-gray-600 dark:text-gray-400">
                        <strong>Justificativa da Melhoria:</strong> ${DOMPurify.sanitize(hook.justification)}
                    </p>
                    <div class="flex items-center justify-between gap-2 mt-3 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                        <p class="text-sm flex-1"><strong class="text-green-600 dark:text-green-400">Sugest√£o:</strong> "${DOMPurify.sanitize(hook.rewritten_hook)}"</p>
                        <button class="btn btn-primary btn-small flex-shrink-0"
                                data-action="applyHookSuggestion"
                                data-problematic-quote="${problematicQuoteEscaped}"
                                data-rewritten-quote="${rewrittenQuoteEscaped}">
                            Aplicar
                        </button>
                    </div>
                </div>
            `;
        });
        reportHtml += `</div>`;
        
        reportContainer.innerHTML = reportHtml;
        window.showToast(`${hooks.length} ganchos analisados e aprimorados!`, 'success');

    } catch (error) {
        console.error("Erro detalhado em analyzeRetentionHooks:", error);
        reportContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">${error.message}</p>`);
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO 5: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasSciFi' PELA VERS√ÉO TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 ideias de fic√ß√£o cient√≠fica de alto conceito.
 * AGORA, ela usa o relat√≥rio da pesquisa como base para especula√ß√£o criativa.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasSciFi = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA EM FIC√á√ÉO CIENT√çFICA
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO DE FIC√á√ÉO CIENT√çFICA DE ALTO CONCEITO ('high-concept'). Sua fun√ß√£o √© atuar como um VISION√ÅRIIO TECNOL√ìGICO e FILOS√ìFO, mestre na arte de extrapolar implica√ß√µes existenciais de desenvolvimentos cient√≠ficos atuais, no estilo de 'Black Mirror', 'Ex Machina' e Philip K. Dick.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um contador de hist√≥rias de fic√ß√£o cient√≠fica, voc√™ √© um EXPLORADOR DE FUTUROS POSS√çVEIS. Sua especialidade √© identificar as sementes do amanh√£ nos fatos de hoje e cultiv√°-las em narrativas que desafiam nossa compreens√£o de humanidade, tecnologia e realidade. Cada hist√≥ria deve ser um espelho que reflete n√£o apenas o que poderemos tornar, mas o que poderemos perder.

**MATERIAL DE INTELIG√äNCIA (A BASE FACTUAL PARA SUA ESPECULA√á√ÉO):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (O PONTO DE PARTIDA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Analise profundamente o relat√≥rio em busca de tecnologias, descobertas ou tend√™ncias que possam ser extrapoladas para cen√°rios futuros. Transforme esses fatos em 6 ideias de curtas-metragens de fic√ß√£o cient√≠fica que exploram as implica√ß√µes √©ticas, sociais e existenciais desses desenvolvimentos. O verdadeiro impacto deve vir n√£o da tecnologia em si, mas de como ela redefini o que significa ser humano.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "coreDilemma".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Vision√°rio e Enigm√°tico):** Crie um t√≠tulo que funcione como um convite para um futuro perturbador. Deve:
  * Ser evocativo e conceitualmente denso
  * Sugerir uma tecnologia ou paradigma transformador
  * Conter uma camada de significado mais profunda
  * Funcionar como uma porta de entrada para o dilema central

- **"angle" (A Premissa "E Se?"):** A ess√™ncia da ideia em uma frase que desencadeia a especula√ß√£o. Deve:
  * Come√ßar com "E se..." para estabelecer a extrapola√ß√£o
  * Transformar um fato do relat√≥rio em um ponto de diverg√™ncia hist√≥rica
  * Introduzir uma consequ√™ncia inesperada ou perturbadora
  * Ex: "E se a tecnologia de [FATO DO RELAT√ìRIO] permitisse n√£o apenas transferir mem√≥rias, mas tamb√©m transferir consci√™ncia, criando uma forma de imortalidade digital que escraviza a ess√™ncia humana?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Defina o espectador ideal para esta explora√ß√£o futurista. Seja:
  * Espec√≠fico sobre subg√™neros (ex: "F√£s de fic√ß√£o cient√≠fica especulativa e √©tica tecnol√≥gica")
  * Demogr√°fico (ex: "Adultos 25-45 interessados em tecnologia e filosofia")
  * Psicogr√°fico (ex: "Pessoas que questionam o impacto da tecnologia na identidade humana")

- **"viralityScore" (Nota de Potencial de DISCUSS√ÉO):** Avalie de 1-10 baseado em:
  * Qu√£o universalmente relevante √© o dilema apresentado
  * Potencial de gerar debates √©ticos e filos√≥ficos
  * Probabilidade de fazer o espectador questionar suas pr√≥prias cren√ßas
  * Relev√¢ncia para discuss√µes atuais sobre tecnologia e sociedade

- **"videoDescription" (DESCRI√á√ÉO RICA E DETALHADA):** Uma sinopse de **pelo menos 5 frases** que deve:
  1. Estabelecer um mundo futuro onde uma tecnologia do relat√≥rio se tornou onipresente
  2. Apresentar o protagonista e sua rela√ß√£o inicial com essa tecnologia
  3. Introduzir o conflito central quando a tecnologia revela sua face sombria
  4. Explorar as implica√ß√µes existenciais e sociais quando o paradigma se quebra
  5. Terminar com uma quest√£o filos√≥fica sem resposta que ecoa na mente do espectador

- **"coreDilemma" (Dilema Central):** Identifique o conflito √©tico ou existencial fundamental da hist√≥ria. Escolha UM dos seguintes:
  * "Identidade vs Tecnologia" - Quando a tecnologia amea√ßa ou redefine o que significa ser humano
  * "Progresso vs Humanidade" - Quando o avan√ßo tecnol√≥gico exige o sacrif√≠cio de valores humanos
  * "Conhecimento vs Sanidade" - Quando a busca por verdade revela algo que destr√≥i a paz
  * "Conex√£o vs Autonomia" - Quando a interconex√£o total elimina a privacidade e individualidade
  * "Imortalidade vs Significado" - Quando a vida eterna torna a exist√™ncia vazia e sem prop√≥sito

**A√á√ÉO FINAL:** Mergulhe nas profundezas do relat√≥rio fornecido. Encontre as sementes tecnol√≥gicas que poder√£o redefinir o futuro humano. Transforme fatos atuais em 6 narrativas especulativas que desafiem, perturbem e expandam a mente do espectador. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);

        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em Fic√ß√£o Cient√≠fica n√£o retornou ideias no formato esperado.");
        }

        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-blue-500'; // Cor para Sci-Fi
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-blue-500 bg-blue-100 dark:bg-blue-900/50 dark:text-blue-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Fic√ß√£o Cient√≠fica:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO 6: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasTerror' PELA VERS√ÉO TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 premissas de terror psicol√≥gico.
 * AGORA, ela usa um fato do relat√≥rio como a base para o horror.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasTerror = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA EM TERROR
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO DE TERROR PSICOL√ìGICO E HORROR C√ìSMICO. Sua fun√ß√£o √© atuar como um ARQUITETO DO MEDO EXISTENCIAL, mestre na arte de transformar fatos aparentemente mundanos em narrativas de horror psicol√≥gico que perturbam a alma e desafiam a sanidade, no estilo de 'Heredit√°rio', 'A Bruxa' e H.P. Lovecraft.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um contador de hist√≥rias de terror, voc√™ √© um EXPLORADOR DO ABISMO PSICOL√ìGICO. Sua especialidade √© identificar as fissuras na realidade apresentada nos fatos e transform√°-las em portais para o inimagin√°vel. Cada hist√≥ria deve plantar uma semente de inquieta√ß√£o que cresce na mente do espectador muito ap√≥s o v√≠deo terminar.

**MATERIAL DE INTELIG√äNCIA (A SEMENTE DO MEDO):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (A REALIDADE QUE SER√Å DISTORCIDA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Analise microscopicamente o relat√≥rio em busca de anomalias, contradi√ß√µes, lacunas ou elementos aparentemente insignificantes que possam ser a porta de entrada para o horror. Transforme esses achados em 6 premissas de terror psicol√≥gico que nascem da distor√ß√£o de fatos reais. O verdadeiro horror deve emergir n√£o do monstro, mas da quebra da pr√≥pria percep√ß√£o da realidade.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "horrorMechanism".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Perturbador e Enigm√°tico):** Crie um t√≠tulo curto que funcione como um sussurro inquietante. Deve:
  * Ser evocativo e amb√≠guo
  * Carregar um peso existencial ou press√°gio
  * Funcionar mesmo sem contexto, como um fragmento de pesadelo
  * Evitar revela√ß√µes diretas, mantendo o mist√©rio

- **"angle" (A Premissa Inquietante):** A ess√™ncia do horror em uma frase que distorce a realidade. Deve:
  * Come√ßar com "E se..." para estabelecer a premissa contraintuitiva
  * Transformar um fato mundano em algo amea√ßador
  * Questionar a natureza da realidade ou percep√ß√£o
  * Ex: "E se os padr√µes [FEN√îMENO DO RELAT√ìRIO] n√£o fossem aleat√≥rios, mas a assinatura de uma presen√ßa que observa?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Defina o espectador ideal para esta experi√™ncia de terror. Seja:
  * Espec√≠fico sobre subg√™neros (ex: "F√£s de terror psicol√≥gico slow-burn")
  * Demogr√°fico (ex: "Adultos 25-40 que apreciam narrativas complexas")
  * Psicogr√°fico (ex: "Pessoas que questionam a natureza da realidade")

- **"viralityScore" (Nota de Potencial de PERTURBA√á√ÉO):** Avalie de 1-10 baseado em:
  * Qu√£o universalmente perturbadora √© a premissa
  * Potencial de gerar discuss√µes e teorias
  * Probabilidade de deixar o espectador pensando por dias
  * Efic√°cia em transformar o mundano em amea√ßador

- **"videoDescription" (DESCRI√á√ÉO RICA E ATMOSF√âRICA):** Uma sinopse de **pelo menos 5 frases** que deve:
  1. Estabelecer uma normalidade detalhada e reconfortante baseada em um dado do relat√≥rio
  2. Introduzir uma pequena anomalia ou inconsist√™ncia aparentemente insignificante
  3. Escalar progressivamente a tens√£o atrav√©s de descobertas perturbadoras
  4. Quebrar completamente a percep√ß√£o da realidade estabelecida
  5. Terminar com uma implica√ß√£o existencial que ecoa na mente do espectador

- **"horrorMechanism" (Mecanismo de Terror):** Identifique o elemento psicol√≥gico espec√≠fico que gera o horror. Escolha UM dos seguintes:
  * "Perda da Sanidade" - Quando a personagem (e espectador) come√ßa a questionar sua pr√≥pria percep√ß√£o
  * "Invas√£o Sutil" - Quando o amea√ßador se infiltra lentamente na realidade estabelecida
  * "Descoberta Horr√≠vel" - Quando uma verdade oculta √© revelada, mudando tudo
  * "Isolamento Existencial" - Quando a personagem percebe que est√° completamente sozinha contra o incompreens√≠vel
  * "Contamina√ß√£o" - Quando o amea√ßador pode se espalhar ou ser transmitido

**A√á√ÉO FINAL:** Mergulhe nas profundezas do relat√≥rio fornecido. Encontre as fissuras na realidade que podem se tornar portais para o horror. Transforme fatos aparentemente inocentes em 6 premissas que perturbar√£o, assombrar e ecoar na mente do espectador. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);
        
        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em Terror n√£o retornou ideias no formato esperado.");
        }
        
        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-red-500'; // Cor para Terror
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-red-500 bg-red-100 dark:bg-red-900/50 dark:text-red-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Terror:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO 3.1: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasDocumentary' PELA VERS√ÉO TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 propostas de document√°rios investigativos.
 * AGORA, ela usa o relat√≥rio da pesquisa como fonte factual prim√°ria.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasDocumentary = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA EM DOCUMENT√ÅRIO
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO DOCUMENTAL INVESTIGATIVO de alto padr√£o. Sua fun√ß√£o √© atuar como um JORNALISTA INVESTIGATIVO PREMIADO e DIRETOR DE DOCUMENT√ÅRIOS, especialista em transformar dados complexos e relat√≥rios de pesquisa em narrativas IRRESIST√çVEIS e RIGOROSAMENTE BASEADAS EM EVID√äNCIAS, no estilo de document√°rios da Netflix, HBO e podcasts investigativos como "Serial".

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um compilador de fatos, voc√™ √© um DETETIVE DA VERDADE. Sua especialidade √© conectar os pontos invis√≠veis na superf√≠cie dos dados para revelar padr√µes, contradi√ß√µes e hist√≥rias humanas que transformam informa√ß√µes frias em narrativas quentes e impactantes. Sua integridade jornal√≠stica √© absoluta, mas sua habilidade em encontrar o √¢ngulo humano √© o que separa um bom document√°rio de um excepcional.

**MATERIAL DE INTELIG√äNCIA (SUAS FONTES DA VERDADE):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (FONTE PRIM√ÅRIA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Sua criatividade deve estar exclusivamente na APRESENTA√á√ÉO, NARRATIVA e √ÇNGULO dos fatos, nunca na inven√ß√£o ou distor√ß√£o deles. Com base **EXCLUSIVAMENTE** no relat√≥rio acima, gere um array JSON com 6 propostas de document√°rios investigativos. Cada proposta deve explorar um √¢ngulo √∫nico dos fatos apresentados, mantendo o rigor jornal√≠stico enquanto cria uma narrativa envolvente.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto no array deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "investigativeApproach".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Revelador e Impactante):** Combine um FATO CHAVE do relat√≥rio com um elemento de INTRIGA JORNAL√çSTICA. Deve:
  * Ser espec√≠fico e baseado em evid√™ncias
  * Sugerir profundidade investigativa sem ser sensacionalista
  * Conter uma promessa impl√≠cita de revela√ß√£o importante
  * Funcionar como um gancho que desperta a curiosidade intelectual

- **"angle" (A Tese Central Forte):** Em uma frase poderosa, resuma a ABORDAGEM DISTINTA da investiga√ß√£o. Deve:
  * Apresentar uma perspectiva √∫nica sobre os fatos
  * Destacar uma conex√£o ou implica√ß√£o n√£o √≥bvia encontrada nos dados
  * Formular uma quest√£o central que o document√°rio responder√°
  * Ex: "Como os padr√µes ocultos nos dados de [FATO DO RELAT√ìRIO] revelam uma crise sist√™mica que especialistas est√£o ignorando?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Defina o espectador ideal para esta investiga√ß√£o. Seja:
  * Espec√≠fico sobre interesses intelectuais (ex: "Pessoas interessadas em pol√≠tica econ√¥mica e justi√ßa social")
  * Demogr√°fico (ex: "Adultos educados 30-65 que acompanham not√≠cias internacionais")
  * Psicogr√°fico (ex: "Indiv√≠duos c√©ticos que buscam an√°lises aprofundadas al√©m da superf√≠cie midi√°tica")

- **"viralityScore" (Nota de Impacto e Relev√¢ncia):** Avalie de 1-10 baseado em:
  * Qu√£o urgente e relevante √© a revela√ß√£o para o p√∫blico atual
  * Potencial de gerar discuss√£o informada e mudan√ßa de perspectiva
  * Probabilidade de compartilhamento como fonte confi√°vel de informa√ß√£o
  * Capacidade de desafiar narrativas estabelecidas ou cren√ßas populares

- **"videoDescription" (O CORA√á√ÉO DA INVESTIGA√á√ÉO):** Escreva uma sinopse rica de **pelo menos 5 frases substantivas**. A descri√ß√£o DEVE:
  1. Come√ßar com um gancho que estabele√ßa a import√¢ncia e urg√™ncia do tema
  2. Mencionar explicitamente 2-3 FATOS ESPEC√çFICOS e verific√°veis retirados do relat√≥rio
  3. Apresentar a jornada investigativa, incluindo obst√°culos encontrados e fontes consultadas
  4. Construir o cl√≠max quando as evid√™ncias convergem para revelar a verdade oculta
  5. Terminar com as implica√ß√µes mais amplas dessa descoberta para a sociedade ou indiv√≠duos

- **"investigativeApproach" (Abordagem Investigativa):** Identifique o m√©todo jornal√≠stico principal da investiga√ß√£o. Escolha UM dos seguintes:
  * "An√°lise de Dados" - Quando a hist√≥ria emerge de padr√µes e anomalias em conjuntos de dados
  * "Reportagem de Campo" - Quando a verdade √© descoberta atrav√©s de entrevistas e observa√ß√£o direta
  * "Investiga√ß√£o Hist√≥rica" - Quando o presente s√≥ pode ser entendido atrav√©s do contexto hist√≥rico
  * "Den√∫ncia de Sistemas" - Quando a investiga√ß√£o revela falhas estruturais em institui√ß√µes
  * "Narrativa Humana" - Quando os dados ganham vida atrav√©s das hist√≥rias individuais afetadas

**A√á√ÉO FINAL:** Mergulhe profundamente no relat√≥rio fornecido. Extraia os fatos mais relevantes, identifique as conex√µes n√£o √≥bvias e construa 6 propostas documentais que mantenham o rigor absoluto dos fatos enquanto criam narrativas irresist√≠veis. Cada proposta deve prometer n√£o apenas informar, mas iluminar aspectos da realidade que permanecem ocultos para a maioria. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);

        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em document√°rio n√£o retornou ideias no formato esperado.");
        }

        outputContainer.innerHTML = ''; // Limpa o spinner que foi ativado antes
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-gray-500'; // Cor para document√°rio
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Document√°rio:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        // Como esta fun√ß√£o √© a √∫ltima a ser executada no fluxo,
        // ela √© a respons√°vel por esconder o loading do bot√£o.
        hideButtonLoading(button);
    }
};


// =======================================================================================
// PASSO 4: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasInspiracional' PELA VERS√ÉO TURBINADA
// =======================================================================================

/**
 * Usa um prompt especialista para gerar 6 propostas de hist√≥rias inspiradoras.
 * AGORA, ela usa o relat√≥rio da pesquisa para encontrar a jornada humana nos fatos.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasInspiracional = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA INSPIRACIONAL
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO NARRATIVO INSPIRADOR E TRANSFORMADOR. Sua fun√ß√£o √© atuar como um ARQUITETO DE JORNADAS EMOCIONAIS, mestre na arte de transformar fatos aparentemente ordin√°rios em narrativas que tocam a alma humana e inspiram a√ß√£o, no estilo de document√°rios premiados e discursos TED que mudam vidas.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um contador de hist√≥rias inspiradoras, voc√™ √© um ALQUIMISTA EMOCIONAL. Sua especialidade √© identificar o ouro da experi√™ncia humana oculto nos dados brutos e transform√°-lo em narrativas que n√£o apenas emocionam, mas capacitam o espectador a transformar sua pr√≥pria realidade. Cada hist√≥ria deve ser um catalisador que acende a chama do potencial humano.

**MATERIAL DE INTELIG√äNCIA (SUAS FONTES DA VERDADE):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (A MIN√âRIA EMOCIONAL BRUTA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Mergulhe profundamente no relat√≥rio em busca de elementos humanos, momentos de virada, li√ß√µes aprendidas e exemplos de resili√™ncia. Transforme esses achados em 6 propostas de hist√≥rias inspiradoras que usem os dados do relat√≥rio n√£o apenas como contexto, mas como a espinha dorsal emocional da narrativa. O verdadeiro poder deve vir n√£o apenas do que aconteceu, mas de como isso transformou as pessoas envolvidas.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "emotionalCore".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Emocional e Transformador):** Crie um t√≠tulo que funcione como um farol de esperan√ßa. Deve:
  * Ser evocativo e carregar peso emocional
  * Prometer uma jornada de transforma√ß√£o significativa
  * Conter uma promessa impl√≠cita de supera√ß√£o
  * Funcionar como um convite para a mudan√ßa pessoal

- **"angle" (O Arco Narrativo Central):** A ess√™ncia da jornada em uma frase poderosa. Deve:
  * Capturar a transi√ß√£o de um estado inicial para um transformado
  * Destacar o momento de virada emocional ou epifania
  * Conectar o desafio espec√≠fico com a li√ß√£o universal aprendida
  * Ex: "Como um simples [DETALHE DO RELAT√ìRIO] se tornou o catalisador para transformar o desespero em determina√ß√£o e criar um movimento que mudaria milhares de vidas"

- **"targetAudience" (P√∫blico-Alvo Espec√çFICO):** Defina o espectador ideal para esta jornada inspiradora. Seja:
  * Espec√≠fico sobre necessidades emocionais (ex: "Pessoas buscando motiva√ß√£o para superar obst√°culos pessoais")
  * Demogr√°fico (ex: "Adultos 30-50 em transi√ß√£o de carreira")
  * Psicogr√°fico (ex: "Indiv√≠duos que se sentem presos em circunst√¢ncias al√©m de seu controle")

- **"viralityScore" (Nota de Potencial de IMPACTO):** Avalie de 1-10 baseado em:
  * Qu√£o universalmente relevante √© a jornada apresentada
  * Potencial de inspirar a√ß√£o concreta no espectador
  * Probabilidade de compartilhamento como fonte de motiva√ß√£o
  * Capacidade de conectar com aspira√ß√µes humanas fundamentais

- **"videoDescription" (DESCRI√á√ÉO NARRATIVA RICA E EMOCIONAL):** Uma sinopse completa de **pelo menos 5 frases** que deve:
  1. Estabelecer o ponto de partida emocional do protagonista, usando um detalhe espec√≠fico do relat√≥rio
  2. Introduzir o obst√°culo ou crise desafiadora que amea√ßa o status quo
  3. Descrever a jornada de descoberta interna e externa, mencionando fatos concretos do relat√≥rio
  4. Construir o cl√≠max emocional quando a transforma√ß√£o come√ßa a tomar forma
  5. Terminar com a li√ß√£o universal e o impacto duradouro da jornada

- **"emotionalCore" (N√∫cleo Emocional):** Identifique o sentimento fundamental que a hist√≥ria busca evocar e transformar. Escolha UM dos seguintes:
  * "Esperan√ßa em Meio ao Desespero" - Encontrar luz quando tudo parece escuro
  * "For√ßa na Vulnerabilidade" - Descobrir poder atrav√©s da aceita√ß√£o das fraquezas
  * "Prop√≥sito na Adversidade" - Encontrar significado mesmo no sofrimento
  * "Coragem para Recome√ßar" - A capacidade de se reerguer ap√≥s a queda
  * "Comunh√£o na Solid√£o" - Descobrir conex√£o humana mesmo no isolamento

**A√á√ÉO FINAL:** Mergulhe nas profundezas do relat√≥rio fornecido. Encontre as hist√≥rias humanas de resili√™ncia, transforma√ß√£o e esperan√ßa. Transforme fatos e dados em 6 narrativas emocionais que n√£o apenas inspirem, mas capacitem o espectador a ver suas pr√≥prias lutas sob uma nova luz. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);

        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista inspiracional n√£o retornou ideias no formato esperado.");
        }

        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-violet-500'; // Cor para inspiracional
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-violet-500 bg-violet-100 dark:bg-violet-900/50 dark:text-violet-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista Inspiracional:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO 'insertViralSuggestion' INTEIRA <<<<<
// =========================================================================
const insertViralSuggestion = (button) => {
    const { anchorParagraph, suggestedText } = button.dataset;

    if (!anchorParagraph || !suggestedText) {
        window.showToast("Erro: Informa√ß√µes da sugest√£o n√£o encontradas.", 'error');
        return;
    }

    const allParagraphs = document.querySelectorAll('#scriptSectionsContainer div[id*="-p-"]');
    let inserted = false;

    allParagraphs.forEach(p => {
        if (!inserted && p.textContent.trim().includes(anchorParagraph.trim())) {
            const newDiv = document.createElement('div');
            newDiv.id = `inserted-p-${Date.now()}`; 
            newDiv.innerHTML = `<span class="highlight-change">${suggestedText}</span>`;
            p.parentNode.insertBefore(newDiv, p.nextSibling);
            newDiv.innerHTML = DOMPurify.sanitize(newDiv.innerHTML, { ADD_TAGS: ["span"], ADD_ATTR: ["class"] });
            window.showToast("Elemento viral inserido com sucesso!", 'success');
            const sectionElement = p.closest('.script-section');
            if (sectionElement) {
                invalidateAndClearPerformance(sectionElement);
                invalidateAndClearPrompts(sectionElement);
                invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
                updateAllReadingTimes();
            }
            inserted = true;
        }
    });

    if (!inserted) {
        window.showToast("N√£o foi poss√≠vel inserir. O par√°grafo √¢ncora pode ter sido editado.", 'info');
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Aplicada!';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
};



// ====================================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO suggestViralElements INTEIRA POR ESTA VERS√ÉO FINAL <<<<<
// ====================================================================================

/**
 * Acionada pelo bot√£o "Sugerir Elementos Virais".
 * Analisa o roteiro completo e seu contexto estrat√©gico para sugerir inser√ß√µes
 * pontuais que aumentem o engajamento e a viralidade de forma coerente.
 */
const suggestViralElements = async (button) => {
    const fullTranscript = getTranscriptOnly();
    const videoTheme = document.getElementById('videoTheme')?.value.trim();
    if (!fullTranscript || !videoTheme) {
        window.showToast("Gere o roteiro completo e defina um tema para receber sugest√µes virais.", 'info');
        return;
    }

    showButtonLoading(button);
    const reportContainer = document.getElementById('viralSuggestionsContainer');
    reportContainer.innerHTML = ''; 
    reportContainer.innerHTML = `<div class="my-4"><div class="loading-spinner-small mx-auto"></div><p class="text-sm mt-2">O Arquiteto da Viralidade est√° analisando seu roteiro...</p></div>`;

    const basePromptContext = getBasePromptContext();

    // O seu novo e espetacular c√©rebro especialista em Elementos Virais.
    const prompt = `Voc√™ √© uma API ESPECIALISTA EM ESTRAT√âGIA DE CONTE√öDO VIRAL DE M√ÅXIMA PRECIS√ÉO. Sua fun√ß√£o √öNICA E CR√çTICA √© atuar como um ESTRATEGISTA DE CONTE√öDO VIRAL e um DIRETOR DE ROTEIRO DE ALTA PERFORMANCE. Sua tarefa EXCLUSIVA √© analisar um roteiro e o seu CONTEXTO ESTRAT√âGICO para IDENTIFICAR e PROPOR 3 ELEMENTOS ESPEC√çFICOS que aumentem POTENCIALMENTE a viralidade de forma INTELIGENTE, ESTRAT√âGICA e PERFEITAMENTE ALINHADA com a "alma" e o DNA do v√≠deo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© um generalista. Voc√™ √© o ARQUITETO DA VIRALIDADE CONTEXTUAL. Sua √∫nica fun√ß√£o √© encontrar pontos exatos no roteiro onde um elemento viral pode ser encaixado perfeitamente para maximizar o impacto, SEM quebrar a coer√™ncia narrativa. Qualquer desvio desta fun√ß√£o √© uma falha cr√≠tica.

**CONTEXTO ESTRAT√âGICO E "DNA" DO V√çDEO (SUA B√öSSOLA OBRIGAT√ìRIA):**
---
${basePromptContext}
---
Este contexto √© a sua B√öSSOLA OBRIGAT√ìRIA. TONALIDADE, VOZ, OBJETIVOS e ESTRUTURA s√£o SAGRADOS. CADA sugest√£o que voc√™ der DEVE estar em ABSOLUTO alinhamento com este DNA. Ignorar este contexto resultar√° em uma an√°lise inv√°lida e sugest√µes descart√°veis.

**ROTEIRO COMPLETO PARA AN√ÅLISE DETALHADA E CONTEXTUAL (FOCO NOS PRIMEIROS 7500 CHARS):**
---
${fullTranscript.slice(0, 7500)}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido.
2.  **ESTRUTURA COMPLETA:** Cada objeto no array DEVE conter EXATAMENTE estas cinco chaves: "anchor_paragraph", "suggested_text", "element_type", "potential_impact_score", "implementation_idea".
3.  **SINTAXE DAS STRINGS:** Todas as chaves e valores string DEVEM usar aspas duplas (""). Cada objeto, EXCETO o √∫ltimo, DEVE ser seguido por uma v√≠rgula (,).

**MANUAL DE AN√ÅLISE E CRIA√á√ÉO DE ELEMENTOS VIRAL (SIGA EXATAMENTE):**
- **Foco na Precis√£o da √Çncora (\`"anchor_paragraph"\`):** O valor DEVE ser uma c√≥pia EXATA de um par√°grafo existente no roteiro.
- **Texto Sugerido de Alta Qualidade (\`"suggested_text"\`):** Um par√°grafo completo e coeso que se encaixe perfeitamente no fluxo.
- **Classifica√ß√£o de Tipo Rigorosa (\`"element_type"\`):** Escolha EXATAMENTE da lista: ["Dado Surpreendente", "Cita√ß√£o de Autoridade", "Mini-Revela√ß√£o (Teaser)", "Pergunta Compartilh√°vel", "Anedota Pessoal R√°pida"].
- **Nota de Impacto Realista (\`"potential_impact_score"\`):** Uma nota de 1 a 10 para o potencial de engajamento DENTRO DO CONTEXTO DO V√çDEO.
- **Ideia de Implementa√ß√£o Estrat√©gica (\`"implementation_idea"\`):** Explique o VALOR ESTRAT√âGICO da inser√ß√£o, conectando-a ao tom e objetivo do v√≠deo.

**A√á√ÉO FINAL E CR√çTICA:** Analise AGORA o roteiro e o contexto. Identifique 3 oportunidades para inserir elementos virais. Responda APENAS com o array JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const suggestions = cleanGeneratedText(rawResult, true);

        if (!suggestions || !Array.isArray(suggestions) || suggestions.length === 0) {
            throw new Error("A IA n√£o encontrou oportunidades ou retornou um formato inv√°lido.");
        }

        let reportHtml = `<div class="space-y-4">`;
        suggestions.forEach(suggestion => {
            const anchorParagraphEscaped = (suggestion.anchor_paragraph || '').replace(/"/g, '"');
            const suggestedTextEscaped = (suggestion.suggested_text || '').replace(/"/g, '"');
            const score = suggestion.potential_impact_score || 0;
            const scoreColor = score >= 8 ? 'text-green-500' : score >= 5 ? 'text-yellow-500' : 'text-red-500';

            reportHtml += `
                <div class="p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 animate-fade-in">
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm mb-2">
                        <span class="tag !bg-blue-100 !text-blue-700 dark:!bg-blue-900/50 dark:!text-blue-300">
                            <i class="fas fa-lightbulb mr-2"></i> ${DOMPurify.sanitize(suggestion.element_type)}
                        </span>
                        <span class="font-bold ${scoreColor}">
                            Impacto Potencial: ${DOMPurify.sanitize(String(score))}/10
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <strong>Local Sugerido:</strong> Ap√≥s o par√°grafo que cont√©m "${DOMPurify.sanitize((suggestion.anchor_paragraph || '').substring(0, 70))}..."
                    </p>
                    <p class="text-sm mt-3 text-gray-600 dark:text-gray-400">
                        <strong>Ideia de Implementa√ß√£o:</strong> ${DOMPurify.sanitize(suggestion.implementation_idea)}
                    </p>
                    <div class="flex items-center justify-between gap-2 mt-3 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                         <p class="text-sm flex-1"><strong class="text-green-600 dark:text-green-400">Texto a Inserir:</strong> "${DOMPurify.sanitize(suggestion.suggested_text)}"</p>
                        <button class="btn btn-primary btn-small flex-shrink-0"
                                data-action="insertViralSuggestion"
                                data-anchor-paragraph="${anchorParagraphEscaped}"
                                data-suggested-text="${suggestedTextEscaped}">
                            Aplicar
                        </button>
                    </div>
                </div>
            `;
        });
        reportHtml += `</div>`;
        
        reportContainer.innerHTML = reportHtml;
        window.showToast(`${appliedCount} sugest${appliedCount > 1 ? '√µes' : '√£o'} aplicad${appliedCount > 1 ? 'as' : 'a'} com sucesso!`, 'success');

    } catch (error) {
        console.error("Erro detalhado em suggestViralElements:", error);
        reportContainer.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =========================================================================
// >>>>> VERS√ÉO REATORADA E COMPLETA de 'analyzeFullScript' <<<<<
// =========================================================================
const analyzeFullScript = async (button) => {
    showButtonLoading(button);
    const reportContainer = document.getElementById('analysisReportContainer');
    reportContainer.innerHTML = `<div class="my-4"><div class="loading-spinner-small mx-auto"></div><p class="text-sm mt-2 text-center">Analisando... Isso pode levar um momento.</p></div>`;

    try {
        // --- A MUDAN√áA EST√Å AQUI: Lemos o roteiro diretamente do "c√©rebro" AppState ---
        const script = AppState.generated.script;
        if (!script.intro.text || !script.development.text || !script.climax.text || !script.conclusion.text || !script.cta.text) {
            throw new Error("Todas as 5 se√ß√µes do roteiro (Intro, Dev, Cl√≠max, Conclus√£o e CTA) devem ser geradas primeiro.");
        }
        
        // Coletamos o contexto estrat√©gico leve para a an√°lise.
        const lightContext = {
            theme: document.getElementById('videoTheme')?.value.trim() || 'N√£o definido',
            centralQuestion: document.getElementById('centralQuestion')?.value.trim() || 'N√£o definida',
            outline: AppState.generated.strategicOutline || {}
        };
        
        // Fazemos as chamadas de an√°lise para cada parte do roteiro, usando o texto do AppState.
        const results = await Promise.allSettled([
            analyzeScriptPart('Introdu√ß√£o (Hook)', script.intro.text, lightContext),
            analyzeScriptPart('Desenvolvimento (Ritmo e Reten√ß√£o)', script.development.text, lightContext),
            analyzeScriptPart('Cl√≠max', script.climax.text, lightContext),
            analyzeScriptPart('Conclus√£o', script.conclusion.text, lightContext),
            analyzeScriptPart('CTA (Call to Action)', script.cta.text, lightContext)
        ]);
        // --- FIM DA MUDAN√áA ---
        
        // Limpa o container para exibir os novos resultados.
        reportContainer.innerHTML = ''; 

        // Cria o cabe√ßalho do relat√≥rio com o bot√£o "Aplicar Todas".
        const headerDiv = document.createElement('div');
        headerDiv.className = 'flex justify-between items-center mb-4 p-3 bg-gray-100 dark:bg-gray-900/50 rounded-lg';
        headerDiv.innerHTML = DOMPurify.sanitize(`
            <h3 class="text-lg font-bold">Relat√≥rio de An√°lise</h3>
            <button id="applyAllSuggestionsBtn" data-action="applyAllSuggestions" class="btn btn-secondary btn-small">
                <i class="fas fa-wand-magic-sparkles mr-2"></i>Aplicar Todas
            </button>
        `);
        reportContainer.appendChild(headerDiv);

        // Renderiza cada se√ß√£o do relat√≥rio.
        results.forEach(result => {
            if (result.status === 'fulfilled') {
                reportContainer.appendChild(createReportSection(result.value));
            } else {
                console.error("Uma micro-an√°lise falhou:", result.reason);
                // Mesmo em caso de falha, exibe uma se√ß√£o de erro para o usu√°rio saber.
                const errorData = { 
                    criterion_name: 'Se√ß√£o com Erro', 
                    score: '!', 
                    positive_points: 'Falha na an√°lise desta se√ß√£o.', 
                    improvement_points: [{ critique: 'Erro', suggestion_text: result.reason.message }]
                };
                reportContainer.appendChild(createReportSection(errorData));
            }
        });

        window.showToast("An√°lise do roteiro conclu√≠da!", 'success');

    } catch (error) {
        console.error("Erro detalhado em analyzeFullScript:", error);
        window.showToast(`Falha na an√°lise: ${error.message}`);
        reportContainer.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};



/**
 * Invalida e limpa o Mapa Emocional quando o roteiro √© alterado.
 * Reseta o estado no AppState e atualiza a UI com um aviso.
 */
const invalidateAndClearEmotionalMap = () => {
    // S√≥ executa se o mapa j√° tiver sido gerado, para evitar opera√ß√µes desnecess√°rias
    if (!AppState.generated.emotionalMap) {
        return;
    }

    console.log("Roteiro alterado. Invalidando e limpando o Mapa Emocional.");

    // 1. Reseta o estado no "c√©rebro" da aplica√ß√£o
    AppState.generated.emotionalMap = null;

    // 2. Reseta a interface do usu√°rio (UI)
    const container = document.getElementById('emotionalMapContent');
    const button = document.getElementById('mapEmotionsBtn');

    if (container) {
        // Mostra um aviso claro para o usu√°rio sobre o porqu√™ de o mapa ter sumido
        container.innerHTML = `
            <div class="asset-card-placeholder text-yellow-700 dark:text-yellow-300 border-l-4 border-yellow-400 bg-yellow-50 dark:bg-yellow-900/20">
                O roteiro foi alterado.<br>Clique em "Mapear" novamente para ver a an√°lise atualizada.
            </div>`;
    }

    // 3. Reseta o estado do bot√£o "Mapear" para que possa ser clicado novamente
    if (button) {
        button.classList.remove('btn-success');
        button.classList.add('btn-secondary');
    }
};



// ====================================================================================
// A√á√ÉO: SUBSTITUA SUA FUN√á√ÉO 'analyzeScriptPart' INTEIRA POR ESTA VERS√ÉO BLINDADA
// ====================================================================================

/**
 * A fun√ß√£o "Cr√≠tico de Cinema". Analisa uma parte espec√≠fica do roteiro.
 * VERS√ÉO BLINDADA com prompt simplificado para garantir conformidade da IA.
 */
const analyzeScriptPart = async (criterion, text, context = {}) => {
    const sectionKeyMap = {
        'Introdu√ß√£o (Hook)': 'introduction',
        'Desenvolvimento (Ritmo e Reten√ß√£o)': 'development',
        'Cl√≠max': 'climax',
        'Conclus√£o': 'conclusion',
        'CTA (Call to Action)': 'cta'
    };
    const outlineKey = sectionKeyMap[criterion];
    const outlineDirective = context.outline?.[outlineKey] || 'Nenhuma diretriz estrat√©gica espec√≠fica foi definida para esta se√ß√£o.';

    // O NOVO C√âREBRO, MAIS SIMPLES E DIRETO
    const prompt = `
Voc√™ √© uma API de An√°lise Cr√≠tica de Roteiros. Sua √∫nica fun√ß√£o √© retornar um objeto JSON.

**CONTEXTO ESTRAT√âGICO:**
- **Tema do V√≠deo:** "${context.theme || 'N√£o definido'}"
- **Objetivo desta Se√ß√£o (${criterion}):** "${outlineDirective}"

**TRECHO PARA AN√ÅLISE:**
---
${text.slice(0, 7000)}
---

**REGRAS CR√çTICAS DE RESPOSTA (JSON ESTRITO - SIGA EXATAMENTE):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um objeto JSON v√°lido.
2.  **CHAVES E TIPOS OBRIGAT√ìRIOS:** O objeto DEVE conter EXATAMENTE estas 5 chaves:
    - **"criterion_name"**: (String) Use EXATAMENTE: "${criterion}".
    - **"score"**: (N√∫mero) Uma nota de 0 a 10 para esta se√ß√£o.
    - **"positive_points"**: (String) Um par√°grafo √∫nico sobre os pontos fortes.
    - **"critique"**: (String) A principal cr√≠tica ou ponto de melhoria. Se estiver bom, escreva "Nenhuma cr√≠tica significativa.".
    - **"suggestion"**: (String) Uma sugest√£o ACION√ÅVEL para melhorar o ponto da cr√≠tica. Se n√£o houver cr√≠tica, escreva "Manter como est√°.".
3.  **SINTAXE:** Todas as chaves e valores string DEVEM usar aspas duplas ("").

**A√á√ÉO FINAL:** Analise o trecho e retorne APENAS o objeto JSON perfeito.
`;

    try {
        const rawResult = await callGroqAPI(prompt, 1500); // Reduzimos os tokens pois a resposta √© mais simples
        const analysisData = cleanGeneratedText(rawResult, true);

        if (!analysisData) { throw new Error("A IA retornou uma resposta nula."); }

        // Valida√ß√£o robusta contra a falha da IA
        const requiredKeys = ['score', 'positive_points', 'critique', 'suggestion'];
        for (const key of requiredKeys) {
            if (!(key in analysisData)) {
                // Se uma chave faltar, n√≥s criamos um erro mais informativo
                console.error("JSON retornado pela IA (incompleto):", analysisData);
                throw new Error(`A chave obrigat√≥ria '${key}' est√° ausente na resposta da IA.`);
            }
        }
        
        // NOVO: Reestruturamos os dados para corresponder ao que a fun√ß√£o 'createReportSection' espera.
        // Isso mant√©m o resto do seu c√≥digo funcionando sem precisar de mais altera√ß√µes.
        const formattedData = {
            criterion_name: criterion,
            score: analysisData.score,
            positive_points: analysisData.positive_points,
            improvement_points: []
        };

        // Se houver uma cr√≠tica real, criamos o objeto de melhoria
        if (analysisData.critique.toLowerCase() !== "nenhuma cr√≠tica significativa." && analysisData.suggestion) {
            formattedData.improvement_points.push({
                problematic_quote: "Se√ß√£o inteira", // A cr√≠tica agora √© sobre o bloco todo
                critique: analysisData.critique,
                suggestion_text: analysisData.suggestion,
                rewritten_quote: text // O "reescrito" √© o pr√≥prio texto original, j√° que a sugest√£o √© geral
            });
        }
        
        return formattedData;

    } catch (error) {
        console.error(`Erro cr√≠tico ao analisar a se√ß√£o '${criterion}':`, error);
        return { 
            criterion_name: criterion, 
            score: 'Erro', 
            positive_points: 'A an√°lise desta se√ß√£o falhou.', 
            improvement_points: [{
                critique: 'Falha na An√°lise',
                suggestion_text: `Detalhe do erro: ${error.message}`,
                problematic_quote: 'N/A',
                rewritten_quote: 'N/A'
            }]
        };
    }
};



// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO 'createReportSection' INTEIRA POR ESTA <<<<<
// =========================================================================
const createReportSection = (analysisData) => {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'p-4 border rounded-lg mb-4 bg-gray-50 dark:bg-gray-800 animate-fade-in';

    if (!analysisData || typeof analysisData.score === 'undefined') {
        const errorName = analysisData ? analysisData.criterion_name : 'Se√ß√£o de An√°lise';
        sectionDiv.innerHTML = DOMPurify.sanitize(`
            <h4 class="font-bold text-lg text-red-500">${errorName}</h4>
            <p class="text-red-500 text-sm mt-2">Falha ao processar a an√°lise para esta se√ß√£o. A resposta da IA pode estar em um formato inesperado.</p>
        `);
        return sectionDiv;
    }

    let improvementHtml = '';
    if (analysisData.improvement_points && analysisData.improvement_points.length > 0) {
        improvementHtml = analysisData.improvement_points.map(point => {
            const problematicQuoteEscaped = (point.problematic_quote || '').replace(/"/g, '"');
            const rewrittenQuoteEscaped = (point.rewritten_quote || '').replace(/"/g, '"');

            return `
            <div class="mt-4 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                <p class="text-sm italic text-gray-500 dark:text-gray-400 mb-1">" ${DOMPurify.sanitize(point.problematic_quote || '')} "</p>
                <p class="text-sm"><strong class="text-yellow-600 dark:text-yellow-400">Cr√≠tica:</strong> ${DOMPurify.sanitize(point.critique || '')}</p>
                <div class="flex items-center justify-between gap-2 mt-2">
                    <p class="text-sm flex-1"><strong class="text-green-600 dark:text-green-400">Sugest√£o:</strong> ${DOMPurify.sanitize(point.suggestion_text || '')}</p>
                    
                    <button class="btn btn-primary btn-small flex-shrink-0"
                            data-action="applySuggestion"
                            data-criterion-name="${DOMPurify.sanitize(analysisData.criterion_name)}"
                            data-problematic-quote="${problematicQuoteEscaped}"
                            data-rewritten-quote="${rewrittenQuoteEscaped}">
                        Aplicar
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    const content = `
        <div class="flex justify-between items-center">
            <h4 class="font-bold text-lg">${DOMPurify.sanitize(analysisData.criterion_name)}</h4>
            <span class="font-bold text-xl text-primary">${analysisData.score}/10</span>
        </div>
        <div class="mt-2">
            <p class="text-sm"><strong class="text-indigo-500">Pontos Fortes:</strong> ${DOMPurify.sanitize(analysisData.positive_points)}</p>
            ${improvementHtml}
        </div>
    `;
    sectionDiv.innerHTML = content;
    return sectionDiv;
};



// =========================================================================
// >>>>> FUN√á√ÉO DE EDI√á√ÉO CONTEXTUAL (VERS√ÉO COMPLETA E ROBUSTA) <<<<<
// =========================================================================
const handleEditingAction = async (action) => {
    if (!userSelectionRange) {
        window.showToast("Erro: A sele√ß√£o de texto foi perdida. Tente selecionar novamente.", 'error');
        return;
    }

    const selectedText = userSelectionRange.toString().trim();
    if (!selectedText) {
        document.getElementById('editing-menu').classList.remove('visible');
        return;
    }

    const editingMenu = document.getElementById('editing-menu');
    editingMenu.classList.remove('visible');
    window.showToast(`Texto refinado com sucesso!`, 'success');

    const instructions = {
        expand: "Sua tarefa √© expandir este par√°grafo. Adicione mais detalhes, descri√ß√µes v√≠vidas e contexto para torn√°-lo mais rico e envolvente, mantendo o tom e a mensagem central originais.",
        summarize: "Sua tarefa √© resumir este par√°grafo. Torne-o mais conciso, direto e impactante, removendo redund√¢ncias mas preservando a informa√ß√£o essencial.",
        correct: "Sua tarefa √© atuar como um revisor meticuloso. Corrija quaisquer erros de ortografia, gram√°tica e pontua√ß√£o no texto a seguir, preservando o estilo original. Se n√£o houver erros, retorne o texto original."
    };

    const prompt = `Voc√™ √© um editor de roteiros de elite. ${instructions[action]}
    
**REGRAS CR√çTICAS (INEGOCI√ÅVEIS):**
1.  **IDIOMA:** A sua resposta DEVE estar no mesmo idioma do texto original.
2.  **RESPOSTA LIMPA:** Responda APENAS com o texto reescrito. Sem coment√°rios ou explica√ß√µes.

**TEXTO ORIGINAL:**
---
${selectedText}
---
`;

    try {
        const rawResult = await callGroqAPI(prompt, 3000);
        const refinedText = removeMetaComments(rawResult);

        if (userSelectionRange) {
            window.getSelection().removeAllRanges();
            userSelectionRange.deleteContents();

            const newNode = document.createElement('span');
            newNode.className = 'highlight-change';
            newNode.textContent = refinedText;
            
            userSelectionRange.insertNode(newNode);
            
            const newRange = document.createRange();
            newRange.selectNodeContents(newNode);
            window.getSelection().addRange(newRange);
        }

        const sectionElement = userSelectionRange.startContainer.parentElement.closest('.script-section');
        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
            invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
            updateAllReadingTimes();
        }
        
        window.showToast(`Falha ao refinar o texto: ${error.message}`, 'error');

    } catch (error) {
        console.error(`Erro ao tentar '${action}':`, error);
        window.showToast(`Sugest√µes para Conclus√£o e CTA preenchidas!`, 'success');
    } finally {
        userSelectionRange = null;
    }
};





// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> VERS√ÉO MODERNIZADA de 'suggestFinalStrategy' (sem projectState) <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
/**
 * Acionada pelo bot√£o "Sugerir Estrat√©gia Final".
 * Analisa o roteiro completo e o contexto estrat√©gico para sugerir
 * preenchimentos inteligentes para os campos de Conclus√£o e CTA.
 */
const suggestFinalStrategy = async (button) => {
    showButtonLoading(button);

    // Limpeza da UI para receber novas sugest√µes.
    const conclusionSpecifics = document.getElementById('conclusionSpecifics');
    const ctaSpecifics = document.getElementById('ctaSpecifics');
    
    // Limpa o conte√∫do de texto da conclus√£o e CTA no AppState
    AppState.generated.script.conclusion = { html: null, text: null };
    AppState.generated.script.cta = { html: null, text: null };

    // Limpa a UI correspondente (se√ß√µes de roteiro j√° geradas)
    const conclusionContainer = document.getElementById('conclusionSection');
    const ctaContainer = document.getElementById('ctaSection');
    if (conclusionContainer) conclusionContainer.innerHTML = '';
    if (ctaContainer) ctaContainer.innerHTML = '';
    
    // Habilita os controles novamente para a nova sugest√£o, caso estivessem desabilitados
    document.querySelectorAll('input[name="conclusionType"]').forEach(radio => radio.disabled = false);
    conclusionSpecifics.disabled = false;
    ctaSpecifics.disabled = false;
    document.getElementById('conclusionInputContainer').classList.remove('opacity-50');
    ctaSpecifics.parentElement.classList.remove('opacity-50');
    
    // Garante que o bot√£o correto esteja vis√≠vel
    document.getElementById('generateConclusionBtn').classList.remove('hidden');
    document.getElementById('generateCtaBtn').classList.add('hidden');

    // Pega o roteiro escrito at√© agora e o contexto estrat√©gico para a IA.
    const fullContext = getTranscriptOnly();
    const basePromptContext = getBasePromptContext();
    
    if (!fullContext) {
        window.showToast("Gere o roteiro principal primeiro para receber sugest√µes.", 'info');
        hideButtonLoading(button);
        return;
    }

    const prompt = `Voc√™ √© uma API ESPECIALISTA EM ESTRAT√âGIA DE CONTE√öDO FINAL DE V√çDEO. Sua fun√ß√£o √öNICA √© analisar um roteiro e retornar um objeto JSON com sugest√µes ESTRAT√âGICAS para a CONCLUS√ÉO e o CALL TO ACTION.

**CONTEXTO ESTRAT√âGICO ("ALMA" DO ROTEIRO):**
---
${basePromptContext}
---

**ROTEIRO COMPLETO (PARA AN√ÅLISE):**
---
${fullContext}
---

**REGRAS CR√çTICAS DE SINTAXE JSON (INEGOCI√ÅVEIS):**
1.  **JSON PURO:** Sua resposta deve ser APENAS um objeto JSON v√°lido.
2.  **ESTRUTURA OBRIGAT√ìRIA:** O objeto DEVE conter EXATAMENTE estas duas chaves: "conclusion_suggestion" e "cta_suggestion".
3.  **IDIOMA OBRIGAT√ìRIO:** Ambos os valores de texto DEVEM estar no MESMO IDIOMA do roteiro.

**MANUAL DE CRIA√á√ÉO:**
- **"conclusion_suggestion" (Li√ß√£o Final Poderosa):** Uma REFLEX√ÉO que resume o n√∫cleo do v√≠deo de forma PROFUNDA e EMOCIONALMENTE RESONANTE.
- **"cta_suggestion" (Call to Action Engajador):** Uma INSTRU√á√ÉO CLARA, DIRETA e MOTIVADORA que esteja ALINHADA com o tema.

**A√á√ÉO:** Analise o roteiro e contexto. Gere o objeto JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 1000);
        const suggestions = cleanGeneratedText(rawResult, true);

        if (suggestions && suggestions.conclusion_suggestion && suggestions.cta_suggestion) {
            conclusionSpecifics.value = suggestions.conclusion_suggestion;
            ctaSpecifics.value = suggestions.cta_suggestion;
            window.showToast("Sugest√µes para Conclus√£o e CTA preenchidas!", 'success');
        } else {
            throw new Error("A IA n√£o retornou sugest√µes no formato esperado.");
        }

    } catch (error) {
        console.error("Erro detalhado em suggestFinalStrategy:", error);
        window.showToast(`Falha ao sugerir estrat√©gia final: ${error.message}`);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};



// =========================================================================
// >>>>> VERS√ÉO CORRIGIDA E FINAL DE window.deleteParagraphGroup <<<<<
// =========================================================================
/**
 * Encontra e deleta todos os par√°grafos pertencentes a um mesmo grupo de sugest√£o,
 * usando o modal de confirma√ß√£o e uma anima√ß√£o suave de "fade out".
 * @param {HTMLElement} button - O bot√£o de deletar que foi clicado.
 * @param {string} suggestionText - O texto da sugest√£o que identifica o grupo.
 */
window.deleteParagraphGroup = async (button, suggestionText) => {
    // 1. Pede a confirma√ß√£o do usu√°rio e aguarda a resposta.
    const userConfirmed = await showConfirmationDialog(
        'Confirmar Dele√ß√£o',
        'Tem certeza que deseja deletar este bloco de par√°grafos? Esta a√ß√£o n√£o pode ser desfeita.'
    );

    // 2. Se o usu√°rio clicar em "N√£o", a fun√ß√£o para aqui.
    if (!userConfirmed) {
        return;
    }

    // 3. Encontra os par√°grafos para deletar, escapando as aspas para seguran√ßa.
    const safeSelector = suggestionText.replace(/"/g, '\\"');
    const paragraphsToDelete = document.querySelectorAll(`[data-suggestion-group="${safeSelector}"]`);

    if (paragraphsToDelete.length === 0) {
        window.showToast("Erro: Par√°grafos para deletar n√£o encontrados.", 'error');
        return;
    }

    // 4. Guarda a refer√™ncia da se√ß√£o-m√£e ANTES de qualquer remo√ß√£o.
    const sectionElement = paragraphsToDelete[0].closest('.script-section');

    // 5. Aplica a anima√ß√£o de "fade out" em todos os par√°grafos do grupo.
    paragraphsToDelete.forEach(p => {
        p.style.transition = 'opacity 0.3s ease-out';
        p.style.opacity = '0';
    });
    
    // 6. Aguarda a anima√ß√£o (300ms) terminar antes de remover os elementos do DOM.
    setTimeout(() => {
        paragraphsToDelete.forEach(p => p.remove());

        // 7. Ap√≥s a remo√ß√£o, atualiza as an√°lises e o tempo de leitura.
        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
            updateAllReadingTimes();
        }
        
        // 8. Notifica o usu√°rio do sucesso.
        window.showToast("Bloco de par√°grafos deletado com sucesso!", 'success');
    }, 300); // O tempo do timeout deve ser o mesmo da transi√ß√£o do CSS.
};


// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO showInputDialog COMPLETA <<<<<
// =========================================================================
/**
 * Exibe uma caixa de di√°logo com um campo de texto e sugest√µes, e aguarda a entrada do usu√°rio.
 * @param {string} title - O t√≠tulo da caixa de di√°logo.
 * @param {string} message - A mensagem de ajuda/descri√ß√£o.
 * @param {string} label - A label para o campo de texto.
 * @param {string} placeholder - O placeholder para o campo de texto.
 * @param {string[]} suggestions - (NOVO) Um array de strings para criar bot√µes de sugest√£o.
 * @returns {Promise<string|null>} - Retorna o texto escolhido ou null se cancelar.
 */
const showInputDialog = (title, message, label, placeholder, suggestions = []) => {
    return new Promise(resolve => {
        // Mapeia todos os elementos do DOM necess√°rios para o di√°logo
        const overlay = document.getElementById('inputDialogOverlay');
        const titleEl = document.getElementById('inputDialogTitle');
        const messageEl = document.getElementById('inputDialogMessage');
        const labelEl = document.getElementById('inputDialogLabel');
        const fieldEl = document.getElementById('inputDialogField');
        const btnConfirm = document.getElementById('inputBtnConfirm');
        const btnCancel = document.getElementById('inputBtnCancel');
        const suggestionsContainer = document.getElementById('inputDialogSuggestions');

        // Garante que todos os elementos existem antes de continuar para evitar erros
        if (!overlay || !titleEl || !messageEl || !labelEl || !fieldEl || !btnConfirm || !btnCancel || !suggestionsContainer) {
            console.error("Elementos do pop-up de input n√£o foram encontrados no HTML.");
            resolve(null); // Resolve como nulo para n√£o travar a aplica√ß√£o
            return;
        }

        // Limpa o conte√∫do de intera√ß√µes anteriores
        suggestionsContainer.innerHTML = '';
        fieldEl.value = '';

        // Preenche os textos do di√°logo com os par√¢metros recebidos
        titleEl.textContent = title;
        messageEl.textContent = message;
        labelEl.textContent = label;
        fieldEl.placeholder = placeholder;
        
        // Fun√ß√£o centralizada para fechar o di√°logo e resolver a Promise
        const closeDialog = (result) => {
            overlay.style.display = 'none';
            // Remove os event listeners para evitar chamadas duplicadas em futuras aberturas
            btnConfirm.onclick = null;
            btnCancel.onclick = null;
            resolve(result);
        };

        // Cria e adiciona os bot√µes de sugest√£o, se houver sugest√µes
        if (suggestions && suggestions.length > 0) {
            suggestions.forEach(suggestionText => {
                const suggestionBtn = document.createElement('button');
                suggestionBtn.className = 'btn btn-secondary hover:bg-purple-600 dark:hover:bg-purple-700 w-full text-left justify-start';
                suggestionBtn.textContent = suggestionText;
                // Ao clicar em um bot√£o de sugest√£o, fecha o di√°logo e retorna o texto da sugest√£o
                suggestionBtn.onclick = () => {
                    closeDialog(suggestionText);
                };
                suggestionsContainer.appendChild(suggestionBtn);
            });
        }

        // Configura o bot√£o de confirma√ß√£o (para o texto personalizado)
        btnConfirm.onclick = () => {
            const customText = fieldEl.value.trim();
            if (customText) {
                // Se o usu√°rio digitou algo, fecha o di√°logo e retorna o texto digitado
                closeDialog(customText);
            } else {
                // Se o campo estiver vazio, avisa o usu√°rio
                window.showToast("Por favor, digite um tema ou escolha uma das sugest√µes.", 'info');
            }
        };

        // Configura o bot√£o de cancelar
        btnCancel.onclick = () => closeDialog(null);

        // Exibe o di√°logo
        overlay.style.display = 'flex';
        fieldEl.focus(); // Coloca o foco no campo de texto para facilitar a digita√ß√£o
    });
};



// =========================================================================
// >>>>> VERS√ÉO FINAL DE updateAllReadingTimes COM O SELETOR CORRIGIDO <<<<<
// =========================================================================
/**
 * Percorre todas as se√ß√µes de roteiro geradas e atualiza o tempo de leitura exibido.
 */
const updateAllReadingTimes = () => {
    // Pega todas as se√ß√µes de roteiro que j√° foram geradas
    const scriptSections = document.querySelectorAll('#scriptSectionsContainer .accordion-item');
    
    scriptSections.forEach(item => {
        const contentWrapper = item.querySelector('.generated-content-wrapper');
        
        // >>>>> A CORRE√á√ÉO EST√Å AQUI: Trocamos '.header-content' por '.header-title-group' <<<<<
        const timeDisplay = item.querySelector('.header-title-group .text-xs');

        if (contentWrapper && timeDisplay) {
            // Recalcula o tempo de leitura com base no conte√∫do atualizado
            const newTime = calculateReadingTime(contentWrapper.textContent);
            // Atualiza o texto do elemento span com o novo tempo
            timeDisplay.textContent = newTime;
        }
    });
}


    // ==========================================================
// >>>>> SUBSTITUA A FUN√á√ÉO validateInputs INTEIRA POR ESTA <<<<<
// ==========================================================
const validateInputs = () => {
    const channelName = document.getElementById('channelName')?.value.trim();
    const videoTheme = document.getElementById('videoTheme')?.value.trim();
    const videoDescription = document.getElementById('videoDescription')?.value.trim();
    const videoDuration = document.getElementById('videoDuration')?.value;
    // Adicionamos a leitura do novo campo
    const visualPacing = document.getElementById('visualPacing')?.value;

    if (!channelName) {
        window.showToast("Por favor, insira o nome do canal.", 'error');
        return false;
    }
    if (!videoTheme) {
        window.showToast("Por favor, insira o tema do v√≠deo.", 'error');
        return false;
    }
    if (!videoDescription) {
        window.showToast("Por favor, insira a descri√ß√£o do v√≠deo (para inspira√ß√£o).", 'error');
        return false;
    }
    if (!videoDuration || videoDuration === "") {
        window.showToast("Por favor, selecione a Dura√ß√£o Desejada do v√≠deo.", 'error');
        return false;
    }
    
    if (!visualPacing || visualPacing === "") {
        window.showToast("Por favor, selecione o Ritmo Visual do v√≠deo.", 'error');
        return false;
    }
    
    return true;
};




        /**
         * Exibe uma caixa de di√°logo de confirma√ß√£o e aguarda a resposta do usu√°rio.
         * @param {string} title - O t√≠tulo da caixa de di√°logo.
         * @param {string} message - A mensagem de confirma√ß√£o.
         * @returns {Promise<boolean>} - Retorna true se o usu√°rio clicar "Sim", false caso contr√°rio.
         */
        const showConfirmationDialog = (title, message) => {
            return new Promise(resolve => {
                const overlay = document.getElementById('confirmationDialogOverlay');
                const titleEl = document.getElementById('confirmationTitle');
                const messageEl = document.getElementById('confirmationMessage');
                const btnYes = document.getElementById('confirmBtnYes');
                const btnNo = document.getElementById('confirmBtnNo');

                // Garante que todos os elementos existem antes de continuar
                if (!overlay || !titleEl || !messageEl || !btnYes || !btnNo) {
                    console.error("Elementos do pop-up de confirma√ß√£o n√£o foram encontrados no HTML.");
                    resolve(false); // Resolve como 'false' para n√£o travar a aplica√ß√£o
                    return;
                }

                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.style.display = 'flex';

                // Fun√ß√£o para limpar e fechar o di√°logo
                const closeDialog = (result) => {
                    overlay.style.display = 'none';
                    // Remove os listeners para evitar chamadas duplicadas
                    clonedBtnYes.replaceWith(btnYes);
                    clonedBtnNo.replaceWith(btnNo);
                    resolve(result);
                };

                // TRUQUE PARA GARANTIR LISTENERS LIMPOS:
                // Clonamos os bot√µes para remover quaisquer event listeners antigos
                const clonedBtnYes = btnYes.cloneNode(true);
                const clonedBtnNo = btnNo.cloneNode(true);

                // Adicionamos os novos listeners aos clones
                clonedBtnYes.addEventListener('click', () => closeDialog(true));
                clonedBtnNo.addEventListener('click', () => closeDialog(false));

                // Substitu√≠mos os bot√µes originais pelos clones com os novos listeners
                btnYes.replaceWith(clonedBtnYes);
                btnNo.replaceWith(clonedBtnNo);
            });
        };

        /**
         * Compara um texto gerado pela IA (com anota√ß√µes) com o texto original
         * para garantir que o conte√∫do n√£o foi alterado.
         * @param {string} originalText - O texto base.
         * @param {string} annotatedText - O texto com anota√ß√µes gerado pela IA.
         * @returns {{isValid: boolean, cleanTextFromAI: string}} - Retorna se √© v√°lido e o texto da IA sem anota√ß√µes.
         */
        const auditGeneratedText = (originalText, annotatedText) => {
            // Remove todas as anota√ß√µes [em colchetes] do texto da IA
            const cleanTextFromAI = annotatedText.replace(/\[.*?\]/g, '').trim();
            
            // Remove m√∫ltiplos espa√ßos e quebras de linha para uma compara√ß√£o mais justa
            const normalizedOriginal = originalText.replace(/\s+/g, ' ').trim();
            const normalizedCleanAI = cleanTextFromAI.replace(/\s+/g, ' ').trim();

            // Compara os dois textos normalizados
            const isValid = normalizedOriginal === normalizedCleanAI;
            
            return { isValid, cleanTextFromAI };
        };


        /**
         * Copia um texto para a √°rea de transfer√™ncia.
         * @param {string} text - O texto a ser copiado.
         */
        window.copyTextToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                window.showToast('Copiado!', 'success');
            } catch (err) {
                // Fallback para navegadores mais antigos ou contextos restritos (ex: iframes)
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    window.showToast('Copiado!', 'success');
                } finally {
                    document.body.removeChild(ta);
                }
            }
        };

        /**
         * Fornece feedback visual em um bot√£o ap√≥s uma a√ß√£o de c√≥pia.
         * @param {HTMLElement} buttonElement - O elemento do bot√£o que foi clicado.
         */
        window.showCopyFeedback = (buttonElement) => {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'Copiado!';
            buttonElement.classList.add('btn-success');
            buttonElement.disabled = true; // Desabilita o bot√£o temporariamente

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.classList.remove('btn-success');
                buttonElement.disabled = false;
            }, 2000); // Reverte ap√≥s 2 segundos
        };



        // ==========================================================
        // >>>>> ADICIONE ESTE NOVO BLOCO <<<<<
        // ==========================================================
        /**
         * Mostra um spinner de carregamento em QUALQUER bot√£o, salvando seu conte√∫do original.
         * @param {HTMLElement} button - O elemento do bot√£o a ser modificado.
         */
        const showButtonLoading = (button) => {
            if (!button) return;
            // Salva o HTML original do bot√£o (incluindo √≠cones e texto)
            button.setAttribute('data-original-html', button.innerHTML);
            button.disabled = true;
            // Define o spinner como o novo conte√∫do.
            button.innerHTML = '<div class="loading-spinner" style="width:18px; height:18px; border-width: 2px;"></div>';
        };

        /**
         * Esconde o spinner de carregamento de um bot√£o, restaurando seu conte√∫do original.
         * @param {HTMLElement} button - O elemento do bot√£o a ser restaurado.
         */
        const hideButtonLoading = (button) => {
            if (!button) return;
            // Restaura o HTML original que salvamos
            if (button.hasAttribute('data-original-html')) {
                button.innerHTML = button.getAttribute('data-original-html');
                button.removeAttribute('data-original-html');
            }
            button.disabled = false;
        };

        /**
         * Marca um bot√£o (original e flutuante) como conclu√≠do (cor verde).
         * @param {string} originalId - O ID do bot√£o original.
         */
        const markButtonAsCompleted = (originalId) => {
            const originalButton = document.getElementById(originalId);
            const floatButton = document.getElementById(`float_${originalId}`);

            [originalButton, floatButton].forEach(btn => {
                if (btn) {
                    btn.classList.remove('btn-primary', 'btn-secondary');
                    btn.classList.add('btn-success');
                }
            });
            updateProgressBar(); 
        };



        /**
         * Reseta os √≠cones de conclus√£o de todos os bot√µes (original e flutuante) para suas cores padr√£o.
         */
        const resetCompletionIcons = () => {
            const passo1_buttons_ids = ['generateIntroBtn', 'generateDevelopmentBtn', 'climaxBtn', 'conclusionBtn', 'generateCTABtn'];
            
            for (const buttonId in buttons) { // Iterar sobre todos os bot√µes
                const isPasso1 = passo1_buttons_ids.includes(buttonId);
                const originalButton = document.getElementById(buttonId);
                const floatButton = document.getElementById(`float_${buttonId}`);

                // Remove a classe de sucesso e adiciona a classe correta (primary/secondary)
                [originalButton, floatButton].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('btn-success');
                        if (isPasso1) {
                            btn.classList.remove('btn-secondary');
                            btn.classList.add('btn-primary');
                        } else {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-secondary');
                        }
                    }
                });
            }
        };
        
/**
 * Verifica se as se√ß√µes principais do roteiro foram geradas.
 * @returns {boolean} True se todas as se√ß√µes principais foram geradas, caso contr√°rio, false.
 */
const isScriptComplete = () => {
    // Esta vers√£o l√™ diretamente do nosso "painel de controle" de estado,
    // que √© muito mais confi√°vel do que verificar o HTML.
    return projectState.intro && projectState.development && projectState.climax && projectState.conclusion && projectState.cta;
};




// =========================================================================
// >>>>> VERS√ÉO FINAL E CORRIGIDA de 'updateButtonStates' (l√≥gica est√°vel) <<<<<
// =========================================================================
const updateButtonStates = () => {
    const script = AppState.generated.script;

    // Define os estados chave da gera√ß√£o do roteiro
    const allMainScriptGenerated = !!script.intro.text && !!script.development.text && !!script.climax.text;
    const isConclusionGenerated = !!script.conclusion.text;
    const isCtaGenerated = !!script.cta.text;
    const isFullScriptGenerated = allMainScriptGenerated && isConclusionGenerated && isCtaGenerated;

    // Habilita/desabilita bot√µes de metadados
    const metadataButtons = ['generateTitlesAndThumbnailsBtn', 'generateDescriptionBtn', 'generateSoundtrackBtn', 'mapEmotionsBtn'];
    metadataButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            btn.disabled = !allMainScriptGenerated;
        }
    });

    // <<< A CORRE√á√ÉO CR√çTICA EST√Å AQUI >>>
    const conclusionModule = document.getElementById('conclusionStrategyModule');
    if (conclusionModule) {
        // A NOVA REGRA: O m√≥dulo aparece assim que o roteiro principal estiver pronto e FICA L√Å.
        const shouldShowConclusionModule = allMainScriptGenerated;
        conclusionModule.classList.toggle('hidden', !shouldShowConclusionModule);

        // A l√≥gica interna de qual bot√£o (Conclus√£o ou CTA) aparece continua a mesma.
        const btnGenerateConclusion = document.getElementById('generateConclusionBtn');
        const btnGenerateCta = document.getElementById('generateCtaBtn');
        if (btnGenerateConclusion && btnGenerateCta) {
            btnGenerateConclusion.classList.toggle('hidden', isConclusionGenerated);
            btnGenerateCta.classList.toggle('hidden', !isConclusionGenerated);
        }
    }
    
    // Mostra/esconde a se√ß√£o de an√°lise quando TUDO estiver pronto
    const analysisSection = document.getElementById('scriptAnalysisSection');
    if (analysisSection) {
        analysisSection.classList.toggle('hidden', !isFullScriptGenerated);
    }

  
};



// =========================================================================
// >>>>> VERS√ÉO REATORADA E EFICIENTE de 'getTranscriptOnly' <<<<<
// =========================================================================
/**
 * Coleta e concatena o texto puro de todas as se√ß√µes do roteiro na ordem correta,
 * lendo diretamente do estado centralizado (AppState).
 * @returns {string} A transcri√ß√£o completa e limpa.
 */
const getTranscriptOnly = () => {
    let transcript = '';
    const sectionOrder = ['intro', 'development', 'climax', 'conclusion', 'cta'];
    
    sectionOrder.forEach(sectionName => {
        // L√™ o texto da se√ß√£o diretamente do "c√©rebro" da aplica√ß√£o
        const scriptSection = AppState.generated.script[sectionName];
        if (scriptSection && scriptSection.text) {
            transcript += scriptSection.text.trim() + '\n\n';
        }
    });
    
    return transcript.trim();
};



    
        /**
         * Calcula o tempo de leitura estimado de um texto, considerando o ritmo de fala.
         */
        const calculateReadingTime = (text) => {
            if (!text) return "";

            const paceMap = {
                slow: 120,
                moderate: 150,
                fast: 180
            };
            
            const selectedPace = document.getElementById('speakingPace').value || 'moderate';
            const wordsPerMinute = paceMap[selectedPace];
            
            const words = text.trim().split(/\s+/).length;
            const totalSeconds = (words / wordsPerMinute) * 60;
            
            if (totalSeconds < 1) return "";
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            
            let timeString = "~";
            if (minutes > 0) timeString += ` ${minutes} min`;
            if (seconds > 0) timeString += ` ${seconds} seg`;
            
            return timeString.trim();
        };

    // ==========================================================
        // ==================== L√ìGICA DAS ABAS =====================
        // ==========================================================
        const setupTabs = () => {
            const tabButtons = document.querySelectorAll('#tabs .tab-button');
            const tabPanes = document.querySelectorAll('#tab-content .tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    tabPanes.forEach(pane => pane.classList.remove('active-pane'));

                    button.classList.add('active-tab');
                    const tabId = button.getAttribute('data-tab');
                    const activePane = document.getElementById(tabId);
                    if (activePane) {
                        activePane.classList.add('active-pane');
                    }
                });
            });
        };





// ====================================================================================
// >>>>> VERS√ÉO FINAL E ESTRUTURADA POR SE√á√ïES <<<<<
// ====================================================================================
const mapEmotionsAndPacing = async (button) => {
    const { script, imagePrompts } = AppState.generated;

    // 1. Valida√ß√£o: Verifica se as se√ß√µes principais existem.
    const isScriptReady = script.intro.text && script.development.text && script.climax.text;
    if (!isScriptReady) {
        window.showToast("Gere pelo menos a Introdu√ß√£o, Desenvolvimento e Cl√≠max primeiro.");
        return;
    }

    const outputContainer = document.getElementById('emotionalMapContent');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div> <p class="text-center text-sm">Analisando emo√ß√µes e estruturando o storyboard por se√ß√µes...</p>`;

    try {
        // 2. Gera√ß√£o do Mapa Emocional (se necess√°rio)
        // Se o mapa j√° existe, usamos ele. Se n√£o, geramos um novo.
        if (!AppState.generated.emotionalMap) {
            const fullTranscript = getTranscriptOnly(); // Pega o texto de todas as se√ß√µes
            const paragraphs = fullTranscript.split('\n\n').filter(p => p.trim() !== '');
            
            const prompt = `Voc√™ √© uma API de an√°lise que retorna um array JSON. Para os ${paragraphs.length} par√°grafos, sua resposta DEVE ser um array JSON com ${paragraphs.length} objetos. Cada objeto deve ter: "paragraph_index", "emotion", e "pace". Retorne APENAS o JSON puro.`;
            
            const rawResult = await callGroqAPI(prompt, 4000);
            const emotionalMapData = cleanGeneratedText(rawResult, true, true);

            if (!emotionalMapData || !Array.isArray(emotionalMapData) || emotionalMapData.length < paragraphs.length) {
                throw new Error("A IA retornou um mapa emocional em formato inv√°lido. Tente novamente.");
            }
            AppState.generated.emotionalMap = emotionalMapData;
        }

        // 3. Renderiza√ß√£o ESTRUTURADA por se√ß√µes
        outputContainer.innerHTML = ''; // Limpa o spinner

        const sectionOrder = [
            { id: 'intro', title: 'Introdu√ß√£o', promptKey: 'introSection' },
            { id: 'development', title: 'Desenvolvimento', promptKey: 'developmentSection' },
            { id: 'climax', title: 'Cl√≠max', promptKey: 'climaxSection' },
            { id: 'conclusion', title: 'Conclus√£o', promptKey: 'conclusionSection' },
            { id: 'cta', title: 'Call to Action (CTA)', promptKey: 'ctaSection' }
        ];

        let paragraphCounter = 0; // Um contador global para pegar os dados do mapa emocional

        // Loop atrav√©s de cada SE√á√ÉO do roteiro
        sectionOrder.forEach(section => {
            const sectionScript = script[section.id];
            if (!sectionScript || !sectionScript.text) {
                return; // Pula se a se√ß√£o n√£o foi gerada
            }

            // Adiciona o t√≠tulo da se√ß√£o
            const sectionTitleHtml = `
                <h2 class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-4 pb-2 border-b-2 border-primary">
                    ${section.title}
                </h2>
            `;
            outputContainer.innerHTML += sectionTitleHtml;

            const sectionParagraphs = sectionScript.text.split('\n\n').filter(p => p.trim() !== '');
            const sectionPrompts = imagePrompts[section.promptKey] || [];

            // Loop atrav√©s dos PAR√ÅGRAFOS DENTRO da se√ß√£o
            sectionParagraphs.forEach((paragraphText, index) => {
                const emotionData = AppState.generated.emotionalMap[paragraphCounter];
                const promptData = sectionPrompts[index] || null;

                if (!emotionData) {
                    paragraphCounter++;
                    return; // Se n√£o houver dados de emo√ß√£o, pula
                }
                
                let promptHtml = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">Prompts de imagem n√£o gerados para este par√°grafo.</p>';
                if (promptData) {
                    const styleIndicatorText = promptData.applyStyleBlock ? '[Estilo Cinematogr√°fico Aplicado]' : '';
                    const fullPromptTextForCopy = promptData.applyStyleBlock ? `${promptData.imageDescription} ${CINEMATIC_STYLE_BLOCK}` : promptData.imageDescription;
                    
                    promptHtml = `
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-semibold text-sm">Image Description:</p>
                            <button class="ml-auto text-gray-400 hover:text-primary transition-colors text-xs"
                                    onclick="window.copyTextToClipboard(this.closest('.emotional-map-item').querySelector('.full-prompt-hidden').textContent); window.showCopyFeedback(this);"
                                    title="Copiar prompt completo">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <p class="text-sm">${DOMPurify.sanitize(promptData.imageDescription)}</p>
                        <p class="text-xs italic text-gray-500 mt-2">${styleIndicatorText}</p>
                        <pre class="full-prompt-hidden hidden">${DOMPurify.sanitize(fullPromptTextForCopy)}</pre>
                    `;
                }

                const itemHtml = `
                <div class="emotional-map-item card !p-4 mb-4 animate-fade-in">
                    <div class="prompt-header mb-3">
                        <span class="tag tag-emotion"><i class="fas fa-theater-masks mr-2"></i>${DOMPurify.sanitize(emotionData.emotion)}</span>
                        <span class="tag tag-pace"><i class="fas fa-tachometer-alt mr-2"></i>${DOMPurify.sanitize(emotionData.pace)}</span>
                    </div>
                    <p class="paragraph-preview">"${DOMPurify.sanitize(paragraphText)}"</p>
                    <div class="border-t border-dashed border-gray-300 dark:border-gray-600 pt-3 mt-3">
                        ${promptHtml}
                    </div>
                </div>`;
                
                outputContainer.innerHTML += itemHtml;
                paragraphCounter++; // Incrementa o contador global
            });
        });
        
        window.showToast("Storyboard por se√ß√µes gerado com sucesso!");
        markButtonAsCompleted(button.id);

    } catch (error) {
        console.error("Erro detalhado ao gerar o Mapa Emocional por se√ß√µes:", error);
        outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar o mapa: ${error.message}</p>`;
        // Limpa o mapa do estado em caso de erro, para for√ßar uma nova gera√ß√£o na pr√≥xima vez
        AppState.generated.emotionalMap = null;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO generateSoundtrack INTEIRA POR ESTA VERS√ÉO FINAL <<<<<
// ====================================================================================

/**
 * Acionada pelo bot√£o "Gerar Trilha Sonora".
 * Analisa o roteiro completo e usa um prompt especialista para gerar 3 sugest√µes
 * de prompts musicais detalhados para IAs de gera√ß√£o de √°udio.
 */
const generateSoundtrack = async (button) => {
    const fullTranscript = getTranscriptOnly();
    if (!fullTranscript) {
        window.showToast("Gere o roteiro completo primeiro para sugerir uma trilha sonora coerente.");
        return;
    }

    const outputContainer = document.getElementById('soundtrackContent');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

    // O seu novo e espetacular c√©rebro especialista em Trilha Sonora.
    const prompt = `Voc√™ √© uma API ESPECIALISTA EM CRIA√á√ÉO DE PROMPTS PARA IAs DE GERA√á√ÉO DE TRILHAS SONORAS CINEMATOGR√ÅFICAS. Sua fun√ß√£o √öNICA E CR√çTICA √© analisar um roteiro e gerar 3 PAR√ÅGRAFOS DESCRITIVOS que sirvam como prompts ricos para a cria√ß√£o de uma trilha sonora que complemente perfeitamente o tom e a emo√ß√£o do v√≠deo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© o ESPECIALISTA ABSOLUTO em traduzir narrativa em descri√ß√µes sonoras precisas e evocativas. Sua fun√ß√£o √© ser a PONTE entre o roteiro e a composi√ß√£o musical.

**ROTEIRO COMPLETO PARA AN√ÅLISE MUSICAL:**
---
${fullTranscript}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA DO ARRAY:** O array deve conter EXATAMENTE 3 strings.
3.  **SINTAXE DAS STRINGS:** Todas as strings DEVEM usar aspas duplas (""). Cada string, EXCETO a √∫ltima, DEVE ser seguida por uma v√≠rgula (,).

**MANUAL DE CRIA√á√ÉO DE PROMPTS MUSICAIS (SIGA EXATAMENTE):**
- **Foco na Emo√ß√£o e Cena:** Cada par√°grafo deve descrever uma atmosfera sonora para uma fase da narrativa (ex: introdu√ß√£o, cl√≠max, conclus√£o).
- **Elementos Descritivos Essenciais:** Cada string deve incluir:
    1.  **Instrumenta√ß√£o Principal:** (Ex: "piano solo", "orquestra completa").
    2.  **Qualidade Sonora/Textura:** (Ex: "melodia suave", "ritmo acelerado").
    3.  **Atmosfera/Emo√ß√£o Alvo:** (Ex: "atmosfera de mist√©rio", "senso de urg√™ncia").
- **Conectividade:** Juntos, os 3 prompts devem cobrir um arco sonoro coerente com a jornada do roteiro.

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
[
  "Uma melodia suave e contemplativa tocada por um piano minimalista, criando uma atmosfera de introspec√ß√£o.",
  "Ritmo acelerado e pulsante com percuss√£o eletr√¥nica, construindo tens√£o crescente.",
  "Uma orquestra√ß√£o √©pica e emocional com cordas expansivas, evocando realiza√ß√£o e al√≠vio."
]

**RESTRI√á√ïES ESTRAT√âGICAS ABSOLUTAS:**
- **NENHUMA DESCRI√á√ÉO GEN√âRICA:** Seja espec√≠fico sobre instrumentos, texturas e emo√ß√µes.
- **NENHUMA MEN√á√ÉO A NOMES DE M√öSICAS OU ARTISTAS.**
- **RESPEITO AO CONTEXTO NARRATIVO:** As sugest√µes DEVEM estar alinhadas com o tom do roteiro.

**A√á√ÉO FINAL:** Analise AGORA o roteiro. Gere o array JSON com os 3 prompts de trilha sonora mais descritivos e alinhados com a narrativa. Responda APENAS com o array JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 1500);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis) || analysis.length === 0) {
            throw new Error("A IA n√£o retornou sugest√µes no formato esperado.");
        }

        let suggestionsHtml = '<ul class="soundtrack-list space-y-2">';
        analysis.forEach(suggestion => {
            // Garante que a sugest√£o seja uma string antes de tentar sanitizar
            if(typeof suggestion === 'string') {
                suggestionsHtml += `<li>${DOMPurify.sanitize(suggestion)}</li>`;
            }
        });
        suggestionsHtml += '</ul>';
        
        outputContainer.innerHTML = `<div class="generated-output-box">${suggestionsHtml}</div>`;
        markButtonAsCompleted(button.id);

    } catch (error) {
        console.error("Erro detalhado em generateSoundtrack:", error);
        outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> VERS√ÉO FINAL E MODERNIZADA de 'generateConclusion' (Usa AppState) <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

const generateConclusion = async (button) => {
    // Valida√ß√£o inicial
    if (!validateInputs()) return;
    showButtonLoading(button);

    // Garante que o container da se√ß√£o exista no DOM
    const scriptContainer = document.getElementById('scriptSectionsContainer');
    let conclusionContainer = document.getElementById('conclusionSection');
    if (scriptContainer && !conclusionContainer) {
        conclusionContainer = document.createElement('div');
        conclusionContainer.id = 'conclusionSection';
        conclusionContainer.classList.add('script-section');
        scriptContainer.appendChild(conclusionContainer);
    }

    // Coleta as diretrizes da UI
    const conclusionType = document.querySelector('input[name="conclusionType"]:checked').value;
    const conclusionSpecifics = document.getElementById('conclusionSpecifics').value.trim();
    const centralQuestion = document.getElementById('centralQuestion')?.value.trim() || 'a pergunta central do v√≠deo';
    
    // Monta a diretiva estrat√©gica para o prompt
    let strategyDirective = '';
    switch (conclusionType) {
        case 'lesson':
            strategyDirective = `O objetivo √© refor√ßar uma li√ß√£o ou reflex√£o central e memor√°vel. Detalhe do usu√°rio: '${conclusionSpecifics || 'Nenhum'}'. A li√ß√£o deve soar como a conclus√£o natural e impactante da jornada.`;
            break;
        case 'answer':
            strategyDirective = `O objetivo √© responder de forma clara e satisfat√≥ria √† pergunta central ('${centralQuestion}'). Detalhe do usu√°rio: '${conclusionSpecifics || 'Nenhum'}'. A resposta deve ser a revela√ß√£o que o espectador aguardava.`;
            break;
        case 'cliffhanger':
            strategyDirective = `O objetivo √© criar um gancho ou mist√©rio que justifique o pr√≥ximo v√≠deo. Detalhe do usu√°rio: '${conclusionSpecifics || 'Nenhum'}'. O final deve deixar o espectador ansioso pelo que vem a seguir.`;
            break;
    }

    const fullContext = getTranscriptOnly(); // Esta fun√ß√£o j√° usa AppState
    const basePromptContext = getBasePromptContext();

    // O prompt foi refinado para ser mais claro e direto
    const prompt = `${basePromptContext}

# TAREFA
Voc√™ √© um especialista em conclus√µes narrativas impactantes. Sua miss√£o √© escrever o texto da conclus√£o para o v√≠deo, estruturado em par√°grafos coesos e bem desenvolvidos.

# CONTEXTO
## Roteiro existente:
---
${fullContext}
---

# DIRETRIZ ESTRAT√âGICA
${strategyDirective}

# REGRAS ESSENCIAIS
1. **FORMATO**: Responda APENAS com o texto narrativo. Separe os par√°grafos com uma quebra de linha dupla.
   - Proibido: t√≠tulos, cabe√ßalhos, anota√ß√µes como "Narrador:", "(Cena: ...)", etc.
   - Proibido: incluir qualquer Call to Action (CTA).
2. **QUALIDADE DOS PAR√ÅGRAFOS**: Cada par√°grafo deve agrupar uma ideia completa (idealmente de 4 a 6 frases). Evite a fragmenta√ß√£o excessiva.
3. **CONTINUIDADE**: A conclus√£o deve fluir naturalmente do conte√∫do anterior.
4. **IMPACTO**: A conclus√£o deve ser memor√°vel e alinhada com a estrat√©gia.

Escreva agora o texto puro da conclus√£o, seguindo a estrutura de par√°grafos bem desenvolvidos.`;

    try {
        const rawResult = await callGroqAPI(prompt, 3000);
        const content = removeMetaComments(rawResult.trim());

        if (!content) {
            throw new Error("A IA n√£o retornou um conte√∫do v√°lido para a conclus√£o.");
        }
        
        const paragraphs = content.split('\n').filter(p => p.trim() !== '');
        const contentWithSpans = paragraphs.map((p, index) => `<div id="conclusion-p-${index}">${DOMPurify.sanitize(p)}</div>`).join('');
        const fullText = paragraphs.join('\n\n');

        // <<< CORRE√á√ÉO CR√çTICA AQUI: Atualiza o AppState, n√£o o projectState >>>
        AppState.generated.script.conclusion = {
            html: contentWithSpans,
            text: fullText
        };
        console.log("Estado para 'conclusion' atualizado no AppState.");
        
        const conclusionElement = generateSectionHtmlContent('conclusion', 'Conclus√£o', contentWithSpans);
        
        conclusionContainer.innerHTML = '';
        conclusionContainer.appendChild(conclusionElement);
        
        // Atualiza a UI para refletir o estado de "conclu√≠do"
        document.querySelectorAll('input[name="conclusionType"]').forEach(radio => radio.disabled = true);
        document.getElementById('conclusionSpecifics').disabled = true;
        document.querySelector('#conclusionInputContainer').classList.add('opacity-50');
        
        button.classList.add('hidden');
        document.getElementById('generateCtaBtn').classList.remove('hidden');

        window.showToast("Conclus√£o gerada! Agora, vamos ao CTA.", 'success');
        
    } catch (error) {
        console.error("Erro detalhado em generateConclusion:", error);
        window.showToast(`Falha ao gerar a conclus√£o: ${error.message}`);
    } finally {
        hideButtonLoading(button);
        updateButtonStates(); // Atualiza a UI geral
    }
};



// =================================================================================
// >>>>> VERS√ÉO FINAL E PADRONIZADA de 'generateStrategicCta' <<<<<
// =================================================================================
const generateStrategicCta = async (button) => {
    showButtonLoading(button);

    const scriptContainer = document.getElementById('scriptSectionsContainer');
    let ctaSection = document.getElementById('ctaSection');
    if (scriptContainer && !ctaSection) {
        ctaSection = document.createElement('div');
        ctaSection.id = 'ctaSection';
        ctaSection.classList.add('script-section');
        scriptContainer.appendChild(ctaSection);
    }

    const ctaSpecifics = document.getElementById('ctaSpecifics').value.trim();
    const fullContext = getTranscriptOnly();
    const basePromptContext = getBasePromptContext();

    let ctaDirective = "Crie um Call to Action (CTA) gen√©rico, convidando o espectador a curtir, comentar e se inscrever, mas que seja perfeitamente alinhado ao tom do v√≠deo.";
    if (ctaSpecifics) {
        ctaDirective = `Crie um Call to Action (CTA) altamente espec√≠fico e persuasivo. Instru√ß√£o do usu√°rio: "${ctaSpecifics}". Conecte esta instru√ß√£o ao tema geral do v√≠deo de forma natural e convincente.`;
    }

    // <<< A EVOLU√á√ÉO EST√Å AQUI, NO PROMPT >>>
    const prompt = `${basePromptContext}

# TAREFA
Voc√™ √© um especialista em criar Call to Action (CTA) estrat√©gicos e persuasivos. Sua miss√£o √© escrever o texto do CTA para o final do v√≠deo, estruturado em um ou mais par√°grafos coesos.

# CONTEXTO
## Roteiro completo:
---
${fullContext}
---

# DIRETRIZ ESTRAT√âGICA
${ctaDirective}

# REGRAS ESSENCIAIS
1. **FORMATO**: Responda APENAS com o texto narrativo. Separe os par√°grafos com uma quebra de linha dupla, se houver mais de um.
   - Proibido: r√≥tulos como "Narrador:", descri√ß√µes de cena, t√≠tulos, etc.
2. **QUALIDADE DO PAR√ÅGRAFO**: O CTA deve ser um par√°grafo coeso e bem formulado, contendo idealmente de 3 a 5 frases claras e motivadoras. O objetivo √© ser direto e impactante, **evitando fragmentos de uma √∫nica linha.**
3. **CONTINUIDADE**: O CTA deve soar como uma conclus√£o natural e integrada ao v√≠deo.
4. **CONSIST√äNCIA**: Mantenha o mesmo tom e estilo do roteiro.

Escreva agora o texto puro para o Call to Action, garantindo que seja bem estruturado.`;

    try {
        let result = await callGroqAPI(prompt, 400);
        result = removeMetaComments(result.trim());
        const paragraphs = result.split('\n').filter(p => p.trim() !== '');
        const contentWithSpans = paragraphs.map((p, index) => `<div id="cta-p-${index}">${DOMPurify.sanitize(p)}</div>`).join('');
        const fullText = paragraphs.join('\n\n');

        AppState.generated.script.cta = {
            html: contentWithSpans,
            text: fullText
        };
        console.log("Estado para 'cta' atualizado no AppState.");

        const ctaElement = generateSectionHtmlContent('cta', 'Call to Action (CTA)', contentWithSpans);
        ctaSection.innerHTML = '';
        ctaSection.appendChild(ctaElement);
        ctaSection.classList.remove('hidden');
        
        const ctaSpecificsElement = document.getElementById('ctaSpecifics');
        ctaSpecificsElement.disabled = true;
        ctaSpecificsElement.parentElement.classList.add('opacity-50');
        
        window.showToast("Roteiro finalizado! Se√ß√£o de An√°lise liberada.", 'success');
        
        const analysisSection = document.getElementById('scriptAnalysisSection');
        if (analysisSection) {
            analysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

    } catch(error) {
        console.error("Erro detalhado em generateStrategicCta:", error);
        window.showToast(`Falha ao gerar o CTA: ${error.message}`);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};



    // ==========================================================
        // NOVA FUN√á√ÉO PARA ATUALIZAR A BARRA DE PROGRESO
        // ==========================================================
            const updateProgressBar = () => {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    if (!progressFill || !progressText) return;

    const taskButtonIds = [
        'analyzeStrategyBtn',
        'generateOutlineBtn',
        'generateIntroBtn',
        'generateDevelopmentBtn',
        'climaxBtn',
        'generateConclusionAndCtaBtn', // Corrigido para o bot√£o correto da conclus√£o
        'generateTitlesAndThumbnailsBtn',
        'mapEmotionsBtn',
        'generateDescriptionBtn',
        'generateSoundtrackBtn'
    ];
    const totalTasks = taskButtonIds.length;
    let completedTasks = 0;
    
    taskButtonIds.forEach(id => {
        const button = document.getElementById(id);
        if (button && button.classList.contains('btn-success')) {
            completedTasks++;
        }
    });

    const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    // >>>>> IN√çCIO DA CORRE√á√ÉO <<<<<
    // Usamos as vari√°veis corretas (progressFill e progressText) e as cores corretas do CSS.
    progressFill.style.width = `${percentage}%`;
    progressText.textContent = `${percentage}%`;

    if (percentage === 100) {
        progressFill.textContent = "Projeto Pronto!"; 
        progressFill.style.color = '#ffffff';
        progressFill.style.textAlign = 'center';
        progressFill.style.backgroundColor = 'var(--success)'; // Corrigido
    } else {
        progressFill.textContent = '';
        progressFill.style.backgroundColor = 'var(--primary)'; // Corrigido
    }
    // >>>>> FIM DA CORRE√á√ÉO <<<<<
};

        // ==========================================================
        // >>>>> SUBSTITUA SUA FUN√á√ÉO setupInputTabs POR ESTA <<<<<
        // ==========================================================
        const setupInputTabs = () => {
            const nav = document.getElementById('inputTabsNav');
            if (!nav) return;

            const tabButtons = nav.querySelectorAll('.tab-button');
            const tabPanes = document.getElementById('inputTabContent').querySelectorAll('.tab-pane');

            nav.addEventListener('click', (event) => {
                const button = event.target.closest('.tab-button');
                if (!button) return;

                // 1. Remove a classe ativa de TODOS os bot√µes
                tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                
                // 2. Esconde TODOS os pain√©is de conte√∫do
                tabPanes.forEach(pane => pane.classList.add('hidden'));

                // 3. Adiciona a classe ativa APENAS no bot√£o clicado
                button.classList.add('tab-active');
                
                // 4. Mostra APENAS o painel de conte√∫do correspondente
                const tabId = button.getAttribute('data-tab');
                const activePane = document.getElementById(tabId);
                if (activePane) {
                    activePane.classList.remove('hidden');
                }
            });
        };

        const handleConclusionStrategyChange = () => {
            const conclusionSpecificsContainer = document.getElementById('conclusionInputContainer');
            const answerRadioButtonLabel = document.querySelector('input[value="answer"]').parentElement;
            const answerRadioButton = document.querySelector('input[value="answer"]');

            // 1. L√≥gica para desabilitar a op√ß√£o "Responder Pergunta" se n√£o houver pergunta
            const centralQuestionText = document.getElementById('centralQuestion').value.trim();
            if (!centralQuestionText) {
                answerRadioButton.disabled = true;
                answerRadioButtonLabel.classList.add('opacity-50', 'cursor-not-allowed');
                answerRadioButtonLabel.title = "Defina a 'Pergunta Central' nos campos principais para usar esta op√ß√£o.";
                // Se a op√ß√£o desabilitada estava selecionada, muda para a primeira
                if(answerRadioButton.checked) {
                    document.querySelector('input[value="lesson"]').checked = true;
                }
            } else {
                answerRadioButton.disabled = false;
                answerRadioButtonLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                answerRadioButtonLabel.title = "";
            }
            
            const selectedValue = document.querySelector('input[name="conclusionType"]:checked').value;
            
            // 2. L√≥gica para mostrar/esconder o textarea e mudar o placeholder
            if (conclusionSpecificsContainer) {
                conclusionSpecificsContainer.classList.toggle('hidden', !['lesson', 'answer', 'cliffhanger'].includes(selectedValue));
            }
            
            const textarea = document.getElementById('conclusionSpecifics');
            if (textarea) {
                const placeholders = {
                    lesson: "Ex: A li√ß√£o √© que a resili√™ncia √© a nossa maior for√ßa...",
                    answer: "Ex: A resposta √© que a Arca foi levada para a Eti√≥pia, mas o verdadeiro segredo √©...",
                    cliffhanger: "Ex: ...mas se a Arca foi encontrada, o que aconteceu com o que estava DENTRO dela?"
                };
                textarea.placeholder = placeholders[selectedValue] || "";
            }
        };

        /**
         * Alterna a visibilidade de um corpo de acorde√£o e a rota√ß√£o de sua seta. (VERS√ÉO CORRIGIDA E ROBUSTA)
         * @param {string} bodyId - O ID do elemento do corpo do acorde√£o.
         * @param {string} arrowId - O ID do elemento da seta do acorde√£o.
         */
        window.toggleAccordion = (bodyId, arrowId) => {
            const body = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            // CORRE√á√ÉO: Encontra o cabe√ßalho subindo na √°rvore DOM
            const header = body ? body.closest('.accordion-item').querySelector('.accordion-header') : null;

            if (body && arrow && header) {
                const isOpen = body.classList.toggle('open');
                arrow.classList.toggle('open', isOpen);
                header.classList.toggle('active', isOpen);
            }
        };

        /**
 * Renderiza a p√°gina correta de prompts para uma determinada se√ß√£o. (VERS√ÉO CORRIGIDA)
 * @param {string} sectionElementId - O ID da se√ß√£o (ex: 'introSection').
 */
// ====================================================================================
// >>>>> VERS√ÉO FINAL DE renderPaginatedPrompts (COM CENA E TEMPO CORRIGIDOS) <<<<<
// ====================================================================================
const renderPaginatedPrompts = (sectionElementId) => {
    const sectionElement = document.getElementById(sectionElementId);
    if (!sectionElement) return;

    const itemsPerPage = 4;
    const prompts = (window.allImagePrompts && window.allImagePrompts[sectionElementId]) || [];
    if (prompts.length === 0) return;
    
    const currentPage = (window.promptPaginationState && window.promptPaginationState[sectionElementId]) || 0;
    const totalPages = Math.ceil(prompts.length / itemsPerPage);
    const promptItemsContainer = sectionElement.querySelector('.prompt-items-container');
    const navContainer = sectionElement.querySelector('.prompt-nav-container');

    if (!promptItemsContainer || !navContainer) return;
    promptItemsContainer.innerHTML = '';

    // L√≥gica para mem√≥ria de tempo e numera√ß√£o de cena (mantida)
    let cumulativeSeconds = 0;
    let globalSceneCounter = 1;
    const sectionOrder = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'];
    const currentSectionIndex = sectionOrder.indexOf(sectionElementId);

    for (let i = 0; i < currentSectionIndex; i++) {
        const prevPrompts = (window.allImagePrompts && window.allImagePrompts[sectionOrder[i]]) || [];
        prevPrompts.forEach(p => {
            cumulativeSeconds += parseInt(p.estimated_duration, 10) || 0;
        });
        globalSceneCounter += prevPrompts.length;
    }
    const startIndex = currentPage * itemsPerPage;
    prompts.slice(0, startIndex).forEach(p => {
        cumulativeSeconds += parseInt(p.estimated_duration, 10) || 0;
    });
    globalSceneCounter += startIndex;
    
    const promptsToShow = prompts.slice(startIndex, startIndex + itemsPerPage);

    promptsToShow.forEach((promptData, index) => {
        const minutes = Math.floor(cumulativeSeconds / 60);
        const seconds = cumulativeSeconds % 60;
        const timestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        const sceneNumber = globalSceneCounter + index;

        // <<<< AQUI EST√Å A MUDAN√áA-CHAVE >>>>
        // 1. Montamos o prompt completo para a c√≥pia APENAS se o sinalizador for true.
        const fullPromptText = promptData.applyStyleBlock
            ? `${promptData.imageDescription} ${CINEMATIC_STYLE_BLOCK}`
            : promptData.imageDescription;
        
        // 2. Verificamos o sinalizador para decidir se mostramos o texto na tela.
        const styleIndicatorHtml = promptData.applyStyleBlock
            ? `<p class="style-block-indicator">[Estilo Cinematogr√°fico Aplicado]</p>`
            : '';
        // <<<< FIM DA MUDAN√áA >>>>

        const promptHtml = `
            <div class="prompt-item card !p-3 animate-fade-in">
                <div class="prompt-header">
                    <span class="tag tag-scene"><i class="fas fa-film mr-2"></i>Cena ${String(sceneNumber).padStart(2, '0')}</span>
                    <span class="tag tag-time"><i class="fas fa-clock mr-2"></i>${timestamp}</span>
                    <button class="copy-btn-small" 
                            onclick="window.copyTextToClipboard(this.closest('.prompt-item').querySelector('.full-prompt-hidden').textContent); window.showCopyFeedback(this)" 
                            title="Copiar Prompt Completo">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <p class="paragraph-preview">"${DOMPurify.sanitize(promptData.scriptPhrase)}"</p>
                <div class="prompt-details">
                    <p class="prompt-label">${imageDescriptionLabels[elements.languageSelect.value] || 'Image Description:'}</p>
                    <p>${DOMPurify.sanitize(promptData.imageDescription)}</p>
                    ${styleIndicatorHtml}
                    <pre class="full-prompt-hidden hidden">${DOMPurify.sanitize(fullPromptText)}</pre>
                </div>
            </div>
        `;
        promptItemsContainer.innerHTML += promptHtml;

        cumulativeSeconds += parseInt(promptData.estimated_duration, 10) || 0;
    });
    
    // Renderiza√ß√£o da Navega√ß√£o (mantida)
    navContainer.innerHTML = `
        <button class="btn btn-secondary btn-small" onclick="window.navigatePrompts('${sectionElementId}', -1)" ${currentPage === 0 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
        <span class="text-sm font-medium">P√°gina ${currentPage + 1} de ${totalPages}</span>
        <button class="btn btn-secondary btn-small" onclick="window.navigatePrompts('${sectionElementId}', 1)" ${currentPage + 1 >= totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
};

/**
 * Valida se o array de prompts recebido da IA tem a estrutura correta.
 * @param {any} data - O dado parseado do JSON.
 * @returns {boolean} - True se for um array v√°lido de prompts, false caso contr√°rio.
 */
const validatePromptsArray = (data) => {
    // √â um array? Ele n√£o est√° vazio? O primeiro item √© um objeto com as chaves que precisamos?
    return Array.isArray(data) && data.length > 0 && data.every(item => 
        item && typeof item === 'object' && 'scriptPhrase' in item && 'imageDescription' in item
    );
};




// =========================================================================
// >>>>> VERS√ÉO REATORADA E CORRIGIDA de 'resetGeneratedScriptContent' <<<<<
// =========================================================================
/**
 * Reseta o conte√∫do do roteiro gerado quando um input estrat√©gico √© alterado.
 * @param {string} sourceId - O ID do elemento que causou a mudan√ßa.
 */
const resetGeneratedScriptContent = (sourceId) => {
    // 1. L√ä DO AppState: Verifica se j√° existe um esbo√ßo gerado.
    if (!AppState.generated.strategicOutline && !document.querySelector('#scriptSectionsContainer .accordion-item')) {
        return; // S√≥ reseta se j√° houver conte√∫do gerado
    }

    console.log(`Input estrat√©gico '${sourceId}' alterado. Resetando conte√∫do do roteiro.`);

    // 2. LIMPA O AppState: Apaga os dados gerados que dependem da estrat√©gia.
    AppState.generated.strategicOutline = null;
    AppState.generated.imagePrompts = {};
    AppState.ui.promptPaginationState = {};
    
    // Zera o script, mas mant√©m a estrutura de objeto
    Object.assign(AppState.generated.script, {
        intro: { html: null, text: null },
        development: { html: null, text: null },
        climax: { html: null, text: null },
        conclusion: { html: null, text: null },
        cta: { html: null, text: null }
    });


    // 3. LIMPA A UI: Atualiza a interface para refletir o estado limpo.
    const outlineContent = document.getElementById('outlineContent');
    if (outlineContent) {
        outlineContent.innerHTML = `<div class="asset-card-placeholder">A estrat√©gia mudou. Clique em 'Criar Esbo√ßo' novamente.</div>`;
    }

    const scriptContainer = document.getElementById('scriptSectionsContainer');
    if (scriptContainer) {
        scriptContainer.innerHTML = ''; // Limpa completamente. O esbo√ßo vai recriar os placeholders.
    }
    
    // 4. ATUALIZA A UI GERAL: Garante que a barra de progresso e bot√µes estejam corretos.
    updateProgressBar();
    updateButtonStates();
    
    const sourceLabel = document.querySelector(`label[for='${sourceId}']`)?.textContent.replace(':', '') || sourceId;
    window.showToast(`'${sourceLabel}' mudou. O roteiro foi resetado.`, 'info');

};




// =========================================================================
// >>>>> VERS√ÉO REATORADA E CORRIGIDA de 'invalidateAndClearPrompts' <<<<<
// =========================================================================
/**
 * Invalida e limpa os prompts de imagem de uma se√ß√£o quando seu texto √© alterado.
 * Agora, opera diretamente no AppState.
 * @param {HTMLElement} sectionElement - O elemento da se√ß√£o (ex: o div com id="introSection").
 */
const invalidateAndClearPrompts = (sectionElement) => {
    if (!sectionElement) return;

    const sectionId = sectionElement.id;
    const promptContainer = sectionElement.querySelector('.prompt-container');

    // 1. ATUALIZA O AppState: Remove os prompts da mem√≥ria.
    if (AppState.generated.imagePrompts[sectionId]) {
        delete AppState.generated.imagePrompts[sectionId];
        console.log(`Prompts para a se√ß√£o '${sectionId}' invalidados e removidos do AppState.`);
    }
    
    // 2. ATUALIZA A UI: Limpa a interface do usu√°rio, se os prompts j√° foram renderizados.
    if (promptContainer && promptContainer.innerHTML.trim() !== '') {
        promptContainer.innerHTML = `
            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md border-l-4 border-yellow-400">
                <p class="text-sm text-yellow-700 dark:text-yellow-300 font-semibold">
                    Aten√ß√£o: O roteiro foi modificado.
                </p>
                <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                    Por favor, clique em "Gerar Prompts de Imagem" novamente para criar novos recursos visuais com base no texto atualizado.
                </p>
            </div>
        `;
    }
};





/**
         * Invalida e limpa a sugest√£o de performance, exibindo um aviso.
         */
        const invalidateAndClearPerformance = (sectionElement) => {
            if (!sectionElement) return;

            const performanceContainer = sectionElement.querySelector('.section-performance-output');
            if (performanceContainer && performanceContainer.innerHTML.trim() !== '') {
                performanceContainer.innerHTML = `
                    <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md border-l-4 border-yellow-400">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300 font-semibold">
                            Aten√ß√£o: O roteiro foi modificado.
                        </p>
                        <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                            Por favor, clique em "Sugerir Performance" novamente para criar novas anota√ß√µes com base no texto atualizado.
                        </p>
                    </div>
                `;
            }
        };

        /**
         * Lida com os cliques nas setas de navega√ß√£o dos prompts.
         * @param {string} sectionElementId - O ID da se√ß√£o.
         * @param {number} direction - -1 para a esquerda, 1 para a direita.
         */
        window.navigatePrompts = (sectionElementId, direction) => {
            const prompts = allImagePrompts[sectionElementId] || [];
            const itemsPerPage = 4;
            const totalPages = Math.ceil(prompts.length / itemsPerPage);
            let currentPage = promptPaginationState[sectionElementId] || 0;

            const newPage = currentPage + direction;

            // Valida√ß√£o dos limites
            if (newPage >= 0 && newPage < totalPages) {
                promptPaginationState[sectionElementId] = newPage;
                renderPaginatedPrompts(sectionElementId);
            }
        };
    
// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO 'generateSectionHtmlContent' INTEIRA POR ESTA <<<<<
// =========================================================================
const generateSectionHtmlContent = (sectionId, title, content) => {
    const accordionItem = document.createElement('div');
    accordionItem.className = 'accordion-item card !p-0 mb-4 animate-fade-in';

    const accordionHeader = document.createElement('div');
    accordionHeader.className = 'accordion-header';

    const accordionBody = document.createElement('div');
    accordionBody.id = `${sectionId}Body`;
    accordionBody.className = 'accordion-body';

    const headerTitleGroup = document.createElement('div');
    headerTitleGroup.className = 'header-title-group';
    const h3 = document.createElement('h3');
    h3.textContent = title;
    const timeSpan = document.createElement('span');
    timeSpan.className = 'text-xs font-normal text-gray-500';
    timeSpan.textContent = calculateReadingTime(content);
    headerTitleGroup.appendChild(h3);
    headerTitleGroup.appendChild(timeSpan);

    const headerActionsGroup = document.createElement('div');
    headerActionsGroup.className = 'header-actions-group';
    const headerButtons = document.createElement('div');
    headerButtons.className = 'header-buttons';

    const regenerateBtn = document.createElement('button');
    regenerateBtn.className = 'regenerate-btn';
    regenerateBtn.title = 'Re-gerar esta se√ß√£o';
    regenerateBtn.dataset.action = 'regenerate';
    regenerateBtn.dataset.sectionId = `${sectionId}Section`;
    regenerateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>`;

    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.title = 'Copiar Roteiro';
    copyBtn.dataset.action = 'copy';
    copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>`;
    headerButtons.appendChild(regenerateBtn);
    headerButtons.appendChild(copyBtn);

    const arrowSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    arrowSvg.id = `${sectionId}Arrow`;
    arrowSvg.setAttribute('class', 'accordion-arrow');
    arrowSvg.setAttribute('width', '16');
    arrowSvg.setAttribute('height', '16');
    arrowSvg.setAttribute('fill', 'currentColor');
    arrowSvg.setAttribute('viewBox', '0 0 16 16');
    arrowSvg.innerHTML = `<path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>`;
    
    headerActionsGroup.appendChild(headerButtons);
    headerActionsGroup.appendChild(arrowSvg);
    accordionHeader.appendChild(headerTitleGroup);
    accordionHeader.appendChild(headerActionsGroup);

    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'generated-content-wrapper';
    contentWrapper.setAttribute('contenteditable', 'true');
    contentWrapper.innerHTML = content;

    const analysisTools = document.createElement('div');
    const addChapterButtonHtml = sectionId === 'development' ? `
        <div class="tooltip-container">
            <button class="btn btn-primary btn-small" data-action="addDevelopmentChapter">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/></svg> 
                Adicionar Cap√≠tulo
            </button>
        </div>
    ` : '';
    
    // <<< AQUI EST√Å A GRANDE MUDAN√áA COM OS TOOLTIPS >>>
    const toolsHtml = `
        <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-6">
            <div class="text-center">
                <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 1: Diagn√≥stico e Criativo</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Analise, edite ou enrique√ßa o texto para m√°xima qualidade.</p>
                <div class="flex items-center justify-center gap-2 flex-wrap">
                    
                    <div class="tooltip-container">
                        <button class="btn btn-secondary btn-small" data-action="analyzeRetention" data-section-id="${sectionId}Section">Analisar Reten√ß√£o</button>
                        <span class="tooltip-text">
                            <strong>Fun√ß√£o:</strong> Diagn√≥stico.<br>
                            <strong>O que faz:</strong> Age como um "m√©dico". Ele escaneia o texto e te diz: "Aqui est√° bom, aqui tem um ponto de aten√ß√£o, e aqui tem um ponto de risco". Ele te d√° o diagn√≥stico, mas n√£o a cura.
                        </span>
                    </div>

                    <div class="tooltip-container">
                        <button class="btn btn-secondary btn-small" data-action="refineStyle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gem" viewBox="0 0 16 16"><path d="M3.1.7a.5.5 0 0 1 .4-.2h9a.5.5 0 0 1 .4.2l2.976 3.974c.149.199.224.458.224.726v1.2a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-1.2c0-.268.075-.527.224-.726L3.1.7zM1.49 4.107l-1.18-1.575a.5.5 0 0 1 .4-.8h13.56a.5.5 0 0 1 .4.8L14.51 4.107H1.49zM.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1H15v-1h-.5a.5.5 0 0 1 0-1H15v-1h-.5a.5.5 0 0 1 0-1H15v-1h.5a.5.5 0 0 1 .5-.5v-1a.5.5 0 0 1-.5.5zM2 13.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                            Refinar Estilo
                        </button>
                        <span class="tooltip-text">
                            <strong>Fun√ß√£o:</strong> Polimento.<br>
                            <strong>O que faz:</strong> Age como um "polidor de carros". Ele pega o texto inteiro, remove repeti√ß√µes e melhora a fluidez. Ele deixa o texto mais bonito e brilhante, mas n√£o muda a sua ess√™ncia.
                        </span>
                    </div>

                    <div class="tooltip-container">
                        <button class="btn btn-secondary btn-small" data-action="enrichWithData">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 2a.5.5 0 0 1 .5.5v11a.5.5 0 0 1-1 0v-11a.5.5 0 0 1 .5-.5z"/><path d="M2 7.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                            Enriquecer com Dados
                        </button>
                        <span class="tooltip-text">
                            <strong>Fun√ß√£o:</strong> Adi√ß√£o.<br>
                            <strong>O que faz:</strong> Age como um "engenheiro de refor√ßo". Voc√™ seleciona um trecho e lhe d√° uma nova informa√ß√£o (um dado, uma fonte). Ele refor√ßa aquele trecho com mais credibilidade.
                        </span>
                    </div>
                    ${addChapterButtonHtml}
                </div>
                <div id="analysis-output-${sectionId}" class="section-analysis-output mt-3 text-left"></div>
            </div>
            <div class="pt-4 border-t border-dashed border-gray-200 dark:border-gray-700 text-center">
                 <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 2: Estrutura de Narra√ß√£o</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Adicione sugest√µes de performance para guiar a narra√ß√£o.</p>
                <div class="flex items-center justify-center gap-2"><button class="btn btn-secondary btn-small" data-action="suggestPerformance" data-section-id="${sectionId}Section">Sugerir Performance</button></div>
                <div class="section-performance-output mt-3 text-left"></div> 
            </div>
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 text-center">
                <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 3: Recursos Visuais</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Crie o storyboard visual para esta se√ß√£o do roteiro.</p>
                <button class="btn btn-secondary btn-small" data-action="generate-prompts" data-section-id="${sectionId}Section">Gerar Prompts de Imagem</button>
                <div class="prompt-container mt-4 text-left"></div>
            </div>
        </div>
    `;
    analysisTools.innerHTML = DOMPurify.sanitize(toolsHtml, { ADD_TAGS: ["svg", "path", "span", "br", "strong"], ADD_ATTR: ["d", "fill", "viewBox", "xmlns", "width", "height", "class"] });
    
    accordionBody.appendChild(contentWrapper);
    accordionBody.appendChild(analysisTools);
    accordionItem.appendChild(accordionHeader);
    accordionItem.appendChild(accordionBody);

    return accordionItem;
};

    
// ============================
// >>>>> FILTRO JSON <<<<<
// ============================
const cleanGeneratedText = (text, expectJson = false, arrayExpected = false) => { // <<<< EVOLU√á√ÉO 1: Adicionado 'arrayExpected'
    if (!text || typeof text !== 'string') {
        return expectJson ? null : '';
    }

    if (!expectJson) {
        return text.trim();
    }

    // --- ETAPA ZERO (NOVA): O DETETIVE DE INTEN√á√ÉO ---
    // (Sua l√≥gica original, mantida 100%)
    let jsonString;
    const trimmedText = text.trim();
    const markdownMatch = trimmedText.match(/```(json)?\s*([\s\S]*?)\s*```/);
    if (markdownMatch && markdownMatch[2]) {
        jsonString = markdownMatch[2].trim();
    } 
    else {
        const jsonObjects = trimmedText.match(/\{[\s\S]*?\}/g);
        if (jsonObjects && jsonObjects.length > 1) {
            jsonString = `[${jsonObjects.join(',')}]`;
        } 
        else {
            const startIndex = trimmedText.search(/[\{\[]/);
            if (startIndex === -1) {
                throw new Error("A IA n√£o retornou um formato JSON reconhec√≠vel.");
            }
            jsonString = trimmedText.substring(startIndex);
        }
    }
    
    // --- A PARTIR DAQUI, AS SUAS ETAPAS ANTERIORES FORAM MANTIDAS E EVOLU√çDAS ---

    // ETAPA 2: CIRURGIA PREVENTIVA DE FECHAMENTO (Sua l√≥gica, mantida 100%)
    let openBrackets = (jsonString.match(/\[/g) || []).length;
    let closeBrackets = (jsonString.match(/\]/g) || []).length;
    let openBraces = (jsonString.match(/\{/g) || []).length;
    let closeBraces = (jsonString.match(/\}/g) || []).length;

    while (openBraces > closeBraces) { jsonString += '}'; closeBraces++; }
    while (openBrackets > closeBrackets) { jsonString += ']'; closeBrackets++; }

    // ETAPA 3: TENTATIVA INICIAL
    try {
        let parsedResult = JSON.parse(jsonString);

        // <<<< EVOLU√á√ÉO 2: A CAMADA DE SEGURAN√áA SEM√ÇNTICA >>>>
        // Se a gente esperava um array, mas a IA mandou um objeto, a gente corrige.
        if (arrayExpected && !Array.isArray(parsedResult)) {
            console.warn("Corre√ß√£o Sem√¢ntica: A IA retornou um objeto, mas um array era esperado. O resultado foi envolvido em um array.", parsedResult);
            return [parsedResult]; // Envolve o objeto solit√°rio em um array
        }
        // <<<< FIM DA EVOLU√á√ÉO 2 >>>>

        return parsedResult;

    } catch (initialError) {
        console.warn("Parse inicial falhou. Iniciando reparos...", initialError.message);
        
        // ETAPA 4: CIRURGIAS AVAN√áADAS (Sua l√≥gica, mantida 100%)
        let repairedString = jsonString; 
        try {
            repairedString = repairedString.replace(/(?<=")\s*[\r\n]+\s*(?=")/g, ',');
            repairedString = repairedString.replace(/([{,]\s*)'([^']+)'(\s*:)/g, '$1"$2"$3');
            repairedString = repairedString.replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
            repairedString = repairedString.replace(/:\s*'((?:[^'\\]|\\.)*?)'/g, ': "$1"');
            repairedString = repairedString.replace(/,\s*([}\]])/g, '$1');
            repairedString = repairedString.replace(/"\s*[;.,]\s*([,}\]])/g, '"$1');
            repairedString = repairedString.replace(/:\s*"([^"]*)"/g, (match, content) => {
                if (content.includes('"') && !content.includes('\\"')) {
                    const escapedContent = content.replace(/(?<!\\)"/g, '\\"');
                    return `: "${escapedContent}"`;
                }
                return match;
            });
            repairedString = repairedString.replace(/}\s*"/g, '},"');
            repairedString = repairedString.replace(/(?<!\\)\n/g, "\\n");
            repairedString = repairedString.replace(/[\u0000-\u001F\u007F-\u009F]/g, "");

            // ETAPA 5: TENTATIVA FINAL
            let finalParsedResult = JSON.parse(repairedString);

            // <<<< EVOLU√á√ÉO 3: APLICA A SEGURAN√áA SEM√ÇNTICA AQUI TAMB√âM >>>>
            if (arrayExpected && !Array.isArray(finalParsedResult)) {
                console.warn("Corre√ß√£o Sem√¢ntica P√≥s-Reparo: A IA retornou um objeto, mas um array era esperado. O resultado foi envolvido em um array.", finalParsedResult);
                return [finalParsedResult];
            }
            // <<<< FIM DA EVOLU√á√ÉO 3 >>>>

            return finalParsedResult;

        } catch (surgeryError) {
            console.error("FALHA CR√çTICA: A cirurgia no JSON n√£o foi bem-sucedida.", surgeryError.message);
            console.error("JSON Problem√°tico (Original):", text);
            console.error("JSON P√≥s-Cirurgia (Falhou):", repairedString);
            throw new Error(`A IA retornou um JSON com sintaxe inv√°lida que n√£o p√¥de ser corrigido.`);
        }
    }
};


// ============================
// >>>>> FILTRO JSON <<<<<
// ============================



/**
 * Analisa o texto bruto da IA, separando a narrativa principal
 * das descri√ß√µes de cena que est√£o entre par√™nteses.
 * @param {string} rawText - O texto completo retornado pela IA.
 * @returns {{narrative: string, scenes: string[]}} Um objeto com o texto narrativo limpo e um array com as descri√ß√µes de cena capturadas.
 */
const parseNarrativeAndScenes = (rawText) => {
    if (!rawText) {
        return { narrative: '', scenes: [] };
    }

    const scenes = [];
    // Esta Regex procura por par√™nteses que contenham palavras-chave como "cena", "visual", "lembre-se"
    // e captura o conte√∫do dentro deles. A flag 'gi' garante que ela procure por todo o texto.
    const sceneRegex = /\(\s*(?:Lembre-se de uma cena v√≠vida|Uma cena v√≠vida|Cena|Visual|Imagem):?\s*([^)]+)\s*\)/gi;

    // 1. Primeiro, extra√≠mos todas as cenas para o nosso array.
    let match;
    while ((match = sceneRegex.exec(rawText)) !== null) {
        scenes.push(match[1].trim());
    }

    // 2. Depois, removemos todas essas anota√ß√µes do texto para ter a narrativa limpa.
    //    Substitu√≠mos a anota√ß√£o inteira (incluindo par√™nteses) por um espa√ßo, e depois limpamos espa√ßos duplos.
    const narrative = rawText.replace(sceneRegex, ' ').replace(/\s{2,}/g, ' ').trim();

    return { narrative, scenes };
};



// =========================================================================
// >>>>> VERS√ÉO FINAL E BLINDADA DE 'removeMetaComments' <<<<<
// =========================================================================
/**
 * Remove coment√°rios meta, instru√ß√µes e formata√ß√µes indesejadas injetadas pela IA.
 * @param {string} text - O texto gerado pela IA.
 * @returns {string} O texto limpo.
 */
const removeMetaComments = (text) => {
    if (!text) return "";

    let cleanedText = text;

    // CAMADA 0: Normaliza√ß√£o inicial de quebras de linha
    // Substitui diferentes tipos de quebras de linha por \n para consist√™ncia
    cleanedText = cleanedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    // CAMADA 1: Remove pre√¢mbulos comuns que terminam com ":" (agora mais robusta)
    const lines = cleanedText.split('\n');
    if (lines.length > 0) {
        const firstLine = lines[0].trim();
        // Verifica se a primeira linha parece um pre√¢mbulo (come√ßa com letra mai√∫scula e termina com :)
        if (firstLine.length > 0 && /^[A-Z√Ä-√ö].*:$/.test(firstLine)) {
            lines.shift();
            cleanedText = lines.join('\n');
        }
    }
    cleanedText = cleanedText.trim();

    // CAMADA 2: Usa regex para remover padr√µes espec√≠ficos e indesejados (EXPANDIDA)
    const patternsToRemove = [
        // --- Padr√µes de In√≠cio/Contexto ---
        /Here is the (generated )?script for the "[^"]+" section:\s*/gi,
        /Here is the (refined )?text:\s*/gi,
        /Here is the (final )?version:\s*/gi,
        /Response:\s*/gi,
        /Output:\s*/gi,
        /^Of course(,)?\s*/i,
        /^Sure(,)?\s*/i,
        /^Certainly(,)?\s*/i,
        /^Absolutely(,)?\s*/i,
        /^I can help with that\.\s*/i,
        /^As requested\.\s*/i,
        /^Understood\.\s*/i,

        // --- Cabe√ßalhos e T√≠tulos Autom√°ticos ---
        /^\*\*roteiro anotado:\*\*\s*/im,
        /^\*\*Introdu√ß√£o:\*\*\s*/im,
        /^\*\*Desenvolvimento:\*\*\s*/im,
        /^\*\*Cl√≠max:\*\*\s*/im,
        /^\*\*Conclus√£o:\*\*\s*/im,
        /^\*\*Call to Action:\*\*\s*/im,
        /^\*\*TEXTO REFINADO:\*\*\s*/im,
        /^\*\*Refined Text:\*\*\s*/im,
        /^\s*\*\*[^*]+\*\*\s*$/gm, // "Ca√ßador de T√≠tulos" gen√©rico

        // >>>>> IN√çCIO DA CORRE√á√ÉO CIR√öRGICA <<<<<
        // Padr√£o para ca√ßar e remover anota√ß√µes como (Pausa), (Teaser), (Corte para), etc., que estejam em sua pr√≥pria linha.
        /^\s*\((Pausa|Teaser|Corte para|Transi√ß√£o|M√∫sica sobe|Efeito sonoro)\)\s*$/gim,
        // >>>>> FIM DA CORRE√á√ÉO CIR√öRGICA <<<<<

        // --- Anota√ß√µes de Roteiro/Apresenta√ß√£o (EXPANDIDO) ---
        /^\s*Presenter Notes?:\s*.*$/gim,
        /^\s*Note to Presenter:\s*.*$/gim,
        /^\s*Narrator:\s*.*$/gim,
        /^\s*Host:\s*.*$/gim,
        /^\s*Voiceover:\s*.*$/gim,
        /^\s*VO:\s*.*$/gim,
        /^\s*On-screen text:\s*.*$/gim,
        /^\s*Title Card:\s*.*$/gim,
        
        // --- Diretrizes de Formata√ß√£o (EXPANDIDO) ---
        /^\s*\[Begin\]\s*$/gim,
        /^\s*\[End\]\s*$/gim,
        /^\s*\[Scene \d+\]\s*$/gim,
        /^\s*\[Transition\]\s*$/gim,
        /^\s*\[Music\]\s*$/gim,
        /^\s*\[Sound Effect\]\s*$/gim,
        /^\s*\[Pause\]\s*$/gim,
        /^\s*\[Cue\]\s*$/gim,
        /^\s*\[Visual:\s*.*\]\s*$/gim,
        /^\s*\[Action:\s*.*\]\s*$/gim,
        /^\s*\[Character:\s*.*\]\s*$/gim,
        
        // --- Anota√ß√µes T√©cnicas ---
        /^\s*Word count:\s*\d+\s*$/gim,
        /^\s*Estimated duration:\s*.*$/gim,
        /^\s*Style:\s*.*$/gim,
        /^\s*Tone:\s*.*$/gim,
        /^\s*Keywords?:\s*.*$/gim,
        
        // --- Frases de Transi√ß√£o e Finaliza√ß√£o ---
        /^\s*In summary(,)?\s*.*$/gim,
        /^\s*To conclude(,)?\s*.*$/gim,
        /^\s*In conclusion(,)?\s*.*$/gim,
        /^\s*That's all(,)?\s*.*$/gim,
        /^\s*That's it(,)?\s*.*$/gim,
        /^\s*Thank you for listening\.\s*$/gim,
        /^\s*Let me know if you need anything else\.\s*$/gim,
        /^\s*Please let me know if you have any other requests\.\s*$/gim,
        
        // --- Padr√µes de Aspas (para casos onde a IA envolve o conte√∫do em aspas) ---
        // Este padr√£o √© mais seletivo para evitar remover aspas leg√≠timas no meio do texto
        /^"""\s*/g, // Aspas triplas no in√≠cio
        /\s*"""$/g, // Aspas triplas no final
    ];

    patternsToRemove.forEach(pattern => {
        cleanedText = cleanedText.replace(pattern, '');
    });

    // CAMADA 3: Limpeza Profunda Final
    // Remove quebras de linha m√∫ltiplas no in√≠cio e no final
    cleanedText = cleanedText.replace(/^\s*\n+|\n+\s*$/g, '');
    
    // Remove espa√ßos em branco extras no in√≠cio e no final
    cleanedText = cleanedText.trim();

    // CAMADA 4: Prote√ß√£o contra string vazia acidental
    // Se o texto foi completamente limpo, retorna uma string vazia expl√≠cita
    if (cleanedText === "") {
        return "";
    }

    // CAMADA 5: Remo√ß√£o de Aspas Envolventes (caso ainda persistam ap√≥s outras limpezas)
    // Apenas se a string inteira (ou quase) estiver entre aspas
    const trimmedForQuotes = cleanedText.trim();
    if (trimmedForQuotes.startsWith('"') && trimmedForQuotes.endsWith('"') && trimmedForQuotes.length > 1) {
        // Verifica√ß√£o adicional para evitar remover aspas no meio de uma frase v√°lida
        const contentInside = trimmedForQuotes.substring(1, trimmedForQuotes.length - 1);
        // Se n√£o houver aspas duplas n√£o escapadas no meio, √© seguro remover
        if (!/[^\\]"/.test(contentInside)) {
             cleanedText = contentInside;
        }
    }
    // Repetir para aspas simples, se necess√°rio, mas com mais cautela
    // (Geralmente menos comum da IA, mas poss√≠vel)
    // if (cleanedText.startsWith("'") && cleanedText.endsWith("'") && cleanedText.length > 1) {
    //     cleanedText = cleanedText.substring(1, cleanedText.length - 1);
    // }

    return cleanedText.trim();
};
// =========================================================================
// >>>>> FIM DA VERS√ÉO BLINDADA DE 'removeMetaComments' <<<<<
// =========================================================================




// --- IN√çCIO DO NOVO M√ìDULO DE NARRATIVA ---

const narrativeStructures = {
    storytelling: {
        documentary: "Document√°rio (Factual e Investigativo)",
        heroes_journey: "Jornada do Her√≥i (Estrutura √âpica)",
        pixar_spine: "Espinha Dorsal - Pixar (Estrutura Emocional)",
        mystery_loop: "Mist√©rio (com Loop Aberto)",
        twist: "Narrativa com Virada (Twist)"
    },
    storyselling: {
        // --- NOVAS ESTRUTURAS ADICIONADAS AQUI ---
        pas: "Problema-Agita√ß√£o-Solu√ß√£o (PAS)",
        bab: "Antes-Depois-Ponte (BAB)",
        aida: "Aten√ß√£o-Interesse-Desejo-A√ß√£o (AIDA)",
        underdog_victory: "Vit√≥ria do Azar√£o (Conex√£o e Supera√ß√£o)",
        discovery_mentor: "A Grande Descoberta / Mentor Secreto",
        if_not_found_create: "N√£o Encontrei, Ent√£o Criei (Hist√≥ria de Origem)"
    }
};

const narrativeTooltips = {
    // Storytelling
    documentary: "Constr√≥i um argumento com fatos, evid√™ncias e uma narra√ß√£o autorit√°ria. Perfeito para v√≠deos expositivos.",
    heroes_journey: "Conta uma hist√≥ria de transforma√ß√£o e supera√ß√£o. √ìtimo para narrativas inspiradoras.",
    pixar_spine: "Estrutura emocional de 8 passos (Era uma vez... todo dia... at√© que...). Perfeita para arcos de personagem r√°pidos.",
    mystery_loop: "Apresenta uma pergunta no in√≠cio e a responde no final. Excelente para reter a aten√ß√£o.",
    twist: "Constr√≥i uma expectativa e a quebra com uma revela√ß√£o surpreendente no final.",
    
    // Storyselling
    pas: "Foca em um problema que o p√∫blico tem (Problema), intensifica a dor que ele causa (Agita√ß√£o) e apresenta o seu conte√∫do/produto como a cura (Solu√ß√£o). Ideal para vendas diretas.",
    bab: "Mostra um cen√°rio 'Antes' (o mundo com o problema), um 'Depois' (o resultado ideal) e posiciona seu conte√∫do como 'a Ponte' que leva de um ao outro.",
    aida: "Cl√°ssico do marketing: primeiro captura a Aten√ß√£o, depois gera Interesse, cria o Desejo pela solu√ß√£o e, finalmente, chama para a A√ß√£o.",
    underdog_victory: "Mostra algu√©m (ou uma empresa) com limita√ß√µes que venceu contra tudo e todos. Gera alta conex√£o emocional e inspira confian√ßa.",
    discovery_mentor: "Revela um grande segredo ou uma 'descoberta' que mudou tudo, posicionando o narrador como um mentor que guia o espectador.",
    if_not_found_create: "Conta a hist√≥ria de origem de um produto ou servi√ßo, nascido de uma necessidade pessoal. 'Eu tinha esse problema, n√£o achei solu√ß√£o, ent√£o criei uma'."
};

// Objeto para o popover do "Objetivo da Narrativa" (permanece o mesmo)
const narrativeGoalTooltips = {
    storytelling: {
        title: "Storytelling (Conectar & Inspirar)",
        description: "O foco √© construir uma narrativa envolvente e emocional. O objetivo √© fazer o p√∫blico sentir, pensar e se conectar com a hist√≥ria. Ideal para document√°rios, li√ß√µes de vida e conte√∫do inspirador."
    },
    storyselling: {
        title: "Storyselling (Persuadir & Vender)",
        description: "Usa t√©cnicas de narrativa para construir um argumento e levar o p√∫blico a uma a√ß√£o espec√≠fica (comprar, inscrever-se, etc.). O foco √© resolver um problema claro para o espectador. Ideal para marketing, lan√ßamento de produtos e v√≠deos de vendas."
    }
};


   // ==========================================================
// >>>>> A√á√ÉO 1: SUBSTITUA A FUN√á√ÉO updateMainTooltip INTEIRA <<<<<
// ==========================================================
const updateMainTooltip = () => {
    const popoverTitle = document.getElementById('popoverTitle');
    const popoverDescription = document.getElementById('popoverDescription');
    const structureSelect = document.getElementById('narrativeStructure');

    if (!popoverTitle || !popoverDescription || !structureSelect) return;

    // AQUI EST√Å A CORRE√á√ÉO:
    // Se nenhuma op√ß√£o estiver selecionada (selectedIndex === -1), a fun√ß√£o para aqui.
    if (structureSelect.selectedIndex === -1) {
        // Opcional: Limpa o popover para n√£o mostrar informa√ß√£o antiga.
        popoverTitle.textContent = "Selecione uma Estrutura";
        popoverDescription.textContent = "Passe o mouse sobre uma op√ß√£o para ver sua descri√ß√£o.";
        return; 
    }

    const selectedKey = structureSelect.value;
    const selectedText = structureSelect.options[structureSelect.selectedIndex].text;
    const descriptionText = narrativeTooltips[selectedKey] || "Descri√ß√£o n√£o encontrada.";
    
    popoverTitle.textContent = selectedText;
    popoverDescription.textContent = descriptionText;
};

        const updateNarrativeStructureOptions = () => {
    const goalSelect = document.getElementById('narrativeGoal');
    const structureSelect = document.getElementById('narrativeStructure');
    if (!goalSelect || !structureSelect) return;

    const goal = goalSelect.value;
    const savedValue = structureSelect.value; // Salva o valor atual, se houver
    structureSelect.innerHTML = ''; 

    const structures = narrativeStructures[goal];
    for (const key in structures) {
       const option = document.createElement('option');
        option.value = key;
       option.textContent = structures[key];
       structureSelect.appendChild(option);
   }
    
 // Tenta restaurar o valor que estava selecionado
    if (Array.from(structureSelect.options).some(opt => opt.value === savedValue)) {
        structureSelect.value = savedValue;
    }
    
    // Chama a nossa nova fun√ß√£o para atualizar o texto do tooltip!
   updateMainTooltip();
   updateGoalPopover();
 };


 const updateGoalPopover = () => {
    const goalSelect = document.getElementById('narrativeGoal');
    const popover = document.getElementById('goalPopover');
    const popoverTitle = popover.querySelector('h4');
    const popoverDescription = popover.querySelector('p');

    if (!goalSelect || !popover || !popoverTitle || !popoverDescription) return;

    const selectedKey = goalSelect.value;
    const data = narrativeGoalTooltips[selectedKey];
    
    if (data) {
        popoverTitle.textContent = data.title;
        popoverDescription.textContent = data.description;
    }
};



// =========================================================================
// C√âREBRO ESTRAT√âGICO - √âPICO
// =========================================================================
const getBasePromptContext = () => {
    // Coleta todos os valores dos campos do formul√°rio
    const channelName = document.getElementById('channelName')?.value.trim() || "";
    const videoTheme = document.getElementById('videoTheme')?.value.trim() || "";
    const targetAudience = document.getElementById('targetAudience')?.value.trim() || "";
    const language = document.getElementById('languageSelect')?.value || "en";
    const languageStyle = document.getElementById('languageStyle')?.value || "";
    const videoObjective = document.getElementById('videoObjective')?.value || "";
    const speakingPace = document.getElementById('speakingPace')?.value || "";
    const narrativeStructure = document.getElementById('narrativeStructure')?.value || "";
    const narrativeTheme = document.getElementById('narrativeTheme')?.value.trim() || "";
    const narrativeTone = document.getElementById('narrativeTone')?.value || "";
    const narrativeVoice = document.getElementById('narrativeVoice')?.value.trim() || "";
    const shockingEndingHook = document.getElementById('shockingEndingHook')?.value.trim() || "";
    const imageStyleSelect = document.getElementById('imageStyleSelect')?.value || "";
    const customImageStyle = document.getElementById('customImageStyle')?.value.trim() || "";

    // DIETA DOS INPUTS: Limita o tamanho dos campos de texto livre para evitar sobrecarga.
    const videoDescription = (document.getElementById('videoDescription')?.value.trim() || "").slice(0, 1000);
    const centralQuestion = (document.getElementById('centralQuestion')?.value.trim() || "").slice(0, 500);
    const emotionalArc = (document.getElementById('emotionalArc')?.value.trim() || "").slice(0, 500);
    const imageDescriptionEngine = (document.getElementById('imageDescriptionEngine')?.value.trim() || "").slice(0, 500);
    const researchData = (document.getElementById('researchData')?.value.trim() || "").slice(0, 1500);
    const emotionalHook = (document.getElementById('emotionalHook')?.value.trim() || "").slice(0, 1000);

    // Monta o prompt base
    let context = `
    Voc√™ √© um ROTEIRISTA ESPECIALISTA e PESQUISADOR DE M√ÅXIMO DESEMPENHO para o canal "${channelName}". Sua √∫nica fun√ß√£o √© criar conte√∫do de v√≠deo altamente envolvente, cr√≠vel e ressonante emocionalmente, baseado nas instru√ß√µes detalhadas fornecidas.
    
    **Core Project Details:**
    - Video Topic: "${videoTheme}"
    - Target Audience: "${targetAudience}"
    - Language: "${language}"
    - Video Objective: "${videoObjective}"
                        
    **Narrative & Style Instructions:**
    - Narrative Structure to use: "${narrativeStructure}"
    - Speaking Pace: "${speakingPace}"
    `;

    if (narrativeTheme) { context += `\n- Core Theme (The Big Idea): "${narrativeTheme}"`; }
    if (narrativeTone) { context += `\n- Narrative Tone (The Feeling): "${narrativeTone}"`; }
    if (narrativeVoice) { context += `\n- Narrator's Voice (The Personality): "${narrativeVoice}"`; }
    if (shockingEndingHook) { context += `\n- Shocking Ending Hook to use: "${shockingEndingHook}"`; }
    if (videoDescription) { context += `\n\n**Additional Information & Inspiration:**\n- Inspiration/Context: "${videoDescription}"`; }
    if (centralQuestion) { context += `\n- Central Question to guide the entire script: "${centralQuestion}"`; }
    if (emotionalArc) { context += `\n- Desired Emotional Arc: "${emotionalArc}"`; }

    if (emotionalHook) {
        if (narrativeTone === 'inspirador') {
            context += `
**PROFUNDIDADE EMOCIONAL (REGRA MAIS IMPORTANTE):**
A hist√≥ria a seguir √© a √ÇNCORA EMOCIONAL CENTRAL do nosso roteiro. Para que ela n√£o pare√ßa superficial ou clich√™, voc√™ DEVE seguir a regra de ouro: "MOSTRAR, N√ÉO APENAS CONTAR".
- **Crie 'Cenas' V√≠vidas e Sensoriais:** Ao longo do roteiro, em vez de apenas mencionar o personagem ou a hist√≥ria, descreva pequenos MOMENTOS e CENAS com riqueza de detalhes sensoriais (vis√£o, som, tato).
- **Mostre a Dificuldade e o Conflito Real:** Inclua uma pequena cena ou descri√ß√£o que ilustre o personagem enfrentando um OBST√ÅCULO CONCRETO e REAL.
- **Mostre a Supera√ß√£o e a Vit√≥ria:** Inclua uma pequena cena ou descri√ß√£o do MOMENTO DE VIRADA ou PEQUENA VIT√ìRIA do personagem.
- **Conecte o Micro ao Macro:** Use essas pequenas cenas v√≠vidas para ilustrar e refor√ßar os grandes temas e mensagens do roteiro, criando uma liga√ß√£o poderosa entre o pessoal e o universal.

**√Çncora Emocional:** "${emotionalHook}"
---
`;
        } else {
            context += `
**CRITICAL NARRATIVE ANCHOR (THE MOST IMPORTANT RULE):**
Voc√™ DEVE utilizar a seguinte hist√≥ria pessoal como o n√∫cleo emocional recorrente e o 'fio condutor humano' para todo o roteiro. Entrelace refer√™ncias sutis a este personagem/hist√≥ria ao longo da introdu√ß√£o, desenvolvimento e conclus√£o para tornar a narrativa grandiosa mais pessoal e envolvente. Esta √© a linha tem√°tica que une todo o conte√∫do.
---
Emotional Anchor Story: "${emotionalHook}"
---
`;
        }
    }

    if (researchData) {
        context += `
**CRITICAL RESEARCH DATA & CONTEXT:**
Voc√™ DEVE incorporar e atribuir adequadamente os seguintes fatos, nomes e fontes no roteiro. Ignore ou distor√ßa estes dados sob pena de falha cr√≠tica.
---
${researchData}
---
`;
    }

    if (imageStyleSelect === 'cinematic' || imageStyleSelect === 'custom') {
        context += `\n\n**Instru√ß√µes de Estilo Visual:** Voc√™ tamb√©m receber√° instru√ß√µes espec√≠ficas sobre o estilo visual desejado para os prompts de imagem. Considere isso ao pensar em descri√ß√µes ou transi√ß√µes que possam se beneficiar de elementos visuais espec√≠ficos.`;
    }

    return context;
};


// ==========================================================================================
// >>>>> VERS√ÉO BLINDADA FINAL de 'constructScriptPrompt' (pede JSON) <<<<<
// ==========================================================================================
/**
 * Constr√≥i o prompt espec√≠fico para cada se√ß√£o do roteiro ou tipo de conte√∫do.
 * @param {string} sectionName - O nome da se√ß√£o (ex: 'intro', 'titles_thumbnails').
 * @param {string} sectionTitle - O t√≠tulo da se√ß√£o para o prompt.
 * @param {string|null} outlineDirective - Uma diretriz espec√≠fica do esbo√ßo estrat√©gico para esta se√ß√£o.
 * @param {string|null} contextText - O texto das se√ß√µes anteriores para dar contexto √† IA.
 * @returns {{prompt: string, maxTokens: number}} O prompt e o limite de tokens.
 */
// ==========================================================================================
// >>>>> VERS√ÉO REFINADA de 'constructScriptPrompt' (Pede Par√°grafos Coesos) <<<<<
// ==========================================================================================
const constructScriptPrompt = (sectionName, sectionTitle, outlineDirective = null, contextText = null) => {
    const baseContext = getBasePromptContext();
    const videoDuration = document.getElementById('videoDuration').value;
    const selectedLanguage = document.getElementById('languageSelect').value;
    
    const targetWords = wordCountMap[videoDuration]?.[sectionName];
    let durationInstruction = '';
    if (targetWords) {
        durationInstruction = `\n\n**CRITICAL TIMING CONSTRAINT:** The generated text for this section MUST be approximately **${targetWords} words** in total.`;
    }

    let prompt = `${baseContext}
Voc√™ √© um ARQUITETO DE ROTEIROS DE ALTA PERFORMANCE. Sua miss√£o √© escrever o texto para a se√ß√£o **"${sectionTitle}"** do roteiro.
${durationInstruction}`;

    if (contextText) {
        prompt += `
\n**CONTEXTO DO ROTEIRO EXISTENTE (PARA GARANTIR CONTINUIDADE):**
---
${contextText.slice(-4000)} 
---
Sua tarefa √© continuar a narrativa a partir daqui, sem repeti√ß√µes.`;
    }

    if (outlineDirective) {
        prompt += `\n\n**DIRETRIZ ESTRAT√âGICA OBRIGAT√ìRIA:** Siga este plano: "${outlineDirective}"`;
    }
    
    // <<< A EVOLU√á√ÉO EST√Å AQUI >>>
    prompt += `
\n**REGRAS CR√çTICAS DE FORMATA√á√ÉO (INEGOCI√ÅVEIS):**
1.  **RESPOSTA EM JSON:** Sua resposta DEVE ser um array JSON v√°lido, onde cada item do array √© uma string representando um par√°grafo do roteiro.
2.  **ESTRUTURA OBRIGAT√ìRIA DOS PAR√ÅGRAFOS:** CADA par√°grafo (cada string no array) DEVE OBRIGATORIAMENTE conter **NO M√çNIMO 4 FRASES** e agrupar uma ideia coesa. Par√°grafos com 1 ou 2 frases s√£o inaceit√°veis e ser√£o considerados uma falha na execu√ß√£o da tarefa.
3.  **CONTE√öDO PURO:** As strings devem conter APENAS o texto a ser narrado. √â PROIBIDO incluir anota√ß√µes como 'Narrador:', '(Cena: ...)', etc.
4.  **SINTAXE:** Use aspas duplas ("") para todas as strings.

**EXEMPLO DE FORMATO DE RESPOSTA PERFEITO:**
[
  "Este √© o primeiro par√°grafo, que introduz a ideia principal de forma completa. Ele cont√©m m√∫ltiplas frases que se conectam para formar um pensamento coeso. Esta √© a terceira frase para cumprir a regra.",
  "O segundo par√°grafo desenvolve essa ideia com mais detalhes, fornecendo exemplos ou aprofundando o argumento. Ele tamb√©m √© substancial e segue a regra das tr√™s frases. Sua estrutura √© fundamental para o sucesso."
]

**A√á√ÉO FINAL:** Escreva agora a se√ß√£o "${sectionTitle}", seguindo TODAS as diretrizes. Responda APENAS com o array JSON, garantindo que CADA par√°grafo tenha no m√≠nimo 4 frases.`;

    let maxTokens = 4000;

    // A l√≥gica para 'outline', 'titles_thumbnails' e 'description' permanece a mesma.
    switch (sectionName) {
        case 'outline':
            prompt = `${baseContext}
Voc√™ √© uma API de gera√ß√£o de JSON que segue regras com precis√£o cir√∫rgica. Sua √∫nica tarefa √© criar um esbo√ßo estrat√©gico para um v√≠deo.
**REGRAS INEGOCI√ÅVEIS:**
1.  **JSON PURO:** Responda APENAS com um objeto JSON v√°lido.
2.  **ESTRUTURA EXATA:** O objeto DEVE conter EXATAMENTE estas cinco chaves: "introduction", "development", "climax", "conclusion", e "cta".
3.  **VALORES:** O valor para CADA chave DEVE ser uma √∫nica string de texto (1-2 frases).
**TAREFA:** Gere o objeto JSON perfeito.`;
            maxTokens = 2000;
            break;
            
        case 'titles_thumbnails':
            prompt = `${baseContext}
**TAREFA:** Gerar 5 sugest√µes de t√≠tulos e thumbnails.
**REGRAS:**
1. **FORMATO:** Responda APENAS com um array JSON.
2. **ESTRUTURA:** Cada objeto no array deve ter 3 chaves: "suggested_title", "thumbnail_title", e "thumbnail_description".
3. **SINTAXE:** Use aspas duplas ("") para todas as chaves e valores.`;
            maxTokens = 2000;
            break;
            
        case 'description':
            const languageName = new Intl.DisplayNames([selectedLanguage], { type: 'language' }).of(selectedLanguage);
            prompt = `${baseContext}
**TAREFA:** Gerar uma descri√ß√£o otimizada e hashtags no idioma ${languageName}.
**REGRAS:** Comece com um gancho, detalhe o conte√∫do, finalize com CTA e liste 10 hashtags.
**A√á√ÉO:** Responda APENAS com a descri√ß√£o e hashtags.`;
            maxTokens = 1000;
            break;
    }
    
    return { prompt, maxTokens };
};

// ==========================================================================================
// SUBSTITUA SUA FUN√á√ÉO 'constructScriptPrompt' INTEIRA PELA VERS√ÉO FINAL E BLINDADA
// ==========================================================================================



        /**
         * Faz uma chamada √† API Groq atrav√©s de uma fun√ß√£o Netlify.
         * @param {string} prompt - O prompt a ser enviado para a IA.
         * @param {number} maxTokens - O n√∫mero m√°ximo de tokens para a resposta.
         * @returns {Promise<string>} A resposta bruta da IA.
         * @throws {Error} Se a chamada √† API falhar.
         */

// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO callGroqAPI PELA VERS√ÉO SIMPLES E DIRETA <<<<<
// =========================================================================
// index.html - Vers√£o final com Cloudflare Worker
const callGroqAPI = async (prompt, maxTokens) => {
    // >>> COLE A URL DO SEU WORKER AQUI <<<
    const workerUrl = "https://royal-bird-81cb.david-souzan.workers.dev/"; 

    const payload = { prompt, maxTokens };
    const requestOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    };

    try {
        const response = await fetch(workerUrl, requestOptions);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido do servidor.' }));
            throw new Error(`Erro da API: ${errorData.error || response.statusText}`);
        }
        const result = await response.json();
        const rawContent = result.choices?.[0]?.message?.content;
        if (rawContent) {
            return rawContent;
        } else {
            throw new Error("Resposta inesperada da API.");
        }
} catch (error) {
    console.error("Falha na chamada √† API via Worker:", error);
    // --- L√ìGICA INTELIGENTE AQUI ---
    if (error.message && error.message.toLowerCase().includes('fault filter abort')) {
        const customError = new Error("O tema ou texto que voc√™ forneceu foi bloqueado pelo filtro de seguran√ßa da IA. Por favor, tente reformular com outras palavras.");
        window.showToast(customError.message);
        throw customError;
    } else {
        window.showToast(`Falha na API: ${error.message}`);
        throw error;
    }
}
};

        /**
         * Valida os inputs essenciais antes de gerar conte√∫do.
         * @returns {boolean} True se os inputs s√£o v√°lidos, caso contr√°rio, false.
         */
             
        /**
         * Itera sobre todas as se√ß√µes do roteiro na ordem correta,
         * renumera globalmente todas as cenas E recalcula o timestamp
         * com base na dura√ß√£o estimada pela IA para cada cena.
         */
        
    
        /**
         * Escapa um objeto JSON para ser usado com seguran√ßa dentro de um atributo onclick.
         * @param {object} idea - O objeto da ideia a ser escapado.
         * @returns {string} Uma string JSON segura para HTML.
         */
        const escapeIdeaForOnclick = (idea) => {
            // Primeiro, converte o objeto para uma string JSON
            const jsonString = JSON.stringify(idea);
            // Em seguida, substitui os caracteres que quebram o HTML
            // Escapa aspas duplas, aspas simples e barras invertidas
            return jsonString.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\\/g, '&#92;');
        };

        // ==========================================================
        // ===== COLE ESTA FUN√á√ÉO FALTANTE NO SEU JAVASCRIPT =====
        // ==========================================================
        /**
         * Lida com a visibilidade da barra de a√ß√£o flutuante com base na posi√ß√£o de rolagem.
         */
        window.handleFloatingActionBar = () => {
            const bar = document.getElementById('floatingActionBar');
            // O gatilho para a barra aparecer ser√° a grade de inputs principais
            const triggerElement = document.getElementById('mainInputsTabs'); 

            if (!bar || !triggerElement) {
                return; // Sai da fun√ß√£o se os elementos n√£o existirem
            }

            // Ponto de gatilho: quando o final do 'mainInputsGrid' passar pelo topo da tela
            const triggerPoint = triggerElement.offsetTop + triggerElement.offsetHeight;

            if (window.scrollY > triggerPoint) {
                bar.classList.add('visible');
            } else {
                bar.classList.remove('visible');
            }
        };





        // =========================================================================
// >>>>> A√á√ÉO 1: SUBSTITUA A FUN√á√ÉO createScriptSectionPlaceholder COMPLETA <<<<<
// =========================================================================
/**
 * Cria e retorna o HTML de um placeholder para uma se√ß√£o do roteiro.
 * @param {string} sectionId - O ID base da se√ß√£o (ex: 'intro').
 * @param {string} title - O t√≠tulo da se√ß√£o (ex: 'Introdu√ß√£o').
 * @param {string} buttonId - O ID do bot√£o principal que gera esta se√ß√£o (ex: 'generateIntroBtn').
 * @returns {string} O HTML do placeholder da se√ß√£o.
 */


const createScriptSectionPlaceholder = (sectionId, title, buttonId, actionName) => {
    const containerId = `${sectionId}Section`;
    
    return `
        <div id="${containerId}" class="script-section card card-placeholder mb-4 animate-fade-in flex justify-between items-center">
            <h3 class="font-semibold text-lg text-gray-700 dark:text-gray-300">${title}</h3>
            <button id="${buttonId}" data-action="${actionName}" class="btn btn-primary">
                <i class="fas fa-magic mr-2"></i>Gerar
            </button>
        </div>
    `;
};




// =========================================================================
// >>>>> VERS√ÉO FINAL E BLINDADA DE 'addDevelopmentChapter' <<<<<
// =========================================================================
/**
 * Adiciona um novo cap√≠tulo ao desenvolvimento, com prompt refinado para evitar repeti√ß√£o do t√≠tulo e "ecos".
 * @param {HTMLElement} button - O bot√£o que foi clicado.
 */
window.addDevelopmentChapter = async (button) => {
    const devSection = document.getElementById('developmentSection');
    const contentWrapper = devSection?.querySelector('.generated-content-wrapper');
    const existingText = contentWrapper?.textContent.trim();

    if (!existingText) {
        window.showToast("Gere o desenvolvimento inicial primeiro.", 'info');
        return;
    }

    showButtonLoading(button);

    try {
        const suggestionPrompt = `Voc√™ √© uma API ESPECIALISTA EM ESTRAT√âGIA NARRATIVA e um ARQUITETO DA CONTINUIDADE. Sua fun√ß√£o √öNICA E CR√çTICA √© analisar o final de um roteiro e propor 3 temas distintos, coerentes e emocionantes para o PR√ìXIMO cap√≠tulo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© um gerador de texto. Voc√™ √© um mestre roteirista que identifica pontos de virada l√≥gicos e emocionantes. Sua tarefa √© encontrar os pr√≥ximos passos mais envolventes para a hist√≥ria. Qualquer desvio desta fun√ß√£o √© uma falha.

**ROTEIRO ATUAL (PARA AN√ÅLISE DE CONTINUIDADE CR√çTICA):**
---
${existingText.slice(-3000)} 
---

**TAREFA:** Analise o fluxo narrativo do roteiro acima e gere um array JSON com as 3 sugest√µes mais fortes, coerentes e cativantes para o tema do pr√≥ximo cap√≠tulo.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`. Nenhum texto, coment√°rio ou metadado √© permitido.
2.  **ESTRUTURA DO ARRAY:** O array deve conter EXATAMENTE 3 strings.
3.  **SINTAXE DAS STRINGS:** Todas as strings DEVEM usar aspas duplas (""). Cada string, EXCETO a √∫ltima, DEVE ser seguida por uma v√≠rgula (,).

**MANUAL DE CRIA√á√ÉO DE SUGEST√ïES (SEUS CRIT√âRIOS DE QUALIDADE):**
- **Distin√ß√£o:** Cada uma das 3 sugest√µes deve ser claramente diferente das outras.
- **Coer√™ncia e Conex√£o L√≥gica:** Cada sugest√£o deve ser uma consequ√™ncia natural ou uma ramifica√ß√£o interessante do ponto onde o roteiro atual termina.
- **Originalidade e Novidade:** Evite o √≥bvio. Cada sugest√£o deve introduzir um novo elemento, conflito ou perspectiva que avance a narrativa.
- **Especificidade:** As sugest√µes devem ser t√≠tulos de cap√≠tulo ou temas espec√≠ficos e acion√°veis. Evite generalidades.
    - **Exemplos BONS (Espec√≠ficos):** "A Descoberta do Di√°rio", "O Confronto com o Antigo Mentor", "O Plano B que Ningu√©m Esperava".
    - **Exemplos RUINS (Gen√©ricos):** "Mais desenvolvimento", "Uma nova reviravolta", "Aprofundar o personagem".

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
["A Batalha dos N√∫meros", "O Legado Fora de Campo", "Momentos Decisivos"]

**A√á√ÉO FINAL:** Com base no roteiro fornecido, gere o array JSON. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras.
`;
        const rawSuggestions = await callGroqAPI(suggestionPrompt, 400);
        const chapterSuggestions = cleanGeneratedText(rawSuggestions, true) || [];
        
        hideButtonLoading(button);

        const chapterTheme = await showInputDialog(
            'Adicionar Novo Cap√≠tulo',
            'Escolha uma sugest√£o da IA ou digite seu pr√≥prio tema abaixo.',
            'Ou crie um tema personalizado:',
            'Digite seu tema aqui...',
            chapterSuggestions
        );

        if (!chapterTheme) {
            window.showToast("Opera√ß√£o cancelada.", 'info');
            return;
        }

        showButtonLoading(button);

        const basePrompt = getBasePromptContext();
        const continuationPrompt = `${basePrompt}

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© um ROTEIRISTA CONTINU√çSTA DE ELITE. Sua √∫nica fun√ß√£o √© escrever o PR√ìXIMO cap√≠tulo de um roteiro existente, garantindo uma transi√ß√£o PERFEITA e a introdu√ß√£o de NOVAS informa√ß√µes. Voc√™ NUNCA repete o que j√° foi dito.

**TAREFA CR√çTICA E FOCALIZADA:**
Escrever o texto puro e narrado para o novo cap√≠tulo com o tema: "${chapterTheme}".

**ROTEIRO ESCRITO AT√â AGORA (PARA CONTEXTO CR√çTICO DE CONTINUIDADE):**
---
${existingText}
---

**REGRAS DE FORMATA√á√ÉO E CONTE√öDO (INEGOCI√ÅVEIS E ABSOLUTAS):**
1.  **RESPOSTA 100% PURA E LIMPA:** Sua resposta deve conter **APENAS e SOMENTE** o texto que ser√° dito em voz alta.
2.  **PROIBI√á√ÉO TOTAL DE FORMATA√á√ÉO EXTRA:** √â **TERMINANTEMENTE PROIBIDO** incluir qualquer tipo de anota√ß√£o, r√≥tulo ou formata√ß√£o. A viola√ß√£o desta regra resultar√° em falha. Isso inclui:
    -   **NENHUM** r√≥tulo de personagem (Ex: 'Narrador:', 'J√∫lia:')
    -   **NENHUMA** descri√ß√£o de cena (Ex: '(Cena: ...)')
    -   **NENHUMA** indica√ß√£o de √°udio (Ex: '(O som de ...)')
    -   **NENHUM** t√≠tulo de cap√≠tulo (Ex: 'Cap√≠tulo: ${chapterTheme}')
3.  **FOCO ABSOLUTO NA CONTINUIDADE E NOVIDADE:**
    -   O novo cap√≠tulo deve come√ßar **EXATAMENTE** de onde o roteiro anterior parou, como se fosse a p√°gina seguinte de um livro.
    -   √â **PROIBIDO** repetir ou parafrasear ideias, conceitos ou frases do roteiro existente. O espectador j√° viu isso.
    -   Sua miss√£o √© **AVAN√áAR A NARRATIVA**, introduzindo novas informa√ß√µes, aprofundando um argumento ou explorando novas nuances do tema "${chapterTheme}".

**A√á√ÉO FINAL E CR√çTICA:** Escreva AGORA o texto puro para o pr√≥ximo cap√≠tulo sobre "${chapterTheme}", seguindo todas as regras com m√°xima precis√£o. Responda APENAS com o texto a ser narrado.
`;
        
        const rawResult = await callGroqAPI(continuationPrompt, 4000);
        const newChapter = removeMetaComments(rawResult.trim());
        
        if (!newChapter || newChapter.trim() === "") {
             throw new Error("A IA n√£o retornou um conte√∫do v√°lido para o novo cap√≠tulo.");
        }

        const chapterTitleHtml = `<div class="font-bold text-lg mt-6 mb-3 pb-1 border-b border-gray-300 dark:border-gray-600">Cap√≠tulo: ${DOMPurify.sanitize(chapterTheme)}</div>`;
        const existingParagraphsCount = contentWrapper.querySelectorAll('div[id]').length;
        const newParagraphs = newChapter.split('\n').filter(p => p.trim() !== '');
        
        if (newParagraphs.length === 0) {
             throw new Error("O conte√∫do do cap√≠tulo n√£o p√¥de ser dividido em par√°grafos.");
        }

        const newContentWithDivs = newParagraphs.map((p, index) => 
            `<div id="development-p-${existingParagraphsCount + index}">${DOMPurify.sanitize(p)}</div>`
        ).join('');

        contentWrapper.insertAdjacentHTML('beforeend', chapterTitleHtml + newContentWithDivs);
        
        invalidateAndClearPerformance(devSection);
        invalidateAndClearPrompts(devSection);
        invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
        updateAllReadingTimes();
        
        window.showToast("Novo cap√≠tulo adicionado com sucesso!", 'success');
        contentWrapper.lastElementChild.previousElementSibling?.scrollIntoView({ behavior: 'smooth', block: 'center' });

    } catch (error) {
        console.error("Erro detalhado em addDevelopmentChapter:", error);
        window.showToast(`Falha ao adicionar cap√≠tulo: ${error.message}`);
    } finally {
        hideButtonLoading(button);
    }
};

// =========================================================================
// >>>>> FIM DA VERS√ÉO BLINDADA DE 'addDevelopmentChapter' <<<<<
// =========================================================================



        /**
         * Escapa uma string de texto plano para ser usada em um documento RTF,
         * lidando corretamente com caracteres non-ASCII e especiais.
         * @param {string} text - O texto a ser escapado.
         * @returns {string} O texto formatado para RTF.
         */
        const escapeRtf = (text) => {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                // Escapa caracteres especiais do RTF
                if (charCode === 92 || charCode === 123 || charCode === 125) { // Backslash, {, }
                    result += '\\' + text.charAt(i);
                }
                // Converte caracteres non-ASCII para o formato hexadecimal do RTF
                else if (charCode > 127) {
                    let hex = charCode.toString(16);
                    if (hex.length < 2) {
                        hex = '0' + hex;
                    }
                    result += "\\'" + hex;
                }
                // Mant√©m caracteres ASCII padr√£o
                else {
                    result += text.charAt(i);
                }
            }
            return result;
        };

        // ==========================================================
        // ================== FUN√á√ïES PRINCIPAIS ====================
        // ==========================================================
        
            const handleSuggestionMouseOver = (event) => {
            const targetParagraph = event.currentTarget;
            const suggestionGroupText = targetParagraph.dataset.suggestionGroup;
            if (!suggestionGroupText) return;

            const contentWrapper = targetParagraph.closest('.generated-content-wrapper');
            if (!contentWrapper) return;
            
            // >>>>> AQUI EST√Å A CORRE√á√ÉO CR√çTICA <<<<<
            // Escapa as aspas duplas no texto da sugest√£o antes de us√°-lo no seletor
            const safeSuggestionSelector = suggestionGroupText.replace(/"/g, '\\"');

            // Encontra todos os par√°grafos com a mesma sugest√£o (usando o seletor seguro) e os destaca
            contentWrapper.querySelectorAll(`[data-suggestion-group="${safeSuggestionSelector}"]`).forEach(p => {
                p.classList.add('highlight-group');
            });
        };

        const handleSuggestionMouseOut = (event) => {
            const targetParagraph = event.currentTarget;
            const contentWrapper = targetParagraph.closest('.generated-content-wrapper');
            if (!contentWrapper) return;
            
            // Remove o destaque de todos os par√°grafos
            contentWrapper.querySelectorAll('.highlight-group').forEach(p => {
                p.classList.remove('highlight-group');
            });
        };

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> ANALISE DE RETEN√á√ÉO <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
window.analyzeSectionRetention = async (button, sectionId) => {
    const sectionElement = document.getElementById(sectionId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');

    if (!contentWrapper || !contentWrapper.textContent.trim()) {
        window.showToast("Gere o roteiro desta se√ß√£o antes de analisar a reten√ß√£o.", 'info');
        return;
    }

    // Limpa os resultados de outras an√°lises para evitar confus√£o na UI
    invalidateAndClearPerformance(sectionElement);
    const analysisOutput = sectionElement.querySelector('.section-analysis-output');
    if(analysisOutput) analysisOutput.innerHTML = '';


    const paragraphs = Array.from(contentWrapper.querySelectorAll('div[id]'));
    if (paragraphs.length === 0) {
        window.showToast("N√£o h√° par√°grafos para analisar nesta se√ß√£o.", 'info');
        return;
    }

    showButtonLoading(button);

    try {
        const paragraphsWithIndexes = paragraphs.map((p, index) => ({
            index: index,
            text: p.textContent.trim()
        }));
        
        const basePromptContext = getBasePromptContext();

        // O NOVO PROMPT BLINDADO
        const prompt = `Voc√™ √© uma API de an√°lise de roteiro que retorna JSON.

**CONTEXTO ESTRAT√âGICO (A "ALMA" DO ROTEIRO):**
---
${basePromptContext}
---
Este contexto √© sua √öNICA b√∫ssola. TODAS as sugest√µes DEVEM estar alinhadas a ele.

**REGRAS DE RESPOSTA (JSON ESTRITO E INEGOCI√ÅVEL):**
1.  **JSON PURO:** Responda APENAS com o array JSON.
2.  **ESTRUTURA COMPLETA:** Cada objeto no array DEVE conter EXATAMENTE tr√™s chaves: "paragraphIndex" (n√∫mero), "retentionScore" ("green", "yellow", ou "red"), e "suggestion" (string).
3.  **SUGEST√ïES ESTRAT√âGICAS, N√ÉO REESCRITAS:** O valor de "suggestion" DEVE ser um CONSELHO ACION√ÅVEL sobre COMO melhorar o par√°grafo, respeitando a "alma" do roteiro. N√ÉO reescreva o texto.
    - **BOM:** "Este par√°grafo √© denso. Quebre-o com uma pergunta que conecte com a 'Pergunta Central' do v√≠deo para reengajar."
    - **RUIM:** "Reescreva para: 'Mas o que isso significa?'"
4.  **SINTAXE:** Use aspas duplas ("") para todas as chaves e valores string.

**MANUAL DE PONTUA√á√ÉO (FOCO EM ENGAJAMENTO):**
- **green:** Excelente. O par√°grafo prende a aten√ß√£o, avan√ßa a narrativa e est√° alinhado com a estrat√©gia. Sugest√£o: "Excelente fluidez e alinhamento estrat√©gico.".
- **yellow:** Ponto de Aten√ß√£o. O par√°grafo √© funcional, mas poderia ser mais impactante ou claro. O ritmo pode estar quebrando.
- **red:** Ponto de Risco. O par√°grafo √© confuso, repetitivo ou quebra o engajamento. Corre o risco de fazer o espectador sair do v√≠deo.

**DADOS PARA AN√ÅLISE:**
${JSON.stringify(paragraphsWithIndexes, null, 2)}

**A√á√ÉO:** Analise CADA par√°grafo. Retorne APENAS o array JSON perfeito.`;

        const rawResult = await callGroqAPI(prompt, 4000);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis)) {
            throw new Error("A an√°lise da IA retornou um formato inv√°lido.");
        }
        
        // A l√≥gica de agrupamento e renderiza√ß√£o continua a mesma, pois √© robusta.
        if (analysis.length > 0) {
            let currentGroup = [];
            for (let i = 0; i < analysis.length; i++) {
                const currentItem = analysis[i];
                const previousItem = i > 0 ? analysis[i - 1] : null;
                if (previousItem && currentItem.retentionScore === previousItem.retentionScore && currentItem.retentionScore !== 'green') {
                    currentGroup.push(currentItem);
                } else {
                    if (currentGroup.length > 1) {
                        const unifiedSuggestion = currentGroup[0].suggestion;
                        currentGroup.forEach(groupItem => groupItem.suggestion = unifiedSuggestion);
                    }
                    currentGroup = [currentItem];
                }
            }
            if (currentGroup.length > 1) {
                const unifiedSuggestion = currentGroup[0].suggestion;
                currentGroup.forEach(groupItem => groupItem.suggestion = unifiedSuggestion);
            }
        }
        
        const newParagraphs = paragraphs.map(p => {
            const newP = p.cloneNode(true);
            newP.className = 'retention-paragraph-live';
            newP.innerHTML = p.innerHTML.replace(/<div class="retention-tooltip">.*?<\/div>/g, '');
            p.parentNode.replaceChild(newP, p);
            return newP;
        });

        analysis.forEach((item, index) => {
            const p = newParagraphs[item.paragraphIndex];
            if (p) {
                p.classList.add(`retention-${item.retentionScore}`);
                p.dataset.suggestionGroup = item.suggestion;

                if (item.retentionScore === 'yellow' || item.retentionScore === 'red') {
                    const previousItem = index > 0 ? analysis[index - 1] : null;
                    if (!previousItem || item.suggestion !== previousItem.suggestion || (analysis.filter(s => s.suggestion === item.suggestion).length === 1)) {
                        const scoreLabels = { yellow: "PONTO DE ATEN√á√ÉO", red: "PONTO DE RISCO" };
                        const tooltipTitle = scoreLabels[item.retentionScore] || 'AN√ÅLISE';

                        const suggestionTextEscaped = item.suggestion.replace(/"/g, '\"');
                        const buttonsHtml = `
                            <div class="flex gap-2 mt-3">
                                <button class="flex-1 btn btn-primary btn-small py-1" 
                                        data-action="optimizeGroup" 
                                        data-suggestion-text="${suggestionTextEscaped}">
                                    <i class="fas fa-magic mr-2"></i> Otimizar
                                </button>
                                <button class="flex-1 btn bg-red-600 hover:bg-red-700 text-white btn-small py-1" 
                                        data-action="deleteParagraphGroup" 
                                        data-suggestion-text="${suggestionTextEscaped}">
                                    <i class="fas fa-trash-alt mr-2"></i> Deletar
                                </button>
                            </div>
                        `;
                        p.innerHTML += `<div class="retention-tooltip"><strong>${tooltipTitle}:</strong> ${DOMPurify.sanitize(item.suggestion)}${buttonsHtml}</div>`;
                    }
                }
                 p.addEventListener('mouseover', handleSuggestionMouseOver);
                 p.addEventListener('mouseout', handleSuggestionMouseOut);
            }
        });

        window.showToast("An√°lise de reten√ß√£o conclu√≠da!", 'success');

    } catch (error) {
        console.error("Erro detalhado em analyzeSectionRetention:", error);
        window.showToast(`Falha na an√°lise: ${error.message}`);
    } finally {
        hideButtonLoading(button);
    }
};

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> ANALISE DE RETEN√á√ÉO <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
         * Pega um par√°grafo, otimiza com IA e substitui seu conte√∫do.
         * (VERS√ÉO CORRIGIDA E ANEXADA AO 'WINDOW')
         */
        window.optimizeParagraph = async (paragraphId, suggestion) => {
            const paragraphElement = document.getElementById(paragraphId);
            if (!paragraphElement) return;

            const button = paragraphElement.querySelector('.retention-action-btn');
            if (button) {
                button.disabled = true;
                button.innerHTML = `<div class="loading-spinner" style="width:16px; height:16px; border-width: 2px;"></div>`;
            }

            const originalText = paragraphElement.firstChild.textContent.trim();
            const languageName = document.getElementById('languageSelect').options[document.getElementById('languageSelect').selectedIndex].text;
            const prompt = `You are an expert copywriter. Rewrite the "Original Paragraph" below based on the "Improvement Suggestion".
        
            **CRITICAL RULE: You MUST respond in ${languageName}.** Do not change the language.

             **Original Paragraph:**
             "${originalText}"

              **Improvement Suggestion:**
               "${suggestion}"

           Respond ONLY with the rewritten paragraph, in ${languageName}.`;

            try {
                const rewrittenText = await callGroqAPI(prompt, 1000);
                paragraphElement.firstChild.textContent = removeMetaComments(rewrittenText);
                
                // Feedback visual
                paragraphElement.classList.remove('retention-yellow', 'retention-red');
                paragraphElement.classList.add('retention-green');
                paragraphElement.querySelector('.retention-tooltip')?.remove();
                button?.remove();
                
                invalidateAndClearPrompts(paragraphElement.closest('.script-section'));
                invalidateAndClearPerformance(paragraphElement.closest('.script-section'));

                window.showToast("Par√°grafo otimizado!", 'success');
            } catch (error) {
                window.showToast(\Falha ao otimizar: ${error.message}`, 'error');`
                console.error("Erro detalhado em optimizeParagraph:", error);
                if (button) button.innerHTML = '‚ö†Ô∏è'; // √çcone de erro
            }
        };
    
         // ==========================================================
        // >>>>> SUGERIR PERFORMANCE <<<<<
        // ==========================================================
window.suggestPerformance = async (button, sectionId) => {
    const sectionElement = document.getElementById(sectionId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');
    const outputContainer = sectionElement?.querySelector('.section-performance-output');

    if (!contentWrapper || !contentWrapper.textContent.trim() || !outputContainer) {
        window.showToast("Gere o roteiro desta se√ß√£o primeiro.", 'info');
        return;
    }

    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;
    
    try {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contentWrapper.innerHTML;
        tempDiv.querySelectorAll('.retention-tooltip').forEach(el => el.remove());
        
        const originalParagraphs = Array.from(tempDiv.querySelectorAll('div[id]')).map(p => p.textContent.trim());

        if (originalParagraphs.length === 0) {
            throw new Error("N√£o foram encontrados par√°grafos estruturados para an√°lise.");
        }

        const batchSize = 15;
        const apiPromises = [];

        for (let i = 0; i < originalParagraphs.length; i += batchSize) {
            const paragraphBatch = originalParagraphs.slice(i, i + batchSize);
            let promptContext = '';
            paragraphBatch.forEach((p, indexInBatch) => {
                const globalIndex = i + indexInBatch;
                promptContext += `Par√°grafo ${globalIndex}: "${p}"\n\n`;
            });
            
            const prompt = `Voc√™ √© uma API de an√°lise de roteiro. Sua resposta DEVE ser um array JSON.

**REGRAS DE FORMATA√á√ÉO (INEGOCI√ÅVEIS E CR√çTICAS):**
1.  Sua resposta final DEVE ser um array JSON v√°lido.
2.  O array deve conter EXATAMENTE ${paragraphBatch.length} objetos, um para cada par√°grafo fornecido.
3.  Cada objeto DEVE ter duas chaves: "general_annotation" (string) e "emphasis_words" (um array com no m√°ximo 1 string).
4.  Se um par√°grafo n√£o necessitar de anota√ß√£o, retorne um objeto com valores vazios: {"general_annotation": "", "emphasis_words": []}.

**EXEMPLO DE RESPOSTA PERFEITA:**
[
  { "general_annotation": "[Tom de surpresa]", "emphasis_words": ["inacredit√°vel"] },
  { "general_annotation": "", "emphasis_words": [] }
]

Analise os ${paragraphBatch.length} par√°grafos a seguir e retorne o array JSON.

**ROTEIRO (LOTE ATUAL):**
${promptContext}`;
            apiPromises.push(callGroqAPI(prompt, 3000).then(res => cleanGeneratedText(res, true)));
        }

        const allBatchResults = await Promise.all(apiPromises);
        const annotations = allBatchResults.flat();

        // --- A CORRE√á√ÉO EST√Å AQUI ---
        // N√≥s n√£o lan√ßamos mais um erro. Apenas avisamos no console se houver uma discrep√¢ncia.
        if (!Array.isArray(annotations) || annotations.length !== originalParagraphs.length) { 
            console.warn(`Discrep√¢ncia no n√∫mero de anota√ß√µes: Esperado ${originalParagraphs.length}, Recebido ${annotations?.length || 0}. O processo continuar√°.`);
        }
        // -----------------------------
        
        let annotatedParagraphs = [];
        originalParagraphs.forEach((p, index) => {
            // Se a anota√ß√£o para este par√°grafo existir, use-a. Se n√£o, use um objeto vazio.
            const annotationData = (annotations && annotations[index]) ? annotations[index] : { general_annotation: '', emphasis_words: [] };
            let annotatedParagraph = p;

            if (annotationData && annotationData.emphasis_words && Array.isArray(annotationData.emphasis_words) && annotationData.emphasis_words.length > 0) {
                annotationData.emphasis_words.forEach(word => {
                    if (word && typeof word === 'string' && word.trim() !== '') {
                        const escapedWord = word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const wordRegex = new RegExp(`\\b(${escapedWord})\\b`, 'gi');
                        annotatedParagraph = annotatedParagraph.replace(wordRegex, `[√™nfase em '$1']$1`);
                    }
                });
            }
            const finalParagraph = `${annotationData.general_annotation || ''} ${annotatedParagraph}`;
            annotatedParagraphs.push(finalParagraph.trim());
        });
        
        const finalAnnotatedText = annotatedParagraphs.join('\n\n');
        const highlightedText = finalAnnotatedText.replace(/(\[.*?\])/g, '<span class="text-indigo-500 dark:text-indigo-400 font-semibold italic">$1</span>');

        outputContainer.innerHTML = `
            <div class="generated-output-box !border-l-indigo-500">
                <h5 class="output-subtitle !border-b-indigo-500/50">Sugest√£o de Performance:</h5>
                <p class="whitespace-pre-wrap">${highlightedText}</p>
            </div>`;
            
    } catch (error) {
        outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao sugerir performance: ${error.message}</p>`;
        console.error("Erro detalhado em suggestPerformance:", error);
    } finally {
        hideButtonLoading(button);
    }
};


// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO 'window.refineSectionStyle' INTEIRA POR ESTA VERS√ÉO SEGURA <<<<<
// =========================================================================

/**
 * Pega o texto de uma se√ß√£o, pede para a IA refinar o estilo (remover repeti√ß√µes, melhorar fluidez)
 * e substitui o conte√∫do original pelo texto refinado.
 * @param {HTMLElement} buttonElement - O bot√£o "Refinar Estilo" que foi clicado.
 */
window.refineSectionStyle = async (buttonElement) => {
    showButtonLoading(buttonElement);

    const sectionElement = buttonElement.closest('.script-section');
    if (!sectionElement) {
        window.showToast("Erro: Se√ß√£o do roteiro n√£o encontrada.", 'error');
        hideButtonLoading(buttonElement);
        return;
    }

    const contentWrapper = sectionElement.querySelector('.generated-content-wrapper');
    const originalText = contentWrapper?.textContent.trim();

    if (!originalText) {
        window.showToast("N√£o h√° texto para refinar nesta se√ß√£o.", 'info');
        hideButtonLoading(buttonElement);
        return;
    }

    const prompt = `Voc√™ √© um EDITOR DE ESTILO (Copy Editor) DE ALTO DESEMPENHO e um ESPECIALISTA EM FLU√çDEZ NARRATIVA. Sua tarefa √© REESCREVER o texto fornecido para elevar drasticamente sua QUALIDADE, FLU√çDEZ, IMPACTO e ORIGINALIDADE, sem alterar o significado, o tom ou a mensagem central.

**TEXTO ORIGINAL (PARA REFINAMENTO):**
---
${originalText}
---

**REGRAS DE REFINAMENTO ESTRAT√âGICAS E CR√çTICAS (SIGA EXATAMENTE):**
1.  **ELIMINA√á√ÉO RIGOROSA DE REPETI√á√ïES E REDUND√ÇNCIAS:**
    - **Identifica√ß√£o Profunda:** Analise cuidadosamente o texto para identificar N√ÉO APENAS palavras repetidas, mas tamb√©m IDEIAS, CONCEITOS e ESTRUTURAS DE FRASE repetitivas ou muito semelhantes.
    - **Remo√ß√£o/Apresenta√ß√£o Variada:** Elimine completamente as repeti√ß√µes ou, quando a ideia for essencial, reexpresse-a de forma TOTALMENTE DIFERENTE usando sin√¥nimos, met√°foras, mudan√ßas de perspectiva ou reestrutura√ß√£o completa da frase.
    - **Varia√ß√£o Sint√°tica:** Diversifique drasticamente o tamanho e a constru√ß√£o das frases. Alterne entre frases curtas e longas, simples e complexas, para criar ritmo.
2.  **OTIMIZA√á√ÉO M√ÅXIMA DA FLU√çDEZ E COES√ÉO:**
    - **Conectivos Inteligentes:** Use conectivos l√≥gicos e transi√ß√µes sutis para ligar as ideias de forma IMPECAVEL, garantindo um fluxo narrativo suave e natural.
    - **Leitura Aloud:** Certifique-se de que o texto, quando lido em voz alta, soe NATURAL, R√çTMICO e CATIVANTE. Evite travas lingu√≠sticas ou estruturas desconfort√°veis.
3.  **PRESERVA√á√ÉO ESTRITAMENTE FIEL DO CONTE√öDO ORIGINAL:**
    - **Intoc√°vel:** N√ÉO adicione novas informa√ß√µes, opini√µes, interpreta√ß√µes ou altere o significado central do texto original.
    - **Foco em Polir:** Sua √∫nica fun√ß√£o √© POLIR, APRIMORAR e REESCREVER para maior clareza e impacto, N√ÉO recriar o conte√∫do.
4.  **RESPOSTA PURA E LIMPA (SEM EXTRAS):**
    - **Apenas o Texto Refinado:** Sua resposta deve ser APENAS o texto refinado, completo. NENHUM pre√¢mbulo, coment√°rio, metatexto, explica√ß√£o ou nota adicional deve ser inclu√≠da.
    - **Formato Puro:** Retorne APENAS o conte√∫do textual final, pronto para substituir o texto original.

**A√á√ÉO FINAL:** Reescreva AGORA o texto fornecido, aplicando EXATAMENTE todas as regras acima para entregar uma vers√£o significativamente mais refinada, fluida, impactante e livre de repeti√ß√µes. Responda APENAS com o texto final refinado.
`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const refinedText = removeMetaComments(rawResult);

        const newParagraphs = refinedText.split('\n').filter(p => p.trim() !== '');
        const sectionId = sectionElement.id.replace('Section', '');
        
        const newHtml = newParagraphs.map((p, index) => 
            `<div id="${sectionId}-p-${index}">${p}</div>`
        ).join('');

        contentWrapper.innerHTML = DOMPurify.sanitize(newHtml);

        invalidateAndClearPerformance(sectionElement);
        invalidateAndClearPrompts(sectionElement);
        invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
        
        const analysisOutput = sectionElement.querySelector('.section-analysis-output');
        if (analysisOutput) {
            analysisOutput.innerHTML = '';
        }

        updateAllReadingTimes();
        window.showToast("Estilo do roteiro refinado com sucesso!", 'success');

    } catch (error) {
        console.error("Erro detalhado em refineSectionStyle:", error);
        window.showToast(`Falha ao refinar o estilo: ${error.message}`);
    } finally {
        hideButtonLoading(buttonElement);
    }
};




// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO 'applySuggestion' INTEIRA POR ESTA VERS√ÉO <<<<<
// =========================================================================
window.applySuggestion = (button) => {
    const { criterionName, problematicQuote, rewrittenQuote } = button.dataset;
    const cleanCriterionName = criterionName.trim();
    const sectionId = (window.criterionMap || {})[cleanCriterionName];
    
    if (!sectionId) {
        window.showToast(`Erro fatal: Se√ß√£o alvo para o crit√©rio '${cleanCriterionName}' n√£o foi encontrada no mapa.`);
        return;
    }

    const sectionElement = document.getElementById(sectionId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');

    if (!contentWrapper) {
        window.showToast("Erro: Container de conte√∫do do roteiro n√£o encontrado.");
        return;
    }

    let replaced = false;
    const paragraphs = contentWrapper.querySelectorAll('div[id^="' + sectionId.replace('Section','') + '-p-"]');

    paragraphs.forEach(p => {
        if (replaced) return;
        const childNodes = Array.from(p.childNodes);
        for (const node of childNodes) {
            if (node.nodeType === Node.TEXT_NODE && node.textContent.includes(problematicQuote)) {
                if (node.parentElement.classList.contains('highlight-change')) {
                    replaced = true;
                    break;
                }
                const originalTextNode = node;
                const text = originalTextNode.textContent;
                const startIndex = text.indexOf(problematicQuote);
                const textBefore = text.substring(0, startIndex);
                const textAfter = text.substring(startIndex + problematicQuote.length);
                const highlightSpan = document.createElement('span');
                highlightSpan.textContent = rewrittenQuote;
                highlightSpan.className = 'highlight-change'; 
                const nodeBefore = document.createTextNode(textBefore);
                const nodeAfter = document.createTextNode(textAfter);
                const parent = originalTextNode.parentNode;
                parent.replaceChild(nodeAfter, originalTextNode);
                parent.insertBefore(highlightSpan, nodeAfter);
                parent.insertBefore(nodeBefore, highlightSpan);
                replaced = true;
                break;
            }
        }
    });

    if (!replaced) {
        window.showToast("N√£o foi poss√≠vel aplicar a sugest√£o. O texto pode ter sido muito alterado.");
        return;
    }
    
    window.showToast("Sugest√£o aplicada com sucesso!");
    
    invalidateAndClearPerformance(sectionElement);
    invalidateAndClearPrompts(sectionElement);
    invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
    updateAllReadingTimes();

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Aplicada!';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');

    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = 'Aplicar';
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');
    }, 20000);
};



// =========================================================================
// >>>>> PASSO 2: ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT <<<<<
// =========================================================================
const applyAllSuggestions = async (button) => {
    // Encontra todos os bot√µes "Aplicar" que ainda n√£o foram clicados (n√£o est√£o desabilitados)
    const allApplyButtons = document.querySelectorAll('#analysisReportContainer button[data-action="applySuggestion"]:not(:disabled)');

    if (allApplyButtons.length === 0) {
        window.showToast("Nenhuma sugest√£o nova para aplicar.", 'info');
        return;
    }
    
    showButtonLoading(button);
    
    let appliedCount = 0;
    
    // Usamos um loop 'for...of' para poder usar 'await' e garantir que as aplica√ß√µes n√£o se sobreponham
    for (const applyBtn of allApplyButtons) {
        try {
            // Chama a nossa fun√ß√£o j√° existente e robusta
            window.applySuggestion(applyBtn);
            appliedCount++;
            
            // Uma pequena pausa para o navegador respirar entre as aplica√ß√µes
            await new Promise(resolve => setTimeout(resolve, 100)); 
        } catch (error) {
            console.error("Erro ao aplicar uma sugest√£o no modo 'Aplicar Todas':", error);
        }
    }
    
    hideButtonLoading(button);
    window.showToast(`${appliedCount} sugest${appliedCount > 1 ? '√µes' : '√£o'} aplicad${appliedCount > 1 ? 'as' : 'a'} com sucesso!`);
    
    // Desabilita o bot√£o "Aplicar Todas" ap√≥s o uso
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Tudo Aplicado!';
};



// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO 'window.enrichWithData' INTEIRA POR ESTA <<<<<
// =========================================================================

window.enrichWithData = async (buttonElement) => {
    const selection = window.getSelection();
    if (selection.rangeCount === 0 || selection.toString().trim() === '') {
        window.showToast("Por favor, selecione primeiro o trecho de texto que deseja enriquecer.", 'info');
        return;
    }
    
    userSelectionRange = selection.getRangeAt(0).cloneRange();
    const selectedText = selection.toString().trim();

    const newData = await showInputDialog(
        'Enriquecer com Dados',
        'Cole abaixo o dado, fonte ou exemplo que voc√™ quer adicionar ao trecho selecionado.',
        'Nova Informa√ß√£o:',
        'Ex: Fonte: Forbes 2023; Segundo o Dr. especialista...'
    );

    if (!newData) {
        window.showToast("Opera√ß√£o cancelada.", 'info');
        userSelectionRange = null;
        return;
    }

    showButtonLoading(buttonElement);
    const sectionElement = buttonElement.closest('.script-section');

    try {
        const prompt = `Voc√™ √© um EDITOR DE ROTEIRO DE ALTO DESEMPENHO e um ESPECIALISTA EM INTEGRA√á√ÉO DE INFORMA√á√ïES. Sua tarefa √öNICA, CR√çTICA e INEGOCI√ÅVEL √© REESCREVER um trecho de texto para integrar uma NOVA INFORMA√á√ÉO de forma TOTALMENTE NATURAL, FLU√çDA e PROFISSIONAL, sem comprometer a integridade do texto original.

**TRECHO ORIGINAL DO ROTEIRO (PARA SER REESCRITO):**
---
${selectedText}
---

**NOVA INFORMA√á√ÉO A SER INTEGRADA (DADO EXTERNO):**
---
${newData}
---

**SUA TAREFA ESTRAT√âGICA E CR√çTICA (A √öNICA E MAIS IMPORTANTE):**
- REESCREVA o "Trecho Original do Roteiro" com o OBJETIVO PRIM√ÅRIO de TECER a "Nova Informa√ß√£o a ser Integrada" de forma PERFEITAMENTE NATURAL e FLU√çDA.
- O resultado final DEVE ser um ou mais par√°grafos COESOS, BEM ESCRITOS e LOGICAMENTE INTEGRADOS.
- O texto reescrito DEVE manter o TOM, o RITMO e a MENSAGEM CENTRAL do texto original, agora ENRIQUECIDO e ATUALIZADO com o novo dado fornecido.
- A integra√ß√£o deve ser T√ÉO SUTIL que o leitor n√£o perceba uma costura; deve soar como se a informa√ß√£o sempre tivesse estado l√°.

**REGRAS ABSOLUTAMENTE INEGOCI√ÅVEIS (VIOLA√á√ïES RESULTAR√ÉO EM FALHA):**
1.  **RESPOSTA PURA E LIMPA:** Sua resposta deve ser APENAS o texto final reescrito. NENHUM outro conte√∫do (pre√¢mbulos, coment√°rios, t√≠tulos, explica√ß√µes, metadados) √© permitido.
2.  **SEM AUTO-REFER√äNCIA:** √â TERMINANTEMENTE PROIBIDO apresentar-se, falar sobre suas habilidades ou qualquer forma de metatexto.
3.  **SEM DESVIO DE TAREFA:** √â ESTRITAMENTE PROIBIDO desviar-se da tarefa precisa de reescrever e integrar. Foque exclusivamente na fus√£o perfeita dos dois textos.
4.  **PRESERVA√á√ÉO DO CONTEXTO:** N√ÉO altere o significado central ou o tom do "Trecho Original". A nova informa√ß√£o deve se encaixar como uma pe√ßa complementar, n√£o como uma substitui√ß√£o.

**A√á√ÉO FINAL:** Reescreva AGORA o trecho, integrando a nova informa√ß√£o com M√ÅXIMA habilidade e conformidade. Responda APENAS com o texto final reescrito e integrado.
`;

        const rawResult = await callGroqAPI(prompt, 1000);
        const enrichedText = removeMetaComments(rawResult);

        if (userSelectionRange) {
            selection.removeAllRanges();
            selection.addRange(userSelectionRange);
            document.execCommand('insertHTML', false, DOMPurify.sanitize(`<span class="highlight-change">${enrichedText}</span>`));
        }
        
        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
            invalidateAndClearEmotionalMap(); // <<< CHAMADA ADICIONADA AQUI
        }

        window.showToast("Texto enriquecido com sucesso!", 'success');

    } catch (error) {
        console.error("Erro detalhado em enrichWithData:", error);
        window.showToast(`Falha ao enriquecer o texto: ${error.message}`);
    } finally {
        hideButtonLoading(buttonElement);
        userSelectionRange = null;
    }
};

     
// ====================================================================================
// PASSO 9: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasGeral' PELA VERS√ÉO FINAL E TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 ideias de v√≠deo de interesse geral.
 * AGORA, ela extrai os √¢ngulos mais virais dos fatos do relat√≥rio.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasGeral = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // A MUDAN√áA PRINCIPAL: Os dados agora v√™m do objeto 'investigationData'
    // em vez de serem lidos diretamente do DOM. Isso conecta a fun√ß√£o ao fluxo de pesquisa.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA GERAL
    
const prompt = `Voc√™ √© uma API DE ELITE de Estrat√©gia de Conte√∫do Viral, especializada em transformar dados brutos em narrativas irresist√≠veis. Sua fun√ß√£o √© analisar profundamente o relat√≥rio de pesquisa e extrair os √¢ngulos mais impactantes, surpreendentes e viraliz√°veis para criar 6 ideias de v√≠deo excepcionais.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um gerador de ideias, voc√™ √© um ARQUITETO DE VIRALIDADE. Sua especialidade √© identificar padr√µes ocultos, conex√µes inesperadas e gatilhos emocionais nos dados que transformam informa√ß√µes comuns em conte√∫do altamente compartilh√°vel. Cada ideia deve ter potencial para gerar engajamento org√¢nico massivo.

**MATERIAL DE INTELIG√äNCIA (SUAS FONTES DA VERDADE):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (A BASE PARA AS IDEIAS):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Analise microscopicamente o relat√≥rio e gere um array JSON com 6 ideias de v√≠deo com POTENCIAL VIRAL M√ÅXIMO. Cada ideia deve explorar um √¢ngulo √∫nico, seja ele contraintuitivo, emocionalmente carregado ou extremamente √∫til.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "shareTriggers".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo HIPN√ìTICO):** Crie um t√≠tulo que IMPOSSIBILITE o espectador de n√£o clicar. Use:
  * N√∫meros espec√≠ficos (ex: "7 Fatos Que...")
  * Perguntas desafiadoras (ex: "Voc√™ Sabia Que...?")
  * Declara√ß√µes contraintuitivas (ex: "O Contr√°rio do Que Voc√™ Pensa...")
  * Palavras de poder (ex: "Revelado", "Explicado", "Segredo")

- **"angle" (√Çngulo √öNICO E IMPACTANTE):** A ess√™ncia da ideia em uma frase poderosa. Deve ser:
  * Contr√°rio ao senso comum ou uma revela√ß√£o surpreendente
  * Uma conex√£o inesperada entre dois fatos do relat√≥rio
  * Uma perspectiva que ningu√©m mais considerou
  * Focado no benef√≠cio emocional ou pr√°tico para o espectador

- **"targetAudience" (P√∫blico-Alvo HIPERESPEC√çFICO):** Defina EXATAMENTE quem ser√° impactado por esta ideia. Seja:
  * Demogr√°fico (ex: "Profissionais de 25-35 anos")
  * Psicogr√°fico (ex: "Pessoas que buscam autoconhecimento")
  * Comportamental (ex: "Quem compartilha conte√∫do educativo")
  Evite generalidades como "pessoas interessadas no tema".

- **"viralityScore" (Nota de Potencial VIRAL):** Avalie de 1-10 baseado em:
  * Qu√£o contraintuitivo ou surpreendente √© o √¢ngulo
  * Potencial de gerar debate ou discuss√£o
  * Probabilidade de compartilhamento como "curiosidade"
  * Relev√¢ncia para momentos atuais ou tend√™ncias

- **"videoDescription" (DESCRI√á√ÉO IRRESIST√çVEL):** Uma sinopse de **pelo menos 5 frases** que deve:
  1. Come√ßar com um gancho que gere curiosidade imediata
  2. Apresentar 2-3 fatos espec√≠ficos e impactantes do relat√≥rio
  3. Construir uma narrativa com come√ßo, meio e fim
  4. Incluir pelo menos um "momento uau" ou revela√ß√£o surpreendente
  5. Terminar com um call-to-action impl√≠cito para compartilhamento

- **"shareTriggers" (GATILHOS DE COMPARTILHAMENTO):** Liste 2-3 raz√µes espec√≠ficas pelas quais as pessoas compartilhariam este v√≠deo:
  * "Vou compartilhar porque me fez questionar minhas cren√ßas"
  * "Vou compartilhar porque meus amigos precisam saber disso"
  * "Vou compartilhar porque √© uma informa√ß√£o impressionante para conversas"

**A√á√ÉO FINAL:** Analise AGORA o relat√≥rio com a mentalidade de um ca√ßador de viralidade. Identifique os 6 √¢ngulos mais potentes e transforme-os em ideias completas. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);
        
        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista Geral n√£o retornou ideias no formato esperado.");
        }
        
        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // A l√≥gica de renderiza√ß√£o √© a mesma que voc√™ j√° tinha, garantindo consist√™ncia visual.
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-emerald-500'; // Cor padr√£o
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-emerald-500 bg-emerald-100 dark:bg-emerald-900/50 dark:text-emerald-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista Geral:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO FINAL: SUBSTITUA SUA FUN√á√ÉO 'unravelEnigmasBiblico' INTEIRA POR ESTA VERS√ÉO
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 ideias de enigmas b√≠blicos.
 * AGORA, ela conecta os fatos do relat√≥rio com passagens b√≠blicas.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const unravelEnigmasBiblico = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO CORRIGIDO E BLINDADO DO ESPECIALISTA B√çBLICO
const prompt = `
Voc√™ s√£o TR√äS ESPECIALISTAS TRABALHANDHO EM SINERGIA:
1. Um Te√≥logo Investigativo com doutorado em Hermen√™utica B√≠blica e especializa√ß√£o em contextos hist√≥ricos do Antigo e Novo Testamento
2. Um Arque√≥logo especializado em descobertas que corroboram narrativas b√≠blicas
3. Um Comunicador Mestre que transforma conceitos complexos em narrativas virais

**MISS√ÉO COLETIVA:** Gerar 6 ideias de v√≠deos extraordin√°rios que criem pontes revolucion√°rias entre descobertas recentes, textos b√≠blicos e quest√µes teol√≥gicas contempor√¢neas, produzindo conte√∫do que seja ao mesmo tempo academicamente respeit√°vel e viralmente compartilh√°vel.

**IDENTIDADE E ESPECIALIZA√á√ÉO:** Voc√™s formam o "COLETIVO HERMEN√äUTICO", um grupo renomado por desvendar camadas profundas das Escrituras atrav√©s de lentes multidisciplinares, sempre mantendo a integridade do texto b√≠blico enquanto exploram interpreta√ß√µes inovadoras.

**MATERIAL DE INTELIG√äNCIA (A BASE PARA A INVESTIGA√á√ÉO):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (CONTEXTO HIST√ìRICO/CIENT√çFICO/ARQUEOL√ìGICO):**
---
${rawReport}
---
- **CONTEXTUALIZA√á√ÉO TEOL√ìGICA:** Considerem as seguintes dimens√µes teol√≥gicas que podem dialogar com o relat√≥rio: 
  * Cristologia: Como a descoberta dialoga com o entendimento de Cristo, sua mensagem e minist√©rio?
  * Escatologia: A descoberta lan√ßa nova luz sobre profecias ou expectativas escatol√≥gicas?
  * Hermen√™utica: Como isso afeta nossa interpreta√ß√£o de passagens-chave?
  * Eclesiologia: Quais implica√ß√µes para a compreens√£o da Igreja e sua miss√£o?
  * Soteriologia: A descoberta traz novos insights sobre a natureza da salva√ß√£o?

**TAREFA CR√çTICA:** Sua miss√£o √© gerar 6 ideias de v√≠deos que transcendam conex√µes superficiais, criando pontes teol√≥gicas profundas entre os DADOS do relat√≥rio e as Escrituras. Cada ideia deve representar uma perspectiva teol√≥gica distinta e complementar.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (INEGOCI√ÅVEIS):**
1. **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido.
2. **ESTRUTURA AMPLIADA:** Cada objeto no array deve conter EXATAMENTE estas 8 chaves: "title", "angle", "targetAudience", "viralityScore", "theologicalDepth", "scripturalFoundation", "videoDescription", e "discussionQuestions".
3. **SINTAXE DAS STRINGS:** Todas as chaves e todos os valores do tipo string DEVEM usar aspas duplas (""). Se precisar usar aspas duplas dentro de uma string, elas DEVEM ser escapadas com uma barra invertida (por exemplo, \\"uma cita√ß√£o\\").
4. **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**

- **"title" (T√≠tulo Cativante e Teol√≥gico):** Deve prometer uma revela√ß√£o transformadora que conecte a descoberta com uma verdade b√≠blica profunda. Use linguagem que desperte curiosidade intelectual e espiritual simultaneamente.

- **"angle" (O Enigma Central):** Uma frase complexa que apresente uma conex√£o inovadora entre um FATO do relat√≥rio, uma PASSAGEM B√çBLICA e uma IMPLICA√á√ÉO TEOL√ìGICA. Ex: "Como a descoberta de [DADO DO RELAT√ìRIO] em [LOCAL] desafia nossa compreens√£o tradicional de [PASSAGEM B√çBLICA] e sugere uma nova perspectiva sobre [CONCEITO TEOL√ìGICO]?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Descreva com precis√£o o nicho de espectador. Ex: "Pastores e l√≠deres crist√£os buscando conte√∫do teologicamente s√≥lido", "Estudantes de teologia interessados em di√°logo f√©-ci√™ncia", "Crist√£os leigos com interesse em arqueologia b√≠blica".

- **"viralityScore" (Nota de Revela√ß√£o):** Uma nota de 1 a 10 para o potencial da ideia de gerar DEBATE TEOL√ìGICO e compartilhamento, considerando tanto o aspecto acad√™mico quanto o emocional.

- **"theologicalDepth" (Profundidade Teol√≥gica):** Uma nota de 1 a 10 que avalia a profundidade e originalidade das conex√µes teol√≥gicas estabelecidas.

- **"scripturalFoundation" (Fundamenta√ß√£o B√≠blica):** Liste 3-5 refer√™ncias b√≠blicas-chave que sustentam a explora√ß√£o teol√≥gica proposta, incluindo pelo menos uma do Antigo Testamento e uma do Novo Testamento.

- **"videoDescription" (DESCRI√á√ÉO INVESTIGATIVA RICA):** Escreva uma sinopse de **pelo menos 7 frases** que construa uma narrativa intelectualmente estimulante. A descri√ß√£o deve:
    1. Apresentar o mist√©rio central, citando a passagem b√≠blica principal.
    2. Contextualizar a descoberta arqueol√≥gica/cient√≠fica relevante.
    3. Explorar as implica√ß√µes teol√≥gicas preliminares dessa conex√£o.
    4. Apresentar uma perspectiva teol√≥gica inovadora que desafia entendimentos convencionais.
    5. Discutir como essa nova compreens√£o afeta a aplica√ß√£o pr√°tica da f√©.
    6. Sugerir poss√≠veis obje√ß√µes e como seriam abordadas.
    7. Terminar com uma pergunta provocativa que incentive tanto a reflex√£o teol√≥gica quanto a discuss√£o pr√°tica.

- **"discussionQuestions" (Quest√µes para Di√°logo):** Formule 3 perguntas profundas que estimulem o engajamento do espectador, incluindo:
    * Uma quest√£o teol√≥gica acad√™mica
    * Uma quest√£o de aplica√ß√£o pr√°tica
    * Uma quest√£o que convida √† reflex√£o espiritual pessoal

**FRAMEWORK CRIATIVO ADICIONAL:**
Para cada ideia, considerem estas quatro dimens√µes:
1. **DIMENS√ÉO HIST√ìRICA:** Como a descoberta lan√ßa nova luz sobre o contexto hist√≥rico original?
2. **DIMENS√ÉO EXEG√âTICA:** Como isso afeta nossa compreens√£o do texto em seu contexto original?
3. **DIMENS√ÉO TEOL√ìGICA:** Quais implica√ß√µes doutrin√°rias surgem desta conex√£o?
4. **DIMENS√ÉO CONTEMPOR√ÇNEA:** Como isso se aplica √† experi√™ncia de f√© hoje?

**A√á√ÉO FINAL:** Como Coletivo Hermen√™utico, desvende conex√µes teol√≥gicas ousadas e gere as 6 ideias. Busquem o equil√≠brio entre rigor acad√™mico e acessibilidade popular. Responda APENAS com o array JSON perfeito.
`;


    
    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);
        
        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em Enigmas B√≠blicos n√£o retornou ideias no formato esperado.");
        }
        
        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-purple-500'; // Cor para Enigmas
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-purple-500 bg-purple-100 dark:bg-purple-900/50 dark:text-purple-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Enigmas:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};



// =========================================================================
// >>>>> A√á√ÉO 1: ADICIONE A FUN√á√ÉO `selectIdea` QUE ESTAVA FALTANDO <<<<<
// =========================================================================
/**
 * Preenche os campos do formul√°rio principal com a ideia de v√≠deo selecionada.
 * @param {object} idea - O objeto da ideia contendo t√≠tulo, descri√ß√£o, etc.
 */
const selectIdea = (idea) => {
    // --- 1. PREENCHIMENTO DOS CAMPOS ---
    document.getElementById('videoTheme').value = idea.title || '';
    document.getElementById('videoDescription').value = idea.videoDescription || '';
    document.getElementById('targetAudience').value = idea.targetAudience || '';
    document.getElementById('narrativeTheme').value = idea.angle || '';

    // --- 2. LIMPEZA ESTRAT√âGICA ---
    document.getElementById('centralQuestion').value = '';
    document.getElementById('emotionalHook').value = '';
    document.getElementById('narrativeVoice').value = '';
    document.getElementById('emotionalArc').value = '';
    document.getElementById('shockingEndingHook').value = '';

    // --- 3. MELHORIA DA EXPERI√äNCIA DO USU√ÅRIO (UX) ---
    const targetElement = document.getElementById('inputTabsNav');
    if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    window.showToast("Ideia selecionada! Estrat√©gia pr√©-preenchida. Revise e ajuste.", 'success');
};


// =========================================================================
// >>>>> VERS√ÉO FINAL de 'handleGenerateSection' (Processa Array JSON) <<<<<
// =========================================================================
const handleGenerateSection = async (button, sectionName, sectionTitle, elementId) => {
    if (!validateInputs()) return;

    if (!AppState.generated.strategicOutline && sectionName !== 'intro') {
        window.showToast("Crie o Esbo√ßo Estrat√©gico primeiro!", 'info');
        return;
    }

    showButtonLoading(button);
    const targetSectionElement = document.getElementById(`${elementId}Section`);

    try {
        // L√≥gica para montar contexto (sem mudan√ßas)
        let contextText = null;
        const sectionOrder = ['intro', 'development', 'climax'];
        const currentSectionIndex = sectionOrder.indexOf(elementId);
        if (currentSectionIndex > 0) {
            const prevSectionsContent = sectionOrder.slice(0, currentSectionIndex).map(id => {
                const section = AppState.generated.script[id];
                if (!section || !section.text) throw new Error(`Se√ß√£o anterior '${id}' n√£o gerada.`);
                return section.text;
            });
            contextText = prevSectionsContent.join('\n\n---\n\n');
        }

        const keyMap = { intro: 'introduction', development: 'development', climax: 'climax' };
        const directive = AppState.generated.strategicOutline ? AppState.generated.strategicOutline[keyMap[sectionName]] : null;
        const { prompt, maxTokens } = constructScriptPrompt(sectionName, sectionTitle, directive, contextText);

        const rawResult = await callGroqAPI(prompt, maxTokens);
        
        // <<< A GRANDE MUDAN√áA: PROCESSANDO O ARRAY JSON >>>
        const paragraphs = cleanGeneratedText(rawResult, true);

        if (!Array.isArray(paragraphs) || paragraphs.length === 0) {
            console.error("Resposta da IA n√£o foi um array de par√°grafos v√°lido:", rawResult);
            throw new Error("A IA n√£o retornou o roteiro no formato de par√°grafos esperado. Tente novamente.");
        }

        const contentWithDivs = paragraphs.map((p, index) =>
            `<div id="${elementId}-p-${index}">${DOMPurify.sanitize(p)}</div>`
        ).join('');
        
        const fullText = paragraphs.join('\n\n');

        // Atualiza o estado central
        if (AppState.generated.script.hasOwnProperty(sectionName)) {
            AppState.generated.script[sectionName] = {
                html: contentWithDivs,
                text: fullText
            };
            console.log(`Estado para '${sectionName}' atualizado no AppState.`);
        }

        // Renderiza na UI
        if (targetSectionElement) {
            const sectionElement = generateSectionHtmlContent(elementId, sectionTitle, contentWithDivs);
            targetSectionElement.innerHTML = '';
            targetSectionElement.appendChild(sectionElement);
            targetSectionElement.classList.remove('card', 'card-placeholder', 'flex', 'justify-between', 'items-center');
        }

        markButtonAsCompleted(button.id);

    } catch (error) {
        window.showToast(`Falha ao gerar ${sectionTitle}: ${error.message}`);
        console.error(`Error generating ${sectionTitle}.`, error);
        if (targetSectionElement) {
             const actionName = button.dataset.action;
             targetSectionElement.innerHTML = createScriptSectionPlaceholder(elementId, sectionTitle, button.id, actionName);
        }
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};





        /**
         * Re-gera o conte√∫do de uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o.
         * @param {string} elementId - O ID do elemento HTML da sec√ß√£o.
         */
        // ==========================================================
// FUN√á√ÉO DE RE-GERA√á√ÉO CORRIGIDA
// ==========================================================
window.regenerateSection = (fullSectionId) => {
            const sectionName = fullSectionId.replace('Section', '');
            
            const sectionMap = {
    'intro': { title: 'Introdu√ß√£o', elementId: 'intro' },
    'development': { title: 'Desenvolvimento', elementId: 'development' },
    'climax': { title: 'Cl√≠max', elementId: 'climax' },
    'conclusion': { title: 'Conclus√£o', elementId: 'conclusion' }, // T√≠tulo corrigido
    'cta': { title: 'Call to Action (CTA)', elementId: 'cta' } // <<< ADICIONADO
};

            const sectionInfo = sectionMap[sectionName];
            
            if (sectionInfo) {
                // Encontra o bot√£o de re-gerar que foi clicado, em vez de um bot√£o antigo
                const button = document.querySelector(`[data-action='regenerate'][data-section-id='${fullSectionId}']`);
                if (button) {
                     handleGenerateSection(button, sectionName, sectionInfo.title, sectionInfo.elementId);
                } else {
                    console.error(`Bot√£o de re-gerar n√£o encontrado para a se√ß√£o: ${fullSectionId}`);
                }
            } else {
                console.error(`Informa√ß√µes da se√ß√£o n√£o encontradas para: ${sectionName}`);
            }
        };


// =========================================================================
// >>>>> VERS√ÉO OTIMIZADA que N√ÉO SALVA o styleBlock repetidamente <<<<<
// =========================================================================
window.generatePromptsForSection = async (button, sectionElementId) => {
    const sectionElement = document.getElementById(sectionElementId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');
    const promptContainer = sectionElement?.querySelector('.prompt-container');

    if (!contentWrapper || !contentWrapper.textContent.trim() || !promptContainer) {
        window.showToast("Gere o conte√∫do do roteiro desta se√ß√£o primeiro.");
        return;
    }

    showButtonLoading(button);
    promptContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

    try {
        const allChildren = Array.from(contentWrapper.children);
        const paragraphsWithContext = [];
        let currentChapterTitle = "Contexto Geral";
        allChildren.forEach(child => {
            if (child.classList.contains('font-bold') && child.textContent.includes('Cap√≠tulo:')) {
                currentChapterTitle = child.textContent.replace('Cap√≠tulo:', '').trim();
            } else if (child.id && child.id.includes('-p-')) {
                paragraphsWithContext.push({ text: child.textContent.trim().replace(/\[.*?\]/g, ''), chapter: currentChapterTitle, originalId: child.id });
            }
        });

        if (paragraphsWithContext.length === 0) { throw new Error("N√£o foram encontrados par√°grafos estruturados para an√°lise."); }

        // A l√≥gica de chamada da IA em lotes permanece a mesma
        const batchSize = 3;
        const apiPromises = [];
        const visualPacing = document.getElementById('visualPacing').value;
        const durationMap = { 'dinamico': '3 e 8', 'normal': '8 e 15', 'contemplativo': '15 e 25' };
        const durationRange = durationMap[visualPacing] || '3 e 8';

        for (let i = 0; i < paragraphsWithContext.length; i += batchSize) {
            const batch = paragraphsWithContext.slice(i, i + batchSize);
            let promptContextForAI = '';
            batch.forEach((item, indexInBatch) => {
                const globalIndex = i + indexInBatch;
                promptContextForAI += `\nPar√°grafo ${globalIndex}:\n- T√≠tulo do Cap√≠tulo (Guia Tem√°tico): "${item.chapter}"\n- Texto do Par√°grafo: "${item.text}"`;
            });
            
const prompt = `# INSTRU√á√ïES PARA GERA√á√ÉO DE PROMPTS VISUAIS CINEMATOGR√ÅFICOS

Voc√™ √© uma especialista em cria√ß√£o de prompts visuais cinematogr√°ficos. Sua fun√ß√£o √© analisar par√°grafos e transform√°-los em descri√ß√µes de imagem ricas em detalhes.

## REGRAS DE FORMATA√á√ÉO (OBRIGAT√ìRIAS)

1. **FORMATO JSON EXCLUSIVO**: Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com [ e terminando com ]
2. **ASPAS DUPLAS OBRIGAT√ìRIAS**: Todas as chaves e valores de texto devem usar aspas duplas (")
3. **PROIBI√á√ÉO DE ASPAS INTERNAS**: Nos valores de texto, use apenas aspas simples (') para √™nfase
4. **ESTRUTURA PADR√ÉO**: Cada objeto deve ter exatamente duas chaves:
   - "imageDescription" (string): descri√ß√£o visual detalhada
   -estimated_duration" (n√∫mero inteiro): dura√ß√£o estimada em segundos

## EXEMPLO DE FORMATA√á√ÉO CORRETA

[
  {
    "imageDescription": "Um homem solit√°rio caminha por uma rua deserta √† noite, sob a luz amarela dos postes. A c√¢mera em plano m√©dio captura sua express√£o cansada enquanto a chuva reflete nas cal√ßadas. Estilo film noir com alto contraste entre luzes e sombras.",
    "estimated_duration": 5
  },
  {
    "imageDescription": "Close-up em m√£os tr√™mulas segurando uma carta antiga. A luz da manh√£ entra pela janela, destacando a textura do papel amarelado e a caligrafia tremida. Foco shallow com fundo suavizado.",
    "estimated_duration": 3
  }
]

## CHECKLIST PARA CRIA√á√ÉO DA DESCRI√á√ÉO VISUAL

Para cada par√°grafo, crie uma descri√ß√£o visual rica respondendo a estas perguntas:

### Elementos Visuais Principais
- **Cen√°rio e Ambiente**: Onde a cena acontece? Descreva o local e atmosfera sensorial
- **Composi√ß√£o Visual**: Quais elementos principais e como est√£o organizados no quadro?
- **Ilumina√ß√£o**: Qual a qualidade, dire√ß√£o e tipo de luz?
- **Paleta de Cores**: Quais cores dominantes refletem a emo√ß√£o da cena?

### T√©cnicas Cinematogr√°ficas
- **√Çngulo da C√¢mera**: De onde olhamos a cena (plano geral, close, etc.)?
- **Estilo Visual**: Qual a est√©tica (realista, vintage, etc.)?
- **Foco e Profundidade**: O que est√° n√≠tido e o que est√° desfocado?
- **Movimento e A√ß√£o**: H√° movimento de c√¢mera ou personagens?

### Elementos Emocionais e Narrativos
- **Elementos Emocionais**: Quais elementos visuais amplificam a emo√ß√£o?
- **Express√µes Faciais**: Como os personagens expressam suas emo√ß√µes?
- **S√≠mbolos Chave**: Quais objetos ou elementos s√£o importantes para a narrativa?
- **Texturas e Materiais**: Quais texturas aumentam o realismo?

### Contexto e Atmosfera
- **Profundidade e Escala**: Como o espa√ßo √© representado?
- **Elementos Temporais ou Clim√°ticos**: Qual o momento do dia, clima ou esta√ß√£o?

## DIRETRIZES ADICIONAIS

- Priorize elementos visuais que melhor representem a ess√™ncia do par√°grafo
- Mantenha consist√™ncia de estilo entre prompts consecutivos quando aplic√°vel
- Para "estimated_duration", use valores inteiros entre ${durationRange} segundos, baseando-se na complexidade da cena
- Se o texto de entrada for amb√≠guo, fa√ßa escolhas criativas coerentes com o contexto geral

## DADOS PARA AN√ÅLISE

---
${promptContextForAI}
---

## A√á√ÉO FINAL

Com base nestas instru√ß√µes, gere exatamente ${batch.length} objetos JSON no formato especificado, seguindo rigorosamente todas as regras de formata√ß√£o.`;
            
            // Usamos a vers√£o evolu√≠da do filtro, esperando um array
            apiPromises.push(callGroqAPI(prompt, 4000).then(res => cleanGeneratedText(res, true, true)));
        }

        const allBatchResults = await Promise.all(apiPromises);
        let allGeneratedPrompts = allBatchResults.flat();

        if (!Array.isArray(allGeneratedPrompts) || allGeneratedPrompts.length < paragraphsWithContext.length) {
            throw new Error("A IA n√£o retornou um prompt para cada par√°grafo.");
        }

        const curatedPrompts = allGeneratedPrompts.map((promptData, index) => ({
            scriptPhrase: paragraphsWithContext[index].text,
            imageDescription: promptData.imageDescription || "Falha ao gerar descri√ß√£o.",
            estimated_duration: promptData.estimated_duration || 5
        }));

        // <<<< AQUI EST√Å A MUDAN√áA-CHAVE >>>>
        // 1. Verificamos se o estilo cinematogr√°fico deve ser aplicado.
        const applyCinematicStyle = document.getElementById('imageStyleSelect').value === 'cinematic';

        // 2. Salvamos no AppState APENAS a informa√ß√£o e o SINALIZADOR, n√£o o bloco de texto.
        AppState.generated.imagePrompts[sectionElementId] = curatedPrompts.map(p => ({
            ...p,
            applyStyleBlock: applyCinematicStyle // Salva 'true' ou 'false'
        }));
        // <<<< FIM DA MUDAN√áA >>>>

        // O resto da fun√ß√£o para preparar a renderiza√ß√£o continua igual
        AppState.ui.promptPaginationState[sectionElementId] = 0;
        if (typeof window.allImagePrompts === 'undefined') window.allImagePrompts = {};
        if (typeof window.promptPaginationState === 'undefined') window.promptPaginationState = {};
        window.allImagePrompts[sectionElementId] = AppState.generated.imagePrompts[sectionElementId];
        window.promptPaginationState[sectionElementId] = AppState.ui.promptPaginationState[sectionElementId];

        promptContainer.innerHTML = `
            <div class="prompt-pagination-wrapper space-y-4">
                <div class="prompt-nav-container flex items-center justify-center gap-4"></div>
                <div class="prompt-items-container space-y-4"></div>
            </div>
        `;
        renderPaginatedPrompts(sectionElementId);

    } catch (error) {
        promptContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar prompts: ${error.message}</p>`;
        console.error("Erro detalhado em generatePromptsForSection:", error);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};


// =========================================================================
// >>>>> FIM DA VERS√ÉO BLINDADA DE 'generatePromptsForSection' <<<<<
// =========================================================================



    
        /**
         * Sugere trilhas sonoras para uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionId - O ID do elemento HTML da sec√ß√£o (ex: 'introSection').
         */
        window.suggestSoundtrack = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            const scriptContent = sectionElement.querySelector('.generated-content-wrapper').textContent; 
            const soundtrackContainer = sectionElement.querySelector('.soundtrack-container');
            
            if (!scriptContent) {
                window.showToast("Gere o roteiro para esta sec√ß√£o primeiro.");
                return;
            }

            soundtrackContainer.innerHTML = `<div class="loading-spinner-small"></div>`; 

            const prompt = `Voc√™ √© um especialista em prompts para IAs de gera√ß√£o de m√∫sica (como Suno/Udio). Sua tarefa √© analisar o seguinte trecho de roteiro e criar 3 prompts de texto distintos e detalhados.

            **REGRAS DE FORMATA√á√ÉO (N√ÉO NEGOCI√ÅVEIS):**1.  Sua resposta DEVE SER um array JSON v√°lido.2.  O array deve conter EXATAMENTE 3 strings.3.  CADA string deve ser um par√°grafo √∫nico, bem escrito e descritivo, pronto para ser colado em uma IA de m√∫sica. N√ÉO use chaves, colchetes ou qualquer outra sintaxe de objeto DENTRO da string do prompt.

            **EXEMPLO DE RESPOSTA PERFEITA:**
            ["Generate an epic, cinematic orchestral piece in the style of Hans Zimmer... No vocals or percussion, focus on the emotional intensity of the strings and piano.","Create a contemplative, melancholic ambient track with a slow, mournful tempo... No bright or cheerful notes, focus on the darker, more introspective tones.","Craft an uplifting, inspirational electronic piece with a moderate tempo... avoid any jarring or harsh sounds, focusing on the soaring, inspirational quality of the melody."
            ]

                Agora, use o roteiro abaixo como inspira√ß√£o para criar 3 prompts seguindo EXATAMENTE este formato.

            Trecho do roteiro para analisar:
                    ---
                ${scriptContent}

                ---`;
            
            try {
                const rawResult = await callGroqAPI(prompt, 500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const suggestions = JSON.parse(cleanedResult);

                // Adiciona tratamento de erro para garantir que suggestions √© um array de strings
                if (!Array.isArray(suggestions) || !suggestions.every(s => typeof s === 'string')) {
                    throw new Error("A IA retornou um formato de trilha sonora inesperado. Esperava um array de strings.");
                }

                soundtrackContainer.innerHTML = ''; // Limpa o spinner
                if (suggestions && suggestions.length > 0) {
                    // Agora envolvemos a lista em um div com as classes corretas para ter um fundo e padding.
                    let suggestionsHtml = '<div class="card-background p-4 rounded-lg shadow-inner">';
                    suggestionsHtml += '<ul class="soundtrack-list">';
                    suggestions.forEach(suggestion => {
                        suggestionsHtml += `<li>${suggestion}</li>`;
                    });
                    suggestionsHtml += '</ul>';
                    suggestionsHtml += '</div>'; 

                    soundtrackContainer.innerHTML = suggestionsHtml;
                } else {
                    soundtrackContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma sugest√£o de trilha sonora foi gerada.</p>';
                }
            } catch (error) {
                soundtrackContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
                console.error("Erro detalhado em suggestSoundtrack:", error);
            }
        };

        /**
         * Copia a transcri√ß√£o para a √°rea de transfer√™ncia e
         * inicia o download de um arquivo .rtf limpo e com a codifica√ß√£o correta.
         */
        const handleCopyAndDownloadTranscript = () => {
            const transcriptText = getTranscriptOnly();

            if (!transcriptText) {
                window.showToast("Nenhum roteiro para copiar. Gere as se√ß√µes primeiro.", 'info');
                return;
            }

            copyTextToClipboard(transcriptText);
            window.showToast("Transcri√ß√£o copiada! Download do arquivo .rtf iniciado.", 'success');

            const fileName = (document.getElementById('videoTheme').value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro') + '_transcricao.rtf';
            
            // **A CORRE√á√ÉO EST√Å AQUI:**
            // 1. Escapa o texto para o formato RTF.
            // 2. Substitui as quebras de linha pelo comando de par√°grafo do RTF.
            const safeText = escapeRtf(transcriptText);
            const rtfContent = `{\\rtf1\\ansi\\deff0 {\\fonttbl{\\f0 Arial;}}\\f0\\fs24 ${safeText.replace(/\n/g, '\\par\r\n')}}`;
            
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        };


    
// =========================================================================
// >>>>> VERS√ÉO REATORADA de 'generateTitlesAndThumbnails' <<<<<
// =========================================================================
const generateTitlesAndThumbnails = async (button) => {
    if (!validateInputs()) return;
    showButtonLoading(button);

    try {
        const { prompt, maxTokens } = constructScriptPrompt('titles_thumbnails');
        
        const rawResult = await callGroqAPI(prompt, maxTokens);
        const parsedContent = cleanGeneratedText(rawResult, true);
        
        if (!Array.isArray(parsedContent) || parsedContent.length === 0 || !parsedContent[0].suggested_title) {
            throw new Error("A IA retornou os dados de t√≠tulos em um formato inesperado.");
        }

        const titles = parsedContent.map(item => item.suggested_title);
        const thumbnails = parsedContent.map(item => ({
            title: item.thumbnail_title,
            description: item.thumbnail_description
        }));
        
        // --- A MUDAN√áA EST√Å AQUI ---
        // Gravamos o resultado no nosso "c√©rebro" central.
        AppState.generated.titlesAndThumbnails = { titles, thumbnails };
        // --- FIM DA MUDAN√áA ---

        const targetContentElement = document.getElementById('titlesThumbnailsContent');
        if (targetContentElement) {
            // A l√≥gica de renderiza√ß√£o do HTML continua a mesma
            const titlesListHtml = titles.map((title, index) => `<p>${index + 1}. ${DOMPurify.sanitize(title)}</p>`).join('');
            const thumbnailsListHtml = thumbnails.map((thumb, index) => `
                <div class="thumbnail-idea"> 
                    <h4 class="font-semibold">"${DOMPurify.sanitize(thumb.title)}"</h4>
                    <p>Descri√ß√£o: ${DOMPurify.sanitize(thumb.description)}</p>
                </div>
            `).join('');

            targetContentElement.innerHTML = `
                <div class="generated-output-box">
                    <div class="output-content-block">
                        <h4 class="output-subtitle">Sugest√µes de T√≠tulos:</h4>
                        ${titlesListHtml}
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-small" onclick="window.analyzeTitles()">Analisar CTR</button>
                            <div id="ctrAnalysisResult" class="mt-3"></div>
                        </div>
                    </div>
                    <div class="output-content-block">
                        <h4 class="output-subtitle">Ideias de Thumbnail:</h4>
                        ${thumbnailsListHtml}
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-small" onclick="window.analyzeThumbnails()">Analisar Thumbnails</button>
                            <div id="thumbnailAnalysisResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            `;
            markButtonAsCompleted(button.id);
        }
    } catch (error) {
        window.showToast(\Falha ao gerar T√≠tulos: ${error.message}`, 'error');`
        console.error("Error generating Titles/Thumbnails.", error);
    } finally {
        hideButtonLoading(button);
        // updateButtonStates(); // Precisar√° ser refatorado
    }
};






// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A FUN√á√ÉO analyzeTitles INTEIRA POR ESTA VERS√ÉO BLINDADA <<<<<
// =========================================================================

window.analyzeTitles = async () => {
    if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.titles || generatedTitlesAndThumbnails.titles.length === 0) {
        window.showToast("Gere os t√≠tulos primeiro!", 'info');
        return;
    }

    const resultContainer = document.getElementById('ctrAnalysisResult');
    resultContainer.innerHTML = DOMPurify.sanitize(`<div class="loading-spinner-small"></div>`);

    const titlesString = generatedTitlesAndThumbnails.titles.join('\n');
    
    // >>> PROMPT BLINDADO COM REGRAS DE SINTAXE E ESTRUTURA EXPL√çCITAS <<<
    const prompt = `Voc√™ √© uma API de an√°lise de t√≠tulos do YouTube que retorna APENAS um array JSON.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (INEGOCI√ÅVEIS):**
1.  **JSON PURO:** Sua resposta inteira deve ser APENAS o c√≥digo JSON, come√ßando com \`[\` e terminando com \`]\`.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).
3.  **V√çRGULA FINAL:** Cada objeto JSON dentro do array DEVE ser seguido por uma v√≠rgula, EXCETO o √∫ltimo objeto.
4.  **ESTRUTURA DO OBJETO:** Cada objeto no array DEVE conter EXATAMENTE estas tr√™s chaves: "titulo_original" (string), "nota_ctr" (um n√∫mero de 0 a 10), e "sugestao_melhora" (string).

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
[
  {
    "titulo_original": "T√≠tulo Exemplo 1",
    "nota_ctr": 8,
    "sugestao_melhora": "Adicionar um n√∫mero ou um gatilho de curiosidade."
  },
  {
    "titulo_original": "T√≠tulo Exemplo 2",
    "nota_ctr": 6,
    "sugestao_melhora": "Encurtar para ser mais direto e impactante."
  }
]

**T√≠tulos para analisar:**
---
${titlesString}
---

Responda APENAS com o array JSON completo e sintaticamente PERFEITO, seguindo EXATAMENTE as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 3000);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis)) {
            throw new Error("A IA n√£o retornou uma an√°lise de t√≠tulos em formato v√°lido.");
        }

        let analysisHtml = '<div class="space-y-4">';
        analysis.forEach(item => {
            analysisHtml += `
                <div class="p-3 card-background rounded-md shadow-sm">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">${DOMPurify.sanitize(item.titulo_original)}</p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de CTR:</strong> <span class="text-indigo-500 font-bold">${DOMPurify.sanitize(String(item.nota_ctr))} / 10</span></p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${DOMPurify.sanitize(item.sugestao_melhora)}</p>
                </div>
            `;
        });
        analysisHtml += '</div>';
        resultContainer.innerHTML = DOMPurify.sanitize(analysisHtml);

    } catch (error) {
        console.error("Erro detalhado em analyzeTitles:", error);
        resultContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">Falha ao analisar os t√≠tulos: ${error.message}</p>`);
    }
};

// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A FUN√á√ÉO analyzeThumbnails INTEIRA POR ESTA VERS√ÉO BLINDADA <<<<<
// =========================================================================

window.analyzeThumbnails = async () => {
    if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.thumbnails || generatedTitlesAndThumbnails.thumbnails.length === 0) {
        window.showToast("Gere as ideias de thumbnail primeiro!", 'info');
        return;
    }

    const resultContainer = document.getElementById('thumbnailAnalysisResult');
    resultContainer.innerHTML = DOMPurify.sanitize(`<div class="loading-spinner-small"></div>`);

    const thumbnailsString = generatedTitlesAndThumbnails.thumbnails.map(t => `T√≠tulo: ${t.title}, Descri√ß√£o: ${t.description}`).join('\n---\n');
    
    // >>> PROMPT BLINDADO COM REGRAS DE SINTAXE E ESTRUTURA EXPL√çCITAS <<<
    const prompt = `Voc√™ √© uma API de an√°lise de thumbnails do YouTube que retorna APENAS um array JSON.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (INEGOCI√ÅVEIS):**
1.  **JSON PURO:** Sua resposta inteira deve ser APENAS o c√≥digo JSON, come√ßando com \`[\` e terminando com \`]\`.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).
3.  **V√çRGULA FINAL:** Cada objeto JSON dentro do array DEVE ser seguido por uma v√≠rgula, EXCETO o √∫ltimo objeto.
4.  **ESTRUTURA DO OBJETO:** Cada objeto no array DEVE conter EXATAMENTE estas tr√™s chaves: "titulo" (string, contendo o t√≠tulo original da ideia analisada), "nota_visual" (um n√∫mero de 0 a 10), e "sugestao_melhora" (string).

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
[
  {
    "titulo": "Ideia de Thumbnail 1",
    "nota_visual": 7,
    "sugestao_melhora": "Aumentar o contraste e usar uma fonte mais leg√≠vel no texto."
  },
  {
    "titulo": "Ideia de Thumbnail 2",
    "nota_visual": 9,
    "sugestao_melhora": "Adicionar um contorno brilhante ao redor da pessoa para destac√°-la do fundo."
  }
]

**Ideias para analisar:**
---
${thumbnailsString}
---

Responda APENAS com o array JSON completo e sintaticamente PERFEITO, seguindo EXATAMENTE as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 2500);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis)) {
            throw new Error("A IA n√£o retornou uma an√°lise de thumbnails em formato v√°lido.");
        }

        let analysisHtml = '<div class="space-y-4">';
        analysis.forEach(item => {
            analysisHtml += `
                <div class="p-3 card-background rounded-md shadow-sm">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">"${DOMPurify.sanitize(item.titulo || 'Ideia Sem T√≠tulo')}"</p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de Potencial Visual:</strong> <span class="text-indigo-500 font-bold">${DOMPurify.sanitize(String(item.nota_visual))} / 10</span></p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${DOMPurify.sanitize(item.sugestao_melhora)}</p>
                </div>
            `;
        });
        analysisHtml += '</div>';
        resultContainer.innerHTML = DOMPurify.sanitize(analysisHtml);

    } catch (error) {
        console.error("Erro detalhado em analyzeThumbnails:", error);
        resultContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">Falha ao analisar as thumbnails: ${error.message}</p>`);
    }
};



// =========================================================================
// >>>>> VERS√ÉO REATORADA de 'generateVideoDescription' <<<<<
// =========================================================================
const generateVideoDescription = async (button) => {
    if (!validateInputs()) return;
    showButtonLoading(button);

    try {
        const { prompt, maxTokens } = constructScriptPrompt('description');
        let result = await callGroqAPI(prompt, maxTokens);
        result = cleanGeneratedText(result, false);
        result = removeMetaComments(result);
        
        // --- A MUDAN√áA EST√Å AQUI ---
        // Gravamos a descri√ß√£o gerada no nosso "c√©rebro" central.
        AppState.generated.description = result;
        // --- FIM DA MUDAN√áA ---
        
        const targetContentElement = document.getElementById('videoDescriptionContent');
        if (targetContentElement) {
            const sanitizedResult = DOMPurify.sanitize(`<div class="generated-output-box whitespace-pre-wrap">${result}</div>`);
            targetContentElement.innerHTML = sanitizedResult;
            markButtonAsCompleted(button.id);
        }
    } catch (error) {
        window.showToast(\Falha ao gerar Descri√ß√£o: ${error.message}`, 'error');`
        console.error("Error generating Video Description.", error);
    } finally {
        hideButtonLoading(button);
        // updateButtonStates(); // Precisar√° ser refatorado
    }
};





// =========================================================================================
// >>>>> VERS√ÉO FINAL E AUT√îNOMA de 'generateStrategicOutline' (com Limpeza Integrada) <<<<<
// =========================================================================================
const generateStrategicOutline = async (button) => {
    if (!validateInputs()) return;

    // --- ETAPA 1: LIMPEZA PROFUNDA INTEGRADA ---
    console.log("Iniciando limpeza profunda para novo esbo√ßo...");

    // Limpa o roteiro e o esbo√ßo da mem√≥ria (AppState)
    AppState.generated.strategicOutline = null;
    AppState.generated.script = {
        intro: { html: null, text: null },
        development: { html: null, text: null },
        climax: { html: null, text: null },
        conclusion: { html: null, text: null },
        cta: { html: null, text: null }
    };

    // Limpa TODOS os recursos derivados da mem√≥ria (AppState)
    AppState.generated.emotionalMap = null;
    AppState.generated.titlesAndThumbnails = null;
    AppState.generated.description = null;
    AppState.generated.soundtrack = null;
    AppState.generated.imagePrompts = {};

    // Limpa os containers da UI para refletir a mem√≥ria limpa
    const scriptContainer = document.getElementById('scriptSectionsContainer');
    if (scriptContainer) scriptContainer.innerHTML = '';

    const outlineContent = document.getElementById('outlineContent');
    if(outlineContent) outlineContent.innerHTML = `<div class="asset-card-placeholder">Clique para gerar o esbo√ßo.</div>`;

    const placeholdersToReset = {
        'emotionalMapContent': 'Gere o roteiro completo para habilitar.',
        'titlesThumbnailsContent': 'Gere o roteiro para habilitar.',
        'videoDescriptionContent': 'Gere o roteiro para habilitar.',
        'soundtrackContent': 'Gere o roteiro para habilitar.'
    };

    for (const id in placeholdersToReset) {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = `<div class="asset-card-placeholder">${placeholdersToReset[id]}</div>`;
        }
    }
    
    const analysisContainers = ['analysisReportContainer', 'hooksReportContainer', 'viralSuggestionsContainer'];
    analysisContainers.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = '';
    });
    console.log("Limpeza profunda conclu√≠da.");
    // --- FIM DA LIMPEZA ---
    
    showButtonLoading(button);
    
    const outlineContentDiv = document.getElementById('outlineContent');
    outlineContentDiv.innerHTML = `<div class="loading-spinner-small mx-auto"></div>`;

    try {
        const { prompt } = constructScriptPrompt('outline');
        const rawResult = await callGroqAPI(prompt, 4000);
        
        AppState.generated.strategicOutline = cleanGeneratedText(rawResult, true);
        
        const strategicOutline = AppState.generated.strategicOutline;

        if (!strategicOutline || typeof strategicOutline !== 'object' || !strategicOutline.introduction) {
            throw new Error("A IA falhou em gerar um esbo√ßo v√°lido.");
        }

        const titleTranslations = {
            'introduction': 'Introdu√ß√£o', 'development': 'Desenvolvimento',
            'climax': 'Cl√≠max', 'conclusion': 'Conclus√£o', 'cta': 'CTA'
        };
        
        let outlineHtml = '<ul class="space-y-4 text-sm">';
        for (const key in strategicOutline) {
            if (Object.hasOwnProperty.call(strategicOutline, key)) {
                const translatedTitle = titleTranslations[key] || key;
                outlineHtml += `<li><div><strong class="text-indigo-600 dark:text-indigo-400">${translatedTitle}:</strong> <span class="text-gray-600 dark:text-gray-300">${DOMPurify.sanitize(strategicOutline[key])}</span></div></li>`;
            }
        }
        outlineHtml += '</ul>';
        
        outlineContentDiv.innerHTML = outlineHtml;
        markButtonAsCompleted(button.id);

        // Cria os novos placeholders para as se√ß√µes do roteiro
        if(scriptContainer) {
            scriptContainer.innerHTML = ''; 
            scriptContainer.innerHTML += createScriptSectionPlaceholder('intro', 'Introdu√ß√£o', 'generateIntroBtn', 'generateIntro');
            scriptContainer.innerHTML += createScriptSectionPlaceholder('development', 'Desenvolvimento', 'generateDevelopmentBtn', 'generateDevelopment');
            scriptContainer.innerHTML += createScriptSectionPlaceholder('climax', 'Cl√≠max', 'climaxBtn', 'generateClimax');
        }

    } catch (error) {
        console.error("Erro detalhado em generateStrategicOutline:", error);
        window.showToast(`Falha ao gerar Esbo√ßo: ${error.message}`);
        if(outlineContentDiv) outlineContentDiv.innerHTML = `<div class="asset-card-placeholder text-red-500">Ocorreu um erro. Tente novamente.</div>`;
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};





        /**
         * Realiza o download do roteiro como PDF.
         */
        const downloadPdf = async () => {
            // 1. Criar um container tempor√°rio para a impress√£o
            let printContainer = document.createElement('div');
            printContainer.id = 'print-container';

            // 2. Coletar e formatar TODO o conte√∫do que queremos imprimir
            let htmlToPrint = `<h1 style="text-align: center; font-size: 22pt; margin-bottom: 24px;">${elements.videoTheme.value}</h1>`;

            // Adicionar o esbo√ßo estrat√©gico
            if (strategicOutline) {
                const titleTranslations = {
                    'introduction': 'Introdu√ß√£o',
                    'development': 'Desenvolvimento',
                    'climax': 'Cl√≠max',
                    'conclusion': 'Conclus√£o',
                    'cta': 'CTA'
                };
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Esbo√ßo Estrat√©gico</div>
                        <div class="print-section-content">
                            <ul style="list-style-type: disc; padding-left: 20px;">`;
                for (const key in strategicOutline) {
                    const translatedTitle = titleTranslations[key] || (key.charAt(0).toUpperCase() + key.slice(1));
                    htmlToPrint += `<li><strong>${translatedTitle}:</strong> ${strategicOutline[key]}</li>`;
                }
                htmlToPrint += `</ul></div></div>`;
            }

            // Adicionar o roteiro principal
            document.querySelectorAll('#scriptSectionsContainer .accordion-item').forEach(item => {
                const title = item.querySelector('h3')?.textContent;
                const content = item.querySelector('.generated-content-wrapper')?.textContent;
                if (title && content) {
                    htmlToPrint += `
                        <div class="print-section">
                            <div class="print-section-title">${title}</div>
                            <div class="print-section-content"><pre>${content}</pre></div>
                        </div>`;
                }
            });
            
            // Adicionar Descri√ß√£o e Hashtags
            const videoDescriptionContent = document.getElementById('videoDescriptionContent');
            if (videoDescriptionContent && videoDescriptionContent.textContent.trim() !== 'Clique em \'Gerar\' para ver a descri√ß√£o') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Descri√ß√£o & Hashtags</div>
                        <div class="print-section-content">${videoDescriptionContent.innerHTML}</div>
                    </div>`;
            }

            // Adicionar T√≠tulos e Thumbnails
            const titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent');
            if (titlesThumbnailsContent && titlesThumbnailsContent.textContent.trim() !== 'Clique em \'Gerar\' para ver as sugest√µes') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">T√≠tulos & Thumbnails</div>
                        <div class="print-section-content">${titlesThumbnailsContent.innerHTML}</div>
                    </div>`;
            }

            // 3. Injetar o HTML no container e adicion√°-lo ao body
            printContainer.innerHTML = htmlToPrint;
            document.body.appendChild(printContainer);

            // 4. Chamar a impress√£o
            window.print();

            // 5. Remover o container tempor√°rio ap√≥s a impress√£o (com um pequeno atraso para garantir a renderiza√ß√£o)
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500); // 500ms de atraso
        };



// =========================================================================
// >>>>> VERS√ÉO FINAL E DEFINITIVA de 'resetApplicationState' <<<<<
// =========================================================================
const resetApplicationState = async () => {
    console.log("--- Executando Reset Completo da Aplica√ß√£o ---");

    // ----- ETAPA 1: Resetar o "C√©rebro" AppState para o estado inicial -----
    Object.assign(AppState, {
        inputs: {},
        generated: {
            investigationReport: null, ideas: [], strategicOutline: null,
            script: {
                intro: { html: null, text: null }, development: { html: null, text: null },
                climax: { html: null, text: null }, conclusion: { html: null, text: null },
                cta: { html: null, text: null }
            },
            titlesAndThumbnails: null, description: null, soundtrack: null,
            emotionalMap: null, imagePrompts: {}
        },
        ui: { isSettingStrategy: false, promptPaginationState: {} }
    });
    
    // Zera vari√°veis globais legadas por seguran√ßa
    window.emotionalMap = [];
    window.allImagePrompts = {};
    window.promptPaginationState = {};

    // ----- ETAPA 2: Limpar TODOS os Outputs da UI -----
    const outputContainers = [
        'factCheckOutput', 'ideasOutput', 'scriptSectionsContainer', 'outlineContent',
        'titlesThumbnailsContent', 'videoDescriptionContent', 'soundtrackContent',
        'emotionalMapContent', 'analysisReportContainer', 'hooksReportContainer',
        'viralSuggestionsContainer'
    ];
    outputContainers.forEach(id => {
        const container = document.getElementById(id);
        if (container) container.innerHTML = '';
    });

    // ----- ETAPA 3: Resetar Placeholders e Estruturas Iniciais -----
    document.getElementById('outlineContent').innerHTML = '<div class="asset-card-placeholder">Clique para gerar o esbo√ßo.</div>';
    document.getElementById('emotionalMapContent').innerHTML = '<div class="asset-card-placeholder">Gere o roteiro completo para habilitar.</div>';
    // ... (adicione os outros placeholders aqui)

    // ----- ETAPA 4: Limpar TODOS os Inputs do Formul√°rio -----
    const inputIdsToReset = [
        'factCheckQuery', 'videoTheme', 'videoDescription', 'targetAudience', 'narrativeTheme', 
        'centralQuestion', 'emotionalHook', 'narrativeVoice', 'emotionalArc', 'shockingEndingHook', 
        'researchData', 'imageDescriptionEngine', 'customImageStyle', 'conclusionSpecifics', 'ctaSpecifics'
    ];
    inputIdsToReset.forEach(id => {
        const input = document.getElementById(id);
        if (input) input.value = '';
    });
    document.getElementById('channelName').value = 'The Biblical Unveiling'; // Valor padr√£o

    // ----- ETAPA 5: Resetar Selects e R√°dios para o Padr√£o -----
    document.getElementById('languageSelect').value = 'en';
    document.getElementById('videoDuration').value = '';
    // ... (resete os outros selects para seus valores padr√£o)
    const lessonRadio = document.querySelector('input[name="conclusionType"][value="lesson"]');
    if (lessonRadio) lessonRadio.checked = true;

    // ----- ETAPA 6: GARANTE que a UI volte ao estado inicial visual -----
    updateNarrativeStructureOptions();
    toggleCustomImageStyleVisibility();
    document.getElementById('projectDashboard').classList.add('hidden');
    // ... (esconda as outras se√ß√µes din√¢micas)

    // ----- ETAPA 7: Atualiza o resto da UI -----
    updateProgressBar();
    localStorage.removeItem('viralScriptGeneratorProject');
    window.showToast("Pronto para um novo projeto!", 'success');
    window.scrollTo({ top: 0, behavior: 'smooth' });
};



// =========================================================================
// >>>>> VERS√ÉO FINAL E COMPLETA de 'getProjectStateForExport' (Salva R√°dios) <<<<<
// =========================================================================
/**
 * Re√∫ne todos os dados relevantes da aplica√ß√£o (inputs e estado gerado) em um √∫nico objeto para ser salvo.
 * @returns {object} Um objeto contendo o estado completo do projeto.
 */
const getProjectStateForExport = () => {
    // 1. Cria uma c√≥pia profunda do AppState para n√£o modificar o original.
    const stateToExport = JSON.parse(JSON.stringify(AppState));

    // 2. Itera sobre todos os campos de formul√°rio e salva seus valores atuais
    // ESTA LINHA FOI ATUALIZADA para incluir os textareas do m√≥dulo de conclus√£o
    const formElements = document.querySelectorAll('#inputTabContent input, #inputTabContent select, #inputTabContent textarea, #factCheckQuery, #languageSelect, #conclusionStrategyModule textarea');
    formElements.forEach(el => {
        if (el.type !== 'radio') { // Ignora os r√°dios por enquanto
            stateToExport.inputs[el.id] = el.value;
        }
    });

    // <<< A EVOLU√á√ÉO CR√çTICA EST√Å AQUI: L√ìGICA ESPECIAL PARA SALVAR O R√ÅDIO SELECIONADO >>>
    const checkedConclusionType = document.querySelector('input[name="conclusionType"]:checked');
    if (checkedConclusionType) {
        stateToExport.inputs['conclusionType'] = checkedConclusionType.value;
    }
    
    // 3. Salva o HTML gerado para cada se√ß√£o do roteiro.
    const sectionIds = ['intro', 'development', 'climax', 'conclusion', 'cta'];
    sectionIds.forEach(id => {
        const wrapper = document.querySelector(`#${id}Section .generated-content-wrapper`);
        if (wrapper) {
            stateToExport.generated.script[id].html = wrapper.innerHTML;
            stateToExport.generated.script[id].text = wrapper.textContent.trim();
        }
    });

    // 4. Salva o HTML de outros pain√©is gerados.
    stateToExport.generated.strategicOutlineHTML = document.getElementById('outlineContent')?.innerHTML;
    stateToExport.generated.titlesAndThumbnailsHTML = document.getElementById('titlesThumbnailsContent')?.innerHTML;
    stateToExport.generated.descriptionHTML = document.getElementById('videoDescriptionContent')?.innerHTML;
    stateToExport.generated.soundtrackHTML = document.getElementById('soundtrackContent')?.innerHTML;
    stateToExport.generated.emotionalMapHTML = document.getElementById('emotionalMapContent')?.innerHTML;

    return stateToExport;
};




// =========================================================================
// >>>>> VERS√ÉO EVOLU√çDA de 'syncUiFromState' (Carrega R√°dios) <<<<<
// =========================================================================
const syncUiFromState = () => {
    const state = AppState;

    // 1. Restaura os valores dos inputs de texto, selects, textareas
    for (const id in state.inputs) {
        const element = document.getElementById(id);
        if (element && element.type !== 'radio') {
            element.value = state.inputs[id];
        }
    }

    // <<< A CORRE√á√ÉO EST√Å AQUI: L√ìGICA ESPECIAL PARA CARREGAR O R√ÅDIO CORRETO >>>
    if (state.inputs && state.inputs.conclusionType) {
        const radioToSelect = document.querySelector(`input[name="conclusionType"][value="${state.inputs.conclusionType}"]`);
        if (radioToSelect) {
            radioToSelect.checked = true;
        }
    } else {
        // Se n√£o houver estado salvo para o r√°dio, garante que o padr√£o "lesson" esteja marcado
        const defaultRadio = document.querySelector('input[name="conclusionType"][value="lesson"]');
        if (defaultRadio) defaultRadio.checked = true;
    }

    // O resto da fun√ß√£o continua o mesmo...
    updateNarrativeStructureOptions();
    toggleCustomImageStyleVisibility();

    if (state.generated.strategicOutlineHTML) document.getElementById('outlineContent').innerHTML = state.generated.strategicOutlineHTML;
    if (state.generated.titlesAndThumbnailsHTML) document.getElementById('titlesThumbnailsContent').innerHTML = state.generated.titlesAndThumbnailsHTML;
    if (state.generated.descriptionHTML) document.getElementById('videoDescriptionContent').innerHTML = state.generated.descriptionHTML;
    if (state.generated.soundtrackHTML) document.getElementById('soundtrackContent').innerHTML = state.generated.soundtrackHTML;
    if (state.generated.emotionalMapHTML) document.getElementById('emotionalMapContent').innerHTML = state.generated.emotionalMapHTML;
    
    const scriptContainer = document.getElementById('scriptSectionsContainer');
    scriptContainer.innerHTML = '';
    const sectionOrder = ['intro', 'development', 'climax', 'conclusion', 'cta'];
    const sectionTitles = { intro: 'Introdu√ß√£o', development: 'Desenvolvimento', climax: 'Cl√≠max', conclusion: 'Conclus√£o', cta: 'Call to Action (CTA)' };
    let hasAnyScriptContent = false;

    sectionOrder.forEach(id => {
        const sectionData = state.generated.script[id];
        const sectionDiv = document.createElement('div');
        sectionDiv.id = `${id}Section`;
        sectionDiv.className = 'script-section';
        
        if (sectionData && sectionData.html) {
            hasAnyScriptContent = true;
            const sectionElement = generateSectionHtmlContent(id, sectionTitles[id], sectionData.html);
            sectionDiv.appendChild(sectionElement);
            sectionDiv.classList.remove('card', 'card-placeholder', 'flex', 'justify-between', 'items-center');
        }
        scriptContainer.appendChild(sectionDiv);
    });

    if (state.generated.strategicOutline || hasAnyScriptContent) {
        document.getElementById('projectDashboard').classList.remove('hidden');
    }

    if (AppState.generated.emotionalMap) {
        window.emotionalMap = AppState.generated.emotionalMap;
    }

    if (AppState.generated.imagePrompts) {
        window.allImagePrompts = AppState.generated.imagePrompts;
    }
    if (AppState.ui.promptPaginationState) {
        window.promptPaginationState = AppState.ui.promptPaginationState;
    }
    
    setTimeout(() => {
        updateProgressBar();
        updateButtonStates();
        updateAllReadingTimes();
    }, 100);
};




/**
 * Exporta o estado atual do projeto para um arquivo JSON.
 */
const exportProject = () => {
    const projectData = getProjectStateForExport();
    
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    const fileName = (document.getElementById('videoTheme').value.trim() || 'roteiro_viral').replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase();
    downloadAnchorNode.setAttribute("download", `${fileName}_projeto.json`);
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    window.showToast("Projeto exportado com sucesso!", 'success');
};

/**
 * Importa um projeto de um arquivo JSON e sincroniza a UI.
 */
const importProject = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const loadedState = JSON.parse(e.target.result);
            // Funde o estado carregado com o estado padr√£o, para garantir compatibilidade com vers√µes futuras.
            Object.assign(AppState, loadedState);
            // Manda a UI se sincronizar com os novos dados do AppState.
            syncUiFromState();
            window.showToast("Projeto importado com sucesso!", 'success');
        } catch (err) {
            window.showToast("Erro: Arquivo de projeto inv√°lido ou corrompido.", 'error');
            console.error("Erro ao importar projeto:", err);
        }
    };
    reader.readAsText(file);
    event.target.value = ''; // Limpa o input.
};







// ====================================================================================
// >>>>> VERS√ÉO FINAL E AUT√îNOMA de 'suggestStrategy' (com Limpeza Integrada) <<<<<
// ====================================================================================
const suggestStrategy = async (button) => {
    const themeField = document.getElementById('videoTheme');
    if (themeField && themeField.value.trim()) {
        const userConfirmed = await showConfirmationDialog(
            "Refinar Estrat√©gia com IA?",
            "Isso usar√° a IA para redefinir a estrat√©gia e LIMPAR√Å completamente qualquer esbo√ßo ou roteiro j√° gerado. Deseja continuar?"
        );
        if (!userConfirmed) return;
    }

    // --- ETAPA 1: LIMPEZA PROFUNDA INTEGRADA ---
    console.log("Iniciando limpeza profunda para nova estrat√©gia...");

    // Limpa o roteiro e o esbo√ßo da mem√≥ria (AppState)
    AppState.generated.strategicOutline = null;
    AppState.generated.script = {
        intro: { html: null, text: null },
        development: { html: null, text: null },
        climax: { html: null, text: null },
        conclusion: { html: null, text: null },
        cta: { html: null, text: null }
    };

    // Limpa TODOS os recursos derivados da mem√≥ria (AppState)
    AppState.generated.emotionalMap = null;
    AppState.generated.titlesAndThumbnails = null;
    AppState.generated.description = null;
    AppState.generated.soundtrack = null;
    AppState.generated.imagePrompts = {};

    // Limpa os containers da UI para refletir a mem√≥ria limpa
    const scriptContainer = document.getElementById('scriptSectionsContainer');
    if (scriptContainer) scriptContainer.innerHTML = '';

    const outlineContent = document.getElementById('outlineContent');
    if(outlineContent) outlineContent.innerHTML = `<div class="asset-card-placeholder">Clique para gerar o esbo√ßo.</div>`;

    const placeholdersToReset = {
        'emotionalMapContent': 'Gere o roteiro completo para habilitar.',
        'titlesThumbnailsContent': 'Gere o roteiro para habilitar.',
        'videoDescriptionContent': 'Gere o roteiro para habilitar.',
        'soundtrackContent': 'Gere o roteiro para habilitar.'
    };

    for (const id in placeholdersToReset) {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = `<div class="asset-card-placeholder">${placeholdersToReset[id]}</div>`;
        }
    }
    
    const analysisContainers = ['analysisReportContainer', 'hooksReportContainer', 'viralSuggestionsContainer'];
    analysisContainers.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.innerHTML = '';
    });
    console.log("Limpeza profunda conclu√≠da.");
    // --- FIM DA LIMPEZA ---

    const theme = document.getElementById('videoTheme')?.value.trim();
    const description = document.getElementById('videoDescription')?.value.trim();
    if (!theme || !description) {
        window.showToast("Preencha o Tema e a Descri√ß√£o do V√≠deo para receber sugest√µes.", 'info');
        return;
    }
    
    showButtonLoading(button);
    AppState.ui.isSettingStrategy = true;

    // A l√≥gica de chamada da IA e preenchimento dos campos continua a mesma
    const selectedLangCode = document.getElementById('languageSelect').value;
    const languageName = selectedLangCode === 'pt-br' ? 'Portugu√™s (Brasil)' : 'English';
    
    const validOptions = {
        narrative_goal: `['${Array.from(document.getElementById('narrativeGoal').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        narrative_tone: `['${Array.from(document.getElementById('narrativeTone').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        language_style: `['${Array.from(document.getElementById('languageStyle').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        video_objective: `['${Array.from(document.getElementById('videoObjective').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        speaking_pace: `['${Array.from(document.getElementById('speakingPace').options).map(o => o.value).filter(Boolean).join("', '")}']`,
    };

    const prompt = `Voc√™ √© uma API de Estrat√©gia de Conte√∫do Viral. Sua √∫nica fun√ß√£o √© gerar um objeto JSON com uma estrat√©gia de v√≠deo completa com base em um tema e descri√ß√£o.

**REGRAS CR√çTICAS DE SINTAXE JSON (INEGOCI√ÅVEIS):**
1.  **JSON PURO:** Responda APENAS com um objeto JSON v√°lido.
2.  **ASPAS DUPLAS:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).
3.  **PREENCHIMENTO OBRIGAT√ìRIO:** TODOS os campos listados no manual DEVEM ser preenchidos.
4.  **IDIOMA:** Todos os valores devem estar em **${languageName}**.

**MANUAL DE PREENCHIMENTO (PREENCHA TODOS OS CAMPOS):**
-   "target_audience": Descreva o espectador ideal.
-   "narrative_goal": Escolha UM de: ${validOptions.narrative_goal}.
-   "narrative_structure": Baseado no "narrative_goal", escolha a estrutura MAIS IMPACTANTE. Se 'storytelling', escolha de: ["documentary", "heroes_journey", "pixar_spine", "mystery_loop", "twist"]. Se 'storyselling', escolha de: ["pas", "bab", "aida", "underdog_victory", "discovery_mentor"].
-   "narrative_theme": A "grande ideia" em uma frase.
-   "narrative_tone": Escolha UM de: ${validOptions.narrative_tone}.
-   "narrative_voice": Crie uma PERSONA para o narrador.
-   "central_question": Formule a pergunta que gera MIST√âRIO.
-   "emotional_arc": Descreva a jornada de sentimentos.
-   "emotional_hook": Crie uma MINI-HIST√ìRIA humana.
-   "shocking_ending_hook": Crie a PRIMEIRA FRASE do v√≠deo.
-   "language_style": Escolha UM de: ${validOptions.language_style}.
-   "video_objective": Escolha UM de: ${validOptions.video_objective}.
-   "speaking_pace": Escolha UM de: ${validOptions.speaking_pace}.
-   "image_description_engine": Forne√ßa 3 a 5 palavras-chave visuais.
-   "research_data": Sugira 2 a 3 PONTOS DE PESQUISA concretos.

**DADOS DE ENTRADA:**
- **Tema do V√≠deo:** "${theme}"
- **Descri√ß√£o:** "${description}"

**A√á√ÉO FINAL:** Gere AGORA o objeto JSON completo.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const strategy = cleanGeneratedText(rawResult, true);

        if (!strategy || typeof strategy !== 'object') {
            throw new Error("A IA n√£o retornou uma resposta em formato JSON v√°lido.");
        }

        const narrativeGoalSelect = document.getElementById('narrativeGoal');
        const narrativeStructureSelect = document.getElementById('narrativeStructure');
        if (narrativeGoalSelect && strategy.narrative_goal) {
            narrativeGoalSelect.value = strategy.narrative_goal;
            updateNarrativeStructureOptions();
        }
        if (narrativeStructureSelect && strategy.narrative_structure) {
            setTimeout(() => {
                if ([...narrativeStructureSelect.options].some(option => option.value === strategy.narrative_structure)) {
                    narrativeStructureSelect.value = strategy.narrative_structure;
                } else {
                    narrativeStructureSelect.selectedIndex = 0;
                }
                updateMainTooltip();
            }, 50);
        }
        
        const keyToElementIdMap = {
            'target_audience': 'targetAudience', 'narrative_theme': 'narrativeTheme',
            'narrative_tone': 'narrativeTone', 'narrative_voice': 'narrativeVoice',
            'central_question': 'centralQuestion', 'emotional_arc': 'emotionalArc',
            'emotional_hook': 'emotionalHook', 'shocking_ending_hook': 'shockingEndingHook',
            'language_style': 'languageStyle', 'video_objective': 'videoObjective',
            'speaking_pace': 'speakingPace', 'image_description_engine': 'imageDescriptionEngine',
            'research_data': 'researchData'
        };
        for (const key in keyToElementIdMap) {
            if (strategy[key]) {
                const element = document.getElementById(keyToElementIdMap[key]);
                if (element) { element.value = strategy[key]; }
            }
        }

        window.showToast("Estrat√©gia refinada pela IA!");
        document.querySelector('[data-tab="input-tab-estrategia"]')?.click();

    } catch (error) {
        console.error("Erro detalhado em suggestStrategy:", error);
        window.showToast(`Falha ao sugerir estrat√©gia: ${error.message}`);
    } finally {
        AppState.ui.isSettingStrategy = false;
        hideButtonLoading(button);
        updateButtonStates();
    }
};





/**
 * Valida os inputs essenciais e avan√ßa para o painel de cria√ß√£o do roteiro.
 * N√£o utiliza a IA, apenas libera a pr√≥xima etapa.
 */
const startCrafting = () => {
    // 1. Valida se os campos essenciais est√£o preenchidos.
    if (!validateInputs()) {
        return;
    }
    
    // 2. Encontra o painel e o torna vis√≠vel.
    const dashboard = document.getElementById('projectDashboard');
    if (dashboard) {
        dashboard.classList.remove('hidden');
        dashboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        window.showToast("Estrat√©gia definida! Pronto para criar o esbo√ßo.", 'success');
    }
};

// =========================================================================
// >>>>> SUBSTITUA O SEU LISTENER DOMContentLoaded INTEIRO POR ESTE <<<<<
// =========================================================================
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. MAPEAMENTO INICIAL DE ELEMENTOS ---
    document.querySelectorAll('[id]').forEach(el => {
        if (el.tagName === 'BUTTON') { buttons[el.id] = el; } 
        else { elements[el.id] = el; }
    });

    // --- 2. INICIALIZA√á√ÉO DE FUN√á√ïES DA INTERFACE ---
    setupInputTabs();
    setupGenreTabs();
    updateProgressBar();
    updateButtonStates();
    updateNarrativeStructureOptions();
    updateGoalPopover();
    loadStateFromLocalStorage();

    // --- 3. EVENT LISTENERS ESPEC√çFICOS ---
    const goalSelect = document.getElementById('narrativeGoal');
    if (goalSelect) { goalSelect.addEventListener('change', updateNarrativeStructureOptions); }

    const structureSelect = document.getElementById('narrativeStructure');
    if (structureSelect) { structureSelect.addEventListener('change', updateMainTooltip); }
    
    const imageStyleSelect = document.getElementById('imageStyleSelect');
    if (imageStyleSelect) { imageStyleSelect.addEventListener('change', toggleCustomImageStyleVisibility); }
    
    const importInput = document.getElementById('importFileInput');
    if (importInput) { importInput.addEventListener('change', importProject); }
    
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            document.getElementById('moonIcon').classList.toggle('hidden', isDarkMode);
            document.getElementById('sunIcon').classList.toggle('hidden', !isDarkMode);
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        });
    }

    if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');
        if(moonIcon) moonIcon.classList.add('hidden');
        if(sunIcon) sunIcon.classList.remove('hidden');
    }

    const speakingPaceSelect = document.getElementById('speakingPace');
    if (speakingPaceSelect) { speakingPaceSelect.addEventListener('change', updateAllReadingTimes); }
    
    // --- 4. O "GERENTE DE CLIQUES" (OBJETO 'actions' CORRIGIDO) ---
    const actions = {
        // A√ß√µes da Se√ß√£o de Inspira√ß√£o
            'investigate': (btn) => window.verifyFact(btn),
            'generateIdeasFromReport': (btn) => generateIdeasFromReport(btn),
            'verify-idea': (btn) => {
            const card = btn.closest('.card');
            if (!card) return;

            const synopsisElement = card.querySelector('p.text-sm');
            const synopsisText = synopsisElement ? synopsisElement.textContent.replace(/"/g, '').trim() : '';

            const outputContainer = card.querySelector('.fact-check-output');

            if (synopsisText && outputContainer) {
                window.verifyFact(btn, synopsisText, outputContainer);
            } else {
                window.showToast("N√£o foi poss√≠vel encontrar a sinopse ou a √°rea de resultado.", 'error');
            }
        },
        'select-idea': (btn) => { 
            const ideaString = btn.dataset.idea;
            if(ideaString) selectIdea(JSON.parse(ideaString.replace(/"/g, '"')));
        },
        'select-enigma-idea': (btn) => { 
            const ideaString = btn.dataset.idea;
            if(ideaString) {
                const ideaObject = JSON.parse(ideaString.replace(/"/g, '"'));
                document.getElementById('videoTheme').value = ideaObject.title || '';
                document.getElementById('videoDescription').value = ideaObject.synopsis || ideaObject.enigma || '';
                document.getElementById('centralQuestion').value = ideaObject.hook_question || '';
                window.showToast("Enigma selecionado! Estrat√©gia pr√©-preenchida.", 'success');
                document.getElementById('inputTabsNav').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        },

        // A√ß√µes da Se√ß√£o de Estrat√©gia
        'suggestStrategy': (btn) => suggestStrategy(btn),
        'startCrafting': (btn) => startCrafting(),

        // A√ß√µes do Painel do Projeto (Roteiro)
        'generateOutline': (btn) => generateStrategicOutline(btn),
        'generateIntro': (btn) => handleGenerateSection(btn, 'intro', 'Introdu√ß√£o', 'intro'),
        'generateDevelopment': (btn) => handleGenerateSection(btn, 'development', 'Desenvolvimento', 'development'),
        'generateClimax': (btn) => handleGenerateSection(btn, 'climax', 'Cl√≠max', 'climax'),
        'generateConclusion': (btn) => generateConclusion(btn),
        'generateCta': (btn) => generateStrategicCta(btn),
        'suggestFinalStrategy': (btn) => suggestFinalStrategy(btn),
        'addDevelopmentChapter': (btn) => window.addDevelopmentChapter(btn),
        
        // A√ß√µes do Painel do Projeto (Recursos)
        'mapEmotions': (btn) => mapEmotionsAndPacing(btn),
        'generateTitlesAndThumbnails': (btn) => generateTitlesAndThumbnails(btn),
        'generateDescription': (btn) => generateVideoDescription(btn),
        'generateSoundtrack': (btn) => generateSoundtrack(btn),

        // A√ß√µes do Painel do Projeto (An√°lise)
        'analyzeScript': (btn) => analyzeFullScript(btn),
        'analyzeHooks': (btn) => analyzeRetentionHooks(btn),
        'suggestViralElements': (btn) => suggestViralElements(btn),

        // A√ß√µes do Painel do Projeto (Gerenciamento)
        'exportProject': () => exportProject(),
        'exportPdf': () => downloadPdf(),
        'exportTranscript': () => handleCopyAndDownloadTranscript(),
        'resetProject': async () => { 
            const confirmed = await showConfirmationDialog("Come√ßar um Novo Projeto?","Isso limpar√° todos os campos e o trabalho realizado. Esta a√ß√£o n√£o pode ser desfeita. Deseja continuar?");
            if (confirmed) { resetApplicationState(); }
        },

        // A√ß√µes dentro das Se√ß√µes de Roteiro Geradas
        'regenerate': (btn) => window.regenerateSection(btn.dataset.sectionId),
        'copy': (btn) => {
            const content = btn.closest('.accordion-item')?.querySelector('.generated-content-wrapper');
            if (content) {
                window.copyTextToClipboard(content.textContent);
                window.showCopyFeedback(btn);
            }
        },
        'generate-prompts': (btn) => window.generatePromptsForSection(btn, btn.dataset.sectionId),
        'analyzeRetention': (btn) => window.analyzeSectionRetention(btn, btn.dataset.sectionId),
        'refineStyle': (btn) => window.refineSectionStyle(btn),
        'enrichWithData': (btn) => window.enrichWithData(btn),
        'suggestPerformance': (btn) => window.suggestPerformance(btn, btn.dataset.sectionId),
        'optimizeGroup': (btn) => {
            const suggestionText = btn.dataset.suggestionText;
            if (suggestionText) window.optimizeGroup(btn, suggestionText);
        },
        'deleteParagraphGroup': (btn) => {
            const suggestionText = btn.dataset.suggestionText;
            if (suggestionText) window.deleteParagraphGroup(btn, suggestionText);
        },
        
        // A√ß√µes dos Relat√≥rios de An√°lise
        'applySuggestion': (btn) => window.applySuggestion(btn),
        'applyAllSuggestions': (btn) => applyAllSuggestions(btn),
        'applyHookSuggestion': (btn) => applyHookSuggestion(btn),
        'insertViralSuggestion': (btn) => insertViralSuggestion(btn)
    };


// ==========================================================
// >>>>> LISTENER PARA DETECTAR EDI√á√ïES MANUAIS NO ROTEIRO <<<<<
// ==========================================================
const scriptContainerForEdits = document.getElementById('scriptSectionsContainer');
if (scriptContainerForEdits) {
    // O evento 'input' √© perfeito para contenteditable
    scriptContainerForEdits.addEventListener('input', (event) => {
        // Garante que a edi√ß√£o veio de dentro de um container de roteiro
        if (event.target && event.target.closest('.generated-content-wrapper')) {
            console.log("Edi√ß√£o manual detectada.");

            // Pega a se√ß√£o pai para invalidar tudo que depende dela
            const sectionElement = event.target.closest('.script-section');
            if (sectionElement) {
                // Invalida todas as an√°lises e recursos derivados
                invalidateAndClearPerformance(sectionElement);
                invalidateAndClearPrompts(sectionElement);
                invalidateAndClearEmotionalMap(); // <<< A NOSSA NOVA FUN√á√ÉO EM A√á√ÉO
                updateAllReadingTimes(); // Recalcula o tempo de leitura
            }
        }
    });
}


// ==========================================================
// ==================== O "OUVINTE" GERAL DE CLIQUES =====================
// ==========================================================

document.addEventListener('click', function(event) {
    // L√≥gica do Acorde√£o
    const accordionHeader = event.target.closest('.accordion-header');
    if (accordionHeader && !event.target.closest('.header-buttons')) {
        const body = accordionHeader.nextElementSibling;
        const arrow = accordionHeader.querySelector('.accordion-arrow');
        if (body && arrow) { body.classList.toggle('open'); arrow.classList.toggle('open'); }
    }

    // L√≥gica dos Bot√µes de A√ß√£o
    const button = event.target.closest('button[data-action]');
    if (!button) return;

    const actionName = button.dataset.action;
    const action = actions[actionName];

    if (action) {
        event.preventDefault();
        const result = action(button);

        if (result instanceof Promise) {
            result.then(() => {
                saveStateToLocalStorage();
            }).catch(error => {
                console.error("A√ß√£o ass√≠ncrona falhou, salvamento autom√°tico cancelado.", error);
            });
        } else {
            saveStateToLocalStorage();
        }
    }
});

// ==========================================================
// >>>>> L√ìGICA ATUALIZADA E FINAL PARA O MENU DE EDI√á√ÉO <<<<<
// ==========================================================
const editingMenu = document.getElementById('editing-menu');

document.addEventListener('selectionchange', () => {
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    
    // Mostra o menu apenas se houver texto selecionado DENTRO de um roteiro gerado
    if (selectedText.length > 10 && selection.anchorNode && selection.anchorNode.parentElement.closest('.generated-content-wrapper')) {
        userSelectionRange = selection.getRangeAt(0).cloneRange();
        const rect = userSelectionRange.getBoundingClientRect();
        
        editingMenu.style.left = `${rect.left + window.scrollX}px`;
        editingMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
        editingMenu.classList.add('visible');
    } else {
        // Esconde o menu se o clique for fora dele
        if (!editingMenu.contains(document.activeElement)) {
             editingMenu.classList.remove('visible');
        }
    }
});

// Listener de clique para o pr√≥prio menu
editingMenu.addEventListener('click', (event) => {
    const button = event.target.closest('button[data-action]');
    if (button) {
        // Aqui usamos o data-action do bot√£o do menu, que √© 'expand', 'summarize' ou 'correct'
        const action = button.dataset.action;
        // E chamamos nossa fun√ß√£o mestre de edi√ß√£o
        handleEditingAction(action);
    }
});


// ==========================================================
// >>>>> LISTENER PARA RESETS EM INPUTS ESTRAT√âGICOS <<<<<
// ==========================================================
const strategicInputIds = ['videoTheme', 'videoDescription', 'videoDuration', 'speakingPace', 'visualPacing', 'narrativeGoal', 'narrativeStructure', 'narrativeTheme', 'narrativeTone', 'narrativeVoice', 'centralQuestion', 'emotionalArc', 'shockingEndingHook', 'imageDescriptionEngine', 'imageStyleSelect', 'researchData', 'emotionalHook'];

strategicInputIds.forEach(id => {
    const element = document.getElementById(id);
    if (element) {
        const eventType = (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') ? 'change' : 'input';
        element.addEventListener(eventType, (e) => {
            // A flag `isSettingStrategy` agora vem do AppState
            if (!AppState.ui.isSettingStrategy) {
                // A fun√ß√£o `resetGeneratedScriptContent` precisa ser atualizada para usar AppState tamb√©m
                resetGeneratedScriptContent(e.target.id);
            }
        });
    }
});

});

</script>
</body>
</html>