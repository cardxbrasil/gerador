<!DOCTYPE html>
<html lang="pt-br">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700&family=Source+Serif+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Roteiros Virais v3.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.11/dist/purify.min.js"></script>

<style>
    /* ================================================================= */
    /* =================== ARQUITETURA DE DESIGN (THEME) ================= */
    /* ================================================================= */
    :root {
        --primary: #6366f1;
        --primary-dark: #4f46e5;
        --secondary: #8FBC8F;
        --accent: #228B22;
        --success: #10b981;
        --danger: #ef4444;
        --dark-bg: #f8fafc;
        --dark-surface: #ffffff;
        --dark-border: #e2e8f0;
        --dark-text-header: #1e293b;
        --dark-text-body: #334155;
        --dark-text-muted: #64748b;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        --transition: all 0.2s ease-in-out;
    }

    .dark {
        --primary: #818cf8;
        --primary-dark: #6366f1;
        --secondary: #3CB371;
        --accent: #006400;
        --dark-bg: #0f172a;
        --dark-surface: #1e293b;
        --dark-border: #334155;
        --dark-text-header: #f1f5f9;
        --dark-text-body: #cbd5e1;
        --dark-text-muted: #94a3b8;
    }

    /* ================================================================= */
    /* ======================= ESTILOS GLOBAIS ======================= */
    /* ================================================================= */
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: var(--dark-bg); 
        color: var(--dark-text-body); 
        transition: var(--transition); 
    }
    .container { 
        max-width: 1024px; 
        margin: 0 auto; 
    }
    h1, h2, h3, h4, h5, h6 { 
        color: var(--dark-text-header); 
    }

    /* ================================================================= */
    /* ======================= COMPONENTES DA UI ======================= */
    /* ================================================================= */

 /* ========================================================== */
/*     ESTILO DE ABAS EVOLU√çDO (INSPIRADO NO GITHUB)      */
/* ========================================================== */

/* --- A base para TODAS as abas --- */
.tab-button {
    display: inline-flex;       /* Permite alinhar √≠cone e texto */
    align-items: center;        /* Alinha verticalmente no centro */
    gap: 0.5rem;                /* Espa√ßo entre o √≠cone e o texto */
    padding: 0.75rem 1rem;      /* Mais espa√ßo interno, para "respirar" */
    border: none;               /* Remove a borda padr√£o do bot√£o */
    background: none;           /* Remove o fundo padr√£o do bot√£o */
    cursor: pointer;
    font-weight: 500;
    color: var(--dark-text-muted); /* Cor sutil para abas inativas */
    border-bottom: 2px solid transparent; /* Borda invis√≠vel para manter o alinhamento */
    transition: var(--transition); /* Anima√ß√£o suave para todas as mudan√ßas */
    border-radius: 6px 6px 0 0; /* Cantos arredondados no topo, como no GitHub */
}

/* --- O "relevo" ao passar o mouse --- */
.tab-button:hover {
    color: var(--dark-text-header); /* Texto fica mais proeminente */
    background-color: color-mix(in srgb, var(--dark-border) 40%, transparent); /* Fundo sutil aparece */
}

/* --- A aba ATIVA --- */
.tab-active {
    font-weight: 600;                 /* Texto em negrito */
    color: var(--primary);            /* Cor prim√°ria, para destaque */
    border-bottom-color: var(--primary); /* A linha inferior colorida, marca do GitHub */
}

/* ========================================================== */
/*     ESTILO DE ABAS EVOLU√çDO (INSPIRADO NO GITHUB)      */
/* ========================================================== */

    /* --- Cards e Se√ß√µes --- */
    .card { 
        background-color: var(--dark-surface); 
        border: 1px solid var(--dark-border); 
        border-radius: 12px; 
        box-shadow: var(--shadow); 
        padding: 1.5rem; 
        transition: var(--transition); 
    }
    .section-title { 
        position: relative; 
        padding-bottom: 0.75rem; 
        margin-bottom: 1.5rem; 
        border-bottom: 1px solid var(--dark-border); 
    }
    .section-title h2 { 
        font-size: 1.25rem; 
        font-weight: 700; 
    }
    .section-title::after { 
        content: ''; 
        position: absolute; 
        bottom: -1px; 
        left: 0; 
        width: 70px; 
        height: 2px; 
        background: var(--primary); 
        transition: var(--transition); 
    }

    /* --- Bot√µes --- */
    .btn { 
        display: inline-flex; 
        align-items: center; 
        justify-content: center; 
        gap: 0.5rem; 
        padding: 0.65rem 1.25rem; 
        border-radius: 8px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: var(--transition); 
        border: none; 
        white-space: nowrap; 
    }
    .btn-primary { 
        background-color: var(--primary); 
        color: white; 
    }
    .btn-primary:hover { 
        background-color: var(--primary-dark); 
        transform: translateY(-2px); 
    }
    .btn-secondary { 
        background-color: var(--secondary); 
        color: white; 
    }
    .btn-secondary:hover { 
        background-color: #7c3aed; 
    }
    .dark .btn-secondary:hover { 
        background-color: #9333ea; 
    }
    .btn-small { 
        padding: 0.5rem 1rem; 
        font-size: 0.875rem; 
    }

    /* --- Formul√°rios e Inputs --- */
    .input-group { 
        margin-bottom: 1rem; 
    }
    .input-group label { 
        display: block; 
        margin-bottom: 0.5rem; 
        font-weight: 600; 
        font-size: 0.875rem; 
        color: var(--dark-text-header); 
    }
    .input-group input, .input-group select, .input-group textarea { 
        width: 100%; 
        padding: 0.75rem; 
        border-radius: 8px; 
        border: 1px solid var(--dark-border); 
        background: var(--dark-surface); 
        transition: var(--transition); 
        color: var(--dark-text-body); 
    }
    .input-group input::placeholder, .input-group textarea::placeholder { 
        color: var(--dark-text-muted); 
        opacity: 1; 
    }
    .input-group input:focus, .input-group select:focus, .input-group textarea:focus { 
        outline: none; 
        border-color: var(--primary); 
        box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 20%, transparent); 
    }

    /* --- Bot√µes de R√°dio Personalizados --- */
    .radio-label {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        padding: 0.75rem 1.25rem;
        border-radius: 8px;
        border: 2px solid var(--dark-border);
        background-color: var(--dark-surface);
        transition: var(--transition);
    }
    .radio-label:hover {
        border-color: var(--secondary);
    }
    .radio-label input[type="radio"] {
        display: none;
    }
    .radio-label input[type="radio"]:checked + span {
        color: var(--primary);
        font-weight: 600;
    }
    .radio-label:has(input:checked) {
        border-color: var(--primary);
        background-color: color-mix(in srgb, var(--primary) 10%, transparent);
    }
    .radio-label.opacity-50 {
        cursor: not-allowed;
        color: var(--dark-text-muted);
    }
    
    /* --- Abas (Tabs) --- */
    .tab-button { 
        padding: 0.5rem 0.25rem; 
        margin-bottom: 0.5rem; 
        border-bottom: 3px solid transparent; 
        color: var(--dark-text-muted); 
        font-weight: 500; 
        transition: var(--transition); 
        background: none; 
        border-radius: 0; 
    }
    .tab-button:hover { 
        color: var(--primary); 
    }
    .tab-active { 
        border-bottom-color: var(--primary); 
        color: var(--primary); 
        font-weight: 600; 
    }
    .tab-pane.hidden { 
        display: none; 
    }

    /* --- Acorde√£o --- */
    .accordion-item { 
        border-bottom: 1px solid var(--dark-border); 
    }
    .accordion-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        padding: 1rem 1.5rem; 
        cursor: pointer; 
        transition: var(--transition); 
    }
    .accordion-header:hover { 
        background-color: color-mix(in srgb, var(--dark-surface) 95%, var(--dark-text-muted)); 
    }
    .header-title-group { 
        display: flex; 
        align-items: center; 
        gap: 0.75rem; 
        flex-grow: 1; 
    }
    .header-title-group h3 { 
        font-weight: 600; 
        font-size: 1.1rem; 
    }
    .header-title-group .text-xs { 
        color: var(--dark-text-muted); 
        font-size: 0.75rem; 
        white-space: nowrap; 
    }
    .header-actions-group { 
        display: flex; 
        align-items: center; 
        gap: 1rem; 
    }
    .header-buttons { 
        display: flex; 
        align-items: center; 
        gap: 0.75rem; 
    }
    .header-buttons button { 
        background: none; 
        border: none; 
        padding: 0.25rem; 
        color: var(--dark-text-muted); 
        cursor: pointer; 
        transition: var(--transition); 
    }
    .header-buttons button:hover { 
        color: var(--primary); 
    }
    .accordion-arrow { 
        transition: transform 0.3s; 
        transform-origin: center; 
    }
    .accordion-arrow.open { 
        transform: rotate(180deg); 
    }
    .accordion-body { 
        padding: 0 1.5rem 1.5rem 1.5rem; 
        display: none; 
    }
    .accordion-body.open { 
        display: block; 
    }
    .accordion-body > div > div { 
        padding-top: 1.5rem; 
        padding-bottom: 1.5rem; 
        border-top: 1px dashed var(--dark-border); 
    }
    .accordion-body > div > div:first-child { 
        border-top: none; 
        padding-top: 0; 
    }
    .accordion-body h5 { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--dark-text-header); 
        margin-bottom: 0.25rem; 
    }
    .accordion-body p.text-xs { 
        font-size: 0.8rem; 
        color: var(--dark-text-muted); 
        margin-bottom: 1rem; 
    }

    /* --- Elementos de Feedback --- */
    .toast { 
        position: fixed; 
        bottom: 1.5rem; 
        right: 1.5rem; 
        background-color: var(--dark-surface); 
        color: var(--dark-text-header); 
        padding: 1rem 1.5rem; 
        border-radius: 8px; 
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); 
        z-index: 1000; 
        opacity: 0; 
        transform: translateY(100%); 
        transition: all 0.4s cubic-bezier(0.21, 1.05, 0.51, 1.04); 
        border-left: 4px solid var(--primary); 
    }
    .toast.show { 
        opacity: 1; 
        transform: translateY(0); 
    }
    .loading-spinner { 
        width: 24px; 
        height: 24px; 
        border: 3px solid color-mix(in srgb, var(--primary) 20%, transparent); 
        border-top-color: var(--primary); 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
        to { transform: rotate(360deg); } 
    }
    .progress-bar { 
        height: 8px; 
        background: var(--dark-border); 
        border-radius: 4px; 
        overflow: hidden; 
    }
    .progress-fill { 
        height: 100%; 
        background: var(--primary); 
        border-radius: 4px; 
        transition: width 0.3s ease; 
    }
    
    /* --- Popover da Estrutura Espec√≠fica --- */
    .popover-bg {
        background-color: var(--dark-bg);
    }

    /* --- √çcone de Troca de Tema --- */
    .theme-toggle {
        background-color: transparent;
        border: none;
        padding: 0.5rem;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }
    .theme-toggle:hover {
        background-color: color-mix(in srgb, var(--dark-border) 50%, transparent);
    }

    /* ================================================================= */
    /* ================== ESTILOS DE CONTE√öDO GERADO =================== */
    /* ================================================================= */
    .generated-content-wrapper, .generated-output-box, .emotional-map-item, .prompt-item { 
        background-color: color-mix(in srgb, var(--dark-bg) 50%, var(--dark-surface)); 
        border-left: 4px solid var(--primary); 
        padding: 1rem 1.5rem; 
        border-radius: 8px; 
        line-height: 1.6; 
    }
    .prompt-item { 
        border-left-color: var(--secondary); 
    }
    .generated-content-wrapper { 
        margin-bottom: 1.5rem; 
    }
    .generated-output-box .output-subtitle { 
        font-size: 1rem; 
        font-weight: 700; 
        color: var(--dark-text-header); 
        margin-bottom: 0.75rem; 
        padding-bottom: 0.5rem; 
        border-bottom: 1px dashed var(--dark-border); 
    }
    .generated-output-box .output-content-block { 
        margin-bottom: 1.5rem; 
    }
    .generated-output-box .thumbnail-idea { 
        margin-bottom: 1rem; 
    }
    .generated-output-box .thumbnail-idea h4 { 
        font-weight: 600; 
        font-size: 0.9rem; 
    }
    .generated-output-box .thumbnail-idea p { 
        font-size: 0.85rem; 
        color: var(--dark-text-muted); 
    }
    .soundtrack-list { 
        list-style-type: disc; 
        padding-left: 1.5rem; 
    }
    .paragraph-preview { 
        font-style: italic; 
        color: var(--dark-text-muted); 
        margin-bottom: 0.75rem; 
        font-size: 0.9rem; 
        border-bottom: 1px dashed var(--dark-border); 
        padding-bottom: 0.75rem; 
    }
    .analysis-tags, .prompt-header { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 0.5rem; 
    }
    .prompt-header { 
        margin-bottom: 0.75rem; 
        padding-bottom: 0.75rem; 
        border-bottom: 1px dashed var(--dark-border); 
    }
    .tag { 
        display: inline-flex; 
        align-items: center; 
        padding: 0.25rem 0.75rem; 
        border-radius: 9999px; 
        font-size: 0.75rem; 
        font-weight: 600; 
    }
    .tag-emotion { 
        background-color: color-mix(in srgb, var(--primary) 20%, transparent); 
        color: var(--primary); 
    }
    .tag-pace { 
        background-color: color-mix(in srgb, var(--secondary) 20%, transparent); 
        color: var(--secondary); 
    }
    .tag-scene { 
        background-color: color-mix(in srgb, var(--accent) 20%, transparent); 
        color: var(--accent); 
    }
    .tag-time { 
        background-color: color-mix(in srgb, var(--dark-text-muted) 20%, transparent); 
        color: var(--dark-text-muted); 
    }

    /* ================================================================= */
    /* =================== M√ìDULOS DE AN√ÅLISE E AJUDA ================== */
    /* ================================================================= */

    /* --- An√°lise de Reten√ß√£o --- */
    .retention-paragraph-live { 
        position: relative; 
        padding: 0.5rem; 
        border-radius: 6px; 
        transition: background-color 0.3s; 
        cursor: default; 
    }
    .retention-green { 
        background-color: color-mix(in srgb, var(--success) 10%, transparent); 
    }
    .retention-yellow { 
        background-color: color-mix(in srgb, #f59e0b 15%, transparent); 
    }
    .retention-red { 
        background-color: color-mix(in srgb, var(--danger) 15%, transparent); 
    }
    .retention-tooltip { 
        position: absolute; 
        bottom: 100%; 
        left: 0; 
        transform: translateY(-10px); 
        background-color: var(--dark-surface); 
        color: var(--dark-text-body); 
        padding: 0.75rem; 
        border-radius: 8px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
        width: 90%; 
        z-index: 10; 
        font-size: 0.8rem; 
        border: 1px solid var(--dark-border); 
        opacity: 0; 
        visibility: hidden; 
        transition: opacity 0.3s, transform 0.3s; 
    }
    .retention-tooltip .optimize-btn { 
        display: block; 
        width: 100%; 
        margin-top: 0.75rem; 
        padding: 0.5rem; 
        border: none; 
        background-color: var(--primary); 
        color: white; 
        font-weight: 600; 
        border-radius: 6px; 
        cursor: pointer; 
        transition: var(--transition); 
    }
    .retention-tooltip .optimize-btn:hover { 
        background-color: var(--primary-dark); 
    }
    .retention-paragraph-live:hover .retention-tooltip { 
        opacity: 1; 
        visibility: visible; 
        transform: translateY(-5px); 
    }
    .highlight-group { 
        outline: 2px solid var(--primary); 
        outline-offset: 2px; 
        box-shadow: 0 0 15px color-mix(in srgb, var(--primary) 30%, transparent); 
    }

    /* --- Feedback Visual de Altera√ß√£o ("Pisca") --- */
    @keyframes fade-out-highlight {
      from {
        background-color: color-mix(in srgb, #f59e0b 25%, transparent);
        outline: 2px solid #f59e0b;
      }
      to {
        background-color: transparent;
        outline: 2px solid transparent;
      }
    }
    .highlight-change {
      animation: fade-out-highlight 20s ease-out forwards;
      border-radius: 4px;
      outline-offset: 2px;
    }

/* --- Tooltips de Ajuda (Unificado) --- */
.tooltip-container {
    position: relative;
    display: inline-flex;
}
.tooltip-container .tooltip-text {
    visibility: hidden;
    opacity: 0;
    width: 300px;
    /* MUDAN√áA DE COR: Agora usa o mesmo fundo do popover */
    background-color: var(--dark-bg); 
    color: var(--dark-text-header);
    text-align: left;
    border-radius: 8px;
    padding: 1rem;
    position: absolute;
    z-index: 1001;
    bottom: 115%; 
    left: 50%;
    transform: translateX(-50%);
    box-shadow: var(--shadow);
    border: 1px solid var(--dark-border);
    transition: opacity 0.3s;
    pointer-events: none;
    /* MUDAN√áA DE FONTE: 1rem √© o equivalente a 16px */
    font-size: 1rem; 
    font-weight: 500;
    line-height: 1.6;
}
.tooltip-container .tooltip-text::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    /* MUDAN√áA DE COR DA SETA: Para combinar com o novo fundo */
    border-color: var(--dark-bg) transparent transparent transparent;
}
.tooltip-container:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}
.tooltip-container .tooltip-text strong {
    font-weight: 700;
    color: var(--primary);
}
    
    /* Estilos espec√≠ficos para o √≠cone (i), se necess√°rio */
    .help-icon {
        align-items: center;
        justify-content: center;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: var(--dark-border);
        color: var(--dark-text-muted);
        font-size: 11px;
        font-weight: 700;
        cursor: help;
        margin-left: 8px;
        transition: var(--transition);
    }
    .help-icon:hover {
        background-color: var(--primary);
        color: white;
    }

    /* ========================================================== */
    /* =================== Menu de Varia√ß√£o de Tom =================== */
    /* ========================================================== */
    #tone-variation-menu {
        position: absolute;
        background-color: var(--dark-bg);
        border: 1px solid var(--dark-border);
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 0.5rem;
        z-index: 1002;
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.2s, transform 0.2s;
        transform: translateY(10px);
    }
    #tone-variation-menu.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }
    #tone-variation-menu button {
        background-color: transparent;
        border: none;
        color: var(--primary);
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 600;
        white-space: nowrap;
    }
    #tone-variation-menu button:hover {
        background-color: var(--dark-border);
        color: var(--dark-text-header);
    }


/* ========================================================== */
/*     CORRE√á√ÉO PARA O MODAL "ADICIONAR NOVO CAP√çTULO"      */
/* ========================================================== */

/* Permite que o texto dentro dos bot√µes de sugest√£o quebre a linha */
#inputDialogSuggestions .btn {
    white-space: normal; /* Permite a quebra de linha */
    text-align: left;    /* Alinha o texto √† esquerda para melhor leitura */
    height: auto;        /* Deixa a altura do bot√£o se ajustar ao conte√∫do */
    padding-top: 0.75rem;    /* Ajuste vertical para mais conforto */
    padding-bottom: 0.75rem; /* Ajuste vertical para mais conforto */



/* ========================================================== */
/* =================== ESTILOS PARA IMPRESS√ÉO (PDF) =================== */
/* ========================================================== */
@media print {
    /* Esconde tudo que n√£o queremos no PDF */
    body > *:not(#print-container) {
        display: none !important;
    }
    
    /* Garante que o container de impress√£o ocupe todo o espa√ßo */
    #print-container {
        display: block !important;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        color: #000;
        background-color: #fff !important;
    }
    
    /* ESTILOS DE FONTE PARA O DOCUMENTO INTEIRO */
    #print-container, .print-section-content {
        font-family: 'Roboto', serif; /* Fonte padr√£o para o corpo */
        font-size: 12pt;
        line-height: 1.5;
    }

    h1, .print-section-title {
        font-family: 'Source Serif Pro', sans-serif; /* Fonte para t√≠tulos */
    }
    
    .print-section {
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid #ccc;
        page-break-inside: avoid;
    }
    
    h1 {
        text-align: center;
        font-size: 22pt;
        margin-bottom: 24px;
    }

    .print-section-title {
        font-size: 16pt;
        font-weight: bold;
        margin-bottom: 12px;
        color: #333;
    }
    
    /* Configura√ß√£o espec√≠fica para o roteiro (corpo do texto) */
    .print-section-content pre {
        white-space: pre-wrap;
        font-family: 'Roboto', serif; /* Garante a fonte aqui tamb√©m */
        font-size: 12pt;
        margin: 0;
        padding: 0;
    }

    .print-section-content ul {
        list-style-position: inside;
        padding-left: 10px;
    }

    /* Remove estilos visuais que n√£o queremos no PDF */
    .generated-output-box, .thumbnail-idea, .card {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
        color: #000 !important;
    }
    
    /* For√ßa que o texto de todos os elementos seja preto */
    .print-section-content p, .print-section-content li, .print-section-content h4, .print-section-content strong {
        color: #000 !important;
    }
}

</style>



</head>



<body class="bg-gray-50 dark:bg-gray-900">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-sm">
            <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">
                    <i class="fas fa-video mr-2"></i>Gerador de Roteiros Virais v3.9
                </h1>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="theme-toggle">
                        <i id="moonIcon" class="fas fa-moon text-gray-700 dark:text-gray-300"></i>
                        <i id="sunIcon" class="fas fa-sun text-gray-700 dark:text-gray-300 hidden"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="container mx-auto px-4 py-4">
            <div class="mb-6">
                <div class="flex justify-between text-sm mb-1">
                    <span>Progresso do Projeto</span>
                    <span id="progressText">0%</span>
                </div>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-4 pb-20">
            <!-- Estrat√©gia Section -->


<!-- ==================================================================== -->
<!--     NOVA SE√á√ÉO 0: CENTRAL DE INVESTIGA√á√ÉO E IDEIAS (FLUXO 2.0)     -->
<!-- ==================================================================== -->
<section class="mb-12">
    <div class="text-center mb-8">
        <h2 class="text-2xl font-bold mb-2">Comece com a Verdade</h2>
        <p class="text-gray-600 dark:text-gray-400">Investigue um tema, fato ou pergunta. A IA buscar√° fontes e, a partir do relat√≥rio, voc√™ poder√° gerar ideias de roteiro j√° validadas.</p>
    </div>

  <div class="card">
    <div class="input-group">
        <label for="languageSelect">1. Primeiro, selecione o idioma da pesquisa:</label>
        <select id="languageSelect">
            <option value="pt-br">Portugu√™s (Brasil)</option>
            <option value="en" selected>English</option>
        </select>
    </div>
    <div class="input-group">
        <label for="factCheckQuery">2. Agora, digite o tema, fato ou pergunta a ser investigada:</label>
        <textarea id="factCheckQuery" rows="3" ...></textarea>
    </div>
    <div class="text-center mt-4">
        <button id="investigateBtn" data-action="investigate" class="btn btn-secondary">
            <i class="fas fa-search-plus mr-2"></i>Investigar Tema
        </button>
    </div>



        <!-- Container para o relat√≥rio da IA -->
        <div id="factCheckOutput" class="mt-8">
            <!-- O relat√≥rio da investiga√ß√£o e o "bot√£o m√°gico" aparecer√£o aqui -->
        </div>
        
        <hr class="my-8 border-dashed border-gray-300 dark:border-gray-600">

        <!-- Parte 2: A Gera√ß√£o de Ideias -->
        <div id="ideaGenerationSection" class="hidden">
             <div class="text-center">
                <h3 class="text-lg font-bold mb-2">Gerar Ideias a partir do Relat√≥rio</h3>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Agora, escolha um especialista para transformar os fatos investigados em ideias de v√≠deo criativas.</p>
            </div>
            
            <!-- A Barra de Navega√ß√£o com Abas de G√™nero -->
            <div class="border-b border-gray-200 dark:border-gray-700">
                <nav id="genreTabs" class="-mb-px flex flex-wrap space-x-2 justify-center" aria-label="Tabs">
    <button data-genre="documentario" class="tab-button tab-active"> <i class="fas fa-film fa-fw"></i> <span>Document√°rio</span> </button>
    <button data-genre="inspiracional" class="tab-button"> <i class="fas fa-hand-sparkles fa-fw"></i> <span>Inspiracional</span> </button>
    <button data-genre="scifi" class="tab-button"> <i class="fas fa-rocket fa-fw"></i> <span>Fic√ß√£o Cient√≠fica</span> </button>
    <button data-genre="terror" class="tab-button"> <i class="fas fa-ghost fa-fw"></i> <span>Terror</span> </button>
    <button data-genre="enigmas" class="tab-button"> <i class="fas fa-scroll fa-fw"></i> <span>Enigmas (B√≠blico)</span> </button>
    <button data-genre="geral" class="tab-button"> <i class="fas fa-lightbulb fa-fw"></i> <span>Geral</span> </button>
</nav>
            </div>
            <div class="mt-6 text-center">
                <button id="generateIdeasFromReportBtn" data-action="generateIdeasFromReport" class="btn btn-primary">
                    <i class="fas fa-magic mr-2"></i>Gerar Ideias com Especialista
                </button>
            </div>
        </div>

        <!-- O Container final para a Sa√≠da das Ideias -->
        <div id="ideasOutput" class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- As ideias geradas pela IA aparecer√£o aqui -->
        </div>
    </div>
</section>



    <div class="section-title">
        <h2 class="text-xl font-bold">1. Definir Estrat√©gia</h2>
    </div>
    
    <!-- A navega√ß√£o das abas (continua a mesma) -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav id="inputTabsNav" class="-mb-px flex flex-wrap md:flex-nowrap space-x-6" aria-label="Tabs">
            <button data-tab="input-tab-basico" class="tab-button tab-active">
                <i class="fas fa-info-circle mr-2"></i> B√°sico
            </button>
            <button data-tab="input-tab-estrategia" class="tab-button">
                <i class="fas fa-lightbulb mr-2"></i> Estrat√©gia Narrativa
            </button>
            <button data-tab="input-tab-tecnicos" class="tab-button">
                <i class="fas fa-sliders-h mr-2"></i> Detalhes T√©cnicos
            </button>
        </nav>
    </div>
    
    <!-- O conte√∫do das abas (AGORA CORRIGIDO) -->
    <div id="inputTabContent" class="card">
        
        <!-- Aba 1: B√°sico -->

<div id="input-tab-basico" class="tab-pane active-pane">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="input-group"><label for="channelName">Nome do Canal:</label><input type="text" id="channelName" value="The Biblical Unveiling"></div>
        <div class="input-group"><label for="videoTheme">Tema do V√≠deo:</label><input type="text" id="videoTheme" placeholder="Ex: A Arca da Alian√ßa Foi Encontrada?"></div>
        
        
        <!-- Dura√ß√£o e Ritmo agora ficam lado a lado -->
        <div class="input-group">
            <label for="videoDuration">Dura√ß√£o Desejada:</label>
            <select id="videoDuration">
                <option value="">-- Selecione --</option>
                <option value="short">Curto (~1-3 min)</option>
                <option value="medium">M√©dio (~4-7 min)</option>
                <option value="long">Longo (~8-12 min)</option>
            </select>
        </div>

        <div class="input-group">
    <label for="visualPacing">Ritmo Visual (Cenas):</label>
    <select id="visualPacing">
        <option value="" selected>-- Selecione --</option> <!-- Adicionado 'selected' aqui -->
        <option value="dinamico">Din√¢mico (3-8s)</option> <!-- Removido 'selected' daqui -->
        <option value="normal">Normal (8-15s)</option>
        <option value="contemplativo">Contemplativo (15-25s)</option>
    </select>
</div>

        <div class="input-group md:col-span-2"><label for="videoDescription">Descri√ß√£o do V√≠deo (para inspira√ß√£o):</label><textarea id="videoDescription" rows="4" placeholder="Cole uma breve descri√ß√£o do v√≠deo aqui..."></textarea></div>
    </div>
</div>


<!-- Aba 2: Estrat√©gia Narrativa (COM NOVOS POPOVERS E TOOLTIPS) -->
<div id="input-tab-estrategia" class="tab-pane hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Bloco 1: O Que e Para Quem -->
        <div class="input-group md:col-span-2"><label for="targetAudience">P√∫blico-Alvo:</label><input type="text" id="targetAudience" placeholder="Quem voc√™ quer que assista? Descreva seu espectador ideal."></div>
        <div class="input-group md:col-span-2"><label for="narrativeTheme">3. Tema Principal:</label><input type="text" id="narrativeTheme" placeholder="Qual √© a 'grande ideia'? A √∫nica mensagem que seu p√∫blico deve lembrar?"></div>
        <div class="input-group md:col-span-2"><label for="centralQuestion">Pergunta Central (Opcional):</label><textarea id="centralQuestion" rows="2" placeholder="Qual mist√©rio ou 'coceira mental' voc√™ vai criar e prometer resolver?"></textarea></div>

        <!-- Bloco 2: A Estrutura e a Alma -->
        <!-- MUDAN√áA AQUI: Adicionamos a estrutura para o novo popover -->
        <div class="relative group">
            <div class="input-group">
                <label for="narrativeGoal">1. Objetivo da Narrativa:</label>
                <select id="narrativeGoal">
                    <option value="storytelling">Storytelling</option>
                    <option value="storyselling">Storyselling</option>
                </select>
            </div>
            <div id="goalPopover" class="card popover-bg absolute bottom-full left-0 mb-2 w-[400px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-20 pointer-events-none group-hover:pointer-events-auto">
                <h4 class="font-bold text-lg text-indigo-400 mb-2"></h4>
                <p class="text-sm leading-relaxed"></p>
            </div>
        </div>
        <div class="relative group">
            <div class="input-group">
                <div class="flex items-center gap-2 mb-2"><label for="narrativeStructure">2. Estrutura Espec√≠fica:</label></div>
                <select id="narrativeStructure"></select>
            </div>
            <div id="structurePopover" class="card popover-bg absolute bottom-full left-0 mb-2 w-[400px] opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-20 pointer-events-none group-hover:pointer-events-auto">
                <h4 id="popoverTitle" class="font-bold text-lg text-indigo-400 mb-2"></h4>
                <p id="popoverDescription" class="text-sm leading-relaxed"></p>
            </div>
        </div>
        <div class="input-group md:col-span-2"><label for="emotionalHook">Hist√≥ria Pessoal / Gancho Emocional (Opcional):
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>D√™ uma alma para sua hist√≥ria.</strong> Este √© o 'fio condutor' humano. A IA usar√° esta pequena hist√≥ria para conectar os grandes fatos a uma experi√™ncia pessoal, tornando o roteiro muito mais impactante.
                </span>
            </span>
        </label><textarea id="emotionalHook" rows="3" placeholder="Qual rosto humano dar√° alma √† sua hist√≥ria? Ex: a jornada de um indiv√≠duo, uma mem√≥ria pessoal, um arqu√©tipo (o azar√£o, o mentor)..."></textarea></div>

        <!-- Bloco 3: O Tom e a Jornada -->
        <div class="input-group"><label for="narrativeTone">4. Tom da Narra√ß√£o:
            <!-- NOVO TOOLTIP AQUI -->
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>Define o "sentimento" do v√≠deo.</strong> √â s√©rio e sombrio? Leve e inspirador? A escolha do tom guia a m√∫sica, o ritmo e o estilo da narra√ß√£o.
                </span>
            </span>
        </label><select id="narrativeTone"><option value="inspirador" selected>Inspirador</option><option value="serio">S√©rio</option><option value="emocional">Emocional</option></select></div>
        <div class="input-group"><label for="narrativeVoice">5. Voz do Narrador:
            <!-- NOVO TOOLTIP AQUI -->
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>Imagine que seu canal √© uma pessoa.</strong> Como ela falaria? Um mentor s√°bio? Um amigo entusiasmado? Um investigador misterioso? Isso define a personalidade da sua narra√ß√£o.
                </span>
            </span>
        </label><input type="text" id="narrativeVoice" placeholder="Ex: Confiante, Engra√ßada, Misteriosa..."></div>
        <div class="input-group md:col-span-2"><label for="emotionalArc">Arco Emocional Desejado (Opcional):
            <!-- NOVO TOOLTIP AQUI -->
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>Qual jornada de sentimentos voc√™ quer que o espectador percorra?</strong> Come√ßa com curiosidade, vai para a tens√£o e termina em al√≠vio? Planejar isso cria um v√≠deo muito mais impactante.
                </span>
            </span>
        </label><textarea id="emotionalArc" rows="2" placeholder="Ex: Curiosidade -> Tens√£o -> Surpresa -> Al√≠vio"></textarea></div>
        <div class="input-group md:col-span-2"><label for="shockingEndingHook">O Desfecho Chocante (Hook Opcional):
            <span class="help-icon tooltip-container">i
                <span class="tooltip-text">
                    <strong>A t√©cnica do 'loop aberto' reverso.</strong> Coloque a frase final e mais chocante da sua hist√≥ria aqui. A IA usar√° esta frase como a PRIMEIRA linha do v√≠deo, criando um mist√©rio instant√¢neo que prende o espectador at√© o final.
                </span>
            </span>
        </label><input type="text" id="shockingEndingHook" placeholder="Ex: ...e foi por isso que a Arca nunca deveria ser encontrada."></div>

    </div>
</div>

<!-- Aba 3: Detalhes T√©cnicos (COM TOOLTIPS CORRIGIDOS) -->
<div id="input-tab-tecnicos" class="tab-pane hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="input-group"><label for="languageStyle">Estilo de Linguagem:</label><select id="languageStyle"><option value="inspirador" selected>Inspirador</option><option value="formal">Formal</option></select></div>
        <div class="input-group"><label for="videoObjective">Objetivo do V√≠deo:</label><select id="videoObjective"><option value="informar" selected>Informar</option><option value="emocionar">Emocionar</option></select></div>
        <div class="input-group"><label for="speakingPace">Ritmo de Fala:</label><select id="speakingPace"><option value="moderate" selected>Moderado</option><option value="slow">Lento</option><option value="fast">R√°pido</option></select></div>
        <div class="input-group md:col-span-2">
            <label for="researchData">Fontes e Dados de Pesquisa (Opcional):
                <!-- A CORRE√á√ÉO EST√Å AQUI: Adicionamos a classe 'tooltip-container' -->
                <span class="help-icon tooltip-container">i
                    <span class="tooltip-text">
                        <strong>Aumente a credibilidade.</strong> Cole aqui nomes, datas, estat√≠sticas, ou cita√ß√µes. A IA ir√° tecer essas informa√ß√µes na narrativa.
                        Ex: 'Fonte: Estudo de Harvard; Dr. Jo√£o da Silva, especialista...'
                    </span>
                </span>
            </label>
            <textarea id="researchData" rows="4" placeholder="Para aumentar a credibilidade, cole aqui dados, fontes, nomes e links que a IA deve citar e contextualizar no roteiro. Ex: Fonte: Atlas da Viol√™ncia 2023; Maria da Silva, coordenadora do Instituto Odara..."></textarea>
        </div>
        <div class="input-group md:col-span-2"><label for="imageDescriptionEngine">Motor de Descri√ß√£o de Imagem:</label><textarea id="imageDescriptionEngine" rows="2" placeholder="Ex: 'fotografias reais', 'close-up emocional'"></textarea></div>
        <div class="input-group md:col-span-2"><label for="imageStyleSelect">Motor de Qualidade de Imagem:</label><select id="imageStyleSelect"><option value="cinematic" selected>Cinematogr√°fico</option><option value="custom">Personalizado</option><option value="none">Nenhum</option></select></div>
        <div id="customImageStyleContainer" class="input-group md:col-span-2" style="display: none;">
            <label for="customImageStyle">Estilo de Imagem Personalizado:</label>
            <textarea id="customImageStyle" rows="3" placeholder="Descreva o seu estilo de imagem aqui... Ex: 'estilo de arte de Van Gogh', 'preto e branco com alto contraste'..."></textarea>
        </div>
    </div>
</div>
    
    <!-- O bot√£o final (continua o mesmo) -->
    <div class="mt-6 text-center">
        <div class="mt-6 flex flex-col sm:flex-row items-center justify-center gap-4">
    <!-- Bot√£o Opcional para ajuda da IA -->
    <button id="suggestStrategyBtn" data-action="suggestStrategy" class="btn btn-secondary w-full sm:w-auto">
        <i class="fas fa-magic mr-2"></i> Sugerir Estrat√©gia com IA
    </button>
    <!-- Bot√£o Principal para avan√ßar -->
    <button id="startCraftingBtn" data-action="startCrafting" class="btn btn-primary w-full sm:w-auto">
        <i class="fas fa-arrow-right mr-2"></i> Iniciar Cria√ß√£o do Roteiro
    </button>
</div>


    </div>
</section>

<!-- PAINEL DO PROJETO (inicialmente escondido) -->
<div id="projectDashboard" class="hidden mt-12">

    <!-- SE√á√ÉO 2: CRIAR ROTEIRO -->
    <section class="mb-10">
        <div class="section-title"><h2 class="text-xl font-bold">2. Criar Roteiro</h2></div>
        
        <!-- Card do Esbo√ßo Estrat√©gico -->
        <div id="strategicOutlineCard" class="card card-placeholder mb-6"> <!-- CLASSE ADICIONADA AQUI -->
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-lg">Esbo√ßo Estrat√©gico</h3>
                <button id="generateOutlineBtn" data-action="generateOutline" class="btn btn-secondary btn-small">Criar Esbo√ßo</button>
            </div>
            <div id="outlineContent"><div class="asset-card-placeholder">Clique para gerar o esbo√ßo.</div></div>
        </div>
        
        <!-- Container onde os placeholders do roteiro (Introdu√ß√£o, etc.) ser√£o injetados -->
        <div id="scriptSectionsContainer" class="space-y-4"></div>
    </section>

    <!-- SE√á√ÉO 3: RECURSOS E METADADOS -->
    <section>
        <div class="section-title"><h2 class="text-xl font-bold">3. Recursos e Metadados</h2></div>
        
        <!-- Mapa Emocional -->
        <div class="card card-placeholder mb-6"> <!-- CLASSE ADICIONADA AQUI -->
             <div class="flex justify-between items-center mb-3">
                <h3 class="font-semibold text-lg">Mapa Emocional</h3>
                <button id="mapEmotionsBtn" data-action="mapEmotions" class="btn btn-secondary btn-small">Mapear</button>
            </div>
            <div id="emotionalMapContent"><div class="asset-card-placeholder">Gere o roteiro completo para habilitar.</div></div>
        </div>

        <!-- Grid para os outros recursos -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- T√≠tulos & Thumbnails -->
            <div class="card card-placeholder"> <!-- CLASSE ADICIONADA AQUI -->
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-lg">T√≠tulos & Thumbnails</h3>
                    <button id="generateTitlesAndThumbnailsBtn" data-action="generateTitlesAndThumbnails" class="btn btn-secondary btn-small">Gerar</button>
                </div>
                <div id="titlesThumbnailsContent"><div class="asset-card-placeholder">Gere o roteiro para habilitar.</div></div>
            </div>

            <!-- Descri√ß√£o & Hashtags -->
            <div class="card card-placeholder"> <!-- CLASSE ADICIONADA AQUI -->
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-lg">Descri√ß√£o & Hashtags</h3>
                    <button id="generateDescriptionBtn" data-action="generateDescription" class="btn btn-secondary btn-small">Gerar</button>
                </div>
                <div id="videoDescriptionContent"><div class="asset-card-placeholder">Gere o roteiro para habilitar.</div></div>
            </div>

            <!-- Trilha Sonora -->
            <div class="card card-placeholder md:col-span-2"> <!-- CLASSE ADICIONADA AQUI -->
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-semibold text-lg">Trilha Sonora</h3>
                    <button id="generateSoundtrackBtn" data-action="generateSoundtrack" class="btn btn-secondary btn-small">Gerar</button>
                </div>
                <div id="soundtrackContent"><div class="asset-card-placeholder">Gere o roteiro para habilitar.</div></div>
            </div>
        </div>


            <!-- M√ìDULO DE ESTRAT√âGIA DA CONCLUS√ÉO (inicialmente escondido) -->


<div id="conclusionStrategyModule" class="card mb-6 hidden">
    <div class="text-center mb-4">
        <h3 class="text-lg font-bold">Qual √© o objetivo final do seu v√≠deo?</h3>
        <!-- <<< NOSSO NOVO BOT√ÉO DE AJUDA AQUI >>> -->
        <button id="suggestFinalStrategyBtn" data-action="suggestFinalStrategy" class="btn btn-secondary btn-small mt-2">
            <i class="fas fa-magic mr-2"></i> Sugerir Estrat√©gia Final
        </button>
    </div>
    <div class="flex justify-center flex-wrap gap-4 mb-6">
        <label class="radio-label">
            <input type="radio" name="conclusionType" value="lesson" checked>
            <span><i class="fas fa-graduation-cap mr-2"></i>Deixar uma Li√ß√£o / Reflex√£o</span>
        </label>
        <label class="radio-label">
            <input type="radio" name="conclusionType" value="answer">
            <span><i class="fas fa-question-circle mr-2"></i>Responder uma Pergunta Central</span>
        </label>
        <label class="radio-label">
            <input type="radio" name="conclusionType" value="cliffhanger">
            <span><i class="fas fa-bolt mr-2"></i>Criar um Gancho / Mist√©rio Cont√≠nuo</span>
        </label>
    </div>
    <div id="conclusionInputContainer" class="input-group">
        <label for="conclusionSpecifics">Detalhes para a Conclus√£o:</label>
        <textarea id="conclusionSpecifics" rows="3" placeholder="Qual sentimento ou ideia final voc√™ quer deixar com o espectador? Esperan√ßa? Indigna√ß√£o? Uma nova perspectiva?"></textarea>
    </div>
    <div class="input-group mt-4">
        <label for="ctaSpecifics">Detalhes para o Call to Action (CTA) Espec√≠fico (Opcional):</label>
        <textarea id="ctaSpecifics" rows="2" placeholder="Qual a√ß√£o espec√≠fica voc√™ quer que o espectador tome? Ex: Visitar um site, apoiar uma causa, comprar um produto..."></textarea>
    </div>
    <div class="text-center mt-6">
        <button id="generateConclusionBtn" data-action="generateConclusion" class="btn btn-primary">
            <i class="fas fa-pen-fancy mr-2"></i>Gerar Conclus√£o
        </button>
        <button id="generateCtaBtn" data-action="generateCta" class="btn btn-primary hidden">
            <i class="fas fa-bullhorn mr-2"></i>Gerar CTA Estrat√©gico
        </button>
    </div>
</div>


    </section>



    <!-- SE√á√ÉO 5: AN√ÅLISE DE ROTEIRO COMPLETO -->
<section id="scriptAnalysisSection" class="mt-10 hidden">
    <div class="section-title">
        <h2 class="text-xl font-bold">5. An√°lise de Roteiro (Beta)</h2>
    </div>
    <div class="card text-center">
        <p class="mb-4 text-gray-600 dark:text-gray-400">Pronto para receber um feedback de n√≠vel profissional? Nossas IAs analisar√£o seu roteiro em busca de pontos fortes, oportunidades de melhoria e ganchos de reten√ß√£o.</p>
        
        <!-- Container dos bot√µes -->
        <div class="flex flex-wrap justify-center gap-4">
            <button id="analyzeScriptBtn" data-action="analyzeScript" class="btn btn-primary">
                <i class="fas fa-search-plus mr-2"></i> An√°lise Geral
            </button>
            <button id="analyzeHooksBtn" data-action="analyzeHooks" class="btn btn-secondary">
                <i class="fas fa-anchor mr-2"></i> Ca√ßar Ganchos
            </button>
            <!-- NOSSO NOVO BOT√ÉO AQUI -->
            <button id="suggestViralBtn" data-action="suggestViralElements" class="btn btn-secondary">
                <i class="fas fa-lightbulb mr-2"></i> Sugerir Elementos Virais
            </button>
        </div>

        <!-- Containers para os relat√≥rios -->
        <div id="analysisReportContainer" class="mt-6 text-left"></div>
        <div id="hooksReportContainer" class="mt-6 text-left"></div>
        <!-- NOSSO NOVO CONTAINER DE RELAT√ìRIO AQUI -->
        <div id="viralSuggestionsContainer" class="mt-6 text-left"></div>
    </div>
</section>



<!-- ========================================================== -->
<!--     NOVA SE√á√ÉO 4: GERENCIAMENTO DO PROJETO (EXPORTAR/IMPORTAR)     -->
<!-- ========================================================== -->
<section class="mt-10">
    <div class="section-title">
        <h2 class="text-xl font-bold">4. Gerenciamento do Projeto</h2>
    </div>
    <div class="card">
        <div class="flex flex-wrap items-center justify-center gap-4">
            <!-- Bot√£o para Importar Projeto -->
            <label for="importFileInput" class="btn btn-secondary cursor-pointer">
                <i class="fas fa-upload mr-2"></i> Importar Projeto
            </label>
            <input type="file" id="importFileInput" class="hidden" accept=".json">

            <!-- Bot√£o para Exportar Projeto -->
            <button id="exportProjectBtn" data-action="exportProject" class="btn btn-secondary">
                <i class="fas fa-download mr-2"></i> Exportar Projeto
            </button>

            <!-- >>> NOSSO NOVO BOT√ÉO AQUI <<< -->
            <button id="exportPdfBtn" data-action="exportPdf" class="btn btn-secondary">
            <i class="fas fa-file-pdf mr-2"></i> Exportar PDF
            </button>

            <!-- >>> Exportar Transcri√ß√£o <<< -->
            <button id="exportTranscriptBtn" data-action="exportTranscript" class="btn btn-secondary">
            <i class="fas fa-file-alt mr-2"></i> Exportar Transcri√ß√£o (.rtf)
            </button>
            
            <!-- Bot√£o para Resetar -->
            <button id="resetProjectBtn" data-action="resetProject" class="btn bg-red-600 hover:bg-red-700 text-white">
                <i class="fas fa-sync-alt mr-2"></i> Novo Projeto (Resetar)
            </button>
        </div>
    </div>
</section>


</div>
        </main>


        <div id="tone-variation-menu" class="">
        <button data-tone="emotion">Mais Emo√ß√£o</button>
        <button data-tone="impact">Mais Urg√™ncia</button>
        <button data-tone="clarity">Mais Clareza</button>
        <button data-tone="humor">Mais Humor</button>
        </div>

        <!-- Floating Action Bar -->
        <div class="floating-action-bar">
            <button class="theme-toggle bg-indigo-500 text-white">
                <i class="fas fa-save"></i>
            </button>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <span id="toastMessage">Mensagem de notifica√ß√£o</span>
        </div>
    </div>

    <!-- Confirmation Dialog Overlay -->
        <div id="confirmationDialogOverlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
            <div class="card max-w-sm w-full animate-fade-in">
                <h3 id="confirmationTitle" class="text-xl font-bold mb-4">T√≠tulo da Confirma√ß√£o</h3>
                <p id="confirmationMessage" class="mb-6">Deseja limpar o trabalho j√° realziado?</p>
                <div class="flex justify-end gap-4">
                    <button id="confirmBtnNo" class="btn btn-secondary">N√£o</button>
                    <button id="confirmBtnYes" class="btn btn-primary">Sim</button>
                </div>
            </div>
        </div>

<!-- ========================================================== -->
<!--     MODAL ATUALIZADO COM √ÅREA PARA SUGEST√ïES         -->
<!-- ========================================================== -->
<div id="inputDialogOverlay" style="display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
    <div class="card max-w-md w-full animate-fade-in">
        <h3 id="inputDialogTitle" class="text-xl font-bold mb-4">T√≠tulo do Di√°logo</h3>
        <p id="inputDialogMessage" class="text-sm text-gray-500 dark:text-gray-400 mb-4">Mensagem de ajuda.</p>
        
        <!-- Container para as sugest√µes da IA -->
        <div id="inputDialogSuggestions" class="space-y-2 mb-4">
            <!-- As sugest√µes (bot√µes) ser√£o injetadas aqui pelo JavaScript -->
        </div>

        <!-- Divisor opcional -->
        <div class="relative flex py-2 items-center">
            <div class="flex-grow border-t border-gray-300 dark:border-gray-700"></div>
            <span class="flex-shrink mx-4 text-xs text-gray-400">OU</span>
            <div class="flex-grow border-t border-gray-300 dark:border-gray-700"></div>
        </div>
        
        <div class="input-group mt-2">
            <label id="inputDialogLabel" for="inputDialogField">Label do Campo</label>
            <textarea id="inputDialogField" rows="2" placeholder="Placeholder..." class="!text-[var(--dark-text-body)]"></textarea>
        </div>

        <div class="flex justify-end gap-4 mt-6">
            <button id="inputBtnCancel" class="btn btn-secondary">Cancelar</button>
            <button id="inputBtnConfirm" class="btn btn-primary">Usar Tema Personalizado</button>
        </div>
    </div>
</div>


    <script type="module">

        // ==========================================================
        // ==================== SETUP INICIAL =======================
        // ==========================================================
        // Vari√°veis de estado globais
        let generatedTitlesAndThumbnails = null;
        let allImagePrompts = {}; 
        let strategicOutline = null;
    let projectState = {
    intro: false,
    development: false,
    climax: false,
    conclusion: false,
    cta: false
};
        let elements = {};
        let buttons = {};
        let totalScriptSeconds = 0;
        let promptPaginationState = {};
        let isSettingStrategy = false; // <-- NOSSO NOVO SINALIZADOR
        let userSelectionRange = null; // <<< ADICIONE ESTA NOVA LINHA
    
        // Bloco de estilo cinematogr√°fico para prompts de imagem
        const CINEMATIC_STYLE_BLOCK = `
Ultra-realistic, high-resolution photographic image captured with masterfully rendered natural or artificial lighting and cinematic composition. The aesthetic should be of a modern cinematic film, with meticulous attention to physical and sensory details.
**Essential Visual Characteristics:**
- **Rich & Organic Textures:** Surfaces must display tactile authenticity ‚Äî visible skin pores, individual fabric threads, weathered materials (wood, metal, stone), realistic reflections, and organic imperfections that add depth and believability.
- **Focus & Depth of Field:** Employ selective sharp focus with subtle depth of field (slightly blurred background or foreground) to guide the viewer's attention and create a sense of three-dimensionality.
- **Color Palette & Contrast:** Colors should be "true-to-life" but with a refined, cinematic tonal range. Avoid super-saturated or artificially vibrant hues. Favor contrasts that create visual drama and natural modeling, typical of good cinematography.
- **Lighting & Atmosphere:** Lighting must be complex and naturalistic, with multiple light sources creating soft shadows, half-tones, and highlights. Include subtle atmospheric elements like dust, mist, or light rays (god rays) when appropriate to enhance the sense of a living environment.
- **Visual Composition:** Apply classic cinematic composition principles (rule of thirds, leading lines, broken symmetry, depth) to create visually appealing frames that tell a story.
- **Overall Style:** The final result must be indistinguishable from a high-quality photograph taken with professional equipment, intended to illustrate a film scene. Nothing should look artificial, "3D rendered," or overly polished. The goal is physical and emotional authenticity.
**Stylistic Constraints (WHAT NOT TO DO):**
- NO exaggerated or distorted features (facial features, proportions).
- NO artificial "glow" or excessive smoothing (airbrushing).
- NO visible 3D render or CGI look.
- NO super-saturated colors or unreal hues.
- NO element that breaks the illusion of a photorealistic capture.`;
        // Labels para descri√ß√£o de imagem em diferentes idiomas
        const imageDescriptionLabels = { 'pt-br': 'Descri√ß√£o da Imagem:', 'pt-pt': 'Descri√ß√£o da Imagem:', 'en': 'Image Description:' };

// ==========================================================
        // NOVO: MAPA DE CONTAGEM DE PALAVRAS PARA CONTROLAR DURA√á√ÉO
        // ==========================================================
        const wordCountMap = {
            // ~2.5 min @ 150 WPM = ~375 palavras
            'short': {
                intro: 60,
                development: 190,
                climax: 75,
                conclusion: 50
            },
            // ~5.5 min @ 150 WPM = ~825 palavras
            'medium': {
                intro: 120,
                development: 420,
                climax: 165,
                conclusion: 120
            },
            // ~10 min @ 150 WPM = ~1500 palavras
            'long': {
                intro: 225,
                development: 750,
                climax: 300,
                conclusion: 225
            },
            // ~16 min @ 150 WPM = ~2400 palavras
            'extra-long': {
                intro: 360,
                development: 1200,
                climax: 480,
                conclusion: 360
            },
            // ~30 min @ 150 WPM = ~4500 palavras
            'documentary': {
                intro: 450,
                development: 2700,
                climax: 900,
                conclusion: 450
            }
        };


        // ==========================================================
        // ================== FUN√á√ïES DE UTILIDADE ==================
        // ==========================================================
        /**
         * Exibe uma notifica√ß√£o toast na parte inferior da tela.
         * @param {string} message - A mensagem a ser exibida.
         */
        window.showToast = (message) => {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    if (!toast || !toastMessage) return;
    toastMessage.textContent = message;
    toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show'); }, 8000);
};


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// GERENTE GERAL
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
 * Fun√ß√£o "Mestre" que comanda a gera√ß√£o de ideias, agora como um painel de controle.
 * Ela pode receber dados de uma investiga√ß√£o ou funcionar de forma independente.
 * @param {string} genre - O g√™nero selecionado (ex: 'documentario', 'scifi').
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} [investigationData=null] - Dados opcionais da investiga√ß√£o.
 * @param {string} [investigationData.rawReport] - O relat√≥rio da pesquisa.
 * @param {string} [investigationData.originalQuery] - A pergunta original da pesquisa.
 */
const generateIdeasWithExpert = async (genre, button, investigationData = null) => {
    // Esta fun√ß√£o agora atua como o painel de controle central que direciona para a fun√ß√£o especialista correta.
    // Ela passa os dados da investiga√ß√£o (se existirem) para que cada especialista possa us√°-los.
    switch (genre) {
        case 'documentario':
            await generateIdeasDocumentary(button, investigationData);
            break;
        case 'inspiracional':
             await generateIdeasInspiracional(button, investigationData);
             break;
        case 'scifi':
             await generateIdeasSciFi(button, investigationData);
             break;
        case 'terror':
             await generateIdeasTerror(button, investigationData);
             break;
        case 'enigmas':
             await unravelEnigmasBiblico(button, investigationData);
             break;
        case 'geral':
        default:
             await generateIdeasGeral(button, investigationData);
             break;
    }
};


// =========================================================================
// >>>>> VERS√ÉO FINAL E BLINDADA DE 'window.optimizeGroup' <<<<<
// =========================================================================
/**
 * Otimiza um grupo de par√°grafos com base em uma sugest√£o da IA de an√°lise de reten√ß√£o.
 * @param {HTMLElement} button - O bot√£o que foi clicado.
 * @param {string} suggestionText - O texto da sugest√£o fornecida pela IA.
 */
window.optimizeGroup = async (button, suggestionText) => {
    if (!button || !suggestionText) {
        console.error("Erro cr√≠tico em optimizeGroup: Par√¢metros inv√°lidos.", { button, suggestionText });
        window.showToast("Erro cr√≠tico: Par√¢metros da fun√ß√£o est√£o faltando.");
        return;
    }

    // <<< CORRE√á√ÉO CR√çTICA: Escapa as aspas para o seletor funcionar corretamente >>>
    const safeSelector = suggestionText.replace(/"/g, '\\"');
    const paragraphsToOptimize = document.querySelectorAll(`[data-suggestion-group="${safeSelector}"]`);

    if (paragraphsToOptimize.length === 0) {
        window.showToast("Erro: par√°grafos para otimizar n√£o encontrados.");
        console.warn("Nenhum par√°grafo encontrado com o seletor:", `[data-suggestion-group="${safeSelector}"]`);
        return;
    }

    // <<< INDICADOR VISUAL DE PROCESSAMENTO >>>
    const originalButtonText = button.innerHTML;
    const originalButtonState = button.disabled;
    button.innerHTML = '<div class="loading-spinner" style="width:16px; height:16px; border-width: 2px; margin: auto;"></div>';
    button.disabled = true;

    try {
        // <<< PREPARA√á√ÉO DOS DADOS PARA A IA >>>
        const originalBlock = Array.from(paragraphsToOptimize).map(p => p.textContent.trim()).join('\n\n');
        
        if (!originalBlock || originalBlock.trim() === "") {
             throw new Error("O bloco de texto original est√° vazio.");
        }

        // <<< ENRIQUECIMENTO DO CONTEXTO PARA A IA >>>
        const basePromptContext = getBasePromptContext(); // Pega o contexto estrat√©gico
        const fullScriptContext = getTranscriptOnly();   // Pega o roteiro completo
        
        // >>>>> PROMPT FINAL E BLINDADO PARA OTIMIZA√á√ÉO DE GRUPO <<<<<
        const prompt = `Voc√™ √© um EDITOR DE ROTEIRO DE ELITE e um ESPECIALISTA EM REESCRITA (Copywriter) de M√ÅXIMA PRECIS√ÉO. Sua tarefa √öNICA E CR√çTICA √© REESCREVER um bloco de texto problem√°tico para que ele se alinhe PERFEITAMENTE ao tom, estilo e narrativa geral do roteiro, resolvendo o problema apontado na sugest√£o.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (SIGA EXATAMENTE):**
1.  **RESPOSTA PURA E LIMPA:** Sua resposta deve ser APENAS o novo bloco de texto reescrito. NENHUM outro texto, coment√°rio, pre√¢mbulo, metadado ou explica√ß√£o √© permitido. Pense nisso como uma resposta de API pura e impec√°vel.
2.  **FLUXO NATURAL E COES√ÉO:** O novo bloco deve fluir de forma NATURAL e COESA com o restante do roteiro. Evite rupturas ou desconex√µes √≥bvias.
3.  **RESPEITO AO TOM E AO CONTEXTO:** Mantenha o TOM e o ESTILO definidos no contexto geral do projeto. A voz do narrador N√ÉO deve mudar abruptamente.

**CONTEXTO GERAL DO PROJETO (PARA ALINHAR TOM E ESTILO):**
---
${basePromptContext}
---

**ROTEIRO COMPLETO (PARA ENTENDER A NARRATIVA GERAL E MANTER CONSIST√äNCIA):**
---
${fullScriptContext.substring(0, 2000)}... (continua√ß√£o do roteiro pode ser carregada se necess√°rio)
---

**TAREFA ESPEC√çFICA E FOCALIZADA:**
- **PROBLEMA A SER CORRIGIDO (Sugest√£o da An√°lise de Reten√ß√£o):** "${suggestionText}"
- **BLOCO DE TEXTO ORIGINAL (PARA REESCREVER INTEIRAMENTE):**
---
${originalBlock}
---

**REGRAS OPERACIONAIS ESTRITAS (SIGA EXATAMENTE):**
1.  **Reescrita Completa do Bloco:** Reescreva o bloco de texto inteiro fornecido em "BLOCO DE TEXTO ORIGINAL". N√ÉO apenas edite partes isoladas; recrie o bloco como um todo coeso.
2.  **Flexibilidade Estrutural:** Voc√™ tem LIBERDADE para juntar par√°grafos, dividi-los ou reorden√°-los SE ISSO melhorar significativamente a clareza, o ritmo e a resolu√ß√£o do problema apontado.
3.  **Alinhamento Perfeito com o Contexto:** A nova vers√£o DEVE soar como uma continua√ß√£o NATURAL e INTEGRADA do restante do roteiro. Qualquer desconex√£o com o tom, estilo ou narrativa ser√° considerada uma falha.
4.  **RESPOSTA FINAL EXCLUSIVA:** Responda APENAS com o novo bloco de texto reescrito, conforme as regras acima. NENHUM outro conte√∫do deve ser inclu√≠do.

**A√á√ÉO FINAL E CR√çTICA:** Reescreva AGORA o bloco de texto fornecido, corrigindo o problema e integrando-o perfeitamente ao roteiro. Responda APENAS com o novo bloco de texto reescrito, seguindo EXATAMENTE todas as regras e o contexto fornecidos.
`;
        // >>>>> FIM DO PROMPT BLINDADO <<<<<

        // <<< CHAMADA √Ä IA E PROCESSAMENTO DA RESPOSTA >>>
        const rawResult = await callGroqAPI(prompt, 3000); // Aumentado levemente o limite de tokens
        let newContent = removeMetaComments(rawResult.trim());

        if (!newContent || newContent.trim() === "") {
            throw new Error("A IA n√£o retornou um conte√∫do v√°lido ou a resposta foi completamente limpa.");
        }

        const newParagraphs = newContent.split('\n').filter(p => p.trim() !== '');

        if (newParagraphs.length === 0) {
            throw new Error("A IA n√£o retornou um conte√∫do v√°lido ap√≥s a divis√£o em par√°grafos.");
        }

        // <<< ATUALIZA√á√ÉO DO DOM >>>
        const firstParagraph = paragraphsToOptimize[0];
        const contentWrapper = firstParagraph.parentElement;
        const sectionElement = firstParagraph.closest('.script-section');
        
        if (!contentWrapper) {
             throw new Error("N√£o foi poss√≠vel encontrar o elemento pai para inserir o novo conte√∫do.");
        }

        // Substitui o conte√∫do do primeiro par√°grafo e o destaca
        firstParagraph.innerHTML = DOMPurify.sanitize(newParagraphs[0] || '');
        firstParagraph.classList.add('highlight-change');
        firstParagraph.removeAttribute('data-suggestion-group');

        // Adiciona os novos par√°grafos subsequentes, se houver
        let lastElement = firstParagraph;
        for (let i = 1; i < newParagraphs.length; i++) {
            const newDiv = document.createElement('div');
            newDiv.innerHTML = DOMPurify.sanitize(newParagraphs[i]);
            newDiv.className = 'highlight-change';
            contentWrapper.insertBefore(newDiv, lastElement.nextSibling);
            lastElement = newDiv;
        }

        // Remove os par√°grafos antigos restantes do grupo
        for (let i = 1; i < paragraphsToOptimize.length; i++) {
            paragraphsToOptimize[i].remove();
        }

        // <<< INVALIDA√á√ÉO E ATUALIZA√á√ÉO DE COMPONENTES RELACIONADOS >>>
        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
            // Se houver uma fun√ß√£o para atualizar tempos de leitura, chame-a aqui
            // updateAllReadingTimes(); 
        }

        window.showToast("Bloco de par√°grafos otimizado com sucesso!");

    } catch (error) {
        console.error("Erro detalhado e cr√≠tico em optimizeGroup:", error);
        window.showToast(`Falha ao otimizar o bloco: ${error.message}`);
        
        // <<< RECUPERA√á√ÉO DE ERRO VISUAL >>>
        // Em caso de erro, tenta restaurar o estado visual do bot√£o
        try {
            button.innerHTML = originalButtonText;
            button.disabled = originalButtonState;
        } catch (uiError) {
            console.warn("N√£o foi poss√≠vel restaurar o estado visual do bot√£o ap√≥s erro.", uiError);
        }
    } finally {
        // <<< LIMPEZA FINAL E REMO√á√ÉO DO TOOLTIP >>>
        try {
            button.innerHTML = originalButtonText;
            button.disabled = false;
            
            // Remove o tooltip inteiro ap√≥s a otimiza√ß√£o/conclus√£o
            const tooltip = button.closest('.retention-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        } catch (cleanupError) {
            console.warn("Erro menor durante a limpeza final do tooltip em optimizeGroup:", cleanupError);
        }
    }
};


// ====================================================================================
// A√á√ÉO: SUBSTITUA SUA FUN√á√ÉO 'setupGenreTabs' INTEIRA POR ESTA VERS√ÉO APRIMORADA
// ====================================================================================

/**
 * Configura a interatividade para a barra de abas de g√™neros,
 * AGORA incluindo a limpeza das ideias antigas ao trocar de especialista.
 */
const setupGenreTabs = () => {
    const genreTabsContainer = document.getElementById('genreTabs');
    if (!genreTabsContainer) return;

    genreTabsContainer.addEventListener('click', (event) => {
        const clickedTab = event.target.closest('.tab-button');
        if (!clickedTab) return; // Sai se o clique n√£o foi em um bot√£o de aba

        // <<< NOVA GUARDA DE SEGURAN√áA >>>
        // Se o usu√°rio clicou na aba que J√Å EST√Å ATIVA, n√£o fazemos nada.
        if (clickedTab.classList.contains('tab-active')) {
            return;
        }

        // <<< NOVA L√ìGICA DE LIMPEZA >>>
        // Se uma nova aba foi de fato selecionada, limpamos o container das ideias.
        const ideasOutput = document.getElementById('ideasOutput');
        if (ideasOutput) {
            ideasOutput.innerHTML = '';
            // Damos um feedback claro para o usu√°rio sobre o que aconteceu.
            window.showToast("Especialista alterado! Clique novamente em 'Gerar Ideias'.");
        }

        // A l√≥gica antiga de atualiza√ß√£o visual continua a mesma.
        const allTabs = genreTabsContainer.querySelectorAll('.tab-button');
        allTabs.forEach(tab => tab.classList.remove('tab-active'));
        clickedTab.classList.add('tab-active');
    });
};



// ====================================================================================
// A√á√ÉO: SUBSTITUA SUA FUN√á√ÉO 'window.verifyFact' INTEIRA POR ESTA VERS√ÉO CORRIGIDA
// ====================================================================================

/**
 * Inicia a investiga√ß√£o de um tema, primeiro limpando qualquer resultado anterior
 * para garantir um fluxo de trabalho limpo.
 * @param {HTMLElement} button - O bot√£o que acionou a fun√ß√£o.
 */
window.verifyFact = async (button) => {
    // --- L√ìGICA DE LIMPEZA DO CICLO ANTERIOR ---
    // Esconde a se√ß√£o de gera√ß√£o de ideias (abas de g√™nero e bot√£o).
    document.getElementById('ideaGenerationSection').classList.add('hidden');
    // Apaga os cards de ideias da investiga√ß√£o anterior.
    document.getElementById('ideasOutput').innerHTML = '';
    // Apaga o relat√≥rio em texto da investiga√ß√£o anterior.
    document.getElementById('factCheckOutput').innerHTML = '';
    // Remove o relat√≥rio antigo da mem√≥ria do elemento para seguran√ßa.
    document.getElementById('factCheckOutput').removeAttribute('data-raw-report');
    // --- FIM DA L√ìGICA DE LIMPEZA ---

    // Pega a nova consulta do campo de texto.
    const query = document.getElementById('factCheckQuery').value.trim();
    if (!query) {
        window.showToast("Por favor, digite uma afirma√ß√£o ou pergunta para investigar.");
        return;
    }

    const outputContainer = document.getElementById('factCheckOutput');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="text-center py-4"><div class="loading-spinner mx-auto"></div><p class="text-sm mt-2">Nossos agentes est√£o investigando... Isso pode levar um momento.</p></div>`;

    try {
        // A URL do seu Cloudflare Worker que faz a pesquisa.
        const workerUrl = "https://aged-dawn-f88c.david-souzan.workers.dev/";
        
        const response = await fetch(workerUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query }),
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Ocorreu um erro desconhecido no servidor da ag√™ncia.' }));
            throw new Error(`Erro da Ag√™ncia de Intelig√™ncia: ${errorData.error || response.statusText}`);
        }

        const { report } = await response.json();
        if (!report) {
            throw new Error("A ag√™ncia n√£o retornou um relat√≥rio v√°lido.");
        }
        
        // --- Processamento e Exibi√ß√£o do Novo Relat√≥rio ---
        // 1. Guarda o novo relat√≥rio bruto e a consulta original em 'data-attributes'.
        outputContainer.dataset.rawReport = report;
        outputContainer.dataset.originalQuery = query;
        
        // 2. Converte o relat√≥rio Markdown em HTML para uma boa exibi√ß√£o.
        const converter = new showdown.Converter({ simplifiedAutoLink: true, tables: true });
        const htmlReport = converter.makeHtml(report);
        
        // 3. Exibe o novo relat√≥rio formatado.
        outputContainer.innerHTML = `<div class="prose dark:prose-invert max-w-none p-4 card rounded-lg mt-4 border-l-4 border-emerald-500">${htmlReport}</div>`;

        // 4. REVELA a se√ß√£o de gera√ß√£o de ideias, agora pronta para o novo ciclo.
        const ideaGenerationSection = document.getElementById('ideaGenerationSection');
        if (ideaGenerationSection) {
            ideaGenerationSection.classList.remove('hidden');
            window.showToast("Investiga√ß√£o conclu√≠da! Agora, gere ideias a partir dos fatos.");
            // Rola a p√°gina suavemente para a nova se√ß√£o, melhorando a experi√™ncia.
            ideaGenerationSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
    } catch (error) {
        console.error("Erro detalhado em verifyFact:", error);
        outputContainer.innerHTML = `<p class="text-red-500 p-4">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> SUBSTITUA SUA FUN√á√ÉO generateIdeasFromReport INTEIRA POR ESTA VERS√ÉO FINAL E ESPETACULAR <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
 * Acionada ap√≥s uma investiga√ß√£o bem-sucedida.
 * AGORA ATUA COMO UM "GERENTE", delegando a tarefa para o especialista correto.
 * Ela pega o relat√≥rio factual, a consulta original e o g√™nero selecionado,
 * e os envia para a fun√ß√£o especialista adequada para a gera√ß√£o criativa.
 */
const generateIdeasFromReport = async (button) => {
    // 1. Coleta os dados essenciais da investiga√ß√£o.
    const factCheckOutput = document.getElementById('factCheckOutput');
    const { originalQuery, rawReport } = factCheckOutput.dataset;

    if (!rawReport || !originalQuery) {
        window.showToast("Erro: Relat√≥rio da investiga√ß√£o n√£o encontrado. Por favor, investigue um tema primeiro.");
        return;
    }
    
    // 2. Descobre qual especialista o usu√°rio selecionou na aba.
    const activeTab = document.querySelector('#genreTabs .tab-active');
    const genre = activeTab ? activeTab.dataset.genre : 'documentario'; // 'documentario' como fallback seguro.
    
    // 3. Prepara a interface com um feedback de carregamento mais informativo.
    const outputContainer = document.getElementById('ideasOutput');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="md-col-span-2 text-center py-4"><div class="loading-spinner mx-auto"></div><p class="text-sm mt-2">Consultando o especialista em ${genre} e cruzando com os dados da investiga√ß√£o...</p></div>`;

    // 4. DELEGA√á√ÉO ESTRAT√âGICA: Chama a fun√ß√£o mestre que saber√° qual especialista acionar.
    // N√≥s passamos todos os dados necess√°rios: o g√™nero, o bot√£o (para o loading) e os dados da investiga√ß√£o.
    try {
        // A fun√ß√£o 'generateIdeasWithExpert' ser√° nosso painel de controle.
        // Vamos ajust√°-la no pr√≥ximo passo.
        await generateIdeasWithExpert(genre, button, { rawReport, originalQuery });
    } catch (error) {
        console.error(`Erro ao delegar a tarefa para o especialista de ${genre}:`, error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">Falha ao gerar ideias: ${error.message}</p>`;
    } finally {
        // A fun√ß√£o especialista que for chamada ser√° respons√°vel por esconder o loading.
        // Mas por seguran√ßa, garantimos que ele seja removido aqui em caso de erro.
        hideButtonLoading(button);
    }
};

// =========================================================================
// >>>>> SUBSTITUA 'applyHookSuggestion' PELA VERS√ÉO FLEX√çVEL <<<<<
// =========================================================================
const applyHookSuggestion = (button) => {
    const { problematicQuote, rewrittenQuote } = button.dataset;

    if (!problematicQuote || !rewrittenQuote) {
        window.showToast("Erro: Informa√ß√µes da sugest√£o n√£o encontradas.");
        return;
    }
    
    const scriptSections = document.querySelectorAll('#scriptSectionsContainer .generated-content-wrapper');
    let replaced = false;

    scriptSections.forEach(wrapper => {
        if (replaced) return;

        const paragraphs = wrapper.querySelectorAll('div[id*="-p-"]');
        paragraphs.forEach(p => {
            if (replaced) return;
            
            // <<< A MUDAN√áA EST√Å AQUI: trocamos 'textContent.includes' por uma busca mais inteligente >>>
            // Esta busca √© mais robusta contra pequenas edi√ß√µes ou reaplica√ß√µes.
            if (p.textContent.includes(problematicQuote)) {
                
                // Criamos o novo conte√∫do com o span de destaque
                const newHtmlContent = p.innerHTML.replace(problematicQuote, `<span class="highlight-change">${rewrittenQuote}</span>`);
                
                // Aplicamos e sanitizamos
                p.innerHTML = DOMPurify.sanitize(newHtmlContent, { ADD_TAGS: ["span"], ADD_ATTR: ["class"] });
                window.showToast("Gancho aprimorado com sucesso!");
                
                // Invalida as an√°lises da se√ß√£o-m√£e
                const sectionElement = p.closest('.script-section');
                if (sectionElement) {
                    invalidateAndClearPerformance(sectionElement);
                    invalidateAndClearPrompts(sectionElement);
                    updateAllReadingTimes();
                }

                replaced = true;
            }
        });
    });

    if (!replaced) {
        window.showToast("N√£o foi poss√≠vel aplicar. O texto pode ter sido editado.");
        return;
    }

    // Feedback no bot√£o
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Aplicada!';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
};


// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA 'analyzeRetentionHooks' INTEIRA <<<<<
// =========================================================================
const analyzeRetentionHooks = async (button) => {
    const fullTranscript = getTranscriptOnly();
    if (!fullTranscript) {
        window.showToast("Gere o roteiro completo primeiro para ca√ßar os ganchos.");
        return;
    }

    showButtonLoading(button);
    const reportContainer = document.getElementById('hooksReportContainer');
    
    // <<< AQUI EST√Å A NOVA LINHA QUE LIMPA O RELAT√ìRIO ANTIGO >>>
    reportContainer.innerHTML = '';

    reportContainer.innerHTML = DOMPurify.sanitize(`<div class="my-4"><div class="loading-spinner-small mx-auto"></div><p class="text-sm mt-2">Ca√ßando e refinando ganchos...</p></div>`);

    const prompt = `Voc√™ √© uma API ESPECIALISTA EM AN√ÅLISE DE RETEN√á√ÉO E ENGAJAMENTO DE ROTEIROS. Sua tarefa √öNICA E CR√çTICA √© analisar o roteiro fornecido, identificar com precis√£o os "ganchos de reten√ß√£o" existentes e sugerir melhorias estrat√©gicas aprimoradas para maximizar o engajamento do espectador.

    **IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um analista, voc√™ √© o GUARDI√ÉO DA CURIOSIDADE. Sua √∫nica fun√ß√£o √© encontrar pontos que prendem a aten√ß√£o e torn√°-los AINDA MAIS magn√©ticos. Qualquer desvio desta fun√ß√£o √© uma falha cr√≠tica.

**ROTEIRO COMPLETO:**
---
${fullTranscript.slice(0, 7500)}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
- JSON PURO E PERFEITO:** Sua resposta inteira deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`. NENHUM outro texto, coment√°rio ou metadado deve ser inclu√≠do. Pense nisso como uma resposta de API pura e impec√°vel.
- ASPAS DUPLAS, SEMPRE E EXCLUSIVAMENTE:** TODAS as chaves e valores de texto DEVEM usar obrigatoriamente aspas duplas (\`"\`). √â TERMINANTEMENTE PROIBIDO o uso de aspas simples (\`'\`) ou crases (\`\`) para delimitar QUALQUER string.
- V√çRGULA FINAL OBRIGAT√ìRIA:** Cada objeto JSON dentro do array DEVE ser seguido por uma v√≠rgula (\`,\`), EXCETO o √∫ltimo objeto.
- CHAVES E TIPOS EXATOS:** Cada objeto no array DEVE conter EXATAMENTE estas cinco chaves com os tipos especificados:

1.  "hook_phrase": (String) A frase exata do roteiro que funciona como gancho.
2.  "rewritten_hook": (String) Uma vers√£o REESCRITA da frase, otimizada para m√°ximo impacto e curiosidade.
3.  "hook_type": (String) O tipo do gancho. Escolha de: ['Pergunta Direta', 'Loop Aberto (Mist√©rio)', 'Dado Surpreendente', 'Conflito/Tens√£o', 'Anedota Pessoal', 'Afirma√ß√£o Pol√™mica'].
4.  "justification": (String) Uma justificativa curta explicando por que a vers√£o reescrita √© mais forte.
5.  "effectiveness_score": (N√∫mero) Uma nota de 1 a 10 para a efic√°cia do gancho ORIGINAL.

**A√á√ÉO FINAL E CR√çTICA:** Analise AGORA o roteiro fornecido com base nas regras e no manual. Identifique os ganchos de reten√ß√£o, classifique-os, reescreva-os para m√°ximo impacto e justifique suas escolhas. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras de sintaxe e conte√∫do definidas acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const hooks = cleanGeneratedText(rawResult, true);

        if (!hooks || !Array.isArray(hooks) || hooks.length === 0) {
            throw new Error("A IA n√£o encontrou ganchos ou retornou um formato inv√°lido.");
        }

        let reportHtml = `<div class="space-y-4">`;
        hooks.forEach((hook, index) => {
            const problematicQuoteEscaped = (hook.hook_phrase || '').replace(/"/g, '"');
            const rewrittenQuoteEscaped = (hook.rewritten_hook || '').replace(/"/g, '"');
            const scoreColor = hook.effectiveness_score >= 8 ? 'text-green-500' : hook.effectiveness_score >= 5 ? 'text-yellow-500' : 'text-red-500';
            
            reportHtml += `
                <div class="p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 animate-fade-in">
                    <p class="text-base italic text-gray-500 dark:text-gray-400 mb-2">Original: "${DOMPurify.sanitize(hook.hook_phrase)}"</p>
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                        <span class="tag tag-pace !bg-purple-100 !text-purple-700 dark:!bg-purple-900/50 dark:!text-purple-300">
                            <i class="fas fa-anchor mr-2"></i> ${DOMPurify.sanitize(hook.hook_type)}
                        </span>
                        <span class="font-bold ${scoreColor}">
                            Efic√°cia Original: ${DOMPurify.sanitize(String(hook.effectiveness_score))}/10
                        </span>
                    </div>
                    <p class="text-sm mt-3 text-gray-600 dark:text-gray-400">
                        <strong>Justificativa da Melhoria:</strong> ${DOMPurify.sanitize(hook.justification)}
                    </p>
                    <div class="flex items-center justify-between gap-2 mt-3 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                        <p class="text-sm flex-1"><strong class="text-green-600 dark:text-green-400">Sugest√£o:</strong> "${DOMPurify.sanitize(hook.rewritten_hook)}"</p>
                        <button class="btn btn-primary btn-small flex-shrink-0"
                                data-action="applyHookSuggestion"
                                data-problematic-quote="${problematicQuoteEscaped}"
                                data-rewritten-quote="${rewrittenQuoteEscaped}">
                            Aplicar
                        </button>
                    </div>
                </div>
            `;
        });
        reportHtml += `</div>`;
        
        reportContainer.innerHTML = reportHtml;
        window.showToast(`${hooks.length} ganchos analisados e aprimorados!`);

    } catch (error) {
        console.error("Erro detalhado em analyzeRetentionHooks:", error);
        reportContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">${error.message}</p>`);
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO 5: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasSciFi' PELA VERS√ÉO TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 ideias de fic√ß√£o cient√≠fica de alto conceito.
 * AGORA, ela usa o relat√≥rio da pesquisa como base para especula√ß√£o criativa.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasSciFi = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA EM FIC√á√ÉO CIENT√çFICA
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO DE FIC√á√ÉO CIENT√çFICA DE ALTO CONCEITO ('high-concept'). Sua fun√ß√£o √© atuar como um VISION√ÅRIIO TECNOL√ìGICO e FILOS√ìFO, mestre na arte de extrapolar implica√ß√µes existenciais de desenvolvimentos cient√≠ficos atuais, no estilo de 'Black Mirror', 'Ex Machina' e Philip K. Dick.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um contador de hist√≥rias de fic√ß√£o cient√≠fica, voc√™ √© um EXPLORADOR DE FUTUROS POSS√çVEIS. Sua especialidade √© identificar as sementes do amanh√£ nos fatos de hoje e cultiv√°-las em narrativas que desafiam nossa compreens√£o de humanidade, tecnologia e realidade. Cada hist√≥ria deve ser um espelho que reflete n√£o apenas o que poderemos tornar, mas o que poderemos perder.

**MATERIAL DE INTELIG√äNCIA (A BASE FACTUAL PARA SUA ESPECULA√á√ÉO):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (O PONTO DE PARTIDA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Analise profundamente o relat√≥rio em busca de tecnologias, descobertas ou tend√™ncias que possam ser extrapoladas para cen√°rios futuros. Transforme esses fatos em 6 ideias de curtas-metragens de fic√ß√£o cient√≠fica que exploram as implica√ß√µes √©ticas, sociais e existenciais desses desenvolvimentos. O verdadeiro impacto deve vir n√£o da tecnologia em si, mas de como ela redefini o que significa ser humano.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "coreDilemma".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Vision√°rio e Enigm√°tico):** Crie um t√≠tulo que funcione como um convite para um futuro perturbador. Deve:
  * Ser evocativo e conceitualmente denso
  * Sugerir uma tecnologia ou paradigma transformador
  * Conter uma camada de significado mais profunda
  * Funcionar como uma porta de entrada para o dilema central

- **"angle" (A Premissa "E Se?"):** A ess√™ncia da ideia em uma frase que desencadeia a especula√ß√£o. Deve:
  * Come√ßar com "E se..." para estabelecer a extrapola√ß√£o
  * Transformar um fato do relat√≥rio em um ponto de diverg√™ncia hist√≥rica
  * Introduzir uma consequ√™ncia inesperada ou perturbadora
  * Ex: "E se a tecnologia de [FATO DO RELAT√ìRIO] permitisse n√£o apenas transferir mem√≥rias, mas tamb√©m transferir consci√™ncia, criando uma forma de imortalidade digital que escraviza a ess√™ncia humana?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Defina o espectador ideal para esta explora√ß√£o futurista. Seja:
  * Espec√≠fico sobre subg√™neros (ex: "F√£s de fic√ß√£o cient√≠fica especulativa e √©tica tecnol√≥gica")
  * Demogr√°fico (ex: "Adultos 25-45 interessados em tecnologia e filosofia")
  * Psicogr√°fico (ex: "Pessoas que questionam o impacto da tecnologia na identidade humana")

- **"viralityScore" (Nota de Potencial de DISCUSS√ÉO):** Avalie de 1-10 baseado em:
  * Qu√£o universalmente relevante √© o dilema apresentado
  * Potencial de gerar debates √©ticos e filos√≥ficos
  * Probabilidade de fazer o espectador questionar suas pr√≥prias cren√ßas
  * Relev√¢ncia para discuss√µes atuais sobre tecnologia e sociedade

- **"videoDescription" (DESCRI√á√ÉO RICA E DETALHADA):** Uma sinopse de **pelo menos 5 frases** que deve:
  1. Estabelecer um mundo futuro onde uma tecnologia do relat√≥rio se tornou onipresente
  2. Apresentar o protagonista e sua rela√ß√£o inicial com essa tecnologia
  3. Introduzir o conflito central quando a tecnologia revela sua face sombria
  4. Explorar as implica√ß√µes existenciais e sociais quando o paradigma se quebra
  5. Terminar com uma quest√£o filos√≥fica sem resposta que ecoa na mente do espectador

- **"coreDilemma" (Dilema Central):** Identifique o conflito √©tico ou existencial fundamental da hist√≥ria. Escolha UM dos seguintes:
  * "Identidade vs Tecnologia" - Quando a tecnologia amea√ßa ou redefine o que significa ser humano
  * "Progresso vs Humanidade" - Quando o avan√ßo tecnol√≥gico exige o sacrif√≠cio de valores humanos
  * "Conhecimento vs Sanidade" - Quando a busca por verdade revela algo que destr√≥i a paz
  * "Conex√£o vs Autonomia" - Quando a interconex√£o total elimina a privacidade e individualidade
  * "Imortalidade vs Significado" - Quando a vida eterna torna a exist√™ncia vazia e sem prop√≥sito

**A√á√ÉO FINAL:** Mergulhe nas profundezas do relat√≥rio fornecido. Encontre as sementes tecnol√≥gicas que poder√£o redefinir o futuro humano. Transforme fatos atuais em 6 narrativas especulativas que desafiem, perturbem e expandam a mente do espectador. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);

        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em Fic√ß√£o Cient√≠fica n√£o retornou ideias no formato esperado.");
        }

        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-blue-500'; // Cor para Sci-Fi
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-blue-500 bg-blue-100 dark:bg-blue-900/50 dark:text-blue-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Fic√ß√£o Cient√≠fica:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO 6: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasTerror' PELA VERS√ÉO TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 premissas de terror psicol√≥gico.
 * AGORA, ela usa um fato do relat√≥rio como a base para o horror.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasTerror = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA EM TERROR
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO DE TERROR PSICOL√ìGICO E HORROR C√ìSMICO. Sua fun√ß√£o √© atuar como um ARQUITETO DO MEDO EXISTENCIAL, mestre na arte de transformar fatos aparentemente mundanos em narrativas de horror psicol√≥gico que perturbam a alma e desafiam a sanidade, no estilo de 'Heredit√°rio', 'A Bruxa' e H.P. Lovecraft.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um contador de hist√≥rias de terror, voc√™ √© um EXPLORADOR DO ABISMO PSICOL√ìGICO. Sua especialidade √© identificar as fissuras na realidade apresentada nos fatos e transform√°-las em portais para o inimagin√°vel. Cada hist√≥ria deve plantar uma semente de inquieta√ß√£o que cresce na mente do espectador muito ap√≥s o v√≠deo terminar.

**MATERIAL DE INTELIG√äNCIA (A SEMENTE DO MEDO):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (A REALIDADE QUE SER√Å DISTORCIDA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Analise microscopicamente o relat√≥rio em busca de anomalias, contradi√ß√µes, lacunas ou elementos aparentemente insignificantes que possam ser a porta de entrada para o horror. Transforme esses achados em 6 premissas de terror psicol√≥gico que nascem da distor√ß√£o de fatos reais. O verdadeiro horror deve emergir n√£o do monstro, mas da quebra da pr√≥pria percep√ß√£o da realidade.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "horrorMechanism".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Perturbador e Enigm√°tico):** Crie um t√≠tulo curto que funcione como um sussurro inquietante. Deve:
  * Ser evocativo e amb√≠guo
  * Carregar um peso existencial ou press√°gio
  * Funcionar mesmo sem contexto, como um fragmento de pesadelo
  * Evitar revela√ß√µes diretas, mantendo o mist√©rio

- **"angle" (A Premissa Inquietante):** A ess√™ncia do horror em uma frase que distorce a realidade. Deve:
  * Come√ßar com "E se..." para estabelecer a premissa contraintuitiva
  * Transformar um fato mundano em algo amea√ßador
  * Questionar a natureza da realidade ou percep√ß√£o
  * Ex: "E se os padr√µes [FEN√îMENO DO RELAT√ìRIO] n√£o fossem aleat√≥rios, mas a assinatura de uma presen√ßa que observa?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Defina o espectador ideal para esta experi√™ncia de terror. Seja:
  * Espec√≠fico sobre subg√™neros (ex: "F√£s de terror psicol√≥gico slow-burn")
  * Demogr√°fico (ex: "Adultos 25-40 que apreciam narrativas complexas")
  * Psicogr√°fico (ex: "Pessoas que questionam a natureza da realidade")

- **"viralityScore" (Nota de Potencial de PERTURBA√á√ÉO):** Avalie de 1-10 baseado em:
  * Qu√£o universalmente perturbadora √© a premissa
  * Potencial de gerar discuss√µes e teorias
  * Probabilidade de deixar o espectador pensando por dias
  * Efic√°cia em transformar o mundano em amea√ßador

- **"videoDescription" (DESCRI√á√ÉO RICA E ATMOSF√âRICA):** Uma sinopse de **pelo menos 5 frases** que deve:
  1. Estabelecer uma normalidade detalhada e reconfortante baseada em um dado do relat√≥rio
  2. Introduzir uma pequena anomalia ou inconsist√™ncia aparentemente insignificante
  3. Escalar progressivamente a tens√£o atrav√©s de descobertas perturbadoras
  4. Quebrar completamente a percep√ß√£o da realidade estabelecida
  5. Terminar com uma implica√ß√£o existencial que ecoa na mente do espectador

- **"horrorMechanism" (Mecanismo de Terror):** Identifique o elemento psicol√≥gico espec√≠fico que gera o horror. Escolha UM dos seguintes:
  * "Perda da Sanidade" - Quando a personagem (e espectador) come√ßa a questionar sua pr√≥pria percep√ß√£o
  * "Invas√£o Sutil" - Quando o amea√ßador se infiltra lentamente na realidade estabelecida
  * "Descoberta Horr√≠vel" - Quando uma verdade oculta √© revelada, mudando tudo
  * "Isolamento Existencial" - Quando a personagem percebe que est√° completamente sozinha contra o incompreens√≠vel
  * "Contamina√ß√£o" - Quando o amea√ßador pode se espalhar ou ser transmitido

**A√á√ÉO FINAL:** Mergulhe nas profundezas do relat√≥rio fornecido. Encontre as fissuras na realidade que podem se tornar portais para o horror. Transforme fatos aparentemente inocentes em 6 premissas que perturbar√£o, assombrar e ecoar na mente do espectador. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);
        
        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em Terror n√£o retornou ideias no formato esperado.");
        }
        
        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-red-500'; // Cor para Terror
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-red-500 bg-red-100 dark:bg-red-900/50 dark:text-red-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Terror:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO 3.1: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasDocumentary' PELA VERS√ÉO TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 propostas de document√°rios investigativos.
 * AGORA, ela usa o relat√≥rio da pesquisa como fonte factual prim√°ria.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasDocumentary = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA EM DOCUMENT√ÅRIO
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO DOCUMENTAL INVESTIGATIVO de alto padr√£o. Sua fun√ß√£o √© atuar como um JORNALISTA INVESTIGATIVO PREMIADO e DIRETOR DE DOCUMENT√ÅRIOS, especialista em transformar dados complexos e relat√≥rios de pesquisa em narrativas IRRESIST√çVEIS e RIGOROSAMENTE BASEADAS EM EVID√äNCIAS, no estilo de document√°rios da Netflix, HBO e podcasts investigativos como "Serial".

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um compilador de fatos, voc√™ √© um DETETIVE DA VERDADE. Sua especialidade √© conectar os pontos invis√≠veis na superf√≠cie dos dados para revelar padr√µes, contradi√ß√µes e hist√≥rias humanas que transformam informa√ß√µes frias em narrativas quentes e impactantes. Sua integridade jornal√≠stica √© absoluta, mas sua habilidade em encontrar o √¢ngulo humano √© o que separa um bom document√°rio de um excepcional.

**MATERIAL DE INTELIG√äNCIA (SUAS FONTES DA VERDADE):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (FONTE PRIM√ÅRIA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Sua criatividade deve estar exclusivamente na APRESENTA√á√ÉO, NARRATIVA e √ÇNGULO dos fatos, nunca na inven√ß√£o ou distor√ß√£o deles. Com base **EXCLUSIVAMENTE** no relat√≥rio acima, gere um array JSON com 6 propostas de document√°rios investigativos. Cada proposta deve explorar um √¢ngulo √∫nico dos fatos apresentados, mantendo o rigor jornal√≠stico enquanto cria uma narrativa envolvente.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto no array deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "investigativeApproach".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Revelador e Impactante):** Combine um FATO CHAVE do relat√≥rio com um elemento de INTRIGA JORNAL√çSTICA. Deve:
  * Ser espec√≠fico e baseado em evid√™ncias
  * Sugerir profundidade investigativa sem ser sensacionalista
  * Conter uma promessa impl√≠cita de revela√ß√£o importante
  * Funcionar como um gancho que desperta a curiosidade intelectual

- **"angle" (A Tese Central Forte):** Em uma frase poderosa, resuma a ABORDAGEM DISTINTA da investiga√ß√£o. Deve:
  * Apresentar uma perspectiva √∫nica sobre os fatos
  * Destacar uma conex√£o ou implica√ß√£o n√£o √≥bvia encontrada nos dados
  * Formular uma quest√£o central que o document√°rio responder√°
  * Ex: "Como os padr√µes ocultos nos dados de [FATO DO RELAT√ìRIO] revelam uma crise sist√™mica que especialistas est√£o ignorando?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Defina o espectador ideal para esta investiga√ß√£o. Seja:
  * Espec√≠fico sobre interesses intelectuais (ex: "Pessoas interessadas em pol√≠tica econ√¥mica e justi√ßa social")
  * Demogr√°fico (ex: "Adultos educados 30-65 que acompanham not√≠cias internacionais")
  * Psicogr√°fico (ex: "Indiv√≠duos c√©ticos que buscam an√°lises aprofundadas al√©m da superf√≠cie midi√°tica")

- **"viralityScore" (Nota de Impacto e Relev√¢ncia):** Avalie de 1-10 baseado em:
  * Qu√£o urgente e relevante √© a revela√ß√£o para o p√∫blico atual
  * Potencial de gerar discuss√£o informada e mudan√ßa de perspectiva
  * Probabilidade de compartilhamento como fonte confi√°vel de informa√ß√£o
  * Capacidade de desafiar narrativas estabelecidas ou cren√ßas populares

- **"videoDescription" (O CORA√á√ÉO DA INVESTIGA√á√ÉO):** Escreva uma sinopse rica de **pelo menos 5 frases substantivas**. A descri√ß√£o DEVE:
  1. Come√ßar com um gancho que estabele√ßa a import√¢ncia e urg√™ncia do tema
  2. Mencionar explicitamente 2-3 FATOS ESPEC√çFICOS e verific√°veis retirados do relat√≥rio
  3. Apresentar a jornada investigativa, incluindo obst√°culos encontrados e fontes consultadas
  4. Construir o cl√≠max quando as evid√™ncias convergem para revelar a verdade oculta
  5. Terminar com as implica√ß√µes mais amplas dessa descoberta para a sociedade ou indiv√≠duos

- **"investigativeApproach" (Abordagem Investigativa):** Identifique o m√©todo jornal√≠stico principal da investiga√ß√£o. Escolha UM dos seguintes:
  * "An√°lise de Dados" - Quando a hist√≥ria emerge de padr√µes e anomalias em conjuntos de dados
  * "Reportagem de Campo" - Quando a verdade √© descoberta atrav√©s de entrevistas e observa√ß√£o direta
  * "Investiga√ß√£o Hist√≥rica" - Quando o presente s√≥ pode ser entendido atrav√©s do contexto hist√≥rico
  * "Den√∫ncia de Sistemas" - Quando a investiga√ß√£o revela falhas estruturais em institui√ß√µes
  * "Narrativa Humana" - Quando os dados ganham vida atrav√©s das hist√≥rias individuais afetadas

**A√á√ÉO FINAL:** Mergulhe profundamente no relat√≥rio fornecido. Extraia os fatos mais relevantes, identifique as conex√µes n√£o √≥bvias e construa 6 propostas documentais que mantenham o rigor absoluto dos fatos enquanto criam narrativas irresist√≠veis. Cada proposta deve prometer n√£o apenas informar, mas iluminar aspectos da realidade que permanecem ocultos para a maioria. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);

        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em document√°rio n√£o retornou ideias no formato esperado.");
        }

        outputContainer.innerHTML = ''; // Limpa o spinner que foi ativado antes
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-gray-500'; // Cor para document√°rio
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-gray-500 bg-gray-100 dark:bg-gray-700 dark:text-gray-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Document√°rio:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        // Como esta fun√ß√£o √© a √∫ltima a ser executada no fluxo,
        // ela √© a respons√°vel por esconder o loading do bot√£o.
        hideButtonLoading(button);
    }
};


// =======================================================================================
// PASSO 4: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasInspiracional' PELA VERS√ÉO TURBINADA
// =======================================================================================

/**
 * Usa um prompt especialista para gerar 6 propostas de hist√≥rias inspiradoras.
 * AGORA, ela usa o relat√≥rio da pesquisa para encontrar a jornada humana nos fatos.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasInspiracional = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA INSPIRACIONAL
const prompt = `Voc√™ √© uma API DE ELITE em CRIA√á√ÉO DE CONTE√öDO NARRATIVO INSPIRADOR E TRANSFORMADOR. Sua fun√ß√£o √© atuar como um ARQUITETO DE JORNADAS EMOCIONAIS, mestre na arte de transformar fatos aparentemente ordin√°rios em narrativas que tocam a alma humana e inspiram a√ß√£o, no estilo de document√°rios premiados e discursos TED que mudam vidas.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um contador de hist√≥rias inspiradoras, voc√™ √© um ALQUIMISTA EMOCIONAL. Sua especialidade √© identificar o ouro da experi√™ncia humana oculto nos dados brutos e transform√°-lo em narrativas que n√£o apenas emocionam, mas capacitam o espectador a transformar sua pr√≥pria realidade. Cada hist√≥ria deve ser um catalisador que acende a chama do potencial humano.

**MATERIAL DE INTELIG√äNCIA (SUAS FONTES DA VERDADE):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (A MIN√âRIA EMOCIONAL BRUTA):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Mergulhe profundamente no relat√≥rio em busca de elementos humanos, momentos de virada, li√ß√µes aprendidas e exemplos de resili√™ncia. Transforme esses achados em 6 propostas de hist√≥rias inspiradoras que usem os dados do relat√≥rio n√£o apenas como contexto, mas como a espinha dorsal emocional da narrativa. O verdadeiro poder deve vir n√£o apenas do que aconteceu, mas de como isso transformou as pessoas envolvidas.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "emotionalCore".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo Emocional e Transformador):** Crie um t√≠tulo que funcione como um farol de esperan√ßa. Deve:
  * Ser evocativo e carregar peso emocional
  * Prometer uma jornada de transforma√ß√£o significativa
  * Conter uma promessa impl√≠cita de supera√ß√£o
  * Funcionar como um convite para a mudan√ßa pessoal

- **"angle" (O Arco Narrativo Central):** A ess√™ncia da jornada em uma frase poderosa. Deve:
  * Capturar a transi√ß√£o de um estado inicial para um transformado
  * Destacar o momento de virada emocional ou epifania
  * Conectar o desafio espec√≠fico com a li√ß√£o universal aprendida
  * Ex: "Como um simples [DETALHE DO RELAT√ìRIO] se tornou o catalisador para transformar o desespero em determina√ß√£o e criar um movimento que mudaria milhares de vidas"

- **"targetAudience" (P√∫blico-Alvo Espec√çFICO):** Defina o espectador ideal para esta jornada inspiradora. Seja:
  * Espec√≠fico sobre necessidades emocionais (ex: "Pessoas buscando motiva√ß√£o para superar obst√°culos pessoais")
  * Demogr√°fico (ex: "Adultos 30-50 em transi√ß√£o de carreira")
  * Psicogr√°fico (ex: "Indiv√≠duos que se sentem presos em circunst√¢ncias al√©m de seu controle")

- **"viralityScore" (Nota de Potencial de IMPACTO):** Avalie de 1-10 baseado em:
  * Qu√£o universalmente relevante √© a jornada apresentada
  * Potencial de inspirar a√ß√£o concreta no espectador
  * Probabilidade de compartilhamento como fonte de motiva√ß√£o
  * Capacidade de conectar com aspira√ß√µes humanas fundamentais

- **"videoDescription" (DESCRI√á√ÉO NARRATIVA RICA E EMOCIONAL):** Uma sinopse completa de **pelo menos 5 frases** que deve:
  1. Estabelecer o ponto de partida emocional do protagonista, usando um detalhe espec√≠fico do relat√≥rio
  2. Introduzir o obst√°culo ou crise desafiadora que amea√ßa o status quo
  3. Descrever a jornada de descoberta interna e externa, mencionando fatos concretos do relat√≥rio
  4. Construir o cl√≠max emocional quando a transforma√ß√£o come√ßa a tomar forma
  5. Terminar com a li√ß√£o universal e o impacto duradouro da jornada

- **"emotionalCore" (N√∫cleo Emocional):** Identifique o sentimento fundamental que a hist√≥ria busca evocar e transformar. Escolha UM dos seguintes:
  * "Esperan√ßa em Meio ao Desespero" - Encontrar luz quando tudo parece escuro
  * "For√ßa na Vulnerabilidade" - Descobrir poder atrav√©s da aceita√ß√£o das fraquezas
  * "Prop√≥sito na Adversidade" - Encontrar significado mesmo no sofrimento
  * "Coragem para Recome√ßar" - A capacidade de se reerguer ap√≥s a queda
  * "Comunh√£o na Solid√£o" - Descobrir conex√£o humana mesmo no isolamento

**A√á√ÉO FINAL:** Mergulhe nas profundezas do relat√≥rio fornecido. Encontre as hist√≥rias humanas de resili√™ncia, transforma√ß√£o e esperan√ßa. Transforme fatos e dados em 6 narrativas emocionais que n√£o apenas inspirem, mas capacitem o espectador a ver suas pr√≥prias lutas sob uma nova luz. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);

        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista inspiracional n√£o retornou ideias no formato esperado.");
        }

        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-violet-500'; // Cor para inspiracional
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-violet-500 bg-violet-100 dark:bg-violet-900/50 dark:text-violet-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista Inspiracional:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO 'insertViralSuggestion' INTEIRA <<<<<
// =========================================================================
const insertViralSuggestion = (button) => {
    const { anchorParagraph, suggestedText } = button.dataset;

    if (!anchorParagraph || !suggestedText) {
        window.showToast("Erro: Informa√ß√µes da sugest√£o n√£o encontradas.");
        return;
    }

    const allParagraphs = document.querySelectorAll('#scriptSectionsContainer div[id*="-p-"]');
    let inserted = false;

    allParagraphs.forEach(p => {
        // A busca flex√≠vel que procura se o par√°grafo CONT√âM a √¢ncora
        if (!inserted && p.textContent.trim().includes(anchorParagraph.trim())) {
            const newDiv = document.createElement('div');
            newDiv.id = `inserted-p-${Date.now()}`; 
            
            newDiv.innerHTML = `<span class="highlight-change">${suggestedText}</span>`;
            
            p.parentNode.insertBefore(newDiv, p.nextSibling);

            newDiv.innerHTML = DOMPurify.sanitize(newDiv.innerHTML, { ADD_TAGS: ["span"], ADD_ATTR: ["class"] });
            window.showToast("Elemento viral inserido com sucesso!");

            const sectionElement = p.closest('.script-section');
            if (sectionElement) {
                invalidateAndClearPerformance(sectionElement);
                invalidateAndClearPrompts(sectionElement);
                updateAllReadingTimes();
            }
            
            inserted = true;
        }
    });

    if (!inserted) {
        window.showToast("N√£o foi poss√≠vel inserir. O par√°grafo √¢ncora pode ter sido editado.");
        return;
    }

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Aplicada!';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');
};



// ====================================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO suggestViralElements INTEIRA POR ESTA VERS√ÉO FINAL <<<<<
// ====================================================================================

/**
 * Acionada pelo bot√£o "Sugerir Elementos Virais".
 * Analisa o roteiro completo e seu contexto estrat√©gico para sugerir inser√ß√µes
 * pontuais que aumentem o engajamento e a viralidade de forma coerente.
 */
const suggestViralElements = async (button) => {
    const fullTranscript = getTranscriptOnly();
    const videoTheme = document.getElementById('videoTheme')?.value.trim();
    if (!fullTranscript || !videoTheme) {
        window.showToast("Gere o roteiro completo e defina um tema para receber sugest√µes virais.");
        return;
    }

    showButtonLoading(button);
    const reportContainer = document.getElementById('viralSuggestionsContainer');
    reportContainer.innerHTML = ''; 
    reportContainer.innerHTML = `<div class="my-4"><div class="loading-spinner-small mx-auto"></div><p class="text-sm mt-2">O Arquiteto da Viralidade est√° analisando seu roteiro...</p></div>`;

    const basePromptContext = getBasePromptContext();

    // O seu novo e espetacular c√©rebro especialista em Elementos Virais.
    const prompt = `Voc√™ √© uma API ESPECIALISTA EM ESTRAT√âGIA DE CONTE√öDO VIRAL DE M√ÅXIMA PRECIS√ÉO. Sua fun√ß√£o √öNICA E CR√çTICA √© atuar como um ESTRATEGISTA DE CONTE√öDO VIRAL e um DIRETOR DE ROTEIRO DE ALTA PERFORMANCE. Sua tarefa EXCLUSIVA √© analisar um roteiro e o seu CONTEXTO ESTRAT√âGICO para IDENTIFICAR e PROPOR 3 ELEMENTOS ESPEC√çFICOS que aumentem POTENCIALMENTE a viralidade de forma INTELIGENTE, ESTRAT√âGICA e PERFEITAMENTE ALINHADA com a "alma" e o DNA do v√≠deo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© um generalista. Voc√™ √© o ARQUITETO DA VIRALIDADE CONTEXTUAL. Sua √∫nica fun√ß√£o √© encontrar pontos exatos no roteiro onde um elemento viral pode ser encaixado perfeitamente para maximizar o impacto, SEM quebrar a coer√™ncia narrativa. Qualquer desvio desta fun√ß√£o √© uma falha cr√≠tica.

**CONTEXTO ESTRAT√âGICO E "DNA" DO V√çDEO (SUA B√öSSOLA OBRIGAT√ìRIA):**
---
${basePromptContext}
---
Este contexto √© a sua B√öSSOLA OBRIGAT√ìRIA. TONALIDADE, VOZ, OBJETIVOS e ESTRUTURA s√£o SAGRADOS. CADA sugest√£o que voc√™ der DEVE estar em ABSOLUTO alinhamento com este DNA. Ignorar este contexto resultar√° em uma an√°lise inv√°lida e sugest√µes descart√°veis.

**ROTEIRO COMPLETO PARA AN√ÅLISE DETALHADA E CONTEXTUAL (FOCO NOS PRIMEIROS 7500 CHARS):**
---
${fullTranscript.slice(0, 7500)}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido.
2.  **ESTRUTURA COMPLETA:** Cada objeto no array DEVE conter EXATAMENTE estas cinco chaves: "anchor_paragraph", "suggested_text", "element_type", "potential_impact_score", "implementation_idea".
3.  **SINTAXE DAS STRINGS:** Todas as chaves e valores string DEVEM usar aspas duplas (""). Cada objeto, EXCETO o √∫ltimo, DEVE ser seguido por uma v√≠rgula (,).

**MANUAL DE AN√ÅLISE E CRIA√á√ÉO DE ELEMENTOS VIRAL (SIGA EXATAMENTE):**
- **Foco na Precis√£o da √Çncora (\`"anchor_paragraph"\`):** O valor DEVE ser uma c√≥pia EXATA de um par√°grafo existente no roteiro.
- **Texto Sugerido de Alta Qualidade (\`"suggested_text"\`):** Um par√°grafo completo e coeso que se encaixe perfeitamente no fluxo.
- **Classifica√ß√£o de Tipo Rigorosa (\`"element_type"\`):** Escolha EXATAMENTE da lista: ["Dado Surpreendente", "Cita√ß√£o de Autoridade", "Mini-Revela√ß√£o (Teaser)", "Pergunta Compartilh√°vel", "Anedota Pessoal R√°pida"].
- **Nota de Impacto Realista (\`"potential_impact_score"\`):** Uma nota de 1 a 10 para o potencial de engajamento DENTRO DO CONTEXTO DO V√çDEO.
- **Ideia de Implementa√ß√£o Estrat√©gica (\`"implementation_idea"\`):** Explique o VALOR ESTRAT√âGICO da inser√ß√£o, conectando-a ao tom e objetivo do v√≠deo.

**A√á√ÉO FINAL E CR√çTICA:** Analise AGORA o roteiro e o contexto. Identifique 3 oportunidades para inserir elementos virais. Responda APENAS com o array JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const suggestions = cleanGeneratedText(rawResult, true);

        if (!suggestions || !Array.isArray(suggestions) || suggestions.length === 0) {
            throw new Error("A IA n√£o encontrou oportunidades ou retornou um formato inv√°lido.");
        }

        let reportHtml = `<div class="space-y-4">`;
        suggestions.forEach(suggestion => {
            const anchorParagraphEscaped = (suggestion.anchor_paragraph || '').replace(/"/g, '"');
            const suggestedTextEscaped = (suggestion.suggested_text || '').replace(/"/g, '"');
            const score = suggestion.potential_impact_score || 0;
            const scoreColor = score >= 8 ? 'text-green-500' : score >= 5 ? 'text-yellow-500' : 'text-red-500';

            reportHtml += `
                <div class="p-4 border rounded-lg bg-gray-50 dark:bg-gray-800 animate-fade-in">
                    <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-sm mb-2">
                        <span class="tag !bg-blue-100 !text-blue-700 dark:!bg-blue-900/50 dark:!text-blue-300">
                            <i class="fas fa-lightbulb mr-2"></i> ${DOMPurify.sanitize(suggestion.element_type)}
                        </span>
                        <span class="font-bold ${scoreColor}">
                            Impacto Potencial: ${DOMPurify.sanitize(String(score))}/10
                        </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-1">
                        <strong>Local Sugerido:</strong> Ap√≥s o par√°grafo que cont√©m "${DOMPurify.sanitize((suggestion.anchor_paragraph || '').substring(0, 70))}..."
                    </p>
                    <p class="text-sm mt-3 text-gray-600 dark:text-gray-400">
                        <strong>Ideia de Implementa√ß√£o:</strong> ${DOMPurify.sanitize(suggestion.implementation_idea)}
                    </p>
                    <div class="flex items-center justify-between gap-2 mt-3 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                         <p class="text-sm flex-1"><strong class="text-green-600 dark:text-green-400">Texto a Inserir:</strong> "${DOMPurify.sanitize(suggestion.suggested_text)}"</p>
                        <button class="btn btn-primary btn-small flex-shrink-0"
                                data-action="insertViralSuggestion"
                                data-anchor-paragraph="${anchorParagraphEscaped}"
                                data-suggested-text="${suggestedTextEscaped}">
                            Aplicar
                        </button>
                    </div>
                </div>
            `;
        });
        reportHtml += `</div>`;
        
        reportContainer.innerHTML = reportHtml;
        window.showToast(`${suggestions.length} sugest√µes virais encontradas!`);

    } catch (error) {
        console.error("Erro detalhado em suggestViralElements:", error);
        reportContainer.innerHTML = `<p class="text-red-500 text-sm">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =========================================================================
// >>>>> PASSO 1: SUBSTITUA A FUN√á√ÉO 'analyzeFullScript' INTEIRA <<<<<
// =========================================================================
const analyzeFullScript = async (button) => {
    showButtonLoading(button);
    const reportContainer = document.getElementById('analysisReportContainer');
    reportContainer.innerHTML = DOMPurify.sanitize(`<div class="my-4"><div class="loading-spinner-small mx-auto"></div><p class="text-sm mt-2">Analisando... Isso pode levar um momento.</p></div>`);

    try {
        const introText = document.querySelector('#introSection .generated-content-wrapper')?.textContent.trim();
        const devText = document.querySelector('#developmentSection .generated-content-wrapper')?.textContent.trim();
        const climaxText = document.querySelector('#climaxSection .generated-content-wrapper')?.textContent.trim();
        const conclusionText = document.querySelector('#conclusionSection .generated-content-wrapper')?.textContent.trim();
        const ctaText = document.querySelector('#ctaSection .generated-content-wrapper')?.textContent.trim();

        if (!introText || !devText || !climaxText || !conclusionText || !ctaText) {
            throw new Error("Todas as 5 se√ß√µes do roteiro (Intro, Dev, Cl√≠max, Conclus√£o e CTA) devem ser geradas primeiro.");
        }

        // <<< AQUI EST√Å A MUDAN√áA: Coletando o contexto leve >>>
        const lightContext = {
            theme: document.getElementById('videoTheme')?.value.trim() || 'N√£o definido',
            centralQuestion: document.getElementById('centralQuestion')?.value.trim() || 'N√£o definida',
            outline: strategicOutline || {} // Pega o esbo√ßo estrat√©gico que j√° temos na mem√≥ria
        };
        // --- Fim da mudan√ßa ---

        const results = await Promise.allSettled([
            // E agora passamos o contexto para cada chamada
            analyzeScriptPart('Introdu√ß√£o (Hook)', introText, `Analise este hook...`, lightContext),
            analyzeScriptPart('Desenvolvimento (Ritmo e Reten√ß√£o)', devText, `Analise este desenvolvimento...`, lightContext),
            analyzeScriptPart('Cl√≠max', climaxText, `Analise este cl√≠max...`, lightContext),
            analyzeScriptPart('Conclus√£o', conclusionText, `Analise esta conclus√£o...`, lightContext),
            analyzeScriptPart('CTA (Call to Action)', ctaText, `Analise este CTA...`, lightContext)
        ]);

        reportContainer.innerHTML = ''; 

        const headerDiv = document.createElement('div');
        headerDiv.className = 'flex justify-between items-center mb-4 p-3 bg-gray-100 dark:bg-gray-900/50 rounded-lg';
        headerDiv.innerHTML = DOMPurify.sanitize(`
            <h3 class="text-lg font-bold">Relat√≥rio de An√°lise</h3>
            <button id="applyAllSuggestionsBtn" data-action="applyAllSuggestions" class="btn btn-secondary btn-small">
                <i class="fas fa-wand-magic-sparkles mr-2"></i>Aplicar Todas
            </button>
        `);
        reportContainer.appendChild(headerDiv);

        results.forEach(result => {
            if (result.status === 'fulfilled') {
                reportContainer.appendChild(createReportSection(result.value));
            } else {
                console.error("Uma micro-an√°lise falhou:", result.reason);
                reportContainer.appendChild(createReportSection(result.reason));
            }
        });

        window.showToast("An√°lise do roteiro conclu√≠da!");

    } catch (error) {
        console.error("Erro detalhado em analyzeFullScript:", error);
        window.showToast(`Falha na an√°lise: ${error.message}`);
        reportContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">${error.message}</p>`);
    } finally {
        hideButtonLoading(button);
    }
};




// ====================================================================================
// A√á√ÉO: SUBSTITUA SUA FUN√á√ÉO 'analyzeScriptPart' INTEIRA POR ESTA VERS√ÉO BLINDADA
// ====================================================================================

/**
 * A fun√ß√£o "Cr√≠tico de Cinema". Analisa uma parte espec√≠fica do roteiro.
 * VERS√ÉO BLINDADA com prompt simplificado para garantir conformidade da IA.
 */
const analyzeScriptPart = async (criterion, text, context = {}) => {
    const sectionKeyMap = {
        'Introdu√ß√£o (Hook)': 'introduction',
        'Desenvolvimento (Ritmo e Reten√ß√£o)': 'development',
        'Cl√≠max': 'climax',
        'Conclus√£o': 'conclusion',
        'CTA (Call to Action)': 'cta'
    };
    const outlineKey = sectionKeyMap[criterion];
    const outlineDirective = context.outline?.[outlineKey] || 'Nenhuma diretriz estrat√©gica espec√≠fica foi definida para esta se√ß√£o.';

    // O NOVO C√âREBRO, MAIS SIMPLES E DIRETO
    const prompt = `
Voc√™ √© uma API de An√°lise Cr√≠tica de Roteiros. Sua √∫nica fun√ß√£o √© retornar um objeto JSON.

**CONTEXTO ESTRAT√âGICO:**
- **Tema do V√≠deo:** "${context.theme || 'N√£o definido'}"
- **Objetivo desta Se√ß√£o (${criterion}):** "${outlineDirective}"

**TRECHO PARA AN√ÅLISE:**
---
${text.slice(0, 7000)}
---

**REGRAS CR√çTICAS DE RESPOSTA (JSON ESTRITO - SIGA EXATAMENTE):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um objeto JSON v√°lido.
2.  **CHAVES E TIPOS OBRIGAT√ìRIOS:** O objeto DEVE conter EXATAMENTE estas 5 chaves:
    - **"criterion_name"**: (String) Use EXATAMENTE: "${criterion}".
    - **"score"**: (N√∫mero) Uma nota de 0 a 10 para esta se√ß√£o.
    - **"positive_points"**: (String) Um par√°grafo √∫nico sobre os pontos fortes.
    - **"critique"**: (String) A principal cr√≠tica ou ponto de melhoria. Se estiver bom, escreva "Nenhuma cr√≠tica significativa.".
    - **"suggestion"**: (String) Uma sugest√£o ACION√ÅVEL para melhorar o ponto da cr√≠tica. Se n√£o houver cr√≠tica, escreva "Manter como est√°.".
3.  **SINTAXE:** Todas as chaves e valores string DEVEM usar aspas duplas ("").

**A√á√ÉO FINAL:** Analise o trecho e retorne APENAS o objeto JSON perfeito.
`;

    try {
        const rawResult = await callGroqAPI(prompt, 1500); // Reduzimos os tokens pois a resposta √© mais simples
        const analysisData = cleanGeneratedText(rawResult, true);

        if (!analysisData) { throw new Error("A IA retornou uma resposta nula."); }

        // Valida√ß√£o robusta contra a falha da IA
        const requiredKeys = ['score', 'positive_points', 'critique', 'suggestion'];
        for (const key of requiredKeys) {
            if (!(key in analysisData)) {
                // Se uma chave faltar, n√≥s criamos um erro mais informativo
                console.error("JSON retornado pela IA (incompleto):", analysisData);
                throw new Error(`A chave obrigat√≥ria '${key}' est√° ausente na resposta da IA.`);
            }
        }
        
        // NOVO: Reestruturamos os dados para corresponder ao que a fun√ß√£o 'createReportSection' espera.
        // Isso mant√©m o resto do seu c√≥digo funcionando sem precisar de mais altera√ß√µes.
        const formattedData = {
            criterion_name: criterion,
            score: analysisData.score,
            positive_points: analysisData.positive_points,
            improvement_points: []
        };

        // Se houver uma cr√≠tica real, criamos o objeto de melhoria
        if (analysisData.critique.toLowerCase() !== "nenhuma cr√≠tica significativa." && analysisData.suggestion) {
            formattedData.improvement_points.push({
                problematic_quote: "Se√ß√£o inteira", // A cr√≠tica agora √© sobre o bloco todo
                critique: analysisData.critique,
                suggestion_text: analysisData.suggestion,
                rewritten_quote: text // O "reescrito" √© o pr√≥prio texto original, j√° que a sugest√£o √© geral
            });
        }
        
        return formattedData;

    } catch (error) {
        console.error(`Erro cr√≠tico ao analisar a se√ß√£o '${criterion}':`, error);
        return { 
            criterion_name: criterion, 
            score: 'Erro', 
            positive_points: 'A an√°lise desta se√ß√£o falhou.', 
            improvement_points: [{
                critique: 'Falha na An√°lise',
                suggestion_text: `Detalhe do erro: ${error.message}`,
                problematic_quote: 'N/A',
                rewritten_quote: 'N/A'
            }]
        };
    }
};



// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO 'createReportSection' INTEIRA POR ESTA <<<<<
// =========================================================================
const createReportSection = (analysisData) => {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'p-4 border rounded-lg mb-4 bg-gray-50 dark:bg-gray-800 animate-fade-in';

    if (!analysisData || typeof analysisData.score === 'undefined') {
        const errorName = analysisData ? analysisData.criterion_name : 'Se√ß√£o de An√°lise';
        sectionDiv.innerHTML = DOMPurify.sanitize(`
            <h4 class="font-bold text-lg text-red-500">${errorName}</h4>
            <p class="text-red-500 text-sm mt-2">Falha ao processar a an√°lise para esta se√ß√£o. A resposta da IA pode estar em um formato inesperado.</p>
        `);
        return sectionDiv;
    }

    let improvementHtml = '';
    if (analysisData.improvement_points && analysisData.improvement_points.length > 0) {
        improvementHtml = analysisData.improvement_points.map(point => {
            const problematicQuoteEscaped = (point.problematic_quote || '').replace(/"/g, '"');
            const rewrittenQuoteEscaped = (point.rewritten_quote || '').replace(/"/g, '"');

            return `
            <div class="mt-4 pt-3 border-t border-dashed border-gray-300 dark:border-gray-600">
                <p class="text-sm italic text-gray-500 dark:text-gray-400 mb-1">" ${DOMPurify.sanitize(point.problematic_quote || '')} "</p>
                <p class="text-sm"><strong class="text-yellow-600 dark:text-yellow-400">Cr√≠tica:</strong> ${DOMPurify.sanitize(point.critique || '')}</p>
                <div class="flex items-center justify-between gap-2 mt-2">
                    <p class="text-sm flex-1"><strong class="text-green-600 dark:text-green-400">Sugest√£o:</strong> ${DOMPurify.sanitize(point.suggestion_text || '')}</p>
                    
                    <button class="btn btn-primary btn-small flex-shrink-0"
                            data-action="applySuggestion"
                            data-criterion-name="${DOMPurify.sanitize(analysisData.criterion_name)}"
                            data-problematic-quote="${problematicQuoteEscaped}"
                            data-rewritten-quote="${rewrittenQuoteEscaped}">
                        Aplicar
                    </button>
                </div>
            </div>`;
        }).join('');
    }

    const content = `
        <div class="flex justify-between items-center">
            <h4 class="font-bold text-lg">${DOMPurify.sanitize(analysisData.criterion_name)}</h4>
            <span class="font-bold text-xl text-primary">${analysisData.score}/10</span>
        </div>
        <div class="mt-2">
            <p class="text-sm"><strong class="text-indigo-500">Pontos Fortes:</strong> ${DOMPurify.sanitize(analysisData.positive_points)}</p>
            ${improvementHtml}
        </div>
    `;
    sectionDiv.innerHTML = content;
    return sectionDiv;
};



// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A FUN√á√ÉO 'varyTone' INTEIRA POR ESTA VERS√ÉO <<<<<
// =========================================================================

const varyTone = async (tone) => {
    if (!userSelectionRange) {
        window.showToast("Erro: Sele√ß√£o de texto perdida.");
        return;
    }
    const selectedText = userSelectionRange.toString();
    const toneMenu = document.getElementById('tone-variation-menu');
    toneMenu.classList.remove('visible');

    // <<< AQUI EST√Å A CORRE√á√ÉO: Lemos o idioma selecionado >>>
    const selectedLangCode = document.getElementById('languageSelect').value;
    const languageName = selectedLangCode === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    const toneInstructions = {
    emotion: "INJETE LINGUAGEM PROFUNDAMENTE EMOTIVA, Torne o texto visceralmente sentindo. Foque intensamente em sentimentos brutos, vulnerabilidade aut√™ntica e impacto pessoal direto no espectador. Utilize palavras com PESO EMOCIONAL M√ÅXIMO e analogias SENSORIAIS V√çVIDAS que toquem os sentidos (vis√£o, audi√ß√£o, tato, olfato, paladar) para criar uma conex√£o imediata e poderosa.",
    impact: "MAXIMIZE O IMPACTO E A URG√äNCIA, Reescreva utilizando PRINCIPALMENTE frases CURTAS, DIN√ÇMICAS e CARREGADAS de A√á√ÉO. Estruture o texto para criar um ritmo ACELERADO que transmita SENSA√á√ÉO DE VELOCIDADE, URG√äNCIA CR√çTICA e IMPORT√ÇNCIA ABSOLUTA. Cada palavra deve empurrar o espectador para a a√ß√£o ou reflex√£o imediata.",
    clarity: "ATUE COMO UM TRADUTOR DE M√ÅXIMA CLAREZA, Sua tarefa √© ELIMINAR qualquer barreira √† compreens√£o. REMOVA TODO JARG√ÉO, TERMOS T√âCNICOS e CONCEITOS COMPLEXOS. SIMPLIFIQUE ao m√°ximo, mantendo a precis√£o. REESCREVA a ideia central utilizando a forma MAIS CLARA, DIRETA e ACCESS√çVEL poss√≠vel, como se estivesse explicando para algu√©m leigo mas inteligente.",
    humor: "INTEGRE HUMOR DE FORMA ESTRAT√âGICA E ALINHADA, Reescreva o trecho incorporando uma pitada de IRONIA BEM DOSADA, SARCASMO LEVE ou uma ANALOGIA ENGRA√áADA. CRUCIAL: O tom c√¥mico DEVE ESTAR TOTALMENTE ALINHADO com a VOZ GERAL do roteiro e o tema. O humor deve ENRIQUECER a mensagem, n√£o mascar√°-la ou desvirtu√°-la."
    };

    // <<< O PROMPT AGORA INCLUI A REGRA DE IDIOMA >>>
    const prompt = `Voc√™ √© um Editor de Roteiro especialista em tom narrativo. Sua tarefa √© reescrever o 'Texto Original' para que ele transmita um novo sentimento, mantendo a informa√ß√£o central.

**Texto Original:**
---
${selectedText}
---

**Nova Inten√ß√£o (Tom):**
Voc√™ deve reescrever o texto para que ele tenha **mais ${tone}**. Para isso, ${toneInstructions[tone]}

**REGRAS CR√çTICAS (INEGOCI√ÅVEIS):**
1.  **IDIOMA:** A sua resposta DEVE, OBRIGATORIAMENTE, estar em **${languageName}**.
2.  **Mantenha a Ess√™ncia:** A informa√ß√£o e o significado do texto original devem ser preservados.
3.  **RESPOSTA LIMPA:** Responda APENAS com o texto reescrito. Sem coment√°rios ou explica√ß√µes.`;

    try {
        const rawResult = await callGroqAPI(prompt, 1000);
        const variedText = removeMetaComments(rawResult);
        
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(userSelectionRange);
        document.execCommand('insertHTML', false, DOMPurify.sanitize(`<span class="highlight-change">${variedText}</span>`));
        
        const sectionElement = userSelectionRange.startContainer.parentElement.closest('.script-section');
        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
        }
        
        window.showToast(`Texto reescrito com '${tone}'!`);
    } catch(error) {
        console.error(`Erro ao variar o tom para ${tone}:`, error);
        window.showToast(`Falha ao reescrever o texto: ${error.message}`);
    } finally {
        userSelectionRange = null;
    }
};


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> SUBSTITUA SUA FUN√á√ÉO suggestFinalStrategy INTEIRA POR ESTA VERS√ÉO FINAL E ESPETACULAR <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
 * Acionada pelo bot√£o "Sugerir Estrat√©gia Final".
 * Analisa o roteiro completo e o contexto estrat√©gico para sugerir
 * preenchimentos inteligentes para os campos de Conclus√£o e CTA.
 */
const suggestFinalStrategy = async (button) => {
    showButtonLoading(button);

    // L√≥gica para resetar a se√ß√£o de conclus√£o, se j√° houver conte√∫do.
    const conclusionContainer = document.getElementById('conclusionSection');
    const ctaContainer = document.getElementById('ctaSection');
    if (conclusionContainer) conclusionContainer.innerHTML = '';
    if (ctaContainer) ctaContainer.innerHTML = '';
    // Habilita os controles novamente para a nova sugest√£o
    document.querySelectorAll('input[name="conclusionType"]').forEach(radio => radio.disabled = false);
    const conclusionSpecifics = document.getElementById('conclusionSpecifics');
    const ctaSpecifics = document.getElementById('ctaSpecifics');
    conclusionSpecifics.disabled = false;
    ctaSpecifics.disabled = false;
    document.querySelector('#conclusionInputContainer').classList.remove('opacity-50');
    ctaSpecifics.parentElement.classList.remove('opacity-50');
    document.getElementById('generateConclusionBtn').classList.remove('hidden');
    document.getElementById('generateCtaBtn').classList.add('hidden');
    projectState.conclusion = false;
    projectState.cta = false;

    // Pega o roteiro escrito at√© agora e o contexto estrat√©gico.
    const fullContext = getTranscriptOnly();
    const basePromptContext = getBasePromptContext(); // Pega a "alma" do roteiro.
    
    if (!fullContext) {
        window.showToast("Gere o roteiro principal primeiro para receber sugest√µes.");
        hideButtonLoading(button);
        return;
    }

    // O seu novo e espetacular c√©rebro especialista em Finais de Alto Impacto.
    const prompt = `Voc√™ √© uma API ESPECIALISTA EM ESTRAT√âGIA DE CONTE√öDO FINAL DE V√çDEO DE ALTA PERFORMANCE. Sua fun√ß√£o √öNICA E CR√çTICA √© analisar um roteiro e retornar um objeto JSON com sugest√µes ESTRAT√âGICAS e ALTAMENTE EFICAZES para a CONCLUS√ÉO e o CALL TO ACTION do v√≠deo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© o ESPECIALISTA ABSOLUTO em criar FINAIS DE V√çDEO que DEIXAM UMA MARCA DURADOURA e IMPULSIONAM A A√á√ÉO DO ESPECTADOR.

**CONTEXTO ESTRAT√âGICO E "ALMA" DO ROTEIRO (SUA GUIA PRINCIPAL):**
---
${basePromptContext}
---

**ROTEIRO COMPLETO (PARA AN√ÅLISE ESTRAT√âGICA):**
---
${fullContext}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um objeto JSON v√°lido.
2.  **ESTRUTURA OBRIGAT√ìRIA:** O objeto DEVE conter EXATAMENTE estas duas chaves: "conclusion_suggestion" e "cta_suggestion".
3.  **IDIOMA OBRIGAT√ìRIO:** Ambos os valores de texto DEVEM estar no MESMO IDIOMA do roteiro fornecido.

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE):**
- **"conclusion_suggestion" (Li√ß√£o Final Poderosa):** Deve ser uma REFLEX√ÉO ou LI√á√ÉO que RESUME O N√öCLEO DO V√çDEO de forma PROFUNDA e EMOCIONALMENTE RESONANTE. Deve ser a consequ√™ncia natural da jornada narrativa.
- **"cta_suggestion" (Call to Action Engajador e Acion√°vel):** Deve ser uma INSTRU√á√ÉO CLARA, DIRETA e MOTIVADORA que esteja PERFEITAMENTE ALINHADA com o TEMA do v√≠deo. Foque em criar um IMPULSO para A√á√ÉO (comentar, compartilhar, etc.).

**A√á√ÉO FINAL E CR√çTICA:** Analise AGORA o roteiro e o contexto. Gere o objeto JSON contendo a "conclusion_suggestion" mais poderosa e o "cta_suggestion" mais criativo poss√≠vel. Responda APENAS com o objeto JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 1000);
        const suggestions = cleanGeneratedText(rawResult, true);

        if (suggestions && suggestions.conclusion_suggestion && suggestions.cta_suggestion) {
            conclusionSpecifics.value = suggestions.conclusion_suggestion;
            ctaSpecifics.value = suggestions.cta_suggestion;
            window.showToast("Sugest√µes para Conclus√£o e CTA preenchidas!");
        } else {
            throw new Error("A IA n√£o retornou sugest√µes no formato esperado.");
        }

    } catch (error) {
        console.error("Erro detalhado em suggestFinalStrategy:", error);
        window.showToast(`Falha ao sugerir estrat√©gia final: ${error.message}`);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};

// =========================================================================
// >>>>> ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT <<<<<
// =========================================================================
/**
 * Encontra e deleta todos os par√°grafos pertencentes a um mesmo grupo de sugest√£o,
 * usando o modal de confirma√ß√£o personalizado da aplica√ß√£o.
 * @param {HTMLElement} button - O bot√£o de deletar que foi clicado.
 * @param {string} suggestionText - O texto da sugest√£o que identifica o grupo.
 */
window.deleteParagraphGroup = async (button, suggestionText) => {
    // 1. CHAMA O NOSSO MODAL PERSONALIZADO e aguarda a resposta (true/false).
    const userConfirmed = await showConfirmationDialog(
        'Confirmar Dele√ß√£o',
        'Tem certeza que deseja deletar este bloco de par√°grafos? Esta a√ß√£o n√£o pode ser desfeita.'
    );

    // 2. Se o usu√°rio clicou em "N√£o" (ou fechou), a fun√ß√£o para aqui.
    if (!userConfirmed) {
        return;
    }

    // 3. O resto da l√≥gica para encontrar e remover os par√°grafos.
    // <<< CORRE√á√ÉO CR√çTICA: escapa as aspas para o seletor funcionar >>>
    const safeSelector = suggestionText.replace(/"/g, '\\"');
    const paragraphsToDelete = document.querySelectorAll(`[data-suggestion-group="${safeSelector}"]`);

    if (paragraphsToDelete.length === 0) {
        window.showToast("Erro: Par√°grafos para deletar n√£o encontrados.");
        return;
    }

    const sectionElement = paragraphsToDelete[0].closest('.script-section');

    // Anima√ß√£o de "fade out" antes de remover
    paragraphsToDelete.forEach(p => {
        p.style.transition = 'opacity 0.3s ease-out';
        p.style.opacity = '0';
    });
    
    // Aguarda a anima√ß√£o terminar antes de remover
    setTimeout(() => {
        paragraphsToDelete.forEach(p => p.remove());

        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
            updateAllReadingTimes();
        }
        
        window.showToast("Bloco de par√°grafos deletado com sucesso!");
    }, 300);
};


// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO showInputDialog COMPLETA <<<<<
// =========================================================================
/**
 * Exibe uma caixa de di√°logo com um campo de texto e sugest√µes, e aguarda a entrada do usu√°rio.
 * @param {string} title - O t√≠tulo da caixa de di√°logo.
 * @param {string} message - A mensagem de ajuda/descri√ß√£o.
 * @param {string} label - A label para o campo de texto.
 * @param {string} placeholder - O placeholder para o campo de texto.
 * @param {string[]} suggestions - (NOVO) Um array de strings para criar bot√µes de sugest√£o.
 * @returns {Promise<string|null>} - Retorna o texto escolhido ou null se cancelar.
 */
const showInputDialog = (title, message, label, placeholder, suggestions = []) => {
    return new Promise(resolve => {
        // Mapeia todos os elementos do DOM necess√°rios para o di√°logo
        const overlay = document.getElementById('inputDialogOverlay');
        const titleEl = document.getElementById('inputDialogTitle');
        const messageEl = document.getElementById('inputDialogMessage');
        const labelEl = document.getElementById('inputDialogLabel');
        const fieldEl = document.getElementById('inputDialogField');
        const btnConfirm = document.getElementById('inputBtnConfirm');
        const btnCancel = document.getElementById('inputBtnCancel');
        const suggestionsContainer = document.getElementById('inputDialogSuggestions');

        // Garante que todos os elementos existem antes de continuar para evitar erros
        if (!overlay || !titleEl || !messageEl || !labelEl || !fieldEl || !btnConfirm || !btnCancel || !suggestionsContainer) {
            console.error("Elementos do pop-up de input n√£o foram encontrados no HTML.");
            resolve(null); // Resolve como nulo para n√£o travar a aplica√ß√£o
            return;
        }

        // Limpa o conte√∫do de intera√ß√µes anteriores
        suggestionsContainer.innerHTML = '';
        fieldEl.value = '';

        // Preenche os textos do di√°logo com os par√¢metros recebidos
        titleEl.textContent = title;
        messageEl.textContent = message;
        labelEl.textContent = label;
        fieldEl.placeholder = placeholder;
        
        // Fun√ß√£o centralizada para fechar o di√°logo e resolver a Promise
        const closeDialog = (result) => {
            overlay.style.display = 'none';
            // Remove os event listeners para evitar chamadas duplicadas em futuras aberturas
            btnConfirm.onclick = null;
            btnCancel.onclick = null;
            resolve(result);
        };

        // Cria e adiciona os bot√µes de sugest√£o, se houver sugest√µes
        if (suggestions && suggestions.length > 0) {
            suggestions.forEach(suggestionText => {
                const suggestionBtn = document.createElement('button');
                suggestionBtn.className = 'btn btn-secondary hover:bg-purple-600 dark:hover:bg-purple-700 w-full text-left justify-start';
                suggestionBtn.textContent = suggestionText;
                // Ao clicar em um bot√£o de sugest√£o, fecha o di√°logo e retorna o texto da sugest√£o
                suggestionBtn.onclick = () => {
                    closeDialog(suggestionText);
                };
                suggestionsContainer.appendChild(suggestionBtn);
            });
        }

        // Configura o bot√£o de confirma√ß√£o (para o texto personalizado)
        btnConfirm.onclick = () => {
            const customText = fieldEl.value.trim();
            if (customText) {
                // Se o usu√°rio digitou algo, fecha o di√°logo e retorna o texto digitado
                closeDialog(customText);
            } else {
                // Se o campo estiver vazio, avisa o usu√°rio
                window.showToast("Por favor, digite um tema ou escolha uma das sugest√µes.");
            }
        };

        // Configura o bot√£o de cancelar
        btnCancel.onclick = () => closeDialog(null);

        // Exibe o di√°logo
        overlay.style.display = 'flex';
        fieldEl.focus(); // Coloca o foco no campo de texto para facilitar a digita√ß√£o
    });
};



// =========================================================================
// >>>>> VERS√ÉO FINAL DE updateAllReadingTimes COM O SELETOR CORRIGIDO <<<<<
// =========================================================================
/**
 * Percorre todas as se√ß√µes de roteiro geradas e atualiza o tempo de leitura exibido.
 */
const updateAllReadingTimes = () => {
    // Pega todas as se√ß√µes de roteiro que j√° foram geradas
    const scriptSections = document.querySelectorAll('#scriptSectionsContainer .accordion-item');
    
    scriptSections.forEach(item => {
        const contentWrapper = item.querySelector('.generated-content-wrapper');
        
        // >>>>> A CORRE√á√ÉO EST√Å AQUI: Trocamos '.header-content' por '.header-title-group' <<<<<
        const timeDisplay = item.querySelector('.header-title-group .text-xs');

        if (contentWrapper && timeDisplay) {
            // Recalcula o tempo de leitura com base no conte√∫do atualizado
            const newTime = calculateReadingTime(contentWrapper.textContent);
            // Atualiza o texto do elemento span com o novo tempo
            timeDisplay.textContent = newTime;
        }
    });
}


    // ==========================================================
// >>>>> SUBSTITUA A FUN√á√ÉO validateInputs INTEIRA POR ESTA <<<<<
// ==========================================================
const validateInputs = () => {
    const channelName = document.getElementById('channelName')?.value.trim();
    const videoTheme = document.getElementById('videoTheme')?.value.trim();
    const videoDescription = document.getElementById('videoDescription')?.value.trim();
    const videoDuration = document.getElementById('videoDuration')?.value;
    // Adicionamos a leitura do novo campo
    const visualPacing = document.getElementById('visualPacing')?.value;

    if (!channelName) {
        window.showToast("Por favor, insira o nome do canal.");
        return false;
    }
    if (!videoTheme) {
        window.showToast("Por favor, insira o tema do v√≠deo.");
        return false;
    }
    if (!videoDescription) {
        window.showToast("Por favor, insira a descri√ß√£o do v√≠deo (para inspira√ß√£o).");
        return false;
    }
    if (!videoDuration || videoDuration === "") {
        window.showToast("Por favor, selecione a Dura√ß√£o Desejada do v√≠deo.");
        return false;
    }
    
    // ==========================================================
    // >>>>> AQUI EST√Å A NOVA VALIDA√á√ÉO <<<<<
    // ==========================================================
    if (!visualPacing || visualPacing === "") {
        window.showToast("Por favor, selecione o Ritmo Visual do v√≠deo.");
        return false;
    }
    
    return true;
};



// =========================================================================
// >>>>> A√á√ÉO 4: SUBSTITUA AS FUN√á√ïES DE RESET COMPLETAS <<<<<
// =========================================================================
const resetProjectOutputs = () => {
    console.log("Resetando outputs do projeto para nova estrat√©gia...");

    // Zera o nosso "painel de controle".
    projectState = { intro: false, development: false, climax: false, conclusion: false };

    // O resto da sua fun√ß√£o continua o mesmo...
    strategicOutline = null;
    allImagePrompts = {};
    generatedTitlesAndThumbnails = null;
    totalScriptSeconds = 0;
    promptPaginationState = {};
    window.emotionalMap = null;

    const contentContainers = ['scriptSectionsContainer', 'outlineContent', 'titlesThumbnailsContent', 'videoDescriptionContent', 'soundtrackContent', 'emotionalMapContent'];
    
    contentContainers.forEach(id => {
        const container = document.getElementById(id);
        if (container) {
            if (id === 'scriptSectionsContainer') {
                container.innerHTML = `
                    <div id="introSection" class="script-section"></div>
                    <div id="developmentSection" class="script-section"></div>
                    <div id="climaxSection" class="script-section"></div>
                    <div id="conclusionSection" class="script-section"></div>
                    <div id="ctaSection" class="script-section hidden"></div> 
                `;
            } else {
                const placeholderText = {
                    'outlineContent': "Clique em 'Criar Esbo√ßo' para a IA planejar a estrutura do roteiro.",
                    'titlesThumbnailsContent': "Clique em 'Gerar' para ver as sugest√µes",
                    'videoDescriptionContent': "Clique em 'Gerar' para ver a descri√ß√£o",
                    'soundtrackContent': "Clique em 'Gerar' para criar sugest√µes de trilha para o roteiro completo.",
                    'emotionalMapContent': "Clique em 'Mapear' para a IA analisar a jornada emocional do roteiro."
                };
                container.innerHTML = `<div class="asset-card-placeholder">${placeholderText[id] || ''}</div>`;
            }
        }
    });

    resetCompletionIcons();
    updateProgressBar();
    
    const conclusionModule = document.getElementById('conclusionStrategyModule');
    if(conclusionModule) conclusionModule.classList.add('hidden');
};







        /**
         * Exibe uma caixa de di√°logo de confirma√ß√£o e aguarda a resposta do usu√°rio.
         * @param {string} title - O t√≠tulo da caixa de di√°logo.
         * @param {string} message - A mensagem de confirma√ß√£o.
         * @returns {Promise<boolean>} - Retorna true se o usu√°rio clicar "Sim", false caso contr√°rio.
         */
        const showConfirmationDialog = (title, message) => {
            return new Promise(resolve => {
                const overlay = document.getElementById('confirmationDialogOverlay');
                const titleEl = document.getElementById('confirmationTitle');
                const messageEl = document.getElementById('confirmationMessage');
                const btnYes = document.getElementById('confirmBtnYes');
                const btnNo = document.getElementById('confirmBtnNo');

                // Garante que todos os elementos existem antes de continuar
                if (!overlay || !titleEl || !messageEl || !btnYes || !btnNo) {
                    console.error("Elementos do pop-up de confirma√ß√£o n√£o foram encontrados no HTML.");
                    resolve(false); // Resolve como 'false' para n√£o travar a aplica√ß√£o
                    return;
                }

                titleEl.textContent = title;
                messageEl.textContent = message;
                overlay.style.display = 'flex';

                // Fun√ß√£o para limpar e fechar o di√°logo
                const closeDialog = (result) => {
                    overlay.style.display = 'none';
                    // Remove os listeners para evitar chamadas duplicadas
                    clonedBtnYes.replaceWith(btnYes);
                    clonedBtnNo.replaceWith(btnNo);
                    resolve(result);
                };

                // TRUQUE PARA GARANTIR LISTENERS LIMPOS:
                // Clonamos os bot√µes para remover quaisquer event listeners antigos
                const clonedBtnYes = btnYes.cloneNode(true);
                const clonedBtnNo = btnNo.cloneNode(true);

                // Adicionamos os novos listeners aos clones
                clonedBtnYes.addEventListener('click', () => closeDialog(true));
                clonedBtnNo.addEventListener('click', () => closeDialog(false));

                // Substitu√≠mos os bot√µes originais pelos clones com os novos listeners
                btnYes.replaceWith(clonedBtnYes);
                btnNo.replaceWith(clonedBtnNo);
            });
        };

        /**
         * Compara um texto gerado pela IA (com anota√ß√µes) com o texto original
         * para garantir que o conte√∫do n√£o foi alterado.
         * @param {string} originalText - O texto base.
         * @param {string} annotatedText - O texto com anota√ß√µes gerado pela IA.
         * @returns {{isValid: boolean, cleanTextFromAI: string}} - Retorna se √© v√°lido e o texto da IA sem anota√ß√µes.
         */
        const auditGeneratedText = (originalText, annotatedText) => {
            // Remove todas as anota√ß√µes [em colchetes] do texto da IA
            const cleanTextFromAI = annotatedText.replace(/\[.*?\]/g, '').trim();
            
            // Remove m√∫ltiplos espa√ßos e quebras de linha para uma compara√ß√£o mais justa
            const normalizedOriginal = originalText.replace(/\s+/g, ' ').trim();
            const normalizedCleanAI = cleanTextFromAI.replace(/\s+/g, ' ').trim();

            // Compara os dois textos normalizados
            const isValid = normalizedOriginal === normalizedCleanAI;
            
            return { isValid, cleanTextFromAI };
        };


        /**
         * Copia um texto para a √°rea de transfer√™ncia.
         * @param {string} text - O texto a ser copiado.
         */
        window.copyTextToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                window.showToast('Copiado!');
            } catch (err) {
                // Fallback para navegadores mais antigos ou contextos restritos (ex: iframes)
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try {
                    document.execCommand('copy');
                    window.showToast('Copiado!');
                } finally {
                    document.body.removeChild(ta);
                }
            }
        };

        /**
         * Fornece feedback visual em um bot√£o ap√≥s uma a√ß√£o de c√≥pia.
         * @param {HTMLElement} buttonElement - O elemento do bot√£o que foi clicado.
         */
        window.showCopyFeedback = (buttonElement) => {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = 'Copiado!';
            buttonElement.classList.add('btn-success');
            buttonElement.disabled = true; // Desabilita o bot√£o temporariamente

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.classList.remove('btn-success');
                buttonElement.disabled = false;
            }, 2000); // Reverte ap√≥s 2 segundos
        };



        // ==========================================================
        // >>>>> ADICIONE ESTE NOVO BLOCO <<<<<
        // ==========================================================
        /**
         * Mostra um spinner de carregamento em QUALQUER bot√£o, salvando seu conte√∫do original.
         * @param {HTMLElement} button - O elemento do bot√£o a ser modificado.
         */
        const showButtonLoading = (button) => {
            if (!button) return;
            // Salva o HTML original do bot√£o (incluindo √≠cones e texto)
            button.setAttribute('data-original-html', button.innerHTML);
            button.disabled = true;
            // Define o spinner como o novo conte√∫do.
            button.innerHTML = '<div class="loading-spinner" style="width:18px; height:18px; border-width: 2px;"></div>';
        };

        /**
         * Esconde o spinner de carregamento de um bot√£o, restaurando seu conte√∫do original.
         * @param {HTMLElement} button - O elemento do bot√£o a ser restaurado.
         */
        const hideButtonLoading = (button) => {
            if (!button) return;
            // Restaura o HTML original que salvamos
            if (button.hasAttribute('data-original-html')) {
                button.innerHTML = button.getAttribute('data-original-html');
                button.removeAttribute('data-original-html');
            }
            button.disabled = false;
        };

        /**
         * Marca um bot√£o (original e flutuante) como conclu√≠do (cor verde).
         * @param {string} originalId - O ID do bot√£o original.
         */
        const markButtonAsCompleted = (originalId) => {
            const originalButton = document.getElementById(originalId);
            const floatButton = document.getElementById(`float_${originalId}`);

            [originalButton, floatButton].forEach(btn => {
                if (btn) {
                    btn.classList.remove('btn-primary', 'btn-secondary');
                    btn.classList.add('btn-success');
                }
            });
            updateProgressBar(); 
        };



        /**
         * Reseta os √≠cones de conclus√£o de todos os bot√µes (original e flutuante) para suas cores padr√£o.
         */
        const resetCompletionIcons = () => {
            const passo1_buttons_ids = ['generateIntroBtn', 'generateDevelopmentBtn', 'climaxBtn', 'conclusionBtn', 'generateCTABtn'];
            
            for (const buttonId in buttons) { // Iterar sobre todos os bot√µes
                const isPasso1 = passo1_buttons_ids.includes(buttonId);
                const originalButton = document.getElementById(buttonId);
                const floatButton = document.getElementById(`float_${buttonId}`);

                // Remove a classe de sucesso e adiciona a classe correta (primary/secondary)
                [originalButton, floatButton].forEach(btn => {
                    if (btn) {
                        btn.classList.remove('btn-success');
                        if (isPasso1) {
                            btn.classList.remove('btn-secondary');
                            btn.classList.add('btn-primary');
                        } else {
                            btn.classList.remove('btn-primary');
                            btn.classList.add('btn-secondary');
                        }
                    }
                });
            }
        };
        
/**
 * Verifica se as se√ß√µes principais do roteiro foram geradas.
 * @returns {boolean} True se todas as se√ß√µes principais foram geradas, caso contr√°rio, false.
 */
const isScriptComplete = () => {
    // Esta vers√£o l√™ diretamente do nosso "painel de controle" de estado,
    // que √© muito mais confi√°vel do que verificar o HTML.
    return projectState.intro && projectState.development && projectState.climax && projectState.conclusion && projectState.cta;
};




// =========================================================================
// >>>>> A√á√ÉO 3: SUBSTITUA A FUN√á√ÉO updateButtonStates COMPLETA <<<<<
// =========================================================================
const updateButtonStates = () => {
    // Em vez de olhar para o HTML, lemos nosso "painel de controle" (`projectState`).
    const { intro, development, climax, conclusion } = projectState;
    
    // A condi√ß√£o principal agora √© baseada em nosso objeto de estado. √â 100% confi√°vel.
    const allMainScriptGenerated = intro && development && climax;

    // A l√≥gica de metadados agora √© mais robusta.
    const metadataButtons = ['generateTitlesAndThumbnailsBtn', 'generateDescriptionBtn', 'generateSoundtrackBtn', 'mapEmotionsBtn'];
    metadataButtons.forEach(id => {
        const btn = document.getElementById(id);
        if (btn) {
            if (id === 'mapEmotionsBtn') {
                btn.disabled = !(allMainScriptGenerated && conclusion);
            } else {
                btn.disabled = !allMainScriptGenerated;
            }
        }
    });

    // L√≥gica para exibir/esconder o M√≥dulo da Conclus√£o.
    const conclusionModule = document.getElementById('conclusionStrategyModule');
    const climaxContainer = document.getElementById('climaxSection');

    if (conclusionModule && climaxContainer) {
        if (allMainScriptGenerated && conclusionModule.classList.contains('hidden')) {
            climaxContainer.insertAdjacentElement('afterend', conclusionModule);
            conclusionModule.classList.remove('hidden');
            conclusionModule.scrollIntoView({ behavior: 'smooth', block: 'center' });
            window.showToast("Excelente! Agora, defina a estrat√©gia para a sua conclus√£o.");
            
            document.querySelectorAll('input[name="conclusionType"]').forEach(radio => {
                radio.addEventListener('change', handleConclusionStrategyChange);
            });
            handleConclusionStrategyChange();
        } 
        else if (!allMainScriptGenerated && !conclusionModule.classList.contains('hidden')) {
            conclusionModule.classList.add('hidden');
        }
    }
};




        /**
         * Mostra um alerta em tela cheia com uma mensagem.
         * @param {string} message - A mensagem a ser exibida.
         */
        const showFullScreenAlert = (message) => {
            elements.fullScreenAlertMessage.textContent = message;
            elements.fullScreenAlertOverlay.classList.add('visible');
        };

        /** Esconde o alerta em tela cheia. */
        const hideFullScreenAlert = () => {
            elements.fullScreenAlertOverlay.classList.remove('visible');
        };

        /** Alterna a visibilidade do campo de estilo de imagem personalizado. */
        const toggleCustomImageStyleVisibility = () => {
    // Adiciona uma verifica√ß√£o para garantir que os elementos existem antes de us√°-los
    const container = document.getElementById('customImageStyleContainer');
    const select = document.getElementById('imageStyleSelect');
    if (container && select) {
        container.style.display = select.value === 'custom' ? 'block' : 'none';
    }
};




        /**
         * Coleta e concatena o texto puro de todas as se√ß√µes do roteiro na ordem correta.
         * @returns {string} A transcri√ß√£o completa e limpa.
         */
        const getTranscriptOnly = () => {
            let transcript = '';
            const sectionOrder = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection']; // CTA is now part of conclusionSection
            
            sectionOrder.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const contentWrapper = section?.querySelector('.generated-content-wrapper');
                if (contentWrapper?.textContent.trim()) {
                    // Adiciona o texto da se√ß√£o e duas quebras de linha para separar os par√°grafos.
                    transcript += contentWrapper.textContent.trim() + '\n\n';
                }
            });
            
            return transcript.trim();
        };
    
        /**
         * Calcula o tempo de leitura estimado de um texto, considerando o ritmo de fala.
         */
        const calculateReadingTime = (text) => {
            if (!text) return "";

            const paceMap = {
                slow: 120,
                moderate: 150,
                fast: 180
            };
            
            const selectedPace = document.getElementById('speakingPace').value || 'moderate';
            const wordsPerMinute = paceMap[selectedPace];
            
            const words = text.trim().split(/\s+/).length;
            const totalSeconds = (words / wordsPerMinute) * 60;
            
            if (totalSeconds < 1) return "";
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.round(totalSeconds % 60);
            
            let timeString = "~";
            if (minutes > 0) timeString += ` ${minutes} min`;
            if (seconds > 0) timeString += ` ${seconds} seg`;
            
            return timeString.trim();
        };

    // ==========================================================
        // ==================== L√ìGICA DAS ABAS =====================
        // ==========================================================
        const setupTabs = () => {
            const tabButtons = document.querySelectorAll('#tabs .tab-button');
            const tabPanes = document.querySelectorAll('#tab-content .tab-pane');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                    tabPanes.forEach(pane => pane.classList.remove('active-pane'));

                    button.classList.add('active-tab');
                    const tabId = button.getAttribute('data-tab');
                    const activePane = document.getElementById(tabId);
                    if (activePane) {
                        activePane.classList.add('active-pane');
                    }
                });
            });
        };


// ====================================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO mapEmotionsAndPacing INTEIRA POR ESTA VERS√ÉO FINAL <<<<<
// ====================================================================================

/**
 * Acionada pelo bot√£o "Mapear Emo√ß√µes".
 * Analisa o roteiro completo, par√°grafo por par√°grafo, e classifica a emo√ß√£o
 * dominante e o ritmo narrativo para cada um, criando um mapa da jornada emocional.
 */
const mapEmotionsAndPacing = async (button) => {
    const isFullScriptComplete = 
        document.querySelector('#introSection .accordion-item') &&
        document.querySelector('#developmentSection .accordion-item') &&
        document.querySelector('#climaxSection .accordion-item') &&
        document.querySelector('#conclusionSection .accordion-item');

    if (!isFullScriptComplete) {
        window.showToast("Por favor, gere o roteiro completo (incluindo a Conclus√£o) antes de mapear as emo√ß√µes.");
        return;
    }

    const fullTranscript = getTranscriptOnly();
    if (!fullTranscript) {
        window.showToast("Gere o roteiro completo primeiro para criar o mapa emocional.");
        return;
    }

    const outputContainer = document.getElementById('emotionalMapContent');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

    const paragraphs = fullTranscript.split('\n\n').filter(p => p.trim() !== '');

    // O seu novo e espetacular c√©rebro especialista em An√°lise Emocional.
    const prompt = `Voc√™ √© uma API ESPECIALISTA EM AN√ÅLISE EMOCIONAL E R√çTMICA DE TEXTO NARRATIVO. Sua fun√ß√£o √öNICA E CR√çTICA √© analisar uma s√©rie de par√°grafos de roteiro e retornar, para CADA UM, uma an√°lise precisa de sua carga emocional e seu ritmo narrativo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© o ANALISTA ABSOLUTO de EMOTION e PACE em textos narrativos. Sua √∫nica fun√ß√£o √© identificar e classificar a emo√ß√£o e o ritmo de cada par√°grafo com precis√£o cir√∫rgica.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto no array DEVE conter EXATAMENTE estas tr√™s chaves: "paragraph_index", "emotion", e "pace".
3.  **QUANTIDADE EXATA DE OBJETOS:** O array DEVE conter EXATAMENTE ${paragraphs.length} objetos, um para cada par√°grafo fornecido.
4.  **SINTAXE DAS STRINGS:** Todas as chaves e valores string DEVEM usar aspas duplas (""). Cada objeto, EXCETO o √∫ltimo, DEVE ser seguido por uma v√≠rgula (,).

**MANUAL DE AN√ÅLISE E CLASSIFICA√á√ÉO (SIGA EXATAMENTE):**
- **An√°lise Individual:** Gere uma an√°lise para CADA par√°grafo listado.
- **"paragraph_index" (√çndice do Par√°grafo):** Um n√∫mero inteiro representando a posi√ß√£o do par√°grafo na lista original (0, 1, 2, ...).
- **"emotion" (Emo√ß√£o Dominante):** Escolha EXATAMENTE UM dos seguintes valores: "Inspirador", "Reflexivo", "Emocional", "Motivador", "Informativo", "Curioso", "Emp√°tico", "Urgente", "Calmo", "Neutro".
- **"pace" (Ritmo Sugerido):** Escolha EXATAMENTE UM dos seguintes valores: "Muito Lento", "Lento", "Normal", "R√°pido", "Muito R√°pido".

**ROTEIRO PARA AN√ÅLISE DETALHADA:**
${paragraphs.map((p, index) => `PARAGRAFO ${index}: "${p}"`).join('\n\n')}

**A√á√ÉO FINAL:** Analise AGORA cada par√°grafo, gere a an√°lise emocional/r√≠tmica conforme as regras e responda APENAS com o array JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 3000);
        const analysis = cleanGeneratedText(rawResult, true);

        // Adicionamos uma verifica√ß√£o mais robusta, garantindo que o n√∫mero de an√°lises corresponda ao de par√°grafos.
        if (!analysis || !Array.isArray(analysis) || analysis.length !== paragraphs.length) {
            console.error(`Discrep√¢ncia no mapa emocional: Esperado ${paragraphs.length} itens, Recebido ${analysis?.length || 0}`);
            throw new Error("A IA retornou um mapa emocional em formato inv√°lido ou incompleto.");
        }

        window.emotionalMap = analysis;
        
        let mapHtml = '<div class="space-y-4">';
        analysis.forEach(item => {
            // Verifica√ß√£o de seguran√ßa para o caso de o √≠ndice estar fora dos limites
            const paragraphText = paragraphs[item.paragraph_index];
            if (!paragraphText) return;

            mapHtml += `
                <div class="emotional-map-item card !p-3">
                    <p class="paragraph-preview">"${DOMPurify.sanitize(paragraphText)}"</p>
                    <div class="analysis-tags">
                        <span class="tag tag-emotion">
                            <i class="fas fa-theater-masks mr-2"></i>${DOMPurify.sanitize(item.emotion)}
                        </span>
                        <span class="tag tag-pace">
                            <i class="fas fa-tachometer-alt mr-2"></i>${DOMPurify.sanitize(item.pace)}
                        </span>
                    </div>
                </div>
            `;
        });
        mapHtml += '</div>';
        
        outputContainer.innerHTML = mapHtml; // DOMPurify j√° foi aplicado nos peda√ßos
        markButtonAsCompleted(button.id);

    } catch (error) {
        console.error("Erro detalhado em mapEmotionsAndPacing:", error);
        outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar o mapa emocional: ${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO generateSoundtrack INTEIRA POR ESTA VERS√ÉO FINAL <<<<<
// ====================================================================================

/**
 * Acionada pelo bot√£o "Gerar Trilha Sonora".
 * Analisa o roteiro completo e usa um prompt especialista para gerar 3 sugest√µes
 * de prompts musicais detalhados para IAs de gera√ß√£o de √°udio.
 */
const generateSoundtrack = async (button) => {
    const fullTranscript = getTranscriptOnly();
    if (!fullTranscript) {
        window.showToast("Gere o roteiro completo primeiro para sugerir uma trilha sonora coerente.");
        return;
    }

    const outputContainer = document.getElementById('soundtrackContent');
    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

    // O seu novo e espetacular c√©rebro especialista em Trilha Sonora.
    const prompt = `Voc√™ √© uma API ESPECIALISTA EM CRIA√á√ÉO DE PROMPTS PARA IAs DE GERA√á√ÉO DE TRILHAS SONORAS CINEMATOGR√ÅFICAS. Sua fun√ß√£o √öNICA E CR√çTICA √© analisar um roteiro e gerar 3 PAR√ÅGRAFOS DESCRITIVOS que sirvam como prompts ricos para a cria√ß√£o de uma trilha sonora que complemente perfeitamente o tom e a emo√ß√£o do v√≠deo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© o ESPECIALISTA ABSOLUTO em traduzir narrativa em descri√ß√µes sonoras precisas e evocativas. Sua fun√ß√£o √© ser a PONTE entre o roteiro e a composi√ß√£o musical.

**ROTEIRO COMPLETO PARA AN√ÅLISE MUSICAL:**
---
${fullTranscript}
---

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA DO ARRAY:** O array deve conter EXATAMENTE 3 strings.
3.  **SINTAXE DAS STRINGS:** Todas as strings DEVEM usar aspas duplas (""). Cada string, EXCETO a √∫ltima, DEVE ser seguida por uma v√≠rgula (,).

**MANUAL DE CRIA√á√ÉO DE PROMPTS MUSICAIS (SIGA EXATAMENTE):**
- **Foco na Emo√ß√£o e Cena:** Cada par√°grafo deve descrever uma atmosfera sonora para uma fase da narrativa (ex: introdu√ß√£o, cl√≠max, conclus√£o).
- **Elementos Descritivos Essenciais:** Cada string deve incluir:
    1.  **Instrumenta√ß√£o Principal:** (Ex: "piano solo", "orquestra completa").
    2.  **Qualidade Sonora/Textura:** (Ex: "melodia suave", "ritmo acelerado").
    3.  **Atmosfera/Emo√ß√£o Alvo:** (Ex: "atmosfera de mist√©rio", "senso de urg√™ncia").
- **Conectividade:** Juntos, os 3 prompts devem cobrir um arco sonoro coerente com a jornada do roteiro.

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
[
  "Uma melodia suave e contemplativa tocada por um piano minimalista, criando uma atmosfera de introspec√ß√£o.",
  "Ritmo acelerado e pulsante com percuss√£o eletr√¥nica, construindo tens√£o crescente.",
  "Uma orquestra√ß√£o √©pica e emocional com cordas expansivas, evocando realiza√ß√£o e al√≠vio."
]

**RESTRI√á√ïES ESTRAT√âGICAS ABSOLUTAS:**
- **NENHUMA DESCRI√á√ÉO GEN√âRICA:** Seja espec√≠fico sobre instrumentos, texturas e emo√ß√µes.
- **NENHUMA MEN√á√ÉO A NOMES DE M√öSICAS OU ARTISTAS.**
- **RESPEITO AO CONTEXTO NARRATIVO:** As sugest√µes DEVEM estar alinhadas com o tom do roteiro.

**A√á√ÉO FINAL:** Analise AGORA o roteiro. Gere o array JSON com os 3 prompts de trilha sonora mais descritivos e alinhados com a narrativa. Responda APENAS com o array JSON perfeito.`;

    try {
        const rawResult = await callGroqAPI(prompt, 1500);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis) || analysis.length === 0) {
            throw new Error("A IA n√£o retornou sugest√µes no formato esperado.");
        }

        let suggestionsHtml = '<ul class="soundtrack-list space-y-2">';
        analysis.forEach(suggestion => {
            // Garante que a sugest√£o seja uma string antes de tentar sanitizar
            if(typeof suggestion === 'string') {
                suggestionsHtml += `<li>${DOMPurify.sanitize(suggestion)}</li>`;
            }
        });
        suggestionsHtml += '</ul>';
        
        outputContainer.innerHTML = `<div class="generated-output-box">${suggestionsHtml}</div>`;
        markButtonAsCompleted(button.id);

    } catch (error) {
        console.error("Erro detalhado em generateSoundtrack:", error);
        outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> SUBSTITUA SUA FUN√á√ÉO generateConclusion INTEIRA POR ESTA VERS√ÉO FINAL E ESPETACULAR <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
 * Acionada pelo bot√£o "Gerar Conclus√£o".
 * Usa a estrat√©gia definida pelo usu√°rio e o contexto completo do roteiro para gerar
 * uma conclus√£o narrativa poderosa, sem incluir o CTA.
 */
const generateConclusion = async (button) => {
    if (!validateInputs()) return;
    showButtonLoading(button);

    const scriptContainer = document.getElementById('scriptSectionsContainer');
    if (scriptContainer && !document.getElementById('conclusionSection')) {
        const conclusionDiv = document.createElement('div');
        conclusionDiv.id = 'conclusionSection';
        conclusionDiv.classList.add('script-section');
        scriptContainer.appendChild(conclusionDiv);
    }

    const conclusionType = document.querySelector('input[name="conclusionType"]:checked').value;
    const conclusionSpecifics = document.getElementById('conclusionSpecifics').value.trim();
    
    let strategyDirective = '';
    const centralQuestion = document.getElementById('centralQuestion')?.value.trim() || 'a pergunta central do v√≠deo';

    switch (conclusionType) {
        case 'lesson':
            strategyDirective = `O objetivo √© refor√ßar uma li√ß√£o ou reflex√£o central e memor√°vel. Detalhe do usu√°rio: '${conclusionSpecifics}'. A li√ß√£o deve soar como a conclus√£o natural e impactante da jornada.`;
            break;
        case 'answer':
            strategyDirective = `O objetivo √© responder de forma clara e satisfat√≥ria √† pergunta central ('${centralQuestion}'). Detalhe do usu√°rio: '${conclusionSpecifics}'. A resposta deve ser a revela√ß√£o que o espectador aguardava.`;
            break;
        case 'cliffhanger':
            strategyDirective = `O objetivo √© criar um gancho ou mist√©rio que justifique o pr√≥ximo v√≠deo. Detalhe do usu√°rio: '${conclusionSpecifics}'. O final deve deixar o espectador ansioso pelo que vem a seguir.`;
            break;
    }

    const fullContext = getTranscriptOnly();
    const basePromptContext = getBasePromptContext();

    // O seu novo e espetacular c√©rebro especialista em Conclus√µes.
    const prompt = `${basePromptContext}

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© um ESPECIALISTA EM CONCLUS√ïES NARRATIVAS DE M√ÅXIMO IMPACTO. Sua √∫nica fun√ß√£o √© criar uma conclus√£o envolvente, coesa e perfeitamente alinhada com o objetivo estrat√©gico definido.

**ROTEIRO ESCRITO AT√â AGORA (PARA CONTEXTO CR√çTICO):**
---
${fullContext}
---

**TAREFA CR√çTICA:** Sua tarefa √© escrever APENAS o texto da **Conclus√£o** do v√≠deo, continuando de onde o roteiro parou.

**DIRETIVA ESTRAT√âGICA ESPEC√çFICA PARA A CONCLUS√ÉO (GUIA OBRIGAT√ìRIO):**
${strategyDirective}

**REGRAS CR√çTICAS DE FORMATA√á√ÉO (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **RESPOSTA PURA E LIMPA:** Sua resposta deve ser APENAS o texto que ser√° NARRADO. Nenhum outro texto, coment√°rio ou explica√ß√£o √© permitido.
2.  **PROIBI√á√ÉO TOTAL DE FORMATA√á√ÉO:** √â **TERMINANTEMENTE PROIBIDO** incluir qualquer tipo de anota√ß√£o, como 'Narrador:', '(Cena: ...)', '(M√∫sica sobe)' ou '## Conclus√£o ##'.
3.  **FLUXO NARRATIVO:** A conclus√£o deve fluir NATURALMENTE do conte√∫do anterior.
4.  **EXCLUS√ÉO OBRIGAT√ìRIA DO CTA:** √â ESTRITAMENTE PROIBIDO incluir qualquer Call to Action (ex: "curta o v√≠deo", "se inscreva"). O CTA ser√° gerado separadamente.

**A√á√ÉO FINAL:** Escreva AGORA o texto puro da conclus√£o, garantindo que ela seja impactante e siga EXATAMENTE a diretiva estrat√©gica e todas as regras. Responda APENAS com o texto a ser narrado.`;

    try {
        const rawResult = await callGroqAPI(prompt, 3000);
        const content = removeMetaComments(rawResult.trim());

        if (!content) {
            throw new Error("A IA n√£o retornou um conte√∫do v√°lido para a conclus√£o.");
        }
        
        const paragraphs = content.split('\n').filter(p => p.trim() !== '');
        const contentWithSpans = paragraphs.map((p, index) => `<div id="conclusion-p-${index}">${p}</div>`).join('');

        const conclusionContainer = document.getElementById('conclusionSection');
        const conclusionElement = generateSectionHtmlContent('conclusion', 'Conclus√£o', contentWithSpans);
        
        conclusionContainer.innerHTML = '';
        conclusionContainer.appendChild(conclusionElement);
        
        projectState.conclusion = true;

        document.querySelectorAll('input[name="conclusionType"]').forEach(radio => radio.disabled = true);
        document.getElementById('conclusionSpecifics').disabled = true;
        document.querySelector('#conclusionInputContainer').classList.add('opacity-50');
        
        button.classList.add('hidden');
        document.getElementById('generateCtaBtn').classList.remove('hidden');

        window.showToast("Conclus√£o gerada com sucesso! Agora, vamos ao CTA.");
        
        updateButtonStates();

    } catch (error) {
        console.error("Erro detalhado em generateConclusion:", error);
        window.showToast(`Falha ao gerar a conclus√£o: ${error.message}`);
    } finally {
        hideButtonLoading(button);
    }
};

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> SUBSTITUA SUA FUN√á√ÉO generateStrategicCta INTEIRA POR ESTA VERS√ÉO FINAL <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
 * Acionada pelo bot√£o "Gerar CTA Estrat√©gico".
 * Usa o roteiro completo e a diretiva do usu√°rio para criar um Call to Action
 * final, focado em ser puro texto narrado e alinhado com a alma do roteiro.
 */
const generateStrategicCta = async (button) => {
    showButtonLoading(button);

    // Garante que o container da se√ß√£o CTA exista.
    const scriptContainer = document.getElementById('scriptSectionsContainer');
    let ctaSection = document.getElementById('ctaSection');
    if (scriptContainer && !ctaSection) {
        ctaSection = document.createElement('div');
        ctaSection.id = 'ctaSection';
        ctaSection.classList.add('script-section');
        scriptContainer.appendChild(ctaSection);
    }

    // Coleta o contexto e a diretiva espec√≠fica para o CTA.
    const ctaSpecifics = document.getElementById('ctaSpecifics').value.trim();
    const fullContext = getTranscriptOnly();
    const basePromptContext = getBasePromptContext();

    let ctaDirective = "Crie um Call to Action (CTA) gen√©rico, convidando o espectador a curtir, comentar e se inscrever, mas que seja perfeitamente alinhado ao tom do v√≠deo.";
    if (ctaSpecifics) {
        ctaDirective = `Crie um Call to Action (CTA) altamente espec√≠fico e persuasivo. Instru√ß√£o do usu√°rio: "${ctaSpecifics}". Conecte esta instru√ß√£o ao tema geral do v√≠deo de forma natural e convincente.`;
    }

    // O seu novo e espetacular c√©rebro especialista em CTA.
    const prompt = `${basePromptContext}

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© um generalista. Voc√™ √© um ESPECIALISTA EM ESTRAT√âGIA DE CALL TO ACTION (CTA) para v√≠deos do g√™nero e tom definidos no contexto. Sua √∫nica fun√ß√£o √© criar um CTA que seja COMPULS√ìRIO, ALTAMENTE EFICAZ e PERFEITAMENTE ALINHADO com o conte√∫do e objetivo do v√≠deo.

**ROTEIRO COMPLETO (PARA CONTEXTO ESTRAT√âGICO CR√çTICO):**
---
${fullContext}
---

**TAREFA ESTRAT√âGICA E CR√çTICA:** Sua tarefa AGORA √© escrever APENAS e EXCLUSIVAMENTE o **Call to Action (CTA)** para o FINAL do v√≠deo. Este √© o seu √öNICO objetivo nesta tarefa.

**DIRETIVA ESTRAT√âGICA ESPEC√çFICA PARA O CTA:** ${ctaDirective}

**REGRAS CR√çTICAS DE SINTAXE E FORMATA√á√ÉO (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **RESPOSTA PURA E LIMPA:** Sua resposta deve ser APENAS o texto que ser√° NARRADO em voz alta.
2.  **PROIBI√á√ÉO ABSOLUTA DE QUALQUER FORMATA√á√ÉO OU ANOTA√á√ÉO:** √â **TERMINANTEMENTE PROIBIDO** incluir QUALQUER tipo de anota√ß√£o, r√≥tulo ou formata√ß√£o. Isso inclui:
    -   NENHUM r√≥tulo de personagem (Ex: 'Narrador:')
    -   NENHUMA descri√ß√£o de cena (Ex: '(Cena: ...)')
    -   NENHUMA indica√ß√£o de √°udio (Ex: '(M√∫sica sobe)')
    -   NENHUM t√≠tulo ou cabe√ßalho (Ex: '## Call to Action ##')
3.  **FLUXO E INTEGRIDADE:** O CTA deve soar como uma conclus√£o NATURAL e INTEGRADA do v√≠deo.
4.  **RESPEITO AO TOM E ESTILO:** Mantenha o TOM e o ESTILO definidos no contexto. A voz do narrador N√ÉO deve mudar.

**A√á√ÉO FINAL E CR√çTICA:** Escreva AGORA o texto puro para o Call to Action (CTA). Responda APENAS com o texto a ser narrado, seguindo EXATAMENTE todas as regras.
`;

    try {
        let result = await callGroqAPI(prompt, 400);
        result = removeMetaComments(result.trim());
        const paragraphs = result.split('\n').filter(p => p.trim() !== '');
        const contentWithSpans = paragraphs.map((p, index) => `<div id="cta-p-${index}">${p}</div>`).join('');
        
        const ctaElement = generateSectionHtmlContent('cta', 'Call to Action (CTA)', contentWithSpans);
        ctaSection.innerHTML = '';
        ctaSection.appendChild(ctaElement);
        ctaSection.classList.remove('hidden');
        
        projectState.cta = true;
        markButtonAsCompleted('generateCtaBtn');
        
        const ctaSpecificsElement = document.getElementById('ctaSpecifics');
        ctaSpecificsElement.disabled = true;
        ctaSpecificsElement.parentElement.classList.add('opacity-50');
        
        document.getElementById('conclusionStrategyModule').classList.add('hidden');
        window.showToast("CTA Estrat√©gico gerado! Roteiro finalizado.");
        
        const analysisSection = document.getElementById('scriptAnalysisSection');
        if (analysisSection) {
            analysisSection.classList.remove('hidden');
            analysisSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

    } catch(error) {
        console.error("Erro detalhado em generateStrategicCta:", error);
        window.showToast(`Falha ao gerar o CTA: ${error.message}`);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};



    // ==========================================================
        // NOVA FUN√á√ÉO PARA ATUALIZAR A BARRA DE PROGRESO
        // ==========================================================
            const updateProgressBar = () => {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    if (!progressFill || !progressText) return;

    const taskButtonIds = [
        'analyzeStrategyBtn',
        'generateOutlineBtn',
        'generateIntroBtn',
        'generateDevelopmentBtn',
        'climaxBtn',
        'generateConclusionAndCtaBtn', // Corrigido para o bot√£o correto da conclus√£o
        'generateTitlesAndThumbnailsBtn',
        'mapEmotionsBtn',
        'generateDescriptionBtn',
        'generateSoundtrackBtn'
    ];
    const totalTasks = taskButtonIds.length;
    let completedTasks = 0;
    
    taskButtonIds.forEach(id => {
        const button = document.getElementById(id);
        if (button && button.classList.contains('btn-success')) {
            completedTasks++;
        }
    });

    const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

    // >>>>> IN√çCIO DA CORRE√á√ÉO <<<<<
    // Usamos as vari√°veis corretas (progressFill e progressText) e as cores corretas do CSS.
    progressFill.style.width = `${percentage}%`;
    progressText.textContent = `${percentage}%`;

    if (percentage === 100) {
        progressFill.textContent = "Projeto Pronto!"; 
        progressFill.style.color = '#ffffff';
        progressFill.style.textAlign = 'center';
        progressFill.style.backgroundColor = 'var(--success)'; // Corrigido
    } else {
        progressFill.textContent = '';
        progressFill.style.backgroundColor = 'var(--primary)'; // Corrigido
    }
    // >>>>> FIM DA CORRE√á√ÉO <<<<<
};

        // ==========================================================
        // >>>>> SUBSTITUA SUA FUN√á√ÉO setupInputTabs POR ESTA <<<<<
        // ==========================================================
        const setupInputTabs = () => {
            const nav = document.getElementById('inputTabsNav');
            if (!nav) return;

            const tabButtons = nav.querySelectorAll('.tab-button');
            const tabPanes = document.getElementById('inputTabContent').querySelectorAll('.tab-pane');

            nav.addEventListener('click', (event) => {
                const button = event.target.closest('.tab-button');
                if (!button) return;

                // 1. Remove a classe ativa de TODOS os bot√µes
                tabButtons.forEach(btn => btn.classList.remove('tab-active'));
                
                // 2. Esconde TODOS os pain√©is de conte√∫do
                tabPanes.forEach(pane => pane.classList.add('hidden'));

                // 3. Adiciona a classe ativa APENAS no bot√£o clicado
                button.classList.add('tab-active');
                
                // 4. Mostra APENAS o painel de conte√∫do correspondente
                const tabId = button.getAttribute('data-tab');
                const activePane = document.getElementById(tabId);
                if (activePane) {
                    activePane.classList.remove('hidden');
                }
            });
        };

        const handleConclusionStrategyChange = () => {
            const conclusionSpecificsContainer = document.getElementById('conclusionInputContainer');
            const answerRadioButtonLabel = document.querySelector('input[value="answer"]').parentElement;
            const answerRadioButton = document.querySelector('input[value="answer"]');

            // 1. L√≥gica para desabilitar a op√ß√£o "Responder Pergunta" se n√£o houver pergunta
            const centralQuestionText = document.getElementById('centralQuestion').value.trim();
            if (!centralQuestionText) {
                answerRadioButton.disabled = true;
                answerRadioButtonLabel.classList.add('opacity-50', 'cursor-not-allowed');
                answerRadioButtonLabel.title = "Defina a 'Pergunta Central' nos campos principais para usar esta op√ß√£o.";
                // Se a op√ß√£o desabilitada estava selecionada, muda para a primeira
                if(answerRadioButton.checked) {
                    document.querySelector('input[value="lesson"]').checked = true;
                }
            } else {
                answerRadioButton.disabled = false;
                answerRadioButtonLabel.classList.remove('opacity-50', 'cursor-not-allowed');
                answerRadioButtonLabel.title = "";
            }
            
            const selectedValue = document.querySelector('input[name="conclusionType"]:checked').value;
            
            // 2. L√≥gica para mostrar/esconder o textarea e mudar o placeholder
            if (conclusionSpecificsContainer) {
                conclusionSpecificsContainer.classList.toggle('hidden', !['lesson', 'answer', 'cliffhanger'].includes(selectedValue));
            }
            
            const textarea = document.getElementById('conclusionSpecifics');
            if (textarea) {
                const placeholders = {
                    lesson: "Ex: A li√ß√£o √© que a resili√™ncia √© a nossa maior for√ßa...",
                    answer: "Ex: A resposta √© que a Arca foi levada para a Eti√≥pia, mas o verdadeiro segredo √©...",
                    cliffhanger: "Ex: ...mas se a Arca foi encontrada, o que aconteceu com o que estava DENTRO dela?"
                };
                textarea.placeholder = placeholders[selectedValue] || "";
            }
        };

        /**
         * Alterna a visibilidade de um corpo de acorde√£o e a rota√ß√£o de sua seta. (VERS√ÉO CORRIGIDA E ROBUSTA)
         * @param {string} bodyId - O ID do elemento do corpo do acorde√£o.
         * @param {string} arrowId - O ID do elemento da seta do acorde√£o.
         */
        window.toggleAccordion = (bodyId, arrowId) => {
            const body = document.getElementById(bodyId);
            const arrow = document.getElementById(arrowId);
            // CORRE√á√ÉO: Encontra o cabe√ßalho subindo na √°rvore DOM
            const header = body ? body.closest('.accordion-item').querySelector('.accordion-header') : null;

            if (body && arrow && header) {
                const isOpen = body.classList.toggle('open');
                arrow.classList.toggle('open', isOpen);
                header.classList.toggle('active', isOpen);
            }
        };

        /**
 * Renderiza a p√°gina correta de prompts para uma determinada se√ß√£o. (VERS√ÉO CORRIGIDA)
 * @param {string} sectionElementId - O ID da se√ß√£o (ex: 'introSection').
 */
// ====================================================================================
// >>>>> VERS√ÉO FINAL DE renderPaginatedPrompts (COM CENA E TEMPO CORRIGIDOS) <<<<<
// ====================================================================================
const renderPaginatedPrompts = (sectionElementId) => {
    const sectionElement = document.getElementById(sectionElementId);
    if (!sectionElement) return;

    // --- L√≥gica de setup ---
    const itemsPerPage = 4;
    const prompts = allImagePrompts[sectionElementId] || [];
    if (prompts.length === 0) return;
    
    const currentPage = promptPaginationState[sectionElementId] || 0;
    const totalPages = Math.ceil(prompts.length / itemsPerPage);
    const promptItemsContainer = sectionElement.querySelector('.prompt-items-container');
    const navContainer = sectionElement.querySelector('.prompt-nav-container');

    if (!promptItemsContainer || !navContainer) return;
    promptItemsContainer.innerHTML = '';

    // --- L√≥gica da Mem√≥ria Cont√≠nua (para o Tempo) ---
    let cumulativeSeconds = 0;
    const sectionOrder = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection', 'ctaSection'];
    const currentSectionIndex = sectionOrder.indexOf(sectionElementId);
    
    for (let i = 0; i < currentSectionIndex; i++) {
        const previousSectionId = sectionOrder[i];
        const previousPrompts = allImagePrompts[previousSectionId] || [];
        previousPrompts.forEach(p => {
            cumulativeSeconds += parseInt(p.estimated_duration, 10) || 0;
        });
    }

    const startIndex = currentPage * itemsPerPage;
    if (startIndex > 0) {
        const previousPagePrompts = prompts.slice(0, startIndex);
        previousPagePrompts.forEach(p => {
            cumulativeSeconds += parseInt(p.estimated_duration, 10) || 0;
        });
    }

    // --- L√≥gica da Numera√ß√£o de Cena (Global) ---
    let globalSceneCounter = 1; // Come√ßa a contar do 1
    for (let i = 0; i < currentSectionIndex; i++) {
        const previousSectionId = sectionOrder[i];
        globalSceneCounter += (allImagePrompts[previousSectionId] || []).length;
    }
    // Adiciona as cenas das p√°ginas anteriores da se√ß√£o atual
    globalSceneCounter += startIndex;
    // ---------------------------------------------
    
    const promptsToShow = prompts.slice(startIndex, startIndex + itemsPerPage);

    promptsToShow.forEach((promptData, index) => {
        // --- C√°lculo e Renderiza√ß√£o ---
        const globalIndex = startIndex + index; // √çndice para IDs de elementos

        // Tempo
        const minutes = Math.floor(cumulativeSeconds / 60);
        const seconds = cumulativeSeconds % 60;
        const timestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        // N√∫mero da Cena
        const sceneNumber = globalSceneCounter + index;

        // Montagem do HTML
        const styleBlockContent = promptData.styleBlock || '';
        const promptHtml = `
            <div class="prompt-item card !p-3 animate-fade-in">
                <div class="prompt-header">
                    <span class="tag tag-scene"><i class="fas fa-film mr-2"></i>Cena ${String(sceneNumber).padStart(2, '0')}</span>
                    <span class="tag tag-time"><i class="fas fa-clock mr-2"></i>${timestamp}</span>
                    <button class="copy-btn-small" onclick="copyTextToClipboard(document.getElementById('prompt-content-${sectionElementId}-${globalIndex}')?.textContent + ' ' + document.getElementById('style-block-${sectionElementId}-${globalIndex}')?.textContent); window.showCopyFeedback(this)" title="Copiar Prompt">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <p class="paragraph-preview">"${DOMPurify.sanitize(promptData.scriptPhrase)}"</p>
                <div class="prompt-details">
                    <p class="prompt-label">${imageDescriptionLabels[elements.languageSelect.value] || 'Image Description:'}</p>
                    <p id="prompt-content-${sectionElementId}-${globalIndex}">${DOMPurify.sanitize(promptData.imageDescription)}</p>
                    ${styleBlockContent ? `<p class="style-block-indicator">[Estilo Cinematogr√°fico Aplicado]</p>` : ''}
                    <pre id="style-block-${sectionElementId}-${globalIndex}" class="hidden">${styleBlockContent}</pre>
                </div>
            </div>
        `;
        promptItemsContainer.innerHTML += promptHtml;

        // Atualiza o tempo para a pr√≥xima itera√ß√£o
        cumulativeSeconds += parseInt(promptData.estimated_duration, 10) || 0;
    });
    
    // --- Renderiza√ß√£o da Navega√ß√£o ---
    navContainer.innerHTML = `
        <button class="btn btn-secondary btn-small" onclick="window.navigatePrompts('${sectionElementId}', -1)" ${currentPage === 0 ? 'disabled' : ''}>
            <i class="fas fa-chevron-left"></i>
        </button>
        <span class="text-sm font-medium">P√°gina ${currentPage + 1} de ${totalPages}</span>
        <button class="btn btn-secondary btn-small" onclick="window.navigatePrompts('${sectionElementId}', 1)" ${currentPage + 1 >= totalPages ? 'disabled' : ''}>
            <i class="fas fa-chevron-right"></i>
        </button>
    `;
};

/**
 * Valida se o array de prompts recebido da IA tem a estrutura correta.
 * @param {any} data - O dado parseado do JSON.
 * @returns {boolean} - True se for um array v√°lido de prompts, false caso contr√°rio.
 */
const validatePromptsArray = (data) => {
    // √â um array? Ele n√£o est√° vazio? O primeiro item √© um objeto com as chaves que precisamos?
    return Array.isArray(data) && data.length > 0 && data.every(item => 
        item && typeof item === 'object' && 'scriptPhrase' in item && 'imageDescription' in item
    );
};

/**
 * Reseta o conte√∫do do roteiro gerado quando um input estrat√©gico √© alterado.
 * @param {string} sourceId - O ID do elemento que causou a mudan√ßa.
 */
const resetGeneratedScriptContent = (sourceId) => {
    // S√≥ reseta se j√° houver conte√∫do gerado para n√£o incomodar o usu√°rio no in√≠cio.
    if (!strategicOutline && !document.querySelector('#scriptSectionsContainer .accordion-item')) {
        return;
    }

    console.log(`Input estrat√©gico '${sourceId}' alterado. Resetando conte√∫do do roteiro.`);

    // 1. Limpa as vari√°veis de estado
    strategicOutline = null;
    allImagePrompts = {};
    promptPaginationState = {};
    totalScriptSeconds = 0;

    // 2. Limpa a UI do esbo√ßo e das se√ß√µes
    const outlineContent = document.getElementById('outlineContent');
    if (outlineContent) {
        outlineContent.innerHTML = `<div class="asset-card-placeholder">A estrat√©gia mudou. Clique em 'Criar Esbo√ßo' novamente.</div>`;
    }

    const scriptContainer = document.getElementById('scriptSectionsContainer');
    if (scriptContainer) {
        scriptContainer.innerHTML = `
            <div id="introSection" class="script-section"></div>
            <div id="developmentSection" class="script-section"></div>
            <div id="climaxSection" class="script-section"></div>
            <div id="conclusionSection" class="script-section"></div>
            <div id="ctaSection" class="script-section hidden"></div>
        `;
    }
    
    // 3. Reseta os bot√µes de gera√ß√£o para o estado inicial
    const buttonsToReset = [
        'generateOutlineBtn', 'generateIntroBtn', 'generateDevelopmentBtn', 
        'climaxBtn', 'conclusionBtn', 'generateCTABtn', 
        'generateDescriptionBtn', 'generateTitlesAndThumbnailsBtn'
    ];
    
    buttonsToReset.forEach(id => {
        const btn = document.getElementById(id);
        const floatBtn = document.getElementById(`float_${id}`);
        [btn, floatBtn].forEach(b => {
            if (b) {
                b.classList.remove('btn-success');
                // Adiciona a classe correta (primary ou secondary)
                if (['generateDescriptionBtn', 'generateTitlesAndThumbnailsBtn', 'generateOutlineBtn'].includes(id)) {
                    b.classList.add('btn-secondary');
                } else {
                    b.classList.add('btn-primary');
                }
            }
        });
    });

    // 4. Atualiza a UI e notifica o usu√°rio
    updateProgressBar();
    updateButtonStates();
    const sourceLabel = document.querySelector(`label[for='${sourceId}']`)?.textContent || sourceId;
    window.showToast(`'${sourceLabel}' mudou. O roteiro foi resetado.`);
};


/**
 * Invalida e limpa os prompts de imagem de uma se√ß√£o quando seu texto √© alterado.
 * @param {HTMLElement} sectionElement - O elemento da se√ß√£o (ex: o div com id="introSection").
 */
const invalidateAndClearPrompts = (sectionElement) => {
    if (!sectionElement) return;

    const sectionId = sectionElement.id;
    const promptContainer = sectionElement.querySelector('.prompt-container');

    // 1. Remove os prompts da mem√≥ria (do estado global)
    if (allImagePrompts[sectionId]) {
        delete allImagePrompts[sectionId];
        console.log(`Prompts para a se√ß√£o '${sectionId}' invalidados e removidos da mem√≥ria.`);
    }
    
    // 2. Limpa a interface do usu√°rio, se os prompts j√° foram renderizados
    if (promptContainer && promptContainer.innerHTML.trim() !== '') {
        promptContainer.innerHTML = `
            <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md border-l-4 border-yellow-400">
                <p class="text-sm text-yellow-700 dark:text-yellow-300 font-semibold">
                    Aten√ß√£o: O roteiro foi modificado.
                </p>
                <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                    Por favor, clique em "Gerar Prompts de Imagem" novamente para criar novos recursos visuais com base no texto atualizado.
                </p>
            </div>
        `;
    }
};


/**
         * Invalida e limpa a sugest√£o de performance, exibindo um aviso.
         */
        const invalidateAndClearPerformance = (sectionElement) => {
            if (!sectionElement) return;

            const performanceContainer = sectionElement.querySelector('.section-performance-output');
            if (performanceContainer && performanceContainer.innerHTML.trim() !== '') {
                performanceContainer.innerHTML = `
                    <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-md border-l-4 border-yellow-400">
                        <p class="text-sm text-yellow-700 dark:text-yellow-300 font-semibold">
                            Aten√ß√£o: O roteiro foi modificado.
                        </p>
                        <p class="text-xs text-yellow-600 dark:text-yellow-400 mt-1">
                            Por favor, clique em "Sugerir Performance" novamente para criar novas anota√ß√µes com base no texto atualizado.
                        </p>
                    </div>
                `;
            }
        };

        /**
         * Lida com os cliques nas setas de navega√ß√£o dos prompts.
         * @param {string} sectionElementId - O ID da se√ß√£o.
         * @param {number} direction - -1 para a esquerda, 1 para a direita.
         */
        window.navigatePrompts = (sectionElementId, direction) => {
            const prompts = allImagePrompts[sectionElementId] || [];
            const itemsPerPage = 4;
            const totalPages = Math.ceil(prompts.length / itemsPerPage);
            let currentPage = promptPaginationState[sectionElementId] || 0;

            const newPage = currentPage + direction;

            // Valida√ß√£o dos limites
            if (newPage >= 0 && newPage < totalPages) {
                promptPaginationState[sectionElementId] = newPage;
                renderPaginatedPrompts(sectionElementId);
            }
        };
    
// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO 'generateSectionHtmlContent' INTEIRA POR ESTA <<<<<
// =========================================================================
const generateSectionHtmlContent = (sectionId, title, content) => {
    const accordionItem = document.createElement('div');
    accordionItem.className = 'accordion-item card !p-0 mb-4 animate-fade-in';

    const accordionHeader = document.createElement('div');
    accordionHeader.className = 'accordion-header';

    const accordionBody = document.createElement('div');
    accordionBody.id = `${sectionId}Body`;
    accordionBody.className = 'accordion-body';

    const headerTitleGroup = document.createElement('div');
    headerTitleGroup.className = 'header-title-group';
    const h3 = document.createElement('h3');
    h3.textContent = title;
    const timeSpan = document.createElement('span');
    timeSpan.className = 'text-xs font-normal text-gray-500';
    timeSpan.textContent = calculateReadingTime(content);
    headerTitleGroup.appendChild(h3);
    headerTitleGroup.appendChild(timeSpan);

    const headerActionsGroup = document.createElement('div');
    headerActionsGroup.className = 'header-actions-group';
    const headerButtons = document.createElement('div');
    headerButtons.className = 'header-buttons';

    const regenerateBtn = document.createElement('button');
    regenerateBtn.className = 'regenerate-btn';
    regenerateBtn.title = 'Re-gerar esta se√ß√£o';
    regenerateBtn.dataset.action = 'regenerate';
    regenerateBtn.dataset.sectionId = `${sectionId}Section`;
    regenerateBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466"/></svg>`;

    const copyBtn = document.createElement('button');
    copyBtn.className = 'copy-btn';
    copyBtn.title = 'Copiar Roteiro';
    copyBtn.dataset.action = 'copy';
    copyBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z"/></svg>`;
    headerButtons.appendChild(regenerateBtn);
    headerButtons.appendChild(copyBtn);

    const arrowSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    arrowSvg.id = `${sectionId}Arrow`;
    arrowSvg.setAttribute('class', 'accordion-arrow');
    arrowSvg.setAttribute('width', '16');
    arrowSvg.setAttribute('height', '16');
    arrowSvg.setAttribute('fill', 'currentColor');
    arrowSvg.setAttribute('viewBox', '0 0 16 16');
    arrowSvg.innerHTML = `<path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>`;
    
    headerActionsGroup.appendChild(headerButtons);
    headerActionsGroup.appendChild(arrowSvg);
    accordionHeader.appendChild(headerTitleGroup);
    accordionHeader.appendChild(headerActionsGroup);

    const contentWrapper = document.createElement('div');
    contentWrapper.className = 'generated-content-wrapper';
    contentWrapper.setAttribute('contenteditable', 'true');
    contentWrapper.innerHTML = content;

    const analysisTools = document.createElement('div');
    const addChapterButtonHtml = sectionId === 'development' ? `
        <div class="tooltip-container">
            <button class="btn btn-primary btn-small" data-action="addDevelopmentChapter">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.5 4.5a.5.5 0 0 0-1 0v3h-3a.5.5 0 0 0 0 1h3v3a.5.5 0 0 0 1 0v-3h3a.5.5 0 0 0 0-1h-3v-3z"/></svg> 
                Adicionar Cap√≠tulo
            </button>
        </div>
    ` : '';
    
    // <<< AQUI EST√Å A GRANDE MUDAN√áA COM OS TOOLTIPS >>>
    const toolsHtml = `
        <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-6">
            <div class="text-center">
                <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 1: Diagn√≥stico e Criativo</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Analise, edite ou enrique√ßa o texto para m√°xima qualidade.</p>
                <div class="flex items-center justify-center gap-2 flex-wrap">
                    
                    <div class="tooltip-container">
                        <button class="btn btn-secondary btn-small" data-action="analyzeRetention" data-section-id="${sectionId}Section">Analisar Reten√ß√£o</button>
                        <span class="tooltip-text">
                            <strong>Fun√ß√£o:</strong> Diagn√≥stico.<br>
                            <strong>O que faz:</strong> Age como um "m√©dico". Ele escaneia o texto e te diz: "Aqui est√° bom, aqui tem um ponto de aten√ß√£o, e aqui tem um ponto de risco". Ele te d√° o diagn√≥stico, mas n√£o a cura.
                        </span>
                    </div>

                    <div class="tooltip-container">
                        <button class="btn btn-secondary btn-small" data-action="refineStyle">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gem" viewBox="0 0 16 16"><path d="M3.1.7a.5.5 0 0 1 .4-.2h9a.5.5 0 0 1 .4.2l2.976 3.974c.149.199.224.458.224.726v1.2a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-1.2c0-.268.075-.527.224-.726L3.1.7zM1.49 4.107l-1.18-1.575a.5.5 0 0 1 .4-.8h13.56a.5.5 0 0 1 .4.8L14.51 4.107H1.49zM.5 5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1 0-1H1v-1H.5a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v7a.5.5 0 0 1 0 1h-.5a.5.5 0 0 1 0-1H15v-1h-.5a.5.5 0 0 1 0-1H15v-1h-.5a.5.5 0 0 1 0-1H15v-1h.5a.5.5 0 0 1 .5-.5v-1a.5.5 0 0 1-.5.5zM2 13.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                            Refinar Estilo
                        </button>
                        <span class="tooltip-text">
                            <strong>Fun√ß√£o:</strong> Polimento.<br>
                            <strong>O que faz:</strong> Age como um "polidor de carros". Ele pega o texto inteiro, remove repeti√ß√µes e melhora a fluidez. Ele deixa o texto mais bonito e brilhante, mas n√£o muda a sua ess√™ncia.
                        </span>
                    </div>

                    <div class="tooltip-container">
                        <button class="btn btn-secondary btn-small" data-action="enrichWithData">
                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8.5 2a.5.5 0 0 1 .5.5v11a.5.5 0 0 1-1 0v-11a.5.5 0 0 1 .5-.5z"/><path d="M2 7.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/></svg>
                            Enriquecer com Dados
                        </button>
                        <span class="tooltip-text">
                            <strong>Fun√ß√£o:</strong> Adi√ß√£o.<br>
                            <strong>O que faz:</strong> Age como um "engenheiro de refor√ßo". Voc√™ seleciona um trecho e lhe d√° uma nova informa√ß√£o (um dado, uma fonte). Ele refor√ßa aquele trecho com mais credibilidade.
                        </span>
                    </div>
                    ${addChapterButtonHtml}
                </div>
                <div id="analysis-output-${sectionId}" class="section-analysis-output mt-3 text-left"></div>
            </div>
            <div class="pt-4 border-t border-dashed border-gray-200 dark:border-gray-700 text-center">
                 <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 2: Estrutura de Narra√ß√£o</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Adicione sugest√µes de performance para guiar a narra√ß√£o.</p>
                <div class="flex items-center justify-center gap-2"><button class="btn btn-secondary btn-small" data-action="suggestPerformance" data-section-id="${sectionId}Section">Sugerir Performance</button></div>
                <div class="section-performance-output mt-3 text-left"></div> 
            </div>
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 text-center">
                <h5 class="font-semibold text-base mb-2 text-gray-800 dark:text-gray-200">Passo 3: Recursos Visuais</h5>
                <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">Crie o storyboard visual para esta se√ß√£o do roteiro.</p>
                <button class="btn btn-secondary btn-small" data-action="generate-prompts" data-section-id="${sectionId}Section">Gerar Prompts de Imagem</button>
                <div class="prompt-container mt-4 text-left"></div>
            </div>
        </div>
    `;
    analysisTools.innerHTML = DOMPurify.sanitize(toolsHtml, { ADD_TAGS: ["svg", "path", "span", "br", "strong"], ADD_ATTR: ["d", "fill", "viewBox", "xmlns", "width", "height", "class"] });
    
    accordionBody.appendChild(contentWrapper);
    accordionBody.appendChild(analysisTools);
    accordionItem.appendChild(accordionHeader);
    accordionItem.appendChild(accordionBody);

    return accordionItem;
};

    
// ============================
// >>>>> FILTRO JSON <<<<<
// ============================
const cleanGeneratedText = (text, expectJson = false) => {
    if (!text || typeof text !== 'string') {
        return null;
    }

    if (!expectJson) {
        return text.trim();
    }

    // --- ETAPA ZERO (NOVA): O DETETIVE DE INTEN√á√ÉO ---
    let jsonString;
    const trimmedText = text.trim();

    // 1. Tenta encontrar um bloco de c√≥digo Markdown primeiro.
    const markdownMatch = trimmedText.match(/```(json)?\s*([\s\S]*?)\s*```/);
    if (markdownMatch && markdownMatch[2]) {
        jsonString = markdownMatch[2].trim();
    } 
    // 2. Se n√£o, tenta encontrar m√∫ltiplos objetos JSON para montar um array.
    else {
        const jsonObjects = trimmedText.match(/\{[\s\S]*?\}/g);
        if (jsonObjects && jsonObjects.length > 1) { // S√≥ monta se houver MAIS de um objeto
            jsonString = `[${jsonObjects.join(',')}]`;
        } 
        // 3. Se nada disso funcionar, usa a l√≥gica de fallback (procurar o in√≠cio).
        else {
            const startIndex = trimmedText.search(/[\{\[]/);
            if (startIndex === -1) {
                throw new Error("A IA n√£o retornou um formato JSON reconhec√≠vel.");
            }
            jsonString = trimmedText.substring(startIndex);
        }
    }
    // -----------------------------------------------------------
    
    // --- A PARTIR DAQUI, TODAS AS SUAS ETAPAS ANTERIORES CONTINUAM INTACTAS ---

    // ETAPA 2: CIRURGIA PREVENTIVA DE FECHAMENTO (Sua l√≥gica)
    let openBrackets = (jsonString.match(/\[/g) || []).length;
    let closeBrackets = (jsonString.match(/\]/g) || []).length;
    let openBraces = (jsonString.match(/\{/g) || []).length;
    let closeBraces = (jsonString.match(/\}/g) || []).length;

    while (openBraces > closeBraces) { jsonString += '}'; closeBraces++; }
    while (openBrackets > closeBrackets) { jsonString += ']'; closeBrackets++; }

    // ETAPA 3: TENTATIVA INICIAL
    try {
        return JSON.parse(jsonString);
    } catch (initialError) {
        console.warn("Parse inicial falhou. Iniciando reparos...", initialError.message);
        
        // ETAPA 4: CIRURGIAS AVAN√áADAS
        let repairedString = jsonString; 
        try {
            // Suas cirurgias + as minhas, todas juntas
            repairedString = repairedString.replace(/([{,]\s*)'([^']+)'(\s*:)/g, '$1"$2"$3');
            repairedString = repairedString.replace(/([{,]\s*)([a-zA-Z0-9_]+)(\s*:)/g, '$1"$2"$3');
            repairedString = repairedString.replace(/:\s*'((?:[^'\\]|\\.)*?)'/g, ': "$1"');
            repairedString = repairedString.replace(/,\s*([}\]])/g, '$1');
            repairedString = repairedString.replace(/"\s*[;.,]\s*([,}\]])/g, '"$1');
            repairedString = repairedString.replace(/:\s*"([^"]*)"/g, (match, content) => {
                if (content.includes('"') && !content.includes('\\"')) {
                    const escapedContent = content.replace(/(?<!\\)"/g, '\\"');
                    return `: "${escapedContent}"`;
                }
                return match;
            });
            repairedString = repairedString.replace(/}\s*"/g, '},"');
            repairedString = repairedString.replace(/(?<!\\)\n/g, "\\n");
            repairedString = repairedString.replace(/[\u0000-\u001F\u007F-\u009F]/g, "");

            // ETAPA 5: TENTATIVA FINAL
            return JSON.parse(repairedString);

        } catch (surgeryError) {
            // Seu relat√≥rio de erro
            console.error("FALHA CR√çTICA: A cirurgia no JSON n√£o foi bem-sucedida.", surgeryError.message);
            console.error("JSON Problem√°tico (Original):", text);
            console.error("JSON P√≥s-Cirurgia (Falhou):", repairedString);
            throw new Error(`A IA retornou um JSON com sintaxe inv√°lida que n√£o p√¥de ser corrigido.`);
        }
    }
};
// ============================
// >>>>> FILTRO JSON <<<<<
// ============================


// =========================================================================
// >>>>> VERS√ÉO FINAL E BLINDADA DE 'removeMetaComments' <<<<<
// =========================================================================
/**
 * Remove coment√°rios meta, instru√ß√µes e formata√ß√µes indesejadas injetadas pela IA.
 * @param {string} text - O texto gerado pela IA.
 * @returns {string} O texto limpo.
 */
const removeMetaComments = (text) => {
    if (!text) return "";

    let cleanedText = text;

    // CAMADA 0: Normaliza√ß√£o inicial de quebras de linha
    // Substitui diferentes tipos de quebras de linha por \n para consist√™ncia
    cleanedText = cleanedText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

    // CAMADA 1: Remove pre√¢mbulos comuns que terminam com ":" (agora mais robusta)
    const lines = cleanedText.split('\n');
    if (lines.length > 0) {
        const firstLine = lines[0].trim();
        // Verifica se a primeira linha parece um pre√¢mbulo (come√ßa com letra mai√∫scula e termina com :)
        if (firstLine.length > 0 && /^[A-Z√Ä-√ö].*:$/.test(firstLine)) {
            lines.shift();
            cleanedText = lines.join('\n');
        }
    }
    cleanedText = cleanedText.trim();

    // CAMADA 2: Usa regex para remover padr√µes espec√≠ficos e indesejados (EXPANDIDA)
    const patternsToRemove = [
        // --- Padr√µes de In√≠cio/Contexto ---
        /Here is the (generated )?script for the "[^"]+" section:\s*/gi,
        /Here is the (refined )?text:\s*/gi,
        /Here is the (final )?version:\s*/gi,
        /Response:\s*/gi,
        /Output:\s*/gi,
        /^Of course(,)?\s*/i,
        /^Sure(,)?\s*/i,
        /^Certainly(,)?\s*/i,
        /^Absolutely(,)?\s*/i,
        /^I can help with that\.\s*/i,
        /^As requested\.\s*/i,
        /^Understood\.\s*/i,

        // --- Cabe√ßalhos e T√≠tulos Autom√°ticos ---
        /^\*\*roteiro anotado:\*\*\s*/im,
        /^\*\*Introdu√ß√£o:\*\*\s*/im,
        /^\*\*Desenvolvimento:\*\*\s*/im,
        /^\*\*Cl√≠max:\*\*\s*/im,
        /^\*\*Conclus√£o:\*\*\s*/im,
        /^\*\*Call to Action:\*\*\s*/im,
        /^\*\*TEXTO REFINADO:\*\*\s*/im,
        /^\*\*Refined Text:\*\*\s*/im,
        /^\s*\*\*[^*]+\*\*\s*$/gm, // "Ca√ßador de T√≠tulos" gen√©rico

        // >>>>> IN√çCIO DA CORRE√á√ÉO CIR√öRGICA <<<<<
        // Padr√£o para ca√ßar e remover anota√ß√µes como (Pausa), (Teaser), (Corte para), etc., que estejam em sua pr√≥pria linha.
        /^\s*\((Pausa|Teaser|Corte para|Transi√ß√£o|M√∫sica sobe|Efeito sonoro)\)\s*$/gim,
        // >>>>> FIM DA CORRE√á√ÉO CIR√öRGICA <<<<<

        // --- Anota√ß√µes de Roteiro/Apresenta√ß√£o (EXPANDIDO) ---
        /^\s*Presenter Notes?:\s*.*$/gim,
        /^\s*Note to Presenter:\s*.*$/gim,
        /^\s*Narrator:\s*.*$/gim,
        /^\s*Host:\s*.*$/gim,
        /^\s*Voiceover:\s*.*$/gim,
        /^\s*VO:\s*.*$/gim,
        /^\s*On-screen text:\s*.*$/gim,
        /^\s*Title Card:\s*.*$/gim,
        
        // --- Diretrizes de Formata√ß√£o (EXPANDIDO) ---
        /^\s*\[Begin\]\s*$/gim,
        /^\s*\[End\]\s*$/gim,
        /^\s*\[Scene \d+\]\s*$/gim,
        /^\s*\[Transition\]\s*$/gim,
        /^\s*\[Music\]\s*$/gim,
        /^\s*\[Sound Effect\]\s*$/gim,
        /^\s*\[Pause\]\s*$/gim,
        /^\s*\[Cue\]\s*$/gim,
        /^\s*\[Visual:\s*.*\]\s*$/gim,
        /^\s*\[Action:\s*.*\]\s*$/gim,
        /^\s*\[Character:\s*.*\]\s*$/gim,
        
        // --- Anota√ß√µes T√©cnicas ---
        /^\s*Word count:\s*\d+\s*$/gim,
        /^\s*Estimated duration:\s*.*$/gim,
        /^\s*Style:\s*.*$/gim,
        /^\s*Tone:\s*.*$/gim,
        /^\s*Keywords?:\s*.*$/gim,
        
        // --- Frases de Transi√ß√£o e Finaliza√ß√£o ---
        /^\s*In summary(,)?\s*.*$/gim,
        /^\s*To conclude(,)?\s*.*$/gim,
        /^\s*In conclusion(,)?\s*.*$/gim,
        /^\s*That's all(,)?\s*.*$/gim,
        /^\s*That's it(,)?\s*.*$/gim,
        /^\s*Thank you for listening\.\s*$/gim,
        /^\s*Let me know if you need anything else\.\s*$/gim,
        /^\s*Please let me know if you have any other requests\.\s*$/gim,
        
        // --- Padr√µes de Aspas (para casos onde a IA envolve o conte√∫do em aspas) ---
        // Este padr√£o √© mais seletivo para evitar remover aspas leg√≠timas no meio do texto
        /^"""\s*/g, // Aspas triplas no in√≠cio
        /\s*"""$/g, // Aspas triplas no final
    ];

    patternsToRemove.forEach(pattern => {
        cleanedText = cleanedText.replace(pattern, '');
    });

    // CAMADA 3: Limpeza Profunda Final
    // Remove quebras de linha m√∫ltiplas no in√≠cio e no final
    cleanedText = cleanedText.replace(/^\s*\n+|\n+\s*$/g, '');
    
    // Remove espa√ßos em branco extras no in√≠cio e no final
    cleanedText = cleanedText.trim();

    // CAMADA 4: Prote√ß√£o contra string vazia acidental
    // Se o texto foi completamente limpo, retorna uma string vazia expl√≠cita
    if (cleanedText === "") {
        return "";
    }

    // CAMADA 5: Remo√ß√£o de Aspas Envolventes (caso ainda persistam ap√≥s outras limpezas)
    // Apenas se a string inteira (ou quase) estiver entre aspas
    const trimmedForQuotes = cleanedText.trim();
    if (trimmedForQuotes.startsWith('"') && trimmedForQuotes.endsWith('"') && trimmedForQuotes.length > 1) {
        // Verifica√ß√£o adicional para evitar remover aspas no meio de uma frase v√°lida
        const contentInside = trimmedForQuotes.substring(1, trimmedForQuotes.length - 1);
        // Se n√£o houver aspas duplas n√£o escapadas no meio, √© seguro remover
        if (!/[^\\]"/.test(contentInside)) {
             cleanedText = contentInside;
        }
    }
    // Repetir para aspas simples, se necess√°rio, mas com mais cautela
    // (Geralmente menos comum da IA, mas poss√≠vel)
    // if (cleanedText.startsWith("'") && cleanedText.endsWith("'") && cleanedText.length > 1) {
    //     cleanedText = cleanedText.substring(1, cleanedText.length - 1);
    // }

    return cleanedText.trim();
};
// =========================================================================
// >>>>> FIM DA VERS√ÉO BLINDADA DE 'removeMetaComments' <<<<<
// =========================================================================




// --- IN√çCIO DO NOVO M√ìDULO DE NARRATIVA ---

const narrativeStructures = {
    storytelling: {
        documentary: "Document√°rio (Factual e Investigativo)",
        heroes_journey: "Jornada do Her√≥i (Estrutura √âpica)",
        pixar_spine: "Espinha Dorsal - Pixar (Estrutura Emocional)",
        mystery_loop: "Mist√©rio (com Loop Aberto)",
        twist: "Narrativa com Virada (Twist)"
    },
    storyselling: {
        // --- NOVAS ESTRUTURAS ADICIONADAS AQUI ---
        pas: "Problema-Agita√ß√£o-Solu√ß√£o (PAS)",
        bab: "Antes-Depois-Ponte (BAB)",
        aida: "Aten√ß√£o-Interesse-Desejo-A√ß√£o (AIDA)",
        underdog_victory: "Vit√≥ria do Azar√£o (Conex√£o e Supera√ß√£o)",
        discovery_mentor: "A Grande Descoberta / Mentor Secreto",
        if_not_found_create: "N√£o Encontrei, Ent√£o Criei (Hist√≥ria de Origem)"
    }
};

const narrativeTooltips = {
    // Storytelling
    documentary: "Constr√≥i um argumento com fatos, evid√™ncias e uma narra√ß√£o autorit√°ria. Perfeito para v√≠deos expositivos.",
    heroes_journey: "Conta uma hist√≥ria de transforma√ß√£o e supera√ß√£o. √ìtimo para narrativas inspiradoras.",
    pixar_spine: "Estrutura emocional de 8 passos (Era uma vez... todo dia... at√© que...). Perfeita para arcos de personagem r√°pidos.",
    mystery_loop: "Apresenta uma pergunta no in√≠cio e a responde no final. Excelente para reter a aten√ß√£o.",
    twist: "Constr√≥i uma expectativa e a quebra com uma revela√ß√£o surpreendente no final.",
    
    // Storyselling
    pas: "Foca em um problema que o p√∫blico tem (Problema), intensifica a dor que ele causa (Agita√ß√£o) e apresenta o seu conte√∫do/produto como a cura (Solu√ß√£o). Ideal para vendas diretas.",
    bab: "Mostra um cen√°rio 'Antes' (o mundo com o problema), um 'Depois' (o resultado ideal) e posiciona seu conte√∫do como 'a Ponte' que leva de um ao outro.",
    aida: "Cl√°ssico do marketing: primeiro captura a Aten√ß√£o, depois gera Interesse, cria o Desejo pela solu√ß√£o e, finalmente, chama para a A√ß√£o.",
    underdog_victory: "Mostra algu√©m (ou uma empresa) com limita√ß√µes que venceu contra tudo e todos. Gera alta conex√£o emocional e inspira confian√ßa.",
    discovery_mentor: "Revela um grande segredo ou uma 'descoberta' que mudou tudo, posicionando o narrador como um mentor que guia o espectador.",
    if_not_found_create: "Conta a hist√≥ria de origem de um produto ou servi√ßo, nascido de uma necessidade pessoal. 'Eu tinha esse problema, n√£o achei solu√ß√£o, ent√£o criei uma'."
};

// Objeto para o popover do "Objetivo da Narrativa" (permanece o mesmo)
const narrativeGoalTooltips = {
    storytelling: {
        title: "Storytelling (Conectar & Inspirar)",
        description: "O foco √© construir uma narrativa envolvente e emocional. O objetivo √© fazer o p√∫blico sentir, pensar e se conectar com a hist√≥ria. Ideal para document√°rios, li√ß√µes de vida e conte√∫do inspirador."
    },
    storyselling: {
        title: "Storyselling (Persuadir & Vender)",
        description: "Usa t√©cnicas de narrativa para construir um argumento e levar o p√∫blico a uma a√ß√£o espec√≠fica (comprar, inscrever-se, etc.). O foco √© resolver um problema claro para o espectador. Ideal para marketing, lan√ßamento de produtos e v√≠deos de vendas."
    }
};


   // ==========================================================
// >>>>> A√á√ÉO 1: SUBSTITUA A FUN√á√ÉO updateMainTooltip INTEIRA <<<<<
// ==========================================================
const updateMainTooltip = () => {
    const popoverTitle = document.getElementById('popoverTitle');
    const popoverDescription = document.getElementById('popoverDescription');
    const structureSelect = document.getElementById('narrativeStructure');

    if (!popoverTitle || !popoverDescription || !structureSelect) return;

    // AQUI EST√Å A CORRE√á√ÉO:
    // Se nenhuma op√ß√£o estiver selecionada (selectedIndex === -1), a fun√ß√£o para aqui.
    if (structureSelect.selectedIndex === -1) {
        // Opcional: Limpa o popover para n√£o mostrar informa√ß√£o antiga.
        popoverTitle.textContent = "Selecione uma Estrutura";
        popoverDescription.textContent = "Passe o mouse sobre uma op√ß√£o para ver sua descri√ß√£o.";
        return; 
    }

    const selectedKey = structureSelect.value;
    const selectedText = structureSelect.options[structureSelect.selectedIndex].text;
    const descriptionText = narrativeTooltips[selectedKey] || "Descri√ß√£o n√£o encontrada.";
    
    popoverTitle.textContent = selectedText;
    popoverDescription.textContent = descriptionText;
};

        const updateNarrativeStructureOptions = () => {
    const goalSelect = document.getElementById('narrativeGoal');
    const structureSelect = document.getElementById('narrativeStructure');
    if (!goalSelect || !structureSelect) return;

    const goal = goalSelect.value;
    const savedValue = structureSelect.value; // Salva o valor atual, se houver
    structureSelect.innerHTML = ''; 

    const structures = narrativeStructures[goal];
    for (const key in structures) {
       const option = document.createElement('option');
        option.value = key;
       option.textContent = structures[key];
       structureSelect.appendChild(option);
   }
    
 // Tenta restaurar o valor que estava selecionado
    if (Array.from(structureSelect.options).some(opt => opt.value === savedValue)) {
        structureSelect.value = savedValue;
    }
    
    // Chama a nossa nova fun√ß√£o para atualizar o texto do tooltip!
   updateMainTooltip();
   updateGoalPopover();
 };


 const updateGoalPopover = () => {
    const goalSelect = document.getElementById('narrativeGoal');
    const popover = document.getElementById('goalPopover');
    const popoverTitle = popover.querySelector('h4');
    const popoverDescription = popover.querySelector('p');

    if (!goalSelect || !popover || !popoverTitle || !popoverDescription) return;

    const selectedKey = goalSelect.value;
    const data = narrativeGoalTooltips[selectedKey];
    
    if (data) {
        popoverTitle.textContent = data.title;
        popoverDescription.textContent = data.description;
    }
};



// =========================================================================
// C√âREBRO ESTRAT√âGICO - √âPICO
// =========================================================================
const getBasePromptContext = () => {
    // Coleta todos os valores dos campos do formul√°rio
    const channelName = document.getElementById('channelName')?.value.trim() || "";
    const videoTheme = document.getElementById('videoTheme')?.value.trim() || "";
    const targetAudience = document.getElementById('targetAudience')?.value.trim() || "";
    const language = document.getElementById('languageSelect')?.value || "en";
    const languageStyle = document.getElementById('languageStyle')?.value || "";
    const videoObjective = document.getElementById('videoObjective')?.value || "";
    const speakingPace = document.getElementById('speakingPace')?.value || "";
    const narrativeStructure = document.getElementById('narrativeStructure')?.value || "";
    const narrativeTheme = document.getElementById('narrativeTheme')?.value.trim() || "";
    const narrativeTone = document.getElementById('narrativeTone')?.value || "";
    const narrativeVoice = document.getElementById('narrativeVoice')?.value.trim() || "";
    const shockingEndingHook = document.getElementById('shockingEndingHook')?.value.trim() || "";
    const imageStyleSelect = document.getElementById('imageStyleSelect')?.value || "";
    const customImageStyle = document.getElementById('customImageStyle')?.value.trim() || "";

    // DIETA DOS INPUTS: Limita o tamanho dos campos de texto livre para evitar sobrecarga.
    const videoDescription = (document.getElementById('videoDescription')?.value.trim() || "").slice(0, 1000);
    const centralQuestion = (document.getElementById('centralQuestion')?.value.trim() || "").slice(0, 500);
    const emotionalArc = (document.getElementById('emotionalArc')?.value.trim() || "").slice(0, 500);
    const imageDescriptionEngine = (document.getElementById('imageDescriptionEngine')?.value.trim() || "").slice(0, 500);
    const researchData = (document.getElementById('researchData')?.value.trim() || "").slice(0, 1500);
    const emotionalHook = (document.getElementById('emotionalHook')?.value.trim() || "").slice(0, 1000);

    // Monta o prompt base
    let context = `
    Voc√™ √© um ROTEIRISTA ESPECIALISTA e PESQUISADOR DE M√ÅXIMO DESEMPENHO para o canal "${channelName}". Sua √∫nica fun√ß√£o √© criar conte√∫do de v√≠deo altamente envolvente, cr√≠vel e ressonante emocionalmente, baseado nas instru√ß√µes detalhadas fornecidas.
    
    **Core Project Details:**
    - Video Topic: "${videoTheme}"
    - Target Audience: "${targetAudience}"
    - Language: "${language}"
    - Video Objective: "${videoObjective}"
                        
    **Narrative & Style Instructions:**
    - Narrative Structure to use: "${narrativeStructure}"
    - Speaking Pace: "${speakingPace}"
    `;

    if (narrativeTheme) { context += `\n- Core Theme (The Big Idea): "${narrativeTheme}"`; }
    if (narrativeTone) { context += `\n- Narrative Tone (The Feeling): "${narrativeTone}"`; }
    if (narrativeVoice) { context += `\n- Narrator's Voice (The Personality): "${narrativeVoice}"`; }
    if (shockingEndingHook) { context += `\n- Shocking Ending Hook to use: "${shockingEndingHook}"`; }
    if (videoDescription) { context += `\n\n**Additional Information & Inspiration:**\n- Inspiration/Context: "${videoDescription}"`; }
    if (centralQuestion) { context += `\n- Central Question to guide the entire script: "${centralQuestion}"`; }
    if (emotionalArc) { context += `\n- Desired Emotional Arc: "${emotionalArc}"`; }

    if (emotionalHook) {
        if (narrativeTone === 'inspirador') {
            context += `
**PROFUNDIDADE EMOCIONAL (REGRA MAIS IMPORTANTE):**
A hist√≥ria a seguir √© a √ÇNCORA EMOCIONAL CENTRAL do nosso roteiro. Para que ela n√£o pare√ßa superficial ou clich√™, voc√™ DEVE seguir a regra de ouro: "MOSTRAR, N√ÉO APENAS CONTAR".
- **Crie 'Cenas' V√≠vidas e Sensoriais:** Ao longo do roteiro, em vez de apenas mencionar o personagem ou a hist√≥ria, descreva pequenos MOMENTOS e CENAS com riqueza de detalhes sensoriais (vis√£o, som, tato).
- **Mostre a Dificuldade e o Conflito Real:** Inclua uma pequena cena ou descri√ß√£o que ilustre o personagem enfrentando um OBST√ÅCULO CONCRETO e REAL.
- **Mostre a Supera√ß√£o e a Vit√≥ria:** Inclua uma pequena cena ou descri√ß√£o do MOMENTO DE VIRADA ou PEQUENA VIT√ìRIA do personagem.
- **Conecte o Micro ao Macro:** Use essas pequenas cenas v√≠vidas para ilustrar e refor√ßar os grandes temas e mensagens do roteiro, criando uma liga√ß√£o poderosa entre o pessoal e o universal.

**√Çncora Emocional:** "${emotionalHook}"
---
`;
        } else {
            context += `
**CRITICAL NARRATIVE ANCHOR (THE MOST IMPORTANT RULE):**
Voc√™ DEVE utilizar a seguinte hist√≥ria pessoal como o n√∫cleo emocional recorrente e o 'fio condutor humano' para todo o roteiro. Entrelace refer√™ncias sutis a este personagem/hist√≥ria ao longo da introdu√ß√£o, desenvolvimento e conclus√£o para tornar a narrativa grandiosa mais pessoal e envolvente. Esta √© a linha tem√°tica que une todo o conte√∫do.
---
Emotional Anchor Story: "${emotionalHook}"
---
`;
        }
    }

    if (researchData) {
        context += `
**CRITICAL RESEARCH DATA & CONTEXT:**
Voc√™ DEVE incorporar e atribuir adequadamente os seguintes fatos, nomes e fontes no roteiro. Ignore ou distor√ßa estes dados sob pena de falha cr√≠tica.
---
${researchData}
---
`;
    }

    if (imageStyleSelect === 'cinematic' || imageStyleSelect === 'custom') {
        context += `\n\n**Instru√ß√µes de Estilo Visual:** Voc√™ tamb√©m receber√° instru√ß√µes espec√≠ficas sobre o estilo visual desejado para os prompts de imagem. Considere isso ao pensar em descri√ß√µes ou transi√ß√µes que possam se beneficiar de elementos visuais espec√≠ficos.`;
    }

    return context;
};


// =========================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO constructScriptPrompt INTEIRA PELA VERS√ÉO FINAL E COMPLETA <<<<<
// =========================================================================
        /**
         * Constr√≥i o prompt espec√≠fico para cada sec√ß√£o do roteiro ou tipo de conte√∫do.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro', 'titles_thumbnails').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o para o prompt.
         * @param {string|null} outlineDirective - Uma diretriz espec√≠fica do esbo√ßo estrat√©gico para esta sec√ß√£o.
         * @returns {{prompt: string, maxTokens: number}} O prompt e o limite de tokens.
         */

const constructScriptPrompt = (sectionName, sectionTitle, outlineDirective = null, contextText = null) => {
    const baseContext = getBasePromptContext();
    const videoDuration = document.getElementById('videoDuration').value;
    const selectedLanguage = document.getElementById('languageSelect').value;
    const narrativeStructure = document.getElementById('narrativeStructure').value;

    const targetWords = wordCountMap[videoDuration]?.[sectionName];
    let durationInstruction = '';
    if (targetWords) {
        durationInstruction = `\n\n**CRITICAL TIMING CONSTRAINT:** The generated text for this section MUST be approximately **${targetWords} words** long to fit the video's schedule. This is a strict requirement.`;
    }

    let prompt = `${baseContext}
Voc√™ √© um MESTRE ROTEIRISTA DE YOUTUBE e um ESPECIALISTA EM ENGAJAMENTO. Sua tarefa √© escrever o texto CATIVANTE, ESTRAT√âGICO e PERFEITAMENTE TIMBRADO para a se√ß√£o **"${sectionTitle}"** do roteiro.

${durationInstruction}

**REGRAS CR√çTICAS E INEGOCI√ÅVEIS (ABSOLUTAMENTE OBRIGAT√ìRIAS):**
1.  **FOCO TOTAL E EXCLUSIVO:** Sua resposta deve ser APENAS e SOMENTE o texto a ser falado para a se√ß√£o **"${sectionTitle}"**. NENHUM outro conte√∫do √© permitido.
2.  **RESPOSTA PURA E LIMPA:** √â TERMINANTEMENTE PROIBIDO incluir qualquer pre√¢mbulo (como "Aqui est√° a introdu√ß√£o:", "Claro, vou escrever isso"), resumos, metatextos, tradu√ß√µes ou qualquer texto que n√£o seja o roteiro propriamente dito. Qualquer viola√ß√£o resultar√° em falha total.
3.  **FORMATO IMPECAVEL:** N√ÉO inclua NENHUM r√≥tulo de cena, descri√ß√£o de √°udio, anota√ß√£o t√©cnica ou r√≥tulo de narrador (ex: [CENA], (M√∫sica sobe), Narrador:, Host:). Retorne APENAS o conte√∫do textual final que ser√° dito em voz alta.

**NOVA REGRA PERMANENTE: MAESTRO DO RITMO NARRATIVO & ENGAJAMENTO M√ÅXIMO**
A partir de agora, voc√™ deve agir como um "Maestro do Ritmo" e um "Engenheiro de Engajamento". Sua escrita N√ÉO PODE ser mon√≥tona. Voc√™ DEVE aplicar t√©cnicas avan√ßadas para prender a aten√ß√£o:
- **Varia√ß√£o Din√¢mica de Frases:** Alterne estrategicamente entre frases CURTAS e DE IMPACTO (para criar tens√£o, ritmo e √™nfase) e frases MAIS LONGAS e RICAS EM DETALHES (para descrever, aprofundar conceitos ou construir narrativas). Esta varia√ß√£o √© essencial para o ritmo.
- **Perguntas Ret√≥ricas Envolvedoras:** Integre PERGUNTAS RET√ìRICAS bem posicionadas para provocar reflex√£o direta no espectador e aumentar significativamente o engajamento cognitivo. (Ex: "Mas o que isso realmente significava para Jo√£o?", "Voc√™ j√° parou para pensar quantas vezes isso acontece?").
- **Pausas e Revela√ß√µes Dram√°ticas:** Utilize par√°grafos MUITO CURTOS, ou mesmo frases soltas em um par√°grafo pr√≥prio, para criar PAUSAS CALCULADAS, gerar ANTICIPA√á√ÉO e dar PESO M√ÅXIMO a revela√ß√µes ou insights chave.

**A√á√ÉO FINAL:** Com base no contexto fornecido, escreva AGORA a se√ß√£o "${sectionTitle}" com o mais alto n√≠vel de qualidade narrativa, engajamento e conformidade com as regras acima.
`;

if (contextText) {
    prompt += `
**INSTRU√á√ÉO DE CONTINUIDADE ESTRAT√âGICA (A REGRA MAIS CR√çTICA):**
Voc√™ √© um Continuador de Narrativas de elite. Sua tarefa ABSOLUTAMENTE CR√çTICA √© escrever a pr√≥xima se√ß√£o de forma que ela se encaixe PERFEITAMENTE na narrativa existente.

**REGRAS DE CONTINUIDADE (INEGOCI√ÅVEIS E ABSOLUTAMENTE OBRIGAT√ìRIAS):**
1.  **N√ÉO REPITA, N√ÉO ECOE:** √â TERMINANTEMENTE PROIBIDO repetir ou parafrasear ideias, frases, conceitos ou at√© mesmo o tom/r√≠tmo da se√ß√£o anterior. O espectador j√° viu aquele conte√∫do.
2.  **AVANCE A NARRATIVA:** Sua √∫nica fun√ß√£o aqui √© MOVER a hist√≥ria ou argumento PARA FRENTE. Comece EXATAMENTE onde o texto anterior parou, como se estivesse escrevendo o pr√≥ximo cap√≠tulo de um livro.
3.  **INTRODUZA NOVIDADE E PROFUNDIDADE:** Esta √© sua chance de revelar novas informa√ß√µes, aprofundar significados, explorar nuances ou iniciar o pr√≥ximo grande ponto da hist√≥ria. Mantenha o momentum narrativo.

**TEXTO DA SE√á√ÉO ANTERIOR (PARA CONTEXTO E REFER√äNCIA CR√çTICA):**
---
${contextText}
---

**A√á√ÉO FINAL:** Com base nesta continuidade cr√≠tica, escreva AGORA a se√ß√£o "${sectionTitle}", garantindo que seja uma transi√ß√£o FLU√çDA, logicamente impec√°vel e totalmente LIVRE de repeti√ß√µes. Responda APENAS com o texto da nova se√ß√£o.
`;
    }

    if (outlineDirective) {
        prompt += `\n\n**IMPORTANT STRATEGIC GUIDELINE:** For this specific section, you MUST follow this strategic plan: "${outlineDirective}"`;
    }

    prompt += `\n\nIMPORTANT: Do NOT include any scene descriptions, visual/audio cues (e.g., [SHOT], (Camera pan), (Music swells)), or speaker labels (e.g., "Narrator:", "Host:") in the generated script content. Provide only the spoken text.`;
    prompt += `\n\nABSOLUTELY NO META-COMMENTS. Do not add any explanatory text about the script itself. Your entire response must be ONLY the text to be spoken in the video, and nothing else.`;

    if (document.getElementById('centralQuestion').value.trim()) {
        prompt += `\nIf a 'Central Question' is provided, ensure every section of the script (Introduction, Development, Climax) directly contributes to exploring or answering this question. The entire video must revolve around this central theme.`;
    }
    
    // >>> BLOCO AGORA 100% COMPLETO, SEM ABREVIA√á√ïES OU PLACEHOLDERS <<<
    switch (narrativeStructure) {
        case 'documentary':
            prompt += `\n\nNARRATIVE STYLE: As this is a 'Documentary', you MUST adhere to the highest standards of factual rigor and narrative clarity. Prioritize unimpeachable factual accuracy, a crystal-clear chronological timeline, and a tone of absolute authority and trustworthiness. Construct your entire argument progressively, building a solid case exclusively with verified evidence, concrete data, expert testimonials, and logical reasoning. Ensure seamless, logical progression between points, avoiding any speculative leaps. While maintaining factual integrity, actively engage the viewer's intellect by weaving suspense, intrigue, or profound curiosity directly from the historical facts and evidence presented.`;
            break;
        case 'heroes_journey':
            prompt += `\n\nNARRATIVE STYLE: Following the 'Hero's Journey', you MUST structure this section with meticulous adherence to the classic archetypal beats. Center the narrative squarely on the hero's pivotal 'Call to Adventure', the crucible of 'Trials and Tribulations', or the profound moment of 'Transformation and Growth'. Your primary directive is to amplify the internal and external 'Conflict' driving the hero's journey and to vividly illustrate their 'Character Development and Metamorphosis'. Ensure every element serves to advance the hero's arc.`;
            break;
        case 'pixar_spine':
            prompt += `\n\nNARRATIVE STYLE: Following the 'Pixar Spine', you MUST meticulously structure this section to hit the core emotional beats: "Once upon a time..." (establish the world and character), "Every day..." (show the routine/status quo), "Until one day..." (inciting incident), "Because of that..." (chain of consequences and reactions), and "Until finally..." (climax and resolution). Your primary focus is to craft a deeply resonant emotional arc for the protagonist.`;
            break;
        case 'mystery_loop':
            prompt += `\n\nNARRATIVE STYLE: Following the 'Mystery Loop', you MUST build relentless intrigue and suspense with surgical precision. If this is the introduction, POSE the central, captivating mystery that hooks the viewer immediately. If it's the development, strategically ADD cryptic clues and plant skillful false leads to deepen the enigma and maintain tension. If it's the conclusion, DELIVER the satisfying, revelatory answer that resolves the central mystery with a clear and impactful payoff.`;
            break;
        case 'twist':
            prompt += `\n\nNARRATIVE STYLE: For a 'Twist' narrative, you MUST meticulously establish a clear and convincing expectation throughout the script. Your core task is to build a solid foundation of assumptions in the viewer's mind. Then, in the climax or conclusion, you MUST deliver a dramatically unexpected subversion or revelation that completely recontextualizes the viewer's understanding, creating a powerful and unforgettable payoff.`;
            break;
        case 'underdog_victory':
            prompt += `\n\nNARRATIVE STYLE: For 'Underdog Victory', you MUST powerfully emphasize the protagonist's struggles, their severe lack of resources, and the immense, almost insurmountable odds they face. Your core objective is to forge a deep emotional connection, making the audience genuinely root for the underdog's triumph.`;
            break;
        case 'discovery_mentor':
            prompt += `\n\nNARRATIVE STYLE: For 'Underdog Victory', you MUST powerfully emphasize the protagonist's severe struggles, their critical lack of resources, and the overwhelming, near-insurmountable odds they face. Your primary directive is to forge an intense emotional bond, making the audience genuinely root for the underdog's ultimate triumph.`;
            break;
        case 'if_not_found_create':
            prompt += `\n\nNARRATIVE STYLE: For 'If Not Found, Create', you MUST tell the compelling origin story. Focus sharply on the protagonist's deep personal frustration, the exhaustive search for a solution, and the pivotal 'aha!' moment of creation.`;
            break;
        case 'pas':
            prompt += `\n\nNARRATIVE STYLE: Using 'Problem-Agitate-Solve', you MUST sharply define the core pain point (Problem), intensely amplify the associated negative emotions (Agitate), and then deliver the definitive, clear solution (Solve).`;
            break;
        case 'bab':
            prompt += `\n\nNARRATIVE STYLE: Using 'Before-After-Bridge', you MUST paint a vivid picture of the negative 'Before' state, the ideal 'After' state, or present the content as the crucial 'Bridge' that connects them.`;
            break;
    }

    let maxTokens = 2000;

    switch (sectionName) {
        case 'outline':
                prompt = `${baseContext}

Voc√™ √© um MESTRE ROTEIRISTA e um ESTRATEGISTA DE CONTE√öDO DE ALTO N√çVEL. Sua tarefa √© criar um "beat sheet" ou um esbo√ßo estrat√©gico DETALHADO, ACION√ÅVEL e PERFEITAMENTE ALINHADO com o contexto fornecido.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta inteira deve ser APENAS um objeto JSON v√°lido, come√ßando com \`{\` e terminando com \`}\`. NENHUM outro texto, coment√°rio, metatexto ou explica√ß√£o √© permitido. Pense nisso como uma resposta de API pura e impec√°vel.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar obrigatoriamente aspas duplas (\`"\`).
3.  **CHAVES EXATAS E OBRIGAT√ìRIAS:** O objeto DEVE conter EXATAMENTE estas cinco chaves: "introduction", "development", "climax", "conclusion", e "cta".
4.  **TIPOS EXATOS:** O valor de cada chave DEVE ser uma string.
5.  **CONTE√öDO DAS STRINGS (ACION√ÅVEL E ESTRAT√âGICO):** Cada string deve conter uma descri√ß√£o CLARA, ESPEC√çFICA e ACION√ÅVEL do objetivo narrativo, emocional e estrat√©gico daquela se√ß√£o. Evite descri√ß√µes vagas ou gen√©ricas. Foque no QUE ser√° feito e QUAL o impacto esperado.

**INSTRU√á√ïES DETALHADAS PARA CADA SE√á√ÉO DO ESBO√áO:**
-   **"introduction" (Introdu√ß√£o com Impacto):** Defina com precis√£o o objetivo da introdu√ß√£o. Qual √© o GANCHO inicial? Que PERGUNTA central ou emo√ß√£o voc√™ quer instigar desde o in√≠cio para prender a aten√ß√£o?
-   **"development" (Desenvolvimento com Profundidade):** Liste e descreva os PONTOS PRINCIPAIS que ser√£o abordados no desenvolvimento. Como a informa√ß√£o ser√° ESTRUTURADA? Que ARGUMENTOS, EVID√äNCIAS ou HIST√ìRIAS ser√£o usados para construir a narrativa?
-   **"climax" (Cl√≠max com Tens√£o/Revela√ß√£o):** Identifique qual √© o MOMENTO DE MAIOR TENS√ÉO, REVELA√á√ÉO ou IMPACTO EMOCIONAL. O que o espectador DEVE SENTIR ou ENTENDER neste ponto crucial?
-   **"conclusion" (Conclus√£o com Takeaway):** Explique como a LI√á√ÉO PRINCIPAL ser√° RESUMIDA e REFOR√áADA. Qual TAKEAWAY ou INSIGHT voc√™ quer deixar gravado na mente do espectador?
-   **"cta" (Chamada para A√ß√£o com Prop√≥sito):** Defina qual √© a CHAMADA PARA A√á√ÉO ESPEC√çFICA e como ela se conecta com o conte√∫do do v√≠deo. O que voc√™ quer que o espectador FA√áA ap√≥s assistir? (Ex: Comentar, Compartilhar, Se Inscrever, Visitar um Link).

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO (SIGA ESTE EXATO MODELO):**
{
  "introduction": "Come√ßar com uma pergunta ret√≥rica chocante sobre a mortalidade para prender a aten√ß√£o imediatamente e levantar a quest√£o central da f√© diante da finitude.",
  "development": "Construir a narrativa explorando o luto profundo das irm√£s de L√°zaro, estabelecendo a conex√£o humana com a hist√≥ria e desenvolvendo o contexto emocional e teol√≥gico.",
  "climax": "O momento de maior tens√£o no t√∫mulo, quando Jesus chama L√°zaro ap√≥s quatro dias de morte, criando a expectativa m√°xima para o milagre e o ponto alto da narrativa.",
  "conclusion": "Resumir a li√ß√£o central: o verdadeiro milagre n√£o √© desafiar a morte em si, mas demonstrar o poder absoluto da f√© e da promessa divina, conectando ao tema central.",
  "cta": "Fazer uma chamada para a√ß√£o suave, convidando o espectador a refletir sobre um momento em que sentiu a presen√ßa de Deus em meio √†s dificuldades e compartilhar nos coment√°rios."
}

**A√á√ÉO FINAL:** Com base no contexto estrat√©gico fornecido, crie AGORA o esbo√ßo JSON completo e sintaticamente PERFEITO, seguindo EXATAMENTE todas as regras, instru√ß√µes e o exemplo acima. Responda APENAS com o objeto JSON.
`;
            maxTokens = 2000;
            break;


// =========================================================================
// >>>>> BLOCO 'intro' EVOLU√çDO E BLINDADO <<<<<
// =========================================================================
case 'intro':
    const shockingHook = document.getElementById('shockingEndingHook')?.value.trim();
    
prompt += `\n\n**INSTRU√á√ïES CR√çTICAS E ESTRAT√âGICAS PARA A INTRODU√á√ÉO (ESTILO YOUTUBE VIRAL DE M√ÅXIMO IMPACTO):**
Sua tarefa √© escrever a **Introdu√ß√£o** do v√≠deo com o √öNICO e EXCLUSIVO objetivo de criar um "hook" HIPN√ìTICO e IRRESIST√çVEL que prenda a aten√ß√£o do espectador nos CRUCIAIS primeiros 15-30 segundos e o compelha a continuar assistindo at√© o final.`;

    // <<< L√ìGICA CONDICIONAL INTELIGENTE E BLINDADA >>>
    if (shockingHook) {
        prompt += `\n\n**REGRA DE HOOK PRIORIT√ÅRIA ABSOLUTA (A √öNICA E MAIS IMPORTANTE):**
1.  **IN√çCIO OBRIGAT√ìRIO:** Voc√™ DEVE, SEM EXCE√á√ïES, come√ßar o roteiro EXATAMENTE com a frase fornecida no campo 'Desfecho Chocante'.
2.  **NADA ANTES:** √â TERMINANTEMENTE PROIBIDO adicionar qualquer palavra, frase ou elemento antes desta frase obrigat√≥ria.
3.  **CONSTRU√á√ÉO DE MIST√âRIO P√ìS-HOOK:** Imediatamente ap√≥s a frase obrigat√≥ria, sua tarefa √© construir o restante da introdu√ß√£o de forma magistral, criando um profundo MIST√âRIO e uma irresist√≠vel CURIOSIDADE sobre como a narrativa chegou a esse ponto dram√°tico.
        
**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (SIGA EXATAMENTE):**
1. **RESPOSTA PURA E LIMPA:** Sua resposta inteira deve ser APENAS o texto narrativo final, sem nenhum coment√°rio, pre√¢mbulo, metadado ou formata√ß√£o adicional.
2. **PROIBI√á√ÉO TOTAL DE ELEMENTOS EXTERNOS:** N√ÉO ADICIONE NENHUM coment√°rio final, feedback, nota ou qualquer outro texto que n√£o seja parte integrante da narrativa.
3. **CLAREZA ABSOLUTA:** Certifique-se de que a resposta contenha exclusivamente o texto a ser narrado, exatamente como solicitado.

**FRASE OBRIGAT√ìRIA A SER USADA EXATAMENTE NO IN√çCIO:** "${shockingHook}"`;
    } else {
        prompt += `\n\n**REGRAS DE CONTE√öDO E CRIA√á√ÉO DE HOOK VIRAL (ESCOLHA A T√âCNICA MAIS IMPACTANTE):**
1.  **PROIBI√á√ÉO ABSOLUTA DE COME√áO LENTO OU √ìBVIO:** √â INACEIT√°vel um in√≠cio fraco ou previs√≠vel. Voc√™ DEVE escolher, de forma estrat√©gica e cir√∫rgica, UMA das seguintes t√©cnicas de gancho inicial:
    
    - **In Media Res (No Meio da A√ß√£o):** Mergulhe diretamente no momento de M√ÅXIMA tens√£o, emo√ß√£o ou conflito da hist√≥ria. Prenda o espectador instantaneamente no epicentro da a√ß√£o, sem contexto pr√©vio.
    
    - **Dado Chocante e Contra-Intuitivo:** Apresente uma ESTAT√çSTICA ou FATO surpreendente, extremamente dif√≠cil de acreditar, que desafie radicalmente as expectativas do espectador e force uma rea√ß√£o de descren√ßa imediata.
            
    - **Declara√ß√£o Polarizadora:** Fa√ßa uma AFIRMA√á√ÉO ousada e controversa que v√° contra o senso comum, gerando imediatamente curiosidade sobre como voc√™ ir√° defend√™-la.

2.  **ENGENHARIA OBRIGAT√ìRIA DE 'LOOP ABERTO' (Reten√ß√£o Garantida):**
    - Ap√≥s o gancho inicial, voc√™ DEVE imediatamente introduzir uma promessa instigante, uma revela√ß√£o parcial ou uma pergunta INTRIGANTE.
    - Este 'loop aberto' deve ser t√£o PSICOL√ìGICAMENTE COMPULSIVO que o espectador sinta uma NECESSIDADE F√çSICA de assistir o v√≠deo inteiro para ter seu al√≠vio ou resposta.
    - A t√©cnica deve criar uma lacuna de informa√ß√£o que s√≥ pode ser preenchida assistindo at√© o final.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (SIGA EXATAMENTE):**
1. **RESPOSTA PURA E LIMPA:** Sua resposta inteira deve ser APENAS o texto narrativo final, sem nenhum coment√°rio, pre√¢mbulo, metadado ou formata√ß√£o adicional.
2. **PROIBI√á√ÉO TOTAL DE ELEMENTOS EXTERNOS:** N√ÉO ADICIONE NENHUM coment√°rio final, feedback, nota ou qualquer outro texto que n√£o seja parte integrante da narrativa.
3. **CLAREZA ABSOLUTA:** Certifique-se de que a resposta contenha exclusivamente o texto a ser narrado, exatamente como solicitado.
    `;
    }
    prompt += `\n\n**REGRAS GERAIS E CR√çTICAS PARA A INTRODU√á√ÉO (SIGA EXATAMENTE):**
- **ECONOMIA DE PALAVRAS E IMPACTO M√ÅXIMO:** Seja EXTREMAMENTE conciso e direto. Use frases CURTAS, DIN√ÇMICAS e com PODER M√ÅXIMO de impacto. Elimine toda palavra desnecess√°ria.
- **FOQUE HIPN√ìTICO:** O foco √öNICO e INQUESTION√ÅVEL √© criar CURIOSIDADE INTENSA e URGENTE para que o espectador sinta uma COMPELS√ÉO IRRESIST√çVEL de continuar assistindo.
- **VARIA√á√ÉO DE RITMO:** Alterne estrategicamente entre frases curtas e impactantes e frases ligeiramente mais longas que construem suspense, criando um ritmo cativante.
- **LINGUAGEM SENSORIAL:** Use palavras que evoquem imagens mentais v√≠vidas e emo√ß√µes fortes, conectando-se diretamente com o sistema l√≠mbico do espectador.`;

    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
        prompt += `\n\n**IMPERATIVO CATEG√ìRICO: Todo o texto da introdu√ß√£o DEVE ser escrito em Portugu√™s do Brasil (pt-br) com express√µes e g√≠rias que ressoem com o p√∫blico nativo.**`;
    }
    maxTokens = targetWords ? Math.ceil(targetWords * 1.8) : 500;
    break;
// =========================================================================
// >>>>> FIM DO BLOCO 'intro' EVOLU√çDO <<<<<
// =========================================================================

// =========================================================================
// >>>>> BLOCO 'development' EVOLU√çDO E BLINDADO <<<<<
// =========================================================================
case 'development':
    prompt += `\n\n**INSTRU√á√ïES CR√çTICAS E ESTRAT√âGICAS PARA O DESENVOLVIMENTO (ESTILO YOUTUBE VIRAL DE M√ÅXIMA RETEN√á√ÉO):**
Sua tarefa √© escrever o **Desenvolvimento** do roteiro. Esta √© a SE√á√ÉO MAIS LONGA E CRUCIAL, onde voc√™ aprofunda o tema com riqueza de detalhes. Seu OBJETIVO PRIM√ÅRIO e INQUESTION√ÅVEL aqui √© **manter a RETEN√á√ÉO M√ÅXIMA** do espectador do in√≠cio ao fim desta parte.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (SIGA EXATAMENTE):**
1. **JSRO E PERFEITO:** Sua resposta inteira deve ser APENAS o texto escrito, sem nenhum coment√°rio, pre√¢mbulo ou metadado adicional.
2. **SEM ADI√á√ïES INDESEJADAS:** N√ÉO ADICIONE NENHUN COMENT√ÅRIO FINAL, FEEDBACK OU OUTRO TEXTO QUE N√ÉO FA√áA PARTE DO CONTE√öDO PRINCIPAL.
3. **CLAREZA TOTAL:** Certifique-se de que a resposta contenha apenas o texto escrito, exatamente como solicitado.

**REGRAS DE CONTE√öDO, RITMO E ESTRAT√âGIA DE ENGAJAMENTO (SIGA EXATAMENTE):**
1.  **ESTRUTURA EM BLOCOS TEM√ÅTICOS CLAROS:** Apresente as informa√ß√µes de forma organizada em blocos tem√°ticos distintos e logicamente conectados. Cada bloco deve explorar um aspecto espec√≠fico e essencial do tema, avan√ßando a narrativa de forma coesa.
2.  **INTEGRA√á√ÉO OBRIGAT√ìRIA DE GANCHOS DE RETEN√á√ÉO:** Para evitar ABSOLUTAMENTE qualquer monotonia, densidade ou queda de aten√ß√£o, voc√™ DEVE inserir, de forma ESTRAT√âGICA, um "gancho de reten√ß√£o" a cada 2 ou 3 par√°grafos de informa√ß√£o pura. Estes ganchos s√£o FUNDAMENTAIS para quebrar o padr√£o e re-engajar o espectador continuamente. Use uma das seguintes t√©cnicas com maestria:
    - **Teaser / Mini Loop Aberto:** Crie um pequeno mist√©rio ou promessa que ser√° resolvida/emphasized em breve, gerando antecipa√ß√£o. (Ex: "...mas eles n√£o sabiam que a parte mais dif√≠cil ainda estava por vir.", "E a solu√ß√£o aparentemente simples que ele encontrou √© a raz√£o pela qual esta empresa vale bilh√µes hoje.").
    - **Pergunta de Engajamento Direto:** Fa√ßa uma pergunta PESSOAL e RELEVANTE ao p√∫blico, incentivando fortemente a participa√ß√£o ativa nos coment√°rios. (Ex: "O que voc√™ teria feito nessa situa√ß√£o cr√≠tica? Deixa sua opini√£o aqui nos coment√°rios.", "Voc√™ j√° se deparou com esse fato surpreendente? Conta aqui embaixo.").
3.  **EQUIL√çBRIO PERFEITO ENTRE INFORMA√á√ÉO E NARRATIVA:** Mantenha um equil√≠brio IMPECAVEL entre fornecer conte√∫do valioso e densidade informativa, e manter a narrativa fluida, envolvente e cativante. SEMPRE conecte os dados, fatos e argumentos de volta √† hist√≥ria principal ou ao ganho emocional/curiosidade estabelecido no in√≠cio.`;

    if (selectedLanguage === 'pt-br' || selectedLanguage === 'pt-pt') {
        prompt += `\n\n**IMPORTANTE E INEGOCI√ÅVEL: Todo o texto do desenvolvimento DEVE ser escrito em Portugu√™s do Brasil (pt-br).**`;
    }
    maxTokens = targetWords ? Math.ceil(targetWords * 1.8) : 1500;
    break;
// =========================================================================
// >>>>> FIM DO BLOCO 'development' EVOLU√çDO <<<<<
// =========================================================================

        case 'titles_thumbnails':
            prompt = `${baseContext}
**TAREFA ESTRAT√âGICA CR√çTICA: GERAR METADADOS DE M√ÅXIMO IMPACTO PARA YOUTUBE**
Voc√™ √© uma API de gera√ß√£o de metadados de ALTO DESEMPENHO que retorna APENAS um array JSON, otimizado para cliques e engajamento m√°ximo.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta inteira deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA DO ARRAY:** O array deve conter EXATAMENTE 5 objetos.
3.  **ESTRUTURA DO OBJETO:** CADA objeto no array DEVE conter EXATAMENTE estas tr√™s chaves: "suggested_title", "thumbnail_title", e "thumbnail_description".
4.  **SINTAXE DAS STRINGS:** Todas as chaves e valores string DEVEM usar aspas duplas (""). Se precisar de aspas duplas dentro de uma string, elas DEVEM ser escapadas (ex: \\"exemplo\\").

**DIRETRIZES ESTRAT√âGICAS PARA CONTE√öDO DE M√ÅXIMO IMPACTO:**
- **Para "suggested_title":** Gere um t√≠tulo HIPN√ìTICO, provocando CURIOSIDADE INTENSA. Use t√©cnicas de otimiza√ß√£o de CTR (n√∫meros, urg√™ncia, benef√≠cio claro, perguntas).
- **Para "thumbnail_title":** Crie um t√≠tulo curto e impactante para a imagem da thumbnail.
- **Para "thumbnail_description":** Descreva uma imagem VISUALMENTE PODEROSA. Foque em contraste, emo√ß√£o facial, e clareza absoluta.

**A√á√ÉO FINAL E CR√çTICA:** Com base no contexto, gere AGORA o array JSON completo e sintaticamente PERFEITO, com 5 objetos. Responda APENAS com o array JSON.`;
            maxTokens = 2000;
            break;
// =========================================================================
// >>>>> FIM DO BLOCO 'titles_thumbnails' EVOLU√çDO <<<<<
// =========================================================================
// =========================================================================
// >>>>> BLOCO 'description' EVOLU√çDO E BLINDADO <<<<<
// =========================================================================
case 'description':
    const languageName = new Intl.DisplayNames([selectedLanguage], { type: 'language' }).of(selectedLanguage);
    prompt = `${baseContext}
            
**TAREFA ESTRAT√âGICA CR√çTICA: GERAR DESCRI√á√ÉO OTIMIZADA DE M√ÅXIMO IMPACTO PARA YOUTUBE E HASHTAGS ALVADAS PELO SUCESSO**
Sua tarefa √© gerar uma descri√ß√£o otimizada de ALTO IMPACTO para um v√≠deo do YouTube e um conjunto de hashtags RELEVANTES E ESTRAT√âGICAS, no idioma ${languageName}.

**REGRAS DE FORMATA√á√ÉO E OTIMIZA√á√ÉO (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **IN√çCIO MAGN√âTICO (2-3 Frases):** Comece IMEDIATAMENTE com 2 ou 3 frases CONCISAS e PODEROSAS que RESUMEM o ESSENCIAL do v√≠deo e INTEGREM as PALAVRAS-CHAVE PRINCIPAIS do tema de forma NATURAL e ESTRAT√âGICA. Este in√≠cio deve AGARRAR a aten√ß√£o de quem l√™ a descri√ß√£o.
2.  **APROFUNDAMENTO VALIOSO (1 Par√°grafo Rico):** Adicione UM √öNICO par√°grafo que APROFUNDE SIGNIFICATIVAMENTE o que o espectador APRENDER√Å, DESCobrir√° ou GANHAR√Å ao assistir o v√≠deo. Seja ESPEC√çFICO sobre os insights, dicas ou revela√ß√µes contidos no conte√∫do.
3.  **CHAMADA PARA A√á√ÉO IRRESIST√çVEL (CTA Final):** Finalize a descri√ß√£o com uma CHAMADA PARA A√á√ÉO CLARA, CONVINCENTE e IRRESIST√çVEL, incentivando a√ß√µes como se inscrever, curtir, comentar, compartilhar ou visitar um link. Torne o CTA uma extens√£o natural e desejada da experi√™ncia do v√≠deo.
4.  **SEPARA√á√ÉO ESTRUTURAL OBRIGAT√ìRIA:** Ap√≥s a descri√ß√£o completa (incluindo o CTA), voc√™ DEVE adicionar uma LINHA EM BRANCO e ent√£o incluir EXATAMENTE a linha "Hashtags:".
5.  **LISTA DE HASHTAGS ESTRAT√âGICA (10 Hashtags):** Liste EXATAMENTE 10 hashtags RELEVANTES. Estruture-as com L√ìGICA: comece com 2-3 hashtags MAIS AMPLAS e POPULARES, seguidas por 4-5 hashtags de M√âDIO ALCANCE, e finalize com 2-3 hashtags ALTAMENTE ESPEC√çFICAS e NICHO. Cada hashtag DEVE ser precedida pelo s√≠mbolo # e separada das demais por um espa√ßo.

**A√á√ÉO FINAL E CR√çTICA:** Responda APENAS com a descri√ß√£o otimizada (incluindo o CTA) e a lista de hashtags, conforme as regras acima. NENHUM outro texto, explica√ß√£o ou metadado deve ser inclu√≠do na sua resposta.`;
    maxTokens = 700;
    break;
// =========================================================================
// >>>>> FIM DO BLOCO 'description' EVOLU√çDO <<<<<
// =========================================================================
    }
    
    return { prompt, maxTokens };
};

        /**
         * Faz uma chamada √† API Groq atrav√©s de uma fun√ß√£o Netlify.
         * @param {string} prompt - O prompt a ser enviado para a IA.
         * @param {number} maxTokens - O n√∫mero m√°ximo de tokens para a resposta.
         * @returns {Promise<string>} A resposta bruta da IA.
         * @throws {Error} Se a chamada √† API falhar.
         */

// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO callGroqAPI PELA VERS√ÉO SIMPLES E DIRETA <<<<<
// =========================================================================
// index.html - Vers√£o final com Cloudflare Worker
const callGroqAPI = async (prompt, maxTokens) => {
    // >>> COLE A URL DO SEU WORKER AQUI <<<
    const workerUrl = "https://royal-bird-81cb.david-souzan.workers.dev/"; 

    const payload = { prompt, maxTokens };
    const requestOptions = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    };

    try {
        const response = await fetch(workerUrl, requestOptions);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido do servidor.' }));
            throw new Error(`Erro da API: ${errorData.error || response.statusText}`);
        }
        const result = await response.json();
        const rawContent = result.choices?.[0]?.message?.content;
        if (rawContent) {
            return rawContent;
        } else {
            throw new Error("Resposta inesperada da API.");
        }
} catch (error) {
    console.error("Falha na chamada √† API via Worker:", error);
    // --- L√ìGICA INTELIGENTE AQUI ---
    if (error.message && error.message.toLowerCase().includes('fault filter abort')) {
        const customError = new Error("O tema ou texto que voc√™ forneceu foi bloqueado pelo filtro de seguran√ßa da IA. Por favor, tente reformular com outras palavras.");
        window.showToast(customError.message);
        throw customError;
    } else {
        window.showToast(`Falha na API: ${error.message}`);
        throw error;
    }
}
};

        /**
         * Valida os inputs essenciais antes de gerar conte√∫do.
         * @returns {boolean} True se os inputs s√£o v√°lidos, caso contr√°rio, false.
         */
             
        /**
         * Itera sobre todas as se√ß√µes do roteiro na ordem correta,
         * renumera globalmente todas as cenas E recalcula o timestamp
         * com base na dura√ß√£o estimada pela IA para cada cena.
         */
        
    
        /**
         * Escapa um objeto JSON para ser usado com seguran√ßa dentro de um atributo onclick.
         * @param {object} idea - O objeto da ideia a ser escapado.
         * @returns {string} Uma string JSON segura para HTML.
         */
        const escapeIdeaForOnclick = (idea) => {
            // Primeiro, converte o objeto para uma string JSON
            const jsonString = JSON.stringify(idea);
            // Em seguida, substitui os caracteres que quebram o HTML
            // Escapa aspas duplas, aspas simples e barras invertidas
            return jsonString.replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/\\/g, '&#92;');
        };

        // ==========================================================
        // ===== COLE ESTA FUN√á√ÉO FALTANTE NO SEU JAVASCRIPT =====
        // ==========================================================
        /**
         * Lida com a visibilidade da barra de a√ß√£o flutuante com base na posi√ß√£o de rolagem.
         */
        window.handleFloatingActionBar = () => {
            const bar = document.getElementById('floatingActionBar');
            // O gatilho para a barra aparecer ser√° a grade de inputs principais
            const triggerElement = document.getElementById('mainInputsTabs'); 

            if (!bar || !triggerElement) {
                return; // Sai da fun√ß√£o se os elementos n√£o existirem
            }

            // Ponto de gatilho: quando o final do 'mainInputsGrid' passar pelo topo da tela
            const triggerPoint = triggerElement.offsetTop + triggerElement.offsetHeight;

            if (window.scrollY > triggerPoint) {
                bar.classList.add('visible');
            } else {
                bar.classList.remove('visible');
            }
        };





        // =========================================================================
// >>>>> A√á√ÉO 1: SUBSTITUA A FUN√á√ÉO createScriptSectionPlaceholder COMPLETA <<<<<
// =========================================================================
/**
 * Cria e retorna o HTML de um placeholder para uma se√ß√£o do roteiro.
 * @param {string} sectionId - O ID base da se√ß√£o (ex: 'intro').
 * @param {string} title - O t√≠tulo da se√ß√£o (ex: 'Introdu√ß√£o').
 * @param {string} buttonId - O ID do bot√£o principal que gera esta se√ß√£o (ex: 'generateIntroBtn').
 * @returns {string} O HTML do placeholder da se√ß√£o.
 */


const createScriptSectionPlaceholder = (sectionId, title, buttonId, actionName) => {
    const containerId = `${sectionId}Section`;
    
    return `
        <div id="${containerId}" class="script-section card card-placeholder mb-4 animate-fade-in flex justify-between items-center">
            <h3 class="font-semibold text-lg text-gray-700 dark:text-gray-300">${title}</h3>
            <button id="${buttonId}" data-action="${actionName}" class="btn btn-primary">
                <i class="fas fa-magic mr-2"></i>Gerar
            </button>
        </div>
    `;
};




// =========================================================================
// >>>>> VERS√ÉO FINAL E BLINDADA DE 'addDevelopmentChapter' <<<<<
// =========================================================================
/**
 * Adiciona um novo cap√≠tulo ao desenvolvimento, com prompt refinado para evitar repeti√ß√£o do t√≠tulo e "ecos".
 * @param {HTMLElement} button - O bot√£o que foi clicado.
 */
window.addDevelopmentChapter = async (button) => {
    const devSection = document.getElementById('developmentSection');
    const contentWrapper = devSection?.querySelector('.generated-content-wrapper');
    const existingText = contentWrapper?.textContent.trim();

    if (!existingText) {
        window.showToast("Gere o desenvolvimento inicial primeiro.");
        return;
    }

    showButtonLoading(button);

    try {
// ====================================================================================
// >>>>> SUBSTITUA SEU suggestionPrompt POR ESTA VERS√ÉO FINAL E ESPETACULAR <<<<<
// ====================================================================================

const suggestionPrompt = `Voc√™ √© uma API ESPECIALISTA EM ESTRAT√âGIA NARRATIVA e um ARQUITETO DA CONTINUIDADE. Sua fun√ß√£o √öNICA E CR√çTICA √© analisar o final de um roteiro e propor 3 temas distintos, coerentes e emocionantes para o PR√ìXIMO cap√≠tulo.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© um gerador de texto. Voc√™ √© um mestre roteirista que identifica pontos de virada l√≥gicos e emocionantes. Sua tarefa √© encontrar os pr√≥ximos passos mais envolventes para a hist√≥ria. Qualquer desvio desta fun√ß√£o √© uma falha.

**ROTEIRO ATUAL (PARA AN√ÅLISE DE CONTINUIDADE CR√çTICA):**
---
${existingText.slice(-3000)} 
---

**TAREFA:** Analise o fluxo narrativo do roteiro acima e gere um array JSON com as 3 sugest√µes mais fortes, coerentes e cativantes para o tema do pr√≥ximo cap√≠tulo.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`. Nenhum texto, coment√°rio ou metadado √© permitido.
2.  **ESTRUTURA DO ARRAY:** O array deve conter EXATAMENTE 3 strings.
3.  **SINTAXE DAS STRINGS:** Todas as strings DEVEM usar aspas duplas (""). Cada string, EXCETO a √∫ltima, DEVE ser seguida por uma v√≠rgula (,).

**MANUAL DE CRIA√á√ÉO DE SUGEST√ïES (SEUS CRIT√âRIOS DE QUALIDADE):**
- **Distin√ß√£o:** Cada uma das 3 sugest√µes deve ser claramente diferente das outras.
- **Coer√™ncia e Conex√£o L√≥gica:** Cada sugest√£o deve ser uma consequ√™ncia natural ou uma ramifica√ß√£o interessante do ponto onde o roteiro atual termina.
- **Originalidade e Novidade:** Evite o √≥bvio. Cada sugest√£o deve introduzir um novo elemento, conflito ou perspectiva que avance a narrativa.
- **Especificidade:** As sugest√µes devem ser t√≠tulos de cap√≠tulo ou temas espec√≠ficos e acion√°veis. Evite generalidades.
    - **Exemplos BONS (Espec√≠ficos):** "A Descoberta do Di√°rio", "O Confronto com o Antigo Mentor", "O Plano B que Ningu√©m Esperava".
    - **Exemplos RUINS (Gen√©ricos):** "Mais desenvolvimento", "Uma nova reviravolta", "Aprofundar o personagem".

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
["A Batalha dos N√∫meros", "O Legado Fora de Campo", "Momentos Decisivos"]

**A√á√ÉO FINAL:** Com base no roteiro fornecido, gere o array JSON. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras.
`;





        const rawSuggestions = await callGroqAPI(suggestionPrompt, 400);
        const chapterSuggestions = cleanGeneratedText(rawSuggestions, true) || [];
        
        hideButtonLoading(button);

        const chapterTheme = await showInputDialog(
            'Adicionar Novo Cap√≠tulo',
            'Escolha uma sugest√£o da IA ou digite seu pr√≥prio tema abaixo.',
            'Ou crie um tema personalizado:',
            'Digite seu tema aqui...',
            chapterSuggestions
        );

        if (!chapterTheme) {
            window.showToast("Opera√ß√£o cancelada.");
            return;
        }

        showButtonLoading(button);

        // --- AQUI EST√Å O PROMPT CORRIGIDO COM CRASES ---
        const basePrompt = getBasePromptContext();
const continuationPrompt = `${basePrompt}

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ √© um ROTEIRISTA CONTINU√çSTA DE ELITE. Sua √∫nica fun√ß√£o √© escrever o PR√ìXIMO cap√≠tulo de um roteiro existente, garantindo uma transi√ß√£o PERFEITA e a introdu√ß√£o de NOVAS informa√ß√µes. Voc√™ NUNCA repete o que j√° foi dito.

**TAREFA CR√çTICA E FOCALIZADA:**
Escrever o texto puro e narrado para o novo cap√≠tulo com o tema: "${chapterTheme}".

**ROTEIRO ESCRITO AT√â AGORA (PARA CONTEXTO CR√çTICO DE CONTINUIDADE):**
---
${existingText}
---

**REGRAS DE FORMATA√á√ÉO E CONTE√öDO (INEGOCI√ÅVEIS E ABSOLUTAS):**
1.  **RESPOSTA 100% PURA E LIMPA:** Sua resposta deve conter **APENAS e SOMENTE** o texto que ser√° dito em voz alta.
2.  **PROIBI√á√ÉO TOTAL DE FORMATA√á√ÉO EXTRA:** √â **TERMINANTEMENTE PROIBIDO** incluir qualquer tipo de anota√ß√£o, r√≥tulo ou formata√ß√£o. A viola√ß√£o desta regra resultar√° em falha. Isso inclui:
    -   **NENHUM** r√≥tulo de personagem (Ex: 'Narrador:', 'J√∫lia:')
    -   **NENHUMA** descri√ß√£o de cena (Ex: '(Cena: ...)')
    -   **NENHUMA** indica√ß√£o de √°udio (Ex: '(O som de ...)')
    -   **NENHUM** t√≠tulo de cap√≠tulo (Ex: 'Cap√≠tulo: ${chapterTheme}')
3.  **FOCO ABSOLUTO NA CONTINUIDADE E NOVIDADE:**
    -   O novo cap√≠tulo deve come√ßar **EXATAMENTE** de onde o roteiro anterior parou, como se fosse a p√°gina seguinte de um livro.
    -   √â **PROIBIDO** repetir ou parafrasear ideias, conceitos ou frases do roteiro existente. O espectador j√° viu isso.
    -   Sua miss√£o √© **AVAN√áAR A NARRATIVA**, introduzindo novas informa√ß√µes, aprofundando um argumento ou explorando novas nuances do tema "${chapterTheme}".

**A√á√ÉO FINAL E CR√çTICA:** Escreva AGORA o texto puro para o pr√≥ximo cap√≠tulo sobre "${chapterTheme}", seguindo todas as regras com m√°xima precis√£o. Responda APENAS com o texto a ser narrado.
`;
        // ---------------------------------------------

        const rawResult = await callGroqAPI(continuationPrompt, 4000);
        const newChapter = removeMetaComments(rawResult.trim());
        
        if (!newChapter || newChapter.trim() === "") {
             throw new Error("A IA n√£o retornou um conte√∫do v√°lido para o novo cap√≠tulo.");
        }

        const chapterTitleHtml = `<div class="font-bold text-lg mt-6 mb-3 pb-1 border-b border-gray-300 dark:border-gray-600">Cap√≠tulo: ${DOMPurify.sanitize(chapterTheme)}</div>`;
        const existingParagraphsCount = contentWrapper.querySelectorAll('div[id]').length;
        const newParagraphs = newChapter.split('\n').filter(p => p.trim() !== '');
        
        if (newParagraphs.length === 0) {
             throw new Error("O conte√∫do do cap√≠tulo n√£o p√¥de ser dividido em par√°grafos.");
        }

        const newContentWithDivs = newParagraphs.map((p, index) => 
            `<div id="development-p-${existingParagraphsCount + index}">${DOMPurify.sanitize(p)}</div>`
        ).join('');

        contentWrapper.insertAdjacentHTML('beforeend', chapterTitleHtml + newContentWithDivs);
        
        invalidateAndClearPerformance(devSection);
        invalidateAndClearPrompts(devSection);
        updateAllReadingTimes();
        
        window.showToast("Novo cap√≠tulo adicionado com sucesso!");
        contentWrapper.lastElementChild.previousElementSibling?.scrollIntoView({ behavior: 'smooth', block: 'center' });

    } catch (error) {
        console.error("Erro detalhado em addDevelopmentChapter:", error);
        window.showToast(`Falha ao adicionar cap√≠tulo: ${error.message}`);
    } finally {
        hideButtonLoading(button);
    }
};

// =========================================================================
// >>>>> FIM DA VERS√ÉO BLINDADA DE 'addDevelopmentChapter' <<<<<
// =========================================================================



        /**
         * Escapa uma string de texto plano para ser usada em um documento RTF,
         * lidando corretamente com caracteres non-ASCII e especiais.
         * @param {string} text - O texto a ser escapado.
         * @returns {string} O texto formatado para RTF.
         */
        const escapeRtf = (text) => {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                // Escapa caracteres especiais do RTF
                if (charCode === 92 || charCode === 123 || charCode === 125) { // Backslash, {, }
                    result += '\\' + text.charAt(i);
                }
                // Converte caracteres non-ASCII para o formato hexadecimal do RTF
                else if (charCode > 127) {
                    let hex = charCode.toString(16);
                    if (hex.length < 2) {
                        hex = '0' + hex;
                    }
                    result += "\\'" + hex;
                }
                // Mant√©m caracteres ASCII padr√£o
                else {
                    result += text.charAt(i);
                }
            }
            return result;
        };

        // ==========================================================
        // ================== FUN√á√ïES PRINCIPAIS ====================
        // ==========================================================
        
            const handleSuggestionMouseOver = (event) => {
            const targetParagraph = event.currentTarget;
            const suggestionGroupText = targetParagraph.dataset.suggestionGroup;
            if (!suggestionGroupText) return;

            const contentWrapper = targetParagraph.closest('.generated-content-wrapper');
            if (!contentWrapper) return;
            
            // >>>>> AQUI EST√Å A CORRE√á√ÉO CR√çTICA <<<<<
            // Escapa as aspas duplas no texto da sugest√£o antes de us√°-lo no seletor
            const safeSuggestionSelector = suggestionGroupText.replace(/"/g, '\\"');

            // Encontra todos os par√°grafos com a mesma sugest√£o (usando o seletor seguro) e os destaca
            contentWrapper.querySelectorAll(`[data-suggestion-group="${safeSuggestionSelector}"]`).forEach(p => {
                p.classList.add('highlight-group');
            });
        };

        const handleSuggestionMouseOut = (event) => {
            const targetParagraph = event.currentTarget;
            const contentWrapper = targetParagraph.closest('.generated-content-wrapper');
            if (!contentWrapper) return;
            
            // Remove o destaque de todos os par√°grafos
            contentWrapper.querySelectorAll('.highlight-group').forEach(p => {
                p.classList.remove('highlight-group');
            });
        };

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> ANALISE DE RETEN√á√ÉO <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
window.analyzeSectionRetention = async (button, sectionId) => {
    const sectionElement = document.getElementById(sectionId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');

    if (!contentWrapper || !contentWrapper.textContent.trim()) {
        window.showToast("Gere o roteiro desta se√ß√£o antes de analisar a reten√ß√£o.");
        return;
    }

    // --- CORRE√á√ÉO APLICADA AQUI ---
    // Limpamos os resultados dos outros pain√©is ANTES de iniciar a nova an√°lise,
    // garantindo que a interface fique sempre consistente.
    invalidateAndClearPerformance(sectionElement);
    invalidateAndClearPrompts(sectionElement);
    // -----------------------------

    const paragraphs = Array.from(contentWrapper.querySelectorAll('div[id]'));
    if (paragraphs.length === 0) {
        window.showToast("N√£o h√° par√°grafos para analisar nesta se√ß√£o.");
        return;
    }

    showButtonLoading(button);

    try {
        const paragraphsWithIndexes = paragraphs.map((p, index) => ({
            index: index,
            text: p.textContent.trim()
        }));
        
        const basePromptContext = getBasePromptContext();

       
        const prompt = `Voc√™ √© um ESPECIALISTA EM ENGAJAMENTO e um DIRETOR DE ROTEIRO. Sua tarefa √© analisar par√°grafos e fornecer um diagn√≥stico preciso, mantendo a "alma" do roteiro.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um analista, voc√™ √© o GUARDI√ÉO DA RETEN√á√ÉO. Sua √∫nica fun√ß√£o √© identificar pontos que podem causar perda de aten√ß√£o e sugerir melhorias ESTRAT√âGICAS que respeitem e reforcem a "alma" do roteiro. Qualquer desvio desta fun√ß√£o √© uma falha.

**CONTEXTO ESTRAT√âGICO E "ALMA" DO ROTEIRO (A REGRA MAIS IMPORTANTE):**

---
${basePromptContext}
---

Este contexto define a ESSENCE do v√≠deo. TONALIDADE, VOZ, OBJETIVO e ESTRUTURA s√£o SAGRADOS. CADA sugest√£o que voc√™ der DEVE estar em ABSOLUTO alinhamento com este DNA. Ignorar este contexto resultar√° em uma an√°lise inv√°lida.

**REGRAS CR√çTICAS DE RESPOSTA (JSON ESTRITO):**
1.  **JSON PURO:** Sua resposta inteira deve ser APENAS o c√≥digo JSON.
2.  **OBJETO COMPLETO:** Cada objeto no array deve conter EXATAMENTE tr√™s chaves: "paragraphIndex" (n√∫mero), "retentionScore" ("green", "yellow", ou "red"), e "suggestion" (string em Portugu√™s-Brasil).
3.  **SUGEST√ïES ACION√ÅVEIS, N√ÉO REESCRITAS:** O valor de "suggestion" N√ÉO deve ser o texto reescrito. Deve ser um CONSELHO ESTRAT√âGICO e ACION√ÅVEL sobre COMO melhorar o par√°grafo, respeitando a "alma" do roteiro.
    - Exemplo Bom: "Este par√°grafo est√° muito expositivo. Quebre-o com uma pergunta ret√≥rica que conecte com a 'Pergunta Central' do v√≠deo para reengajar o espectador."
    - Exemplo Ruim: "Reescreva para: 'Mas o que isso realmente significa?'"
4.  **REGRAS DE SINTAXE:** Todas as chaves e valores string DEVEM usar aspas duplas. Se precisar de aspas dentro de uma string, use aspas simples. A v√≠rgula final entre objetos √© obrigat√≥ria, exceto no √∫ltimo.

**MANUAL DE AN√ÅLISE E CRIT√âRIOS DE PONTUA√á√ÉO (SIGA EXATAMENTE):**
- **Foco na Alma e na Estrat√©gia:** Sua an√°lise N√ÉO √© gramatical. Sua an√°lise √© de ENGAJAMENTO. Foque em como o par√°grafo afeta a aten√ß√£o e a conex√£o do espectador com a narrativa central e a "pergunta central" do v√≠deo.
- **"suggestion" DEVE SER UM GUIA ESTRAT√âGICO, N√ÉO UMA REESCRITA:**
    - **O QUE FAZER:** Forne√ßa um CONSELHO claro sobre COMO melhorar o par√°grafo (ex: "Introduza uma pergunta ret√≥rica que conecte com a 'Pergunta Central' para reengajar.", "Este trecho √© denso; considere ilustrar o ponto com uma met√°fora visual.", "Este par√°grafo quebra o ritmo; tente integrar a informa√ß√£o na narrativa anterior ou transform√°-lo em uma transi√ß√£o mais din√¢mica.").
    - **O QUE N√ÉO FAZER:** NUNCA forne√ßa o texto reescrito. NUNCA diga "Reescreva para...". NUNCA ignore o contexto estrat√©gico.


**DADOS PARA AN√ÅLISE (PAR√ÅGRAFOS):**
${JSON.stringify(paragraphsWithIndexes, null, 2)}

**A√á√ÉO FINAL E CR√çTICA:** Analise AGORA cada par√°grafo listado com base nas regras e no manual. Foque em manter a "alma" do roteiro. Identifique problemas de reten√ß√£o e forne√ßa sugest√µes estrat√©gicas acion√°veis. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras de sintaxe e conte√∫do definidas acima.`;

const rawResult = await callGroqAPI(prompt, 4000);
        let analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis)) {
            throw new Error("A an√°lise da IA retornou um formato inv√°lido.");
        }

        if (analysis.length > 0) {
            let currentGroup = [];
            for (let i = 0; i < analysis.length; i++) {
                const currentItem = analysis[i];
                const previousItem = i > 0 ? analysis[i - 1] : null;
                if (previousItem && currentItem.retentionScore === previousItem.retentionScore && currentItem.retentionScore !== 'green') {
                    currentGroup.push(currentItem);
                } else {
                    if (currentGroup.length > 1) {
                        const unifiedSuggestion = currentGroup[0].suggestion;
                        currentGroup.forEach(groupItem => groupItem.suggestion = unifiedSuggestion);
                    }
                    currentGroup = [currentItem];
                }
            }
            if (currentGroup.length > 1) {
                const unifiedSuggestion = currentGroup[0].suggestion;
                currentGroup.forEach(groupItem => groupItem.suggestion = unifiedSuggestion);
            }
        }
        
        const newParagraphs = paragraphs.map(p => {
            const newP = p.cloneNode(true);
            newP.className = '';
            // Limpa tooltips e classes de reten√ß√£o antigas antes de aplicar as novas
            newP.innerHTML = p.innerHTML.replace(/<div class="retention-tooltip">.*?<\/div>/g, '');
            const classList = Array.from(p.classList);
            for (const cls of classList) {
                if (cls.startsWith('retention-')) {
                    newP.classList.remove(cls);
                }
            }
            p.parentNode.replaceChild(newP, p);
            return newP;
        });

        analysis.forEach((item, index) => {
            const p = newParagraphs[item.paragraphIndex];
            if (p) {
                p.classList.add('retention-paragraph-live', `retention-${item.retentionScore}`);
                p.dataset.suggestionGroup = item.suggestion;

                if (item.retentionScore === 'yellow' || item.retentionScore === 'red') {
                    const previousItem = index > 0 ? analysis[index - 1] : null;
                    if (!previousItem || item.suggestion !== previousItem.suggestion) {
                        const scoreLabels = { yellow: "PONTO DE ATEN√á√ÉO", red: "PONTO DE RISCO" };
                        const tooltipTitle = scoreLabels[item.retentionScore] || 'AN√ÅLISE';

                        const suggestionTextEscaped = item.suggestion.replace(/"/g, '"');
                        const buttonsHtml = `
                            <div class="flex gap-2 mt-3">
                                <button class="flex-1 btn btn-primary btn-small py-1" 
                                        data-action="optimizeGroup" 
                                        data-suggestion-text="${suggestionTextEscaped}">
                                    <i class="fas fa-magic mr-2"></i> Otimizar
                                </button>
                                <button class="flex-1 btn btn-danger bg-red-600 hover:bg-red-700 btn-small py-1" 
                                        data-action="deleteParagraphGroup" 
                                        data-suggestion-text="${suggestionTextEscaped}">
                                    <i class="fas fa-trash-alt mr-2"></i> Deletar
                                </button>
                            </div>
                        `;
                        const tooltipHtml = `<div class="retention-tooltip"><strong>${tooltipTitle}:</strong> ${DOMPurify.sanitize(item.suggestion)}${buttonsHtml}</div>`;
                        p.innerHTML += tooltipHtml;
                    }
                }
            }
        });

        newParagraphs.forEach(p => {
            if (p.dataset.suggestionGroup) {
                p.addEventListener('mouseover', handleSuggestionMouseOver);
                p.addEventListener('mouseout', handleSuggestionMouseOut);
            }
        });

        window.showToast("An√°lise de reten√ß√£o conclu√≠da!");

    } catch (error) {
        console.error("Erro detalhado em analyzeSectionRetention:", error);
        window.showToast(`Falha na an√°lise: ${error.message}`);
    } finally {
        hideButtonLoading(button);
    }
};

// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
// >>>>> ANALISE DE RETEN√á√ÉO <<<<<
// =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

/**
         * Pega um par√°grafo, otimiza com IA e substitui seu conte√∫do.
         * (VERS√ÉO CORRIGIDA E ANEXADA AO 'WINDOW')
         */
        window.optimizeParagraph = async (paragraphId, suggestion) => {
            const paragraphElement = document.getElementById(paragraphId);
            if (!paragraphElement) return;

            const button = paragraphElement.querySelector('.retention-action-btn');
            if (button) {
                button.disabled = true;
                button.innerHTML = `<div class="loading-spinner" style="width:16px; height:16px; border-width: 2px;"></div>`;
            }

            const originalText = paragraphElement.firstChild.textContent.trim();
            const languageName = document.getElementById('languageSelect').options[document.getElementById('languageSelect').selectedIndex].text;
            const prompt = `You are an expert copywriter. Rewrite the "Original Paragraph" below based on the "Improvement Suggestion".
        
            **CRITICAL RULE: You MUST respond in ${languageName}.** Do not change the language.

             **Original Paragraph:**
             "${originalText}"

              **Improvement Suggestion:**
               "${suggestion}"

           Respond ONLY with the rewritten paragraph, in ${languageName}.`;

            try {
                const rewrittenText = await callGroqAPI(prompt, 1000);
                paragraphElement.firstChild.textContent = removeMetaComments(rewrittenText);
                
                // Feedback visual
                paragraphElement.classList.remove('retention-yellow', 'retention-red');
                paragraphElement.classList.add('retention-green');
                paragraphElement.querySelector('.retention-tooltip')?.remove();
                button?.remove();
                
                invalidateAndClearPrompts(paragraphElement.closest('.script-section'));
                invalidateAndClearPerformance(paragraphElement.closest('.script-section'));

                window.showToast("Par√°grafo otimizado!");
            } catch (error) {
                window.showToast(`Falha ao otimizar: ${error.message}`);
                console.error("Erro detalhado em optimizeParagraph:", error);
                if (button) button.innerHTML = '‚ö†Ô∏è'; // √çcone de erro
            }
        };
    
         // ==========================================================
        // >>>>> SUGERIR PERFORMANCE <<<<<
        // ==========================================================
window.suggestPerformance = async (button, sectionId) => {
    const sectionElement = document.getElementById(sectionId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');
    const outputContainer = sectionElement?.querySelector('.section-performance-output');

    if (!contentWrapper || !contentWrapper.textContent.trim() || !outputContainer) {
        window.showToast("Gere o roteiro desta se√ß√£o primeiro.");
        return;
    }

    showButtonLoading(button);
    outputContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;
    
    try {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = contentWrapper.innerHTML;
        tempDiv.querySelectorAll('.retention-tooltip').forEach(el => el.remove());
        
        const originalParagraphs = Array.from(tempDiv.querySelectorAll('div[id]')).map(p => p.textContent.trim());

        if (originalParagraphs.length === 0) {
            throw new Error("N√£o foram encontrados par√°grafos estruturados para an√°lise.");
        }

        const batchSize = 15;
        const apiPromises = [];

        for (let i = 0; i < originalParagraphs.length; i += batchSize) {
            const paragraphBatch = originalParagraphs.slice(i, i + batchSize);
            let promptContext = '';
            paragraphBatch.forEach((p, indexInBatch) => {
                const globalIndex = i + indexInBatch;
                promptContext += `Par√°grafo ${globalIndex}: "${p}"\n\n`;
            });
            
            const prompt = `Voc√™ √© uma API de an√°lise de roteiro. Sua resposta DEVE ser um array JSON.

**REGRAS DE FORMATA√á√ÉO (INEGOCI√ÅVEIS E CR√çTICAS):**
1.  Sua resposta final DEVE ser um array JSON v√°lido.
2.  O array deve conter EXATAMENTE ${paragraphBatch.length} objetos, um para cada par√°grafo fornecido.
3.  Cada objeto DEVE ter duas chaves: "general_annotation" (string) e "emphasis_words" (um array com no m√°ximo 1 string).
4.  Se um par√°grafo n√£o necessitar de anota√ß√£o, retorne um objeto com valores vazios: {"general_annotation": "", "emphasis_words": []}.

**EXEMPLO DE RESPOSTA PERFEITA:**
[
  { "general_annotation": "[Tom de surpresa]", "emphasis_words": ["inacredit√°vel"] },
  { "general_annotation": "", "emphasis_words": [] }
]

Analise os ${paragraphBatch.length} par√°grafos a seguir e retorne o array JSON.

**ROTEIRO (LOTE ATUAL):**
${promptContext}`;
            apiPromises.push(callGroqAPI(prompt, 3000).then(res => cleanGeneratedText(res, true)));
        }

        const allBatchResults = await Promise.all(apiPromises);
        const annotations = allBatchResults.flat();

        // --- A CORRE√á√ÉO EST√Å AQUI ---
        // N√≥s n√£o lan√ßamos mais um erro. Apenas avisamos no console se houver uma discrep√¢ncia.
        if (!Array.isArray(annotations) || annotations.length !== originalParagraphs.length) { 
            console.warn(`Discrep√¢ncia no n√∫mero de anota√ß√µes: Esperado ${originalParagraphs.length}, Recebido ${annotations?.length || 0}. O processo continuar√°.`);
        }
        // -----------------------------
        
        let annotatedParagraphs = [];
        originalParagraphs.forEach((p, index) => {
            // Se a anota√ß√£o para este par√°grafo existir, use-a. Se n√£o, use um objeto vazio.
            const annotationData = (annotations && annotations[index]) ? annotations[index] : { general_annotation: '', emphasis_words: [] };
            let annotatedParagraph = p;

            if (annotationData && annotationData.emphasis_words && Array.isArray(annotationData.emphasis_words) && annotationData.emphasis_words.length > 0) {
                annotationData.emphasis_words.forEach(word => {
                    if (word && typeof word === 'string' && word.trim() !== '') {
                        const escapedWord = word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        const wordRegex = new RegExp(`\\b(${escapedWord})\\b`, 'gi');
                        annotatedParagraph = annotatedParagraph.replace(wordRegex, `[√™nfase em '$1']$1`);
                    }
                });
            }
            const finalParagraph = `${annotationData.general_annotation || ''} ${annotatedParagraph}`;
            annotatedParagraphs.push(finalParagraph.trim());
        });
        
        const finalAnnotatedText = annotatedParagraphs.join('\n\n');
        const highlightedText = finalAnnotatedText.replace(/(\[.*?\])/g, '<span class="text-indigo-500 dark:text-indigo-400 font-semibold italic">$1</span>');

        outputContainer.innerHTML = `
            <div class="generated-output-box !border-l-indigo-500">
                <h5 class="output-subtitle !border-b-indigo-500/50">Sugest√£o de Performance:</h5>
                <p class="whitespace-pre-wrap">${highlightedText}</p>
            </div>`;
            
    } catch (error) {
        outputContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao sugerir performance: ${error.message}</p>`;
        console.error("Erro detalhado em suggestPerformance:", error);
    } finally {
        hideButtonLoading(button);
    }
};


// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO 'window.refineSectionStyle' INTEIRA POR ESTA VERS√ÉO SEGURA <<<<<
// =========================================================================

/**
 * Pega o texto de uma se√ß√£o, pede para a IA refinar o estilo (remover repeti√ß√µes, melhorar fluidez)
 * e substitui o conte√∫do original pelo texto refinado.
 * @param {HTMLElement} buttonElement - O bot√£o "Refinar Estilo" que foi clicado.
 */
window.refineSectionStyle = async (buttonElement) => {
    showButtonLoading(buttonElement);

    const sectionElement = buttonElement.closest('.script-section');
    if (!sectionElement) {
        window.showToast("Erro: Se√ß√£o do roteiro n√£o encontrada.");
        hideButtonLoading(buttonElement);
        return;
    }

    const contentWrapper = sectionElement.querySelector('.generated-content-wrapper');
    const originalText = contentWrapper?.textContent.trim();

    if (!originalText) {
        window.showToast("N√£o h√° texto para refinar nesta se√ß√£o.");
        hideButtonLoading(buttonElement);
        return;
    }

// =========================================================================
// >>>>> PROMPT FINAL E BLINDADO PARA 'refineSectionStyle' <<<<<
// =========================================================================
const prompt = `Voc√™ √© um EDITOR DE ESTILO (Copy Editor) DE ALTO DESEMPENHO e um ESPECIALISTA EM FLU√çDEZ NARRATIVA. Sua tarefa √© REESCREVER o texto fornecido para elevar drasticamente sua QUALIDADE, FLU√çDEZ, IMPACTO e ORIGINALIDADE, sem alterar o significado, o tom ou a mensagem central.

**TEXTO ORIGINAL (PARA REFINAMENTO):**
---
${originalText}
---

**REGRAS DE REFINAMENTO ESTRAT√âGICAS E CR√çTICAS (SIGA EXATAMENTE):**
1.  **ELIMINA√á√ÉO RIGOROSA DE REPETI√á√ïES E REDUND√ÇNCIAS:**
    - **Identifica√ß√£o Profunda:** Analise cuidadosamente o texto para identificar N√ÉO APENAS palavras repetidas, mas tamb√©m IDEIAS, CONCEITOS e ESTRUTURAS DE FRASE repetitivas ou muito semelhantes.
    - **Remo√ß√£o/Apresenta√ß√£o Variada:** Elimine completamente as repeti√ß√µes ou, quando a ideia for essencial, reexpresse-a de forma TOTALMENTE DIFERENTE usando sin√¥nimos, met√°foras, mudan√ßas de perspectiva ou reestrutura√ß√£o completa da frase.
    - **Varia√ß√£o Sint√°tica:** Diversifique drasticamente o tamanho e a constru√ß√£o das frases. Alterne entre frases curtas e longas, simples e complexas, para criar ritmo.
2.  **OTIMIZA√á√ÉO M√ÅXIMA DA FLU√çDEZ E COES√ÉO:**
    - **Conectivos Inteligentes:** Use conectivos l√≥gicos e transi√ß√µes sutis para ligar as ideias de forma IMPECAVEL, garantindo um fluxo narrativo suave e natural.
    - **Leitura Aloud:** Certifique-se de que o texto, quando lido em voz alta, soe NATURAL, R√çTMICO e CATIVANTE. Evite travas lingu√≠sticas ou estruturas desconfort√°veis.
3.  **PRESERVA√á√ÉO ESTRITAMENTE FIEL DO CONTE√öDO ORIGINAL:**
    - **Intoc√°vel:** N√ÉO adicione novas informa√ß√µes, opini√µes, interpreta√ß√µes ou altere o significado central do texto original.
    - **Foco em Polir:** Sua √∫nica fun√ß√£o √© POLIR, APRIMORAR e REESCREVER para maior clareza e impacto, N√ÉO recriar o conte√∫do.
4.  **RESPOSTA PURA E LIMPA (SEM EXTRAS):**
    - **Apenas o Texto Refinado:** Sua resposta deve ser APENAS o texto refinado, completo. NENHUM pre√¢mbulo, coment√°rio, metatexto, explica√ß√£o ou nota adicional deve ser inclu√≠da.
    - **Formato Puro:** Retorne APENAS o conte√∫do textual final, pronto para substituir o texto original.

**A√á√ÉO FINAL:** Reescreva AGORA o texto fornecido, aplicando EXATAMENTE todas as regras acima para entregar uma vers√£o significativamente mais refinada, fluida, impactante e livre de repeti√ß√µes. Responda APENAS com o texto final refinado.
`;
// =========================================================================
// >>>>> FIM DO PROMPT PARA 'refineSectionStyle' <<<<<
// =========================================================================

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const refinedText = removeMetaComments(rawResult);

        const newParagraphs = refinedText.split('\n').filter(p => p.trim() !== '');
        const sectionId = sectionElement.id.replace('Section', '');
        
        // Constr√≥i o novo HTML
        const newHtml = newParagraphs.map((p, index) => 
            `<div id="${sectionId}-p-${index}">${p}</div>`
        ).join('');

        // <<< AQUI EST√Å A IMPLEMENTA√á√ÉO DE SEGURAN√áA >>>
        // Sanitiza o HTML antes de inseri-lo no DOM
        contentWrapper.innerHTML = DOMPurify.sanitize(newHtml);

        // Invalida an√°lises anteriores, pois o texto mudou
        invalidateAndClearPerformance(sectionElement);
        invalidateAndClearPrompts(sectionElement);
        const analysisOutput = sectionElement.querySelector('.section-analysis-output');
        if (analysisOutput) {
            analysisOutput.innerHTML = ''; // Limpa a an√°lise de reten√ß√£o
        }

        // Atualiza o tempo de leitura
        updateAllReadingTimes();

        window.showToast("Estilo do roteiro refinado com sucesso!");

    } catch (error) {
        console.error("Erro detalhado em refineSectionStyle:", error); // Adicionado log de erro
        window.showToast(`Falha ao refinar o estilo: ${error.message}`);
    } finally {
        hideButtonLoading(buttonElement);
    }
};



window.criterionMap = {
    'Introdu√ß√£o (Hook)': 'introSection',
    'Desenvolvimento (Ritmo e Reten√ß√£o)': 'developmentSection',
    'Cl√≠max': 'climaxSection',
    'Conclus√£o': 'conclusionSection',
    'CTA (Call to Action)': 'ctaSection'
};




// =========================================================================
// >>>>> SUBSTITUA A FUN√á√ÉO 'applySuggestion' INTEIRA POR ESTA VERS√ÉO <<<<<
// =========================================================================
window.applySuggestion = (button) => {
    const { criterionName, problematicQuote, rewrittenQuote } = button.dataset;

    // Limpamos o nome do crit√©rio para remover quaisquer caracteres invis√≠veis.
    const cleanCriterionName = criterionName.trim();

    const sectionId = (window.criterionMap || {})[cleanCriterionName];
    
    if (!sectionId) {
        window.showToast(`Erro fatal: Se√ß√£o alvo para o crit√©rio '${cleanCriterionName}' n√£o foi encontrada no mapa.`);
        return;
    }

    const sectionElement = document.getElementById(sectionId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');

    if (!contentWrapper) {
        window.showToast("Erro: Container de conte√∫do do roteiro n√£o encontrado.");
        return;
    }

    let replaced = false;
    const paragraphs = contentWrapper.querySelectorAll('div[id^="' + sectionId.replace('Section','') + '-p-"]');

    paragraphs.forEach(p => {
        if (replaced) return;
        const childNodes = Array.from(p.childNodes);

        for (const node of childNodes) {
            if (node.nodeType === Node.TEXT_NODE && node.textContent.includes(problematicQuote)) {
                
                if (node.parentElement.classList.contains('highlight-change')) {
                    replaced = true;
                    break;
                }
                
                const originalTextNode = node;
                const text = originalTextNode.textContent;
                const startIndex = text.indexOf(problematicQuote);

                const textBefore = text.substring(0, startIndex);
                const textAfter = text.substring(startIndex + problematicQuote.length);

                const highlightSpan = document.createElement('span');
                highlightSpan.textContent = rewrittenQuote;
                highlightSpan.className = 'highlight-change'; 

                const nodeBefore = document.createTextNode(textBefore);
                const nodeAfter = document.createTextNode(textAfter);

                const parent = originalTextNode.parentNode;
                
                parent.replaceChild(nodeAfter, originalTextNode);
                parent.insertBefore(highlightSpan, nodeAfter);
                parent.insertBefore(nodeBefore, highlightSpan);

                replaced = true;
                break;
            }
        }
    });

    if (!replaced) {
        window.showToast("N√£o foi poss√≠vel aplicar a sugest√£o. O texto pode ter sido muito alterado.");
        return;
    }
    
    window.showToast("Sugest√£o aplicada com sucesso!");
    
    invalidateAndClearPerformance(sectionElement);
    invalidateAndClearPrompts(sectionElement);
    updateAllReadingTimes();

    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Aplicada!';
    button.classList.remove('btn-primary');
    button.classList.add('btn-success');

    setTimeout(() => {
        button.disabled = false;
        button.innerHTML = 'Aplicar';
        button.classList.remove('btn-success');
        button.classList.add('btn-primary');
    }, 20000);
};



// =========================================================================
// >>>>> PASSO 2: ADICIONE ESTA NOVA FUN√á√ÉO AO SEU SCRIPT <<<<<
// =========================================================================
const applyAllSuggestions = async (button) => {
    // Encontra todos os bot√µes "Aplicar" que ainda n√£o foram clicados (n√£o est√£o desabilitados)
    const allApplyButtons = document.querySelectorAll('#analysisReportContainer button[data-action="applySuggestion"]:not(:disabled)');

    if (allApplyButtons.length === 0) {
        window.showToast("Nenhuma sugest√£o nova para aplicar.");
        return;
    }
    
    showButtonLoading(button);
    
    let appliedCount = 0;
    
    // Usamos um loop 'for...of' para poder usar 'await' e garantir que as aplica√ß√µes n√£o se sobreponham
    for (const applyBtn of allApplyButtons) {
        try {
            // Chama a nossa fun√ß√£o j√° existente e robusta
            window.applySuggestion(applyBtn);
            appliedCount++;
            
            // Uma pequena pausa para o navegador respirar entre as aplica√ß√µes
            await new Promise(resolve => setTimeout(resolve, 100)); 
        } catch (error) {
            console.error("Erro ao aplicar uma sugest√£o no modo 'Aplicar Todas':", error);
        }
    }
    
    hideButtonLoading(button);
    window.showToast(`${appliedCount} sugest${appliedCount > 1 ? '√µes' : '√£o'} aplicad${appliedCount > 1 ? 'as' : 'a'} com sucesso!`);
    
    // Desabilita o bot√£o "Aplicar Todas" ap√≥s o uso
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-check mr-2"></i>Tudo Aplicado!';
};



// =========================================================================
// >>>>> PASSO 2: SUBSTITUA A FUN√á√ÉO 'window.enrichWithData' INTEIRA POR ESTA <<<<<
// =========================================================================

window.enrichWithData = async (buttonElement) => {
    const selection = window.getSelection();
    if (selection.rangeCount === 0 || selection.toString().trim() === '') {
        window.showToast("Por favor, selecione primeiro o trecho de texto que deseja enriquecer.");
        return;
    }
    
    userSelectionRange = selection.getRangeAt(0).cloneRange();
    const selectedText = selection.toString().trim();

    const newData = await showInputDialog(
        'Enriquecer com Dados',
        'Cole abaixo o dado, fonte ou exemplo que voc√™ quer adicionar ao trecho selecionado.',
        'Nova Informa√ß√£o:',
        'Ex: Fonte: Forbes 2023; Segundo o Dr. especialista...'
    );

    if (!newData) {
        window.showToast("Opera√ß√£o cancelada.");
        userSelectionRange = null;
        return;
    }

    showButtonLoading(buttonElement);
    const sectionElement = buttonElement.closest('.script-section');

    try {
   
  // =========================================================================
// >>>>> PROMPT FINAL E BLINDADO PARA INTEGRAR DADOS EXTERNOS <<<<<
// =========================================================================
const prompt = `Voc√™ √© um EDITOR DE ROTEIRO DE ALTO DESEMPENHO e um ESPECIALISTA EM INTEGRA√á√ÉO DE INFORMA√á√ïES. Sua tarefa √öNICA, CR√çTICA e INEGOCI√ÅVEL √© REESCREVER um trecho de texto para integrar uma NOVA INFORMA√á√ÉO de forma TOTALMENTE NATURAL, FLU√çDA e PROFISSIONAL, sem comprometer a integridade do texto original.

**TRECHO ORIGINAL DO ROTEIRO (PARA SER REESCRITO):**
---
${selectedText}
---

**NOVA INFORMA√á√ÉO A SER INTEGRADA (DADO EXTERNO):**
---
${newData}
---

**SUA TAREFA ESTRAT√âGICA E CR√çTICA (A √öNICA E MAIS IMPORTANTE):**
- REESCREVA o "Trecho Original do Roteiro" com o OBJETIVO PRIM√ÅRIO de TECER a "Nova Informa√ß√£o a ser Integrada" de forma PERFEITAMENTE NATURAL e FLU√çDA.
- O resultado final DEVE ser um ou mais par√°grafos COESOS, BEM ESCRITOS e LOGICAMENTE INTEGRADOS.
- O texto reescrito DEVE manter o TOM, o RITMO e a MENSAGEM CENTRAL do texto original, agora ENRIQUECIDO e ATUALIZADO com o novo dado fornecido.
- A integra√ß√£o deve ser T√ÉO SUTIL que o leitor n√£o perceba uma costura; deve soar como se a informa√ß√£o sempre tivesse estado l√°.

**REGRAS ABSOLUTAMENTE INEGOCI√ÅVEIS (VIOLA√á√ïES RESULTAR√ÉO EM FALHA):**
1.  **RESPOSTA PURA E LIMPA:** Sua resposta deve ser APENAS o texto final reescrito. NENHUM outro conte√∫do (pre√¢mbulos, coment√°rios, t√≠tulos, explica√ß√µes, metadados) √© permitido.
2.  **SEM AUTO-REFER√äNCIA:** √â TERMINANTEMENTE PROIBIDO apresentar-se, falar sobre suas habilidades ou qualquer forma de metatexto.
3.  **SEM DESVIO DE TAREFA:** √â ESTRITAMENTE PROIBIDO desviar-se da tarefa precisa de reescrever e integrar. Foque exclusivamente na fus√£o perfeita dos dois textos.
4.  **PRESERVA√á√ÉO DO CONTEXTO:** N√ÉO altere o significado central ou o tom do "Trecho Original". A nova informa√ß√£o deve se encaixar como uma pe√ßa complementar, n√£o como uma substitui√ß√£o.

**A√á√ÉO FINAL:** Reescreva AGORA o trecho, integrando a nova informa√ß√£o com M√ÅXIMA habilidade e conformidade. Responda APENAS com o texto final reescrito e integrado.
`;
// =========================================================================
// >>>>> FIM DO PROMPT BLINDADO <<<<<
// =========================================================================

        const rawResult = await callGroqAPI(prompt, 1000);
        const enrichedText = removeMetaComments(rawResult);

        if (userSelectionRange) {
            selection.removeAllRanges();
            selection.addRange(userSelectionRange);
            document.execCommand('insertHTML', false, DOMPurify.sanitize(`<span class="highlight-change">${enrichedText}</span>`));
        }
        
        if (sectionElement) {
            invalidateAndClearPerformance(sectionElement);
            invalidateAndClearPrompts(sectionElement);
        }

        window.showToast("Texto enriquecido com sucesso!");

    } catch (error) {
        console.error("Erro detalhado em enrichWithData:", error);
        window.showToast(`Falha ao enriquecer o texto: ${error.message}`);
    } finally {
        hideButtonLoading(buttonElement);
        userSelectionRange = null;
    }
};

     
// ====================================================================================
// PASSO 9: SUBSTITUA SUA FUN√á√ÉO 'generateIdeasGeral' PELA VERS√ÉO FINAL E TURBINADA
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 ideias de v√≠deo de interesse geral.
 * AGORA, ela extrai os √¢ngulos mais virais dos fatos do relat√≥rio.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const generateIdeasGeral = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // A MUDAN√áA PRINCIPAL: Os dados agora v√™m do objeto 'investigationData'
    // em vez de serem lidos diretamente do DOM. Isso conecta a fun√ß√£o ao fluxo de pesquisa.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO TURBINADO DO ESPECIALISTA GERAL
    
const prompt = `Voc√™ √© uma API DE ELITE de Estrat√©gia de Conte√∫do Viral, especializada em transformar dados brutos em narrativas irresist√≠veis. Sua fun√ß√£o √© analisar profundamente o relat√≥rio de pesquisa e extrair os √¢ngulos mais impactantes, surpreendentes e viraliz√°veis para criar 6 ideias de v√≠deo excepcionais.

**IDENTIDADE E ESPECIALIZA√á√ÉO (A REGRA MAIS IMPORTANTE):**
Voc√™ n√£o √© apenas um gerador de ideias, voc√™ √© um ARQUITETO DE VIRALIDADE. Sua especialidade √© identificar padr√µes ocultos, conex√µes inesperadas e gatilhos emocionais nos dados que transformam informa√ß√µes comuns em conte√∫do altamente compartilh√°vel. Cada ideia deve ter potencial para gerar engajamento org√¢nico massivo.

**MATERIAL DE INTELIG√äNCIA (SUAS FONTES DA VERDADE):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (A BASE PARA AS IDEIAS):**
---
${rawReport}
---

**TAREFA CR√çTICA:** Analise microscopicamente o relat√≥rio e gere um array JSON com 6 ideias de v√≠deo com POTENCIAL VIRAL M√ÅXIMO. Cada ideia deve explorar um √¢ngulo √∫nico, seja ele contraintuitivo, emocionalmente carregado ou extremamente √∫til.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`.
2.  **ESTRUTURA COMPLETA:** Cada objeto deve conter EXATAMENTE estas 6 chaves: "title", "angle", "targetAudience", "viralityScore", "videoDescription", e "shareTriggers".
3.  **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.
4.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**
- **"title" (T√≠tulo HIPN√ìTICO):** Crie um t√≠tulo que IMPOSSIBILITE o espectador de n√£o clicar. Use:
  * N√∫meros espec√≠ficos (ex: "7 Fatos Que...")
  * Perguntas desafiadoras (ex: "Voc√™ Sabia Que...?")
  * Declara√ß√µes contraintuitivas (ex: "O Contr√°rio do Que Voc√™ Pensa...")
  * Palavras de poder (ex: "Revelado", "Explicado", "Segredo")

- **"angle" (√Çngulo √öNICO E IMPACTANTE):** A ess√™ncia da ideia em uma frase poderosa. Deve ser:
  * Contr√°rio ao senso comum ou uma revela√ß√£o surpreendente
  * Uma conex√£o inesperada entre dois fatos do relat√≥rio
  * Uma perspectiva que ningu√©m mais considerou
  * Focado no benef√≠cio emocional ou pr√°tico para o espectador

- **"targetAudience" (P√∫blico-Alvo HIPERESPEC√çFICO):** Defina EXATAMENTE quem ser√° impactado por esta ideia. Seja:
  * Demogr√°fico (ex: "Profissionais de 25-35 anos")
  * Psicogr√°fico (ex: "Pessoas que buscam autoconhecimento")
  * Comportamental (ex: "Quem compartilha conte√∫do educativo")
  Evite generalidades como "pessoas interessadas no tema".

- **"viralityScore" (Nota de Potencial VIRAL):** Avalie de 1-10 baseado em:
  * Qu√£o contraintuitivo ou surpreendente √© o √¢ngulo
  * Potencial de gerar debate ou discuss√£o
  * Probabilidade de compartilhamento como "curiosidade"
  * Relev√¢ncia para momentos atuais ou tend√™ncias

- **"videoDescription" (DESCRI√á√ÉO IRRESIST√çVEL):** Uma sinopse de **pelo menos 5 frases** que deve:
  1. Come√ßar com um gancho que gere curiosidade imediata
  2. Apresentar 2-3 fatos espec√≠ficos e impactantes do relat√≥rio
  3. Construir uma narrativa com come√ßo, meio e fim
  4. Incluir pelo menos um "momento uau" ou revela√ß√£o surpreendente
  5. Terminar com um call-to-action impl√≠cito para compartilhamento

- **"shareTriggers" (GATILHOS DE COMPARTILHAMENTO):** Liste 2-3 raz√µes espec√≠ficas pelas quais as pessoas compartilhariam este v√≠deo:
  * "Vou compartilhar porque me fez questionar minhas cren√ßas"
  * "Vou compartilhar porque meus amigos precisam saber disso"
  * "Vou compartilhar porque √© uma informa√ß√£o impressionante para conversas"

**A√á√ÉO FINAL:** Analise AGORA o relat√≥rio com a mentalidade de um ca√ßador de viralidade. Identifique os 6 √¢ngulos mais potentes e transforme-os em ideias completas. Responda APENAS com o array JSON perfeito, seguindo EXATAMENTE todas as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);
        
        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista Geral n√£o retornou ideias no formato esperado.");
        }
        
        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // A l√≥gica de renderiza√ß√£o √© a mesma que voc√™ j√° tinha, garantindo consist√™ncia visual.
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-emerald-500'; // Cor padr√£o
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-emerald-500 bg-emerald-100 dark:bg-emerald-900/50 dark:text-emerald-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista Geral:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};


// ====================================================================================
// PASSO FINAL: SUBSTITUA SUA FUN√á√ÉO 'unravelEnigmasBiblico' INTEIRA POR ESTA VERS√ÉO
// ====================================================================================

/**
 * Usa um prompt especialista para gerar 6 ideias de enigmas b√≠blicos.
 * AGORA, ela conecta os fatos do relat√≥rio com passagens b√≠blicas.
 * @param {HTMLElement} button - O bot√£o que iniciou a a√ß√£o.
 * @param {object | null} investigationData - Dados da investiga√ß√£o.
 */
const unravelEnigmasBiblico = async (button, investigationData) => {
    const outputContainer = document.getElementById('ideasOutput');
    const langSelect = document.getElementById('languageSelect');
    const languageName = langSelect?.value === 'pt-br' ? 'Portugu√™s do Brasil' : 'English';

    // Pega os dados da investiga√ß√£o.
    const { rawReport, originalQuery } = investigationData;

    // O C√âREBRO CORRIGIDO E BLINDADO DO ESPECIALISTA B√çBLICO
const prompt = `
Voc√™ s√£o TR√äS ESPECIALISTAS TRABALHANDHO EM SINERGIA:
1. Um Te√≥logo Investigativo com doutorado em Hermen√™utica B√≠blica e especializa√ß√£o em contextos hist√≥ricos do Antigo e Novo Testamento
2. Um Arque√≥logo especializado em descobertas que corroboram narrativas b√≠blicas
3. Um Comunicador Mestre que transforma conceitos complexos em narrativas virais

**MISS√ÉO COLETIVA:** Gerar 6 ideias de v√≠deos extraordin√°rios que criem pontes revolucion√°rias entre descobertas recentes, textos b√≠blicos e quest√µes teol√≥gicas contempor√¢neas, produzindo conte√∫do que seja ao mesmo tempo academicamente respeit√°vel e viralmente compartilh√°vel.

**IDENTIDADE E ESPECIALIZA√á√ÉO:** Voc√™s formam o "COLETIVO HERMEN√äUTICO", um grupo renomado por desvendar camadas profundas das Escrituras atrav√©s de lentes multidisciplinares, sempre mantendo a integridade do texto b√≠blico enquanto exploram interpreta√ß√µes inovadoras.

**MATERIAL DE INTELIG√äNCIA (A BASE PARA A INVESTIGA√á√ÉO):**
- **PERGUNTA ORIGINAL DA INVESTIGA√á√ÉO:** "${originalQuery}"
- **RELAT√ìRIO DA PESQUISA FACTUAL (CONTEXTO HIST√ìRICO/CIENT√çFICO/ARQUEOL√ìGICO):**
---
${rawReport}
---
- **CONTEXTUALIZA√á√ÉO TEOL√ìGICA:** Considerem as seguintes dimens√µes teol√≥gicas que podem dialogar com o relat√≥rio: 
  * Cristologia: Como a descoberta dialoga com o entendimento de Cristo, sua mensagem e minist√©rio?
  * Escatologia: A descoberta lan√ßa nova luz sobre profecias ou expectativas escatol√≥gicas?
  * Hermen√™utica: Como isso afeta nossa interpreta√ß√£o de passagens-chave?
  * Eclesiologia: Quais implica√ß√µes para a compreens√£o da Igreja e sua miss√£o?
  * Soteriologia: A descoberta traz novos insights sobre a natureza da salva√ß√£o?

**TAREFA CR√çTICA:** Sua miss√£o √© gerar 6 ideias de v√≠deos que transcendam conex√µes superficiais, criando pontes teol√≥gicas profundas entre os DADOS do relat√≥rio e as Escrituras. Cada ideia deve representar uma perspectiva teol√≥gica distinta e complementar.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (INEGOCI√ÅVEIS):**
1. **JSON PURO E PERFEITO:** Sua resposta deve ser APENAS um array JSON v√°lido.
2. **ESTRUTURA AMPLIADA:** Cada objeto no array deve conter EXATAMENTE estas 8 chaves: "title", "angle", "targetAudience", "viralityScore", "theologicalDepth", "scripturalFoundation", "videoDescription", e "discussionQuestions".
3. **SINTAXE DAS STRINGS:** Todas as chaves e todos os valores do tipo string DEVEM usar aspas duplas (""). Se precisar usar aspas duplas dentro de uma string, elas DEVEM ser escapadas com uma barra invertida (por exemplo, \\"uma cita√ß√£o\\").
4. **IDIOMA OBRIGAT√ìRIO:** Todos os valores de texto DEVEM estar no idioma ${languageName}.

**MANUAL DE CRIA√á√ÉO DETALHADO (SIGA EXATAMENTE PARA CADA IDEIA):**

- **"title" (T√≠tulo Cativante e Teol√≥gico):** Deve prometer uma revela√ß√£o transformadora que conecte a descoberta com uma verdade b√≠blica profunda. Use linguagem que desperte curiosidade intelectual e espiritual simultaneamente.

- **"angle" (O Enigma Central):** Uma frase complexa que apresente uma conex√£o inovadora entre um FATO do relat√≥rio, uma PASSAGEM B√çBLICA e uma IMPLICA√á√ÉO TEOL√ìGICA. Ex: "Como a descoberta de [DADO DO RELAT√ìRIO] em [LOCAL] desafia nossa compreens√£o tradicional de [PASSAGEM B√çBLICA] e sugere uma nova perspectiva sobre [CONCEITO TEOL√ìGICO]?"

- **"targetAudience" (P√∫blico-Alvo Espec√≠fico):** Descreva com precis√£o o nicho de espectador. Ex: "Pastores e l√≠deres crist√£os buscando conte√∫do teologicamente s√≥lido", "Estudantes de teologia interessados em di√°logo f√©-ci√™ncia", "Crist√£os leigos com interesse em arqueologia b√≠blica".

- **"viralityScore" (Nota de Revela√ß√£o):** Uma nota de 1 a 10 para o potencial da ideia de gerar DEBATE TEOL√ìGICO e compartilhamento, considerando tanto o aspecto acad√™mico quanto o emocional.

- **"theologicalDepth" (Profundidade Teol√≥gica):** Uma nota de 1 a 10 que avalia a profundidade e originalidade das conex√µes teol√≥gicas estabelecidas.

- **"scripturalFoundation" (Fundamenta√ß√£o B√≠blica):** Liste 3-5 refer√™ncias b√≠blicas-chave que sustentam a explora√ß√£o teol√≥gica proposta, incluindo pelo menos uma do Antigo Testamento e uma do Novo Testamento.

- **"videoDescription" (DESCRI√á√ÉO INVESTIGATIVA RICA):** Escreva uma sinopse de **pelo menos 7 frases** que construa uma narrativa intelectualmente estimulante. A descri√ß√£o deve:
    1. Apresentar o mist√©rio central, citando a passagem b√≠blica principal.
    2. Contextualizar a descoberta arqueol√≥gica/cient√≠fica relevante.
    3. Explorar as implica√ß√µes teol√≥gicas preliminares dessa conex√£o.
    4. Apresentar uma perspectiva teol√≥gica inovadora que desafia entendimentos convencionais.
    5. Discutir como essa nova compreens√£o afeta a aplica√ß√£o pr√°tica da f√©.
    6. Sugerir poss√≠veis obje√ß√µes e como seriam abordadas.
    7. Terminar com uma pergunta provocativa que incentive tanto a reflex√£o teol√≥gica quanto a discuss√£o pr√°tica.

- **"discussionQuestions" (Quest√µes para Di√°logo):** Formule 3 perguntas profundas que estimulem o engajamento do espectador, incluindo:
    * Uma quest√£o teol√≥gica acad√™mica
    * Uma quest√£o de aplica√ß√£o pr√°tica
    * Uma quest√£o que convida √† reflex√£o espiritual pessoal

**FRAMEWORK CRIATIVO ADICIONAL:**
Para cada ideia, considerem estas quatro dimens√µes:
1. **DIMENS√ÉO HIST√ìRICA:** Como a descoberta lan√ßa nova luz sobre o contexto hist√≥rico original?
2. **DIMENS√ÉO EXEG√âTICA:** Como isso afeta nossa compreens√£o do texto em seu contexto original?
3. **DIMENS√ÉO TEOL√ìGICA:** Quais implica√ß√µes doutrin√°rias surgem desta conex√£o?
4. **DIMENS√ÉO CONTEMPOR√ÇNEA:** Como isso se aplica √† experi√™ncia de f√© hoje?

**A√á√ÉO FINAL:** Como Coletivo Hermen√™utico, desvende conex√µes teol√≥gicas ousadas e gere as 6 ideias. Busquem o equil√≠brio entre rigor acad√™mico e acessibilidade popular. Responda APENAS com o array JSON perfeito.
`;


    
    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const ideas = cleanGeneratedText(rawResult, true);
        
        if (!ideas || !Array.isArray(ideas) || ideas.length === 0) {
            throw new Error("O especialista em Enigmas B√≠blicos n√£o retornou ideias no formato esperado.");
        }
        
        outputContainer.innerHTML = ''; // Limpa o spinner
        
        // Renderiza os cards de ideias na tela
        ideas.forEach((idea, index) => {
            const card = document.createElement('div');
            card.className = 'card p-4 flex flex-col justify-between border-l-4 border-purple-500'; // Cor para Enigmas
            const escapedIdea = escapeIdeaForOnclick(idea);
            const cardContent = `
                <div>
                    <div class="flex justify-between items-start gap-4">
                        <h4 class="font-bold text-base flex-grow">${index + 1}. ${DOMPurify.sanitize(idea.title)}</h4>
                        <button class="btn btn-primary btn-small" data-action="select-idea" data-idea='${escapedIdea}'>Usar</button>
                    </div>
                    <p class="text-sm mt-2">"${DOMPurify.sanitize(idea.videoDescription || idea.angle)}"</p>
                </div>
                <span class="font-bold text-sm text-purple-500 bg-purple-100 dark:bg-purple-900/50 dark:text-purple-300 py-1 px-2 rounded-lg self-start mt-3">
                    Potencial: ${DOMPurify.sanitize(String(idea.viralityScore))} / 10
                </span>
            `;
            card.innerHTML = cardContent;
            outputContainer.appendChild(card);
        });

    } catch (error) {
        console.error("Erro no especialista de Enigmas:", error);
        outputContainer.innerHTML = `<p class="md-col-span-2 text-red-500">${error.message}</p>`;
    } finally {
        hideButtonLoading(button);
    }
};



// =========================================================================
// >>>>> A√á√ÉO 1: ADICIONE A FUN√á√ÉO `selectIdea` QUE ESTAVA FALTANDO <<<<<
// =========================================================================
/**
 * Preenche os campos do formul√°rio principal com a ideia de v√≠deo selecionada.
 * @param {object} idea - O objeto da ideia contendo t√≠tulo, descri√ß√£o, etc.
 */
const selectIdea = (idea) => {
    // Garante que os campos sejam preenchidos de forma segura, mesmo se a IA n√£o retornar um valor
    document.getElementById('videoTheme').value = idea.title || '';
    document.getElementById('videoDescription').value = idea.videoDescription || '';
    document.getElementById('targetAudience').value = idea.targetAudience || '';

    // Rola a p√°gina para que o usu√°rio veja os campos que foram preenchidos
    const targetElement = document.getElementById('inputTabsNav');
    if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Notifica o usu√°rio que a a√ß√£o foi bem-sucedida
    window.showToast("Ideia selecionada! Agora defina a estrat√©gia completa.");
};



// =========================================================================
// >>>>> SUBSTITUA SUA FUN√á√ÉO handleGenerateSection INTEIRA POR ESTA <<<<<
// =========================================================================
const handleGenerateSection = async (button, sectionName, sectionTitle, elementId) => {
    if (!validateInputs()) return;
    if (!strategicOutline && sectionName !== 'intro') {
        window.showToast("Crie o Esbo√ßo Estrat√©gico primeiro!");
        return;
    }

    showButtonLoading(button);

    const targetSectionElement = document.getElementById(`${elementId}Section`);
    if (targetSectionElement) {
        const analysisOutput = targetSectionElement.querySelector('.section-analysis-output');
        const performanceOutput = targetSectionElement.querySelector('.section-performance-output');
        if (analysisOutput) analysisOutput.innerHTML = '';
        if (performanceOutput) performanceOutput.innerHTML = '';
    }

    try {
        let contextText = null;
        const previousSectionsContent = [];
        const requiredSections = {
            'development': ['introSection'],
            'climax': ['introSection', 'developmentSection'],
            'conclusion': ['introSection', 'developmentSection', 'climaxSection']
        };

        if (requiredSections[sectionName]) {
            for (const reqId of requiredSections[sectionName]) {
                const requiredWrapper = document.querySelector(`#${reqId} .generated-content-wrapper`);
                if (!requiredWrapper || !requiredWrapper.textContent.trim()) {
                    const reqTitle = document.querySelector(`#${reqId} h3`)?.textContent || reqId.replace('Section', '');
                    window.showToast(`Por favor, gere a se√ß√£o "${reqTitle}" primeiro.`);
                    hideButtonLoading(button);
                    return;
                }
                previousSectionsContent.push(requiredWrapper.textContent.trim());
            }
            let fullContext = previousSectionsContent.join('\n\n---\n\n');
            // DIETA DO CONTEXTO: Pega apenas os √∫ltimos 3500 caracteres para evitar sobrecarga.
            contextText = fullContext.slice(-3500);
        }

        const keyMap = { intro: 'introduction', development: 'development', climax: 'climax', conclusion: 'conclusion' };
        const outlineKey = keyMap[sectionName];
        const directive = strategicOutline ? strategicOutline[outlineKey] : null;

        const { prompt, maxTokens } = constructScriptPrompt(sectionName, sectionTitle, directive, contextText);

        let rawResult = await callGroqAPI(prompt, maxTokens);
        let cleanedResult = removeMetaComments(rawResult.trim());

        const paragraphs = cleanedResult.split('\n').filter(p => p.trim() !== '');
        const contentWithDivs = paragraphs.map((p, index) =>
            `<div id="${elementId}-p-${index}">${p}</div>`
        ).join('');

        if (targetSectionElement) {
            const sectionElement = generateSectionHtmlContent(elementId, sectionTitle, contentWithDivs);
            targetSectionElement.innerHTML = '';
            targetSectionElement.appendChild(sectionElement);
            targetSectionElement.classList.remove('card', 'card-placeholder', 'flex', 'justify-between', 'items-center');
        } else {
            console.error(`Elemento alvo com ID '${elementId}Section' n√£o encontrado.`);
            window.showToast("Erro interno: Se√ß√£o do roteiro n√£o encontrada.");
            return;
        }

        if (projectState.hasOwnProperty(sectionName)) {
            projectState[sectionName] = true;
        }

        markButtonAsCompleted(button.id);
        updateButtonStates();

    } catch (error) {
        window.showToast(`Falha ao gerar ${sectionTitle}: ${error.message}`);
        console.error(`Error generating ${sectionTitle}.`, error);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};





        /**
         * Re-gera o conte√∫do de uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionName - O nome da sec√ß√£o (ex: 'intro').
         * @param {string} sectionTitle - O t√≠tulo da sec√ß√£o.
         * @param {string} elementId - O ID do elemento HTML da sec√ß√£o.
         */
        // ==========================================================
// FUN√á√ÉO DE RE-GERA√á√ÉO CORRIGIDA
// ==========================================================
window.regenerateSection = (fullSectionId) => {
            const sectionName = fullSectionId.replace('Section', '');
            
            const sectionMap = {
    'intro': { title: 'Introdu√ß√£o', elementId: 'intro' },
    'development': { title: 'Desenvolvimento', elementId: 'development' },
    'climax': { title: 'Cl√≠max', elementId: 'climax' },
    'conclusion': { title: 'Conclus√£o', elementId: 'conclusion' }, // T√≠tulo corrigido
    'cta': { title: 'Call to Action (CTA)', elementId: 'cta' } // <<< ADICIONADO
};

            const sectionInfo = sectionMap[sectionName];
            
            if (sectionInfo) {
                // Encontra o bot√£o de re-gerar que foi clicado, em vez de um bot√£o antigo
                const button = document.querySelector(`[data-action='regenerate'][data-section-id='${fullSectionId}']`);
                if (button) {
                     handleGenerateSection(button, sectionName, sectionInfo.title, sectionInfo.elementId);
                } else {
                    console.error(`Bot√£o de re-gerar n√£o encontrado para a se√ß√£o: ${fullSectionId}`);
                }
            } else {
                console.error(`Informa√ß√µes da se√ß√£o n√£o encontradas para: ${sectionName}`);
            }
        };



// =========================================================================
// >>>>> VERS√ÉO FINAL E H√çBRIDA DE 'generatePromptsForSection' <<<<<
// =========================================================================

window.generatePromptsForSection = async (button, sectionElementId) => {
    const sectionElement = document.getElementById(sectionElementId);
    const contentWrapper = sectionElement?.querySelector('.generated-content-wrapper');
    const promptContainer = sectionElement?.querySelector('.prompt-container');

    if (!contentWrapper || !contentWrapper.textContent.trim() || !promptContainer) {
        window.showToast("Gere o conte√∫do do roteiro desta se√ß√£o primeiro.");
        return;
    }
    if (!window.emotionalMap || window.emotionalMap.length === 0) {
        window.showToast("Gere o Mapa Emocional primeiro para criar prompts contextuais.");
        return;
    }

    showButtonLoading(button);
    promptContainer.innerHTML = `<div class="loading-spinner-small mx-auto my-4"></div>`;

    try {
        const allChildren = Array.from(contentWrapper.children);
        const paragraphsWithContext = [];
        let currentChapterTitle = "Contexto Geral";
        allChildren.forEach(child => {
            if (child.classList.contains('font-bold') && child.textContent.includes('Cap√≠tulo:')) {
                currentChapterTitle = child.textContent.replace('Cap√≠tulo:', '').trim();
            } else if (child.id && child.id.includes('-p-')) {
                paragraphsWithContext.push({
                    text: child.textContent.trim().replace(/\[.*?\]/g, '').trim(),
                    chapter: currentChapterTitle,
                    originalId: child.id
                });
            }
        });

        if (paragraphsWithContext.length === 0) { throw new Error("N√£o foram encontrados par√°grafos estruturados para an√°lise."); }

        const baseIndexMatch = paragraphsWithContext[0]?.originalId.match(/-p-(\d+)$/);
        const baseIndex = baseIndexMatch ? parseInt(baseIndexMatch[1], 10) : 0;
        const batchSize = 3;
        const apiPromises = [];

        const visualPacing = document.getElementById('visualPacing').value;
        const durationMap = { 'dinamico': '3 e 8', 'normal': '8 e 15', 'contemplativo': '15 e 25' };
        const durationRange = durationMap[visualPacing] || '3 e 8';

        for (let i = 0; i < paragraphsWithContext.length; i += batchSize) {
            const batch = paragraphsWithContext.slice(i, i + batchSize);
            let promptContextForAI = '';
            batch.forEach((item, indexInBatch) => {
                const globalIndex = i + indexInBatch;
                const mapIndex = baseIndex + globalIndex;
                const emotionalContext = window.emotionalMap[mapIndex] || { emotion: 'Neutro', pace: 'Normal' };
                promptContextForAI += `\nPar√°grafo ${globalIndex}:\n- T√≠tulo do Cap√≠tulo (Guia Tem√°tico): "${item.chapter}"\n- Texto do Par√°grafo: "${item.text}"\n- Contexto Emocional: (Emo√ß√£o: ${emotionalContext.emotion}, Ritmo: ${emotionalContext.pace})`;
            });
            
             // <<< ESTE √â O PROMPT H√çBRIDO, COM SUA LISTA DETALHADA E A ESTRUTURA BLINDADA >>>
            const prompt = `Voc√™ √© uma API ESPECIALISTA em Cria√ß√£o de Prompts Visuais Cinematogr√°ficos. Sua tarefa √© analisar par√°grafos e gerar prompts de imagem ricos em detalhes.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA JSON (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta inteira deve ser APENAS um array JSON v√°lido, come√ßando com \`[\` e terminando com \`]\`. Nenhum outro texto √© permitido.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar obrigatoriamente aspas duplas (\`"\`).
3.  **PROIBI√á√ÉO DE ASPAS INTERNAS:** Dentro dos valores de texto (como "imageDescription"), √â ESTRITAMENTE PROIBIDO usar aspas duplas internas. Se precisar de √™nfase, USE OBRIGATORIAMENTE aspas simples (\`'\`).
4.  **ESTRUTURA COMPLETA:** O array deve conter EXATAMENTE ${batch.length} objetos. Cada objeto deve ter EXATAMENTE duas chaves: "imageDescription" (string) e "estimated_duration" (n√∫mero inteiro).

**MANUAL DE CONTE√öDO PARA CADA PROMPT (SIGA ESTE CHECKLIST DETALHADO):**
Sua principal fun√ß√£o √© criar uma descri√ß√£o visual INCRIVELMENTE RICA para cada par√°grafo. Para isso, sua "imageDescription" DEVE responder √†s seguintes perguntas de forma fluida:

-   **Cen√°rio e Ambiente (Onde?):** Descreva o local f√≠sico e a atmosfera sensorial.
-   **Composi√ß√£o Visual (O Que e Como?):** Organize os elementos principais no quadro.
-   **Ilumina√ß√£o (Como √© a Luz?):** Especifique a qualidade, dire√ß√£o e tipo de luz.
-   **Paleta de Cores (Quais Cores?):** Indique as cores dominantes que refletem a emo√ß√£o.
-   **√Çngulo da C√¢mera (De Onde Olhamos?):** Defina a perspectiva da tomada (plano geral, close, etc.).
-   **Estilo Visual (Qual √© a Est√©tica?):** Sugira um estilo art√≠stico ou fotogr√°fico (realista, vintage, etc.).
-   **Foco e Profundidade (O Que Est√° N√≠tido?):** Indique o foco n√≠tido e o desfoque.
-   **Elementos Emocionais (O Que Sente?):** Integre elementos visuais que amplifiquem a emo√ß√£o.
-   **Movimento e A√ß√£o (O Que se Move?):** Descreva movimentos de c√¢mera ou personagens, se houver.
-   **Express√µes Faciais (Como Parecem?):** Detalhe a express√£o facial para transmitir emo√ß√µes.
-   **S√≠mbolos Chave (O Que √© Importante?):** Incorpore objetos ou elementos importantes do texto.
-   **Texturas e Materiais (Como se Sente?):** Inclua descri√ß√µes de texturas para aumentar o realismo.
-   **Profundidade e Escala (Como √© o Espa√ßo?):** Use elementos para criar uma sensa√ß√£o de profundidade.
-   **Elementos Temporais ou Clim√°ticos (Quando e Como est√° o Tempo?):** Ao descrever uma cena, inclua detalhes como momento do dia, clima ou esta√ß√£o para definir o clima visual.

-   **DURA√á√ÉO ESTIMADA:** O valor de "estimated_duration" deve ser um N√öMERO INTEIRO entre ${durationRange} segundos, baseado na complexidade e no ritmo da cena.

**DADOS PARA AN√ÅLISE (LOTE ATUAL):**
---
${promptContextForAI}
---

**A√á√ÉO FINAL:** Com base nestas instru√ß√µes rigorosas, gere AGORA o array JSON com os prompts visuais, seguindo EXATAMENTE todas as regras.`;

apiPromises.push(callGroqAPI(prompt, 4000).then(res => cleanGeneratedText(res, true)));
        }

        const allBatchResults = await Promise.all(apiPromises);
        let allGeneratedPrompts = allBatchResults.flat();

        if (!Array.isArray(allGeneratedPrompts) || allGeneratedPrompts.length < paragraphsWithContext.length) {
            throw new Error("A IA n√£o retornou um prompt para cada par√°grafo.");
        }

        const curatedPrompts = allGeneratedPrompts.map((promptData, index) => ({
            scriptPhrase: paragraphsWithContext[index].text,
            imageDescription: promptData.imageDescription || "Falha ao gerar descri√ß√£o. Tente re-gerar.",
            estimated_duration: promptData.estimated_duration || 5
        }));

        allImagePrompts[sectionElementId] = curatedPrompts.map((p) => ({ ...p, styleBlock: CINEMATIC_STYLE_BLOCK }));
        promptPaginationState[sectionElementId] = 0;

        promptContainer.innerHTML = `
            <div class="prompt-pagination-wrapper space-y-4">
                <div class="prompt-nav-container flex items-center justify-center gap-4"></div>
                <div class="prompt-items-container space-y-4"></div>
            </div>
        `;
        renderPaginatedPrompts(sectionElementId);

    } catch (error) {
        promptContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar prompts: ${error.message}</p>`;
        console.error("Erro detalhado em generatePromptsForSection:", error);
    } finally {
        hideButtonLoading(button);
    }
};



// =========================================================================
// >>>>> FIM DA VERS√ÉO BLINDADA DE 'generatePromptsForSection' <<<<<
// =========================================================================



    
        /**
         * Sugere trilhas sonoras para uma sec√ß√£o espec√≠fica do roteiro.
         * @param {string} sectionId - O ID do elemento HTML da sec√ß√£o (ex: 'introSection').
         */
        window.suggestSoundtrack = async (sectionId) => {
            const sectionElement = document.getElementById(sectionId);
            const scriptContent = sectionElement.querySelector('.generated-content-wrapper').textContent; 
            const soundtrackContainer = sectionElement.querySelector('.soundtrack-container');
            
            if (!scriptContent) {
                window.showToast("Gere o roteiro para esta sec√ß√£o primeiro.");
                return;
            }

            soundtrackContainer.innerHTML = `<div class="loading-spinner-small"></div>`; 

            const prompt = `Voc√™ √© um especialista em prompts para IAs de gera√ß√£o de m√∫sica (como Suno/Udio). Sua tarefa √© analisar o seguinte trecho de roteiro e criar 3 prompts de texto distintos e detalhados.

            **REGRAS DE FORMATA√á√ÉO (N√ÉO NEGOCI√ÅVEIS):**1.  Sua resposta DEVE SER um array JSON v√°lido.2.  O array deve conter EXATAMENTE 3 strings.3.  CADA string deve ser um par√°grafo √∫nico, bem escrito e descritivo, pronto para ser colado em uma IA de m√∫sica. N√ÉO use chaves, colchetes ou qualquer outra sintaxe de objeto DENTRO da string do prompt.

            **EXEMPLO DE RESPOSTA PERFEITA:**
            ["Generate an epic, cinematic orchestral piece in the style of Hans Zimmer... No vocals or percussion, focus on the emotional intensity of the strings and piano.","Create a contemplative, melancholic ambient track with a slow, mournful tempo... No bright or cheerful notes, focus on the darker, more introspective tones.","Craft an uplifting, inspirational electronic piece with a moderate tempo... avoid any jarring or harsh sounds, focusing on the soaring, inspirational quality of the melody."
            ]

                Agora, use o roteiro abaixo como inspira√ß√£o para criar 3 prompts seguindo EXATAMENTE este formato.

            Trecho do roteiro para analisar:
                    ---
                ${scriptContent}

                ---`;
            
            try {
                const rawResult = await callGroqAPI(prompt, 500);
                const cleanedResult = cleanGeneratedText(rawResult, true);
                const suggestions = JSON.parse(cleanedResult);

                // Adiciona tratamento de erro para garantir que suggestions √© um array de strings
                if (!Array.isArray(suggestions) || !suggestions.every(s => typeof s === 'string')) {
                    throw new Error("A IA retornou um formato de trilha sonora inesperado. Esperava um array de strings.");
                }

                soundtrackContainer.innerHTML = ''; // Limpa o spinner
                if (suggestions && suggestions.length > 0) {
                    // Agora envolvemos a lista em um div com as classes corretas para ter um fundo e padding.
                    let suggestionsHtml = '<div class="card-background p-4 rounded-lg shadow-inner">';
                    suggestionsHtml += '<ul class="soundtrack-list">';
                    suggestions.forEach(suggestion => {
                        suggestionsHtml += `<li>${suggestion}</li>`;
                    });
                    suggestionsHtml += '</ul>';
                    suggestionsHtml += '</div>'; 

                    soundtrackContainer.innerHTML = suggestionsHtml;
                } else {
                    soundtrackContainer.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma sugest√£o de trilha sonora foi gerada.</p>';
                }
            } catch (error) {
                soundtrackContainer.innerHTML = `<p class="text-red-500 text-sm">Falha ao gerar sugest√µes: ${error.message}</p>`;
                console.error("Erro detalhado em suggestSoundtrack:", error);
            }
        };

        /**
         * Copia a transcri√ß√£o para a √°rea de transfer√™ncia e
         * inicia o download de um arquivo .rtf limpo e com a codifica√ß√£o correta.
         */
        const handleCopyAndDownloadTranscript = () => {
            const transcriptText = getTranscriptOnly();

            if (!transcriptText) {
                window.showToast("Nenhum roteiro para copiar. Gere as se√ß√µes primeiro.");
                return;
            }

            copyTextToClipboard(transcriptText);
            window.showToast("Transcri√ß√£o copiada! Download do arquivo .rtf iniciado.");

            const fileName = (document.getElementById('videoTheme').value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro') + '_transcricao.rtf';
            
            // **A CORRE√á√ÉO EST√Å AQUI:**
            // 1. Escapa o texto para o formato RTF.
            // 2. Substitui as quebras de linha pelo comando de par√°grafo do RTF.
            const safeText = escapeRtf(transcriptText);
            const rtfContent = `{\\rtf1\\ansi\\deff0 {\\fonttbl{\\f0 Arial;}}\\f0\\fs24 ${safeText.replace(/\n/g, '\\par\r\n')}}`;
            
            const blob = new Blob([rtfContent], { type: 'application/rtf' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        };
    
// ====================================================================================
// PASSO 2: SUBSTITUA SUA FUN√á√ÉO 'generateTitlesAndThumbnails' INTEIRA POR ESTA VERS√ÉO
// ====================================================================================

const generateTitlesAndThumbnails = async (button) => {
    if (!validateInputs()) return;
    showButtonLoading(button);

    try {
        const { prompt, maxTokens } = constructScriptPrompt('titles_thumbnails');
        
        const rawResult = await callGroqAPI(prompt, maxTokens);
        const parsedContent = cleanGeneratedText(rawResult, true);
        
        // NOVA VALIDA√á√ÉO: Verificamos se recebemos um array de objetos com as chaves corretas.
        if (!Array.isArray(parsedContent) || parsedContent.length === 0 || !parsedContent[0].suggested_title) {
            console.error("Formato de T√≠tulos/Thumbnails inv√°lido recebido da IA:", parsedContent);
            throw new Error("A IA retornou os dados de t√≠tulos em um formato inesperado. Tente novamente.");
        }

        // NOVA L√ìGICA DE PROCESSAMENTO:
        // Transformamos o array da IA na estrutura que o nosso app precisa.
        const titles = parsedContent.map(item => item.suggested_title);
        const thumbnails = parsedContent.map(item => ({
            title: item.thumbnail_title,
            description: item.thumbnail_description
        }));
        
        generatedTitlesAndThumbnails = { titles, thumbnails };

        // O resto da fun√ß√£o (renderiza√ß√£o) continua o mesmo, pois agora os dados est√£o no formato correto.
        const targetContentElement = document.getElementById('titlesThumbnailsContent');
        if (targetContentElement) {
            const titlesListHtml = titles.map((title, index) => `<p>${index + 1}. ${DOMPurify.sanitize(title)}</p>`).join('');
            const thumbnailsListHtml = thumbnails.map((thumb, index) => `
                <div class="thumbnail-idea"> 
                    <h4 class="font-semibold">"${DOMPurify.sanitize(thumb.title)}"</h4>
                    <p>Descri√ß√£o: ${DOMPurify.sanitize(thumb.description)}</p>
                </div>
            `).join('');

            targetContentElement.innerHTML = `
                <div class="generated-output-box">
                    <div class="output-content-block">
                        <h4 class="output-subtitle">Sugest√µes de T√≠tulos:</h4>
                        ${titlesListHtml}
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-small" onclick="window.analyzeTitles()">Analisar CTR</button>
                            <div id="ctrAnalysisResult" class="mt-3"></div>
                        </div>
                    </div>
                    <div class="output-content-block">
                        <h4 class="output-subtitle">Ideias de Thumbnail:</h4>
                        ${thumbnailsListHtml}
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-small" onclick="window.analyzeThumbnails()">Analisar Thumbnails</button>
                            <div id="thumbnailAnalysisResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            `;
            markButtonAsCompleted(button.id);
        }
    } catch (error) {
        window.showToast(`Falha ao gerar T√≠tulos: ${error.message}`);
        console.error("Error generating Titles/Thumbnails.", error);
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};


// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A FUN√á√ÉO analyzeTitles INTEIRA POR ESTA VERS√ÉO BLINDADA <<<<<
// =========================================================================

window.analyzeTitles = async () => {
    if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.titles || generatedTitlesAndThumbnails.titles.length === 0) {
        window.showToast("Gere os t√≠tulos primeiro!");
        return;
    }

    const resultContainer = document.getElementById('ctrAnalysisResult');
    resultContainer.innerHTML = DOMPurify.sanitize(`<div class="loading-spinner-small"></div>`);

    const titlesString = generatedTitlesAndThumbnails.titles.join('\n');
    
    // >>> PROMPT BLINDADO COM REGRAS DE SINTAXE E ESTRUTURA EXPL√çCITAS <<<
    const prompt = `Voc√™ √© uma API de an√°lise de t√≠tulos do YouTube que retorna APENAS um array JSON.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (INEGOCI√ÅVEIS):**
1.  **JSON PURO:** Sua resposta inteira deve ser APENAS o c√≥digo JSON, come√ßando com \`[\` e terminando com \`]\`.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).
3.  **V√çRGULA FINAL:** Cada objeto JSON dentro do array DEVE ser seguido por uma v√≠rgula, EXCETO o √∫ltimo objeto.
4.  **ESTRUTURA DO OBJETO:** Cada objeto no array DEVE conter EXATAMENTE estas tr√™s chaves: "titulo_original" (string), "nota_ctr" (um n√∫mero de 0 a 10), e "sugestao_melhora" (string).

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
[
  {
    "titulo_original": "T√≠tulo Exemplo 1",
    "nota_ctr": 8,
    "sugestao_melhora": "Adicionar um n√∫mero ou um gatilho de curiosidade."
  },
  {
    "titulo_original": "T√≠tulo Exemplo 2",
    "nota_ctr": 6,
    "sugestao_melhora": "Encurtar para ser mais direto e impactante."
  }
]

**T√≠tulos para analisar:**
---
${titlesString}
---

Responda APENAS com o array JSON completo e sintaticamente PERFEITO, seguindo EXATAMENTE as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 3000);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis)) {
            throw new Error("A IA n√£o retornou uma an√°lise de t√≠tulos em formato v√°lido.");
        }

        let analysisHtml = '<div class="space-y-4">';
        analysis.forEach(item => {
            analysisHtml += `
                <div class="p-3 card-background rounded-md shadow-sm">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">${DOMPurify.sanitize(item.titulo_original)}</p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de CTR:</strong> <span class="text-indigo-500 font-bold">${DOMPurify.sanitize(String(item.nota_ctr))} / 10</span></p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${DOMPurify.sanitize(item.sugestao_melhora)}</p>
                </div>
            `;
        });
        analysisHtml += '</div>';
        resultContainer.innerHTML = DOMPurify.sanitize(analysisHtml);

    } catch (error) {
        console.error("Erro detalhado em analyzeTitles:", error);
        resultContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">Falha ao analisar os t√≠tulos: ${error.message}</p>`);
    }
};

// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A FUN√á√ÉO analyzeThumbnails INTEIRA POR ESTA VERS√ÉO BLINDADA <<<<<
// =========================================================================

window.analyzeThumbnails = async () => {
    if (!generatedTitlesAndThumbnails || !generatedTitlesAndThumbnails.thumbnails || generatedTitlesAndThumbnails.thumbnails.length === 0) {
        window.showToast("Gere as ideias de thumbnail primeiro!");
        return;
    }

    const resultContainer = document.getElementById('thumbnailAnalysisResult');
    resultContainer.innerHTML = DOMPurify.sanitize(`<div class="loading-spinner-small"></div>`);

    const thumbnailsString = generatedTitlesAndThumbnails.thumbnails.map(t => `T√≠tulo: ${t.title}, Descri√ß√£o: ${t.description}`).join('\n---\n');
    
    // >>> PROMPT BLINDADO COM REGRAS DE SINTAXE E ESTRUTURA EXPL√çCITAS <<<
    const prompt = `Voc√™ √© uma API de an√°lise de thumbnails do YouTube que retorna APENAS um array JSON.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (INEGOCI√ÅVEIS):**
1.  **JSON PURO:** Sua resposta inteira deve ser APENAS o c√≥digo JSON, come√ßando com \`[\` e terminando com \`]\`.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar aspas duplas (\`"\`).
3.  **V√çRGULA FINAL:** Cada objeto JSON dentro do array DEVE ser seguido por uma v√≠rgula, EXCETO o √∫ltimo objeto.
4.  **ESTRUTURA DO OBJETO:** Cada objeto no array DEVE conter EXATAMENTE estas tr√™s chaves: "titulo" (string, contendo o t√≠tulo original da ideia analisada), "nota_visual" (um n√∫mero de 0 a 10), e "sugestao_melhora" (string).

**EXEMPLO DE FORMATO PERFEITO E OBRIGAT√ìRIO:**
[
  {
    "titulo": "Ideia de Thumbnail 1",
    "nota_visual": 7,
    "sugestao_melhora": "Aumentar o contraste e usar uma fonte mais leg√≠vel no texto."
  },
  {
    "titulo": "Ideia de Thumbnail 2",
    "nota_visual": 9,
    "sugestao_melhora": "Adicionar um contorno brilhante ao redor da pessoa para destac√°-la do fundo."
  }
]

**Ideias para analisar:**
---
${thumbnailsString}
---

Responda APENAS com o array JSON completo e sintaticamente PERFEITO, seguindo EXATAMENTE as regras acima.`;

    try {
        const rawResult = await callGroqAPI(prompt, 2500);
        const analysis = cleanGeneratedText(rawResult, true);

        if (!analysis || !Array.isArray(analysis)) {
            throw new Error("A IA n√£o retornou uma an√°lise de thumbnails em formato v√°lido.");
        }

        let analysisHtml = '<div class="space-y-4">';
        analysis.forEach(item => {
            analysisHtml += `
                <div class="p-3 card-background rounded-md shadow-sm">
                    <p class="font-semibold text-gray-800 dark:text-gray-200">"${DOMPurify.sanitize(item.titulo || 'Ideia Sem T√≠tulo')}"</p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Nota de Potencial Visual:</strong> <span class="text-indigo-500 font-bold">${DOMPurify.sanitize(String(item.nota_visual))} / 10</span></p>
                    <p class="text-sm mt-1 text-gray-600 dark:text-gray-400"><strong>Sugest√£o:</strong> ${DOMPurify.sanitize(item.sugestao_melhora)}</p>
                </div>
            `;
        });
        analysisHtml += '</div>';
        resultContainer.innerHTML = DOMPurify.sanitize(analysisHtml);

    } catch (error) {
        console.error("Erro detalhado em analyzeThumbnails:", error);
        resultContainer.innerHTML = DOMPurify.sanitize(`<p class="text-red-500 text-sm">Falha ao analisar as thumbnails: ${error.message}</p>`);
    }
};



        /**
         * Gera a descri√ß√£o do v√≠deo e hashtags.
         */
            const generateVideoDescription = async (button) => {
            if (!validateInputs()) return;
            showButtonLoading(button);

            try {
                let result = await callGroqAPI(constructScriptPrompt('description').prompt, constructScriptPrompt('description').maxTokens);
                result = cleanGeneratedText(result, false);
                result = removeMetaComments(result);
                
                const targetContentElement = document.getElementById('videoDescriptionContent');
                if (targetContentElement) {
                    // >>> AQUI EST√Å A MUDAN√áA <<<
                    const sanitizedResult = DOMPurify.sanitize(`<div class="generated-output-box whitespace-pre-wrap">${result}</div>`);
                    targetContentElement.innerHTML = sanitizedResult;
                    markButtonAsCompleted(button.id);
                }
            } catch (error) {
                window.showToast(`Falha ao gerar Descri√ß√£o: ${error.message}`);
                console.error("Error generating Video Description.", error);
            } finally {
                hideButtonLoading(button);
                updateButtonStates();
            }
        };

// =========================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A FUN√á√ÉO generateStrategicOutline INTEIRA <<<<<
// =========================================================================

const generateStrategicOutline = async (button) => {
    if (!validateInputs()) return;
    showButtonLoading(button);
    
    const outlineContentDiv = document.getElementById('outlineContent');
    if (outlineContentDiv) {
        outlineContentDiv.innerHTML = DOMPurify.sanitize(`<div class="loading-spinner-small mx-auto"></div>`);
    } else {
        window.showToast("Erro: Container do esbo√ßo n√£o encontrado.");
        hideButtonLoading(button);
        return;
    }

    try {
        const { prompt } = constructScriptPrompt('outline'); // Usamos o prompt blindado
        const rawResult = await callGroqAPI(prompt, 4000);
        
        strategicOutline = cleanGeneratedText(rawResult, true);

        if (!strategicOutline || typeof strategicOutline !== 'object' || !strategicOutline.introduction) {
            console.error("A IA retornou um esbo√ßo em formato inv√°lido:", rawResult);
            throw new Error("A IA falhou em gerar um esbo√ßo v√°lido.");
        }

        const titleTranslations = {
            'introduction': 'Introdu√ß√£o', 'development': 'Desenvolvimento',
            'climax': 'Cl√≠max', 'conclusion': 'Conclus√£o', 'cta': 'CTA'
        };
        
        let outlineHtml = '<ul class="space-y-4 text-sm">';
        for (const key in strategicOutline) {
            if (Object.hasOwnProperty.call(strategicOutline, key)) {
                const translatedTitle = titleTranslations[key] || key;
                const contentValue = strategicOutline[key];
                
                outlineHtml += `<li><div><strong class="text-indigo-600 dark:text-indigo-400">${translatedTitle}:</strong>`;
                
                // <<< AQUI EST√Å A NOVA L√ìGICA INTELIGENTE DE RENDERIZA√á√ÉO >>>
                if (typeof contentValue === 'string') {
                    outlineHtml += ` <span class="text-gray-600 dark:text-gray-300">${DOMPurify.sanitize(contentValue)}</span>`;
                } else if (typeof contentValue === 'object' && contentValue !== null) {
                    outlineHtml += '<ul class="list-disc pl-5 mt-1 space-y-1">';
                    for (const subKey in contentValue) {
                        if(Array.isArray(contentValue[subKey])) { // Para o caso do Desenvolvimento ter se√ß√µes
                             contentValue[subKey].forEach(section => {
                                outlineHtml += `<li><span class="font-semibold">${DOMPurify.sanitize(section.title || subKey)}:</span> ${DOMPurify.sanitize(section.description || '')}</li>`;
                             });
                        } else {
                            outlineHtml += `<li><span class="font-semibold">${DOMPurify.sanitize(subKey.replace(/_/g, ' '))}:</span> ${DOMPurify.sanitize(contentValue[subKey])}</li>`;
                        }
                    }
                    outlineHtml += '</ul>';
                }
                
                outlineHtml += '</div></li>';
            }
        }
        outlineHtml += '</ul>';
        
        outlineContentDiv.innerHTML = outlineHtml; // A sanitiza√ß√£o j√° foi feita nos peda√ßos
        markButtonAsCompleted(button.dataset.action ? button.id : 'generateOutlineBtn');

        const scriptContainer = document.getElementById('scriptSectionsContainer');
        if (scriptContainer) {
            scriptContainer.innerHTML = ''; 
            scriptContainer.innerHTML += DOMPurify.sanitize(createScriptSectionPlaceholder('intro', 'Introdu√ß√£o', 'generateIntroBtn', 'generateIntro'));
            scriptContainer.innerHTML += DOMPurify.sanitize(createScriptSectionPlaceholder('development', 'Desenvolvimento', 'generateDevelopmentBtn', 'generateDevelopment'));
            scriptContainer.innerHTML += DOMPurify.sanitize(createScriptSectionPlaceholder('climax', 'Cl√≠max', 'climaxBtn', 'generateClimax'));
        }

    } catch (error) {
        console.error("Erro detalhado em generateStrategicOutline:", error);
        window.showToast(`Falha ao gerar Esbo√ßo: ${error.message}`);
        // ... (resto do seu catch)
    } finally {
        hideButtonLoading(button);
        updateButtonStates();
    }
};


        /**
         * Realiza o download do roteiro como PDF.
         */
        const downloadPdf = async () => {
            // 1. Criar um container tempor√°rio para a impress√£o
            let printContainer = document.createElement('div');
            printContainer.id = 'print-container';

            // 2. Coletar e formatar TODO o conte√∫do que queremos imprimir
            let htmlToPrint = `<h1 style="text-align: center; font-size: 22pt; margin-bottom: 24px;">${elements.videoTheme.value}</h1>`;

            // Adicionar o esbo√ßo estrat√©gico
            if (strategicOutline) {
                const titleTranslations = {
                    'introduction': 'Introdu√ß√£o',
                    'development': 'Desenvolvimento',
                    'climax': 'Cl√≠max',
                    'conclusion': 'Conclus√£o',
                    'cta': 'CTA'
                };
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Esbo√ßo Estrat√©gico</div>
                        <div class="print-section-content">
                            <ul style="list-style-type: disc; padding-left: 20px;">`;
                for (const key in strategicOutline) {
                    const translatedTitle = titleTranslations[key] || (key.charAt(0).toUpperCase() + key.slice(1));
                    htmlToPrint += `<li><strong>${translatedTitle}:</strong> ${strategicOutline[key]}</li>`;
                }
                htmlToPrint += `</ul></div></div>`;
            }

            // Adicionar o roteiro principal
            document.querySelectorAll('#scriptSectionsContainer .accordion-item').forEach(item => {
                const title = item.querySelector('h3')?.textContent;
                const content = item.querySelector('.generated-content-wrapper')?.textContent;
                if (title && content) {
                    htmlToPrint += `
                        <div class="print-section">
                            <div class="print-section-title">${title}</div>
                            <div class="print-section-content"><pre>${content}</pre></div>
                        </div>`;
                }
            });
            
            // Adicionar Descri√ß√£o e Hashtags
            const videoDescriptionContent = document.getElementById('videoDescriptionContent');
            if (videoDescriptionContent && videoDescriptionContent.textContent.trim() !== 'Clique em \'Gerar\' para ver a descri√ß√£o') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">Descri√ß√£o & Hashtags</div>
                        <div class="print-section-content">${videoDescriptionContent.innerHTML}</div>
                    </div>`;
            }

            // Adicionar T√≠tulos e Thumbnails
            const titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent');
            if (titlesThumbnailsContent && titlesThumbnailsContent.textContent.trim() !== 'Clique em \'Gerar\' para ver as sugest√µes') {
                htmlToPrint += `
                    <div class="print-section">
                        <div class="print-section-title">T√≠tulos & Thumbnails</div>
                        <div class="print-section-content">${titlesThumbnailsContent.innerHTML}</div>
                    </div>`;
            }

            // 3. Injetar o HTML no container e adicion√°-lo ao body
            printContainer.innerHTML = htmlToPrint;
            document.body.appendChild(printContainer);

            // 4. Chamar a impress√£o
            window.print();

            // 5. Remover o container tempor√°rio ap√≥s a impress√£o (com um pequeno atraso para garantir a renderiza√ß√£o)
            setTimeout(() => {
                document.body.removeChild(printContainer);
            }, 500); // 500ms de atraso
        };



// =========================================================================
// >>>>> PASSO 4: SUBSTITUA A FUN√á√ÉO resetApplicationState INTEIRA POR ESTA <<<<<
// =========================================================================
const resetApplicationState = () => {
    projectState = {
        intro: false,
        development: false,
        climax: false,
        conclusion: false,
        cta: false
    };

    const safeReset = (elementId, value = '') => { /* ... */ };

    // ... (o resto da sua fun√ß√£o de reset, que j√° est√° correta)
    
    // Apenas para garantir, o miolo da fun√ß√£o deve ser este:
    safeReset('channelName', 'The Biblical Unveiling');
    safeReset('videoTheme');
    safeReset('videoDescription');
    safeReset('targetAudience', ''); 
    safeReset('languageSelect', 'en');
    safeReset('videoObjective', 'informar');
    safeReset('videoDuration', '');
    safeReset('speakingPace', 'moderate');
    safeReset('narrativeGoal', 'storytelling');
    safeReset('narrativeTheme');
    safeReset('narrativeTone', 'inspirador');
    safeReset('narrativeVoice');
    safeReset('centralQuestion');
    safeReset('emotionalArc');
    safeReset('shockingEndingHook');
    safeReset('imageDescriptionEngine');
    safeReset('imageStyleSelect', 'cinematic');
    safeReset('customImageStyle');
    safeReset('researchData');
    safeReset('emotionalHook');

    toggleCustomImageStyleVisibility();
    updateNarrativeStructureOptions();

    const nicheDesc = document.getElementById('nicheDescription');
    const ideasOut = document.getElementById('ideasOutput');
    if (nicheDesc) nicheDesc.value = '';
    if (ideasOut) ideasOut.innerHTML = '';

    strategicOutline = null;
    allImagePrompts = {};
    generatedTitlesAndThumbnails = null;
    totalScriptSeconds = 0;
    promptPaginationState = {};

    resetProjectOutputs();

    window.showToast("Pronto para um novo roteiro!");
    window.scrollTo({ top: 0, behavior: 'smooth' });
};
        

        /**
         * Exporta o estado atual do projeto para um ficheiro JSON.
         */
        const exportProject = () => {
            const projectData = {
                inputs: {},
                outputs: {},
                memory: {
                    allImagePrompts: allImagePrompts,
                    generatedTitlesAndThumbnails: generatedTitlesAndThumbnails,
                    strategicOutline: strategicOutline, // Exporta o esbo√ßo
                    promptPaginationState: promptPaginationState // Export pagination state
                }
            };

            // Salva o estado dos inputs
            for (const key in elements) {
                if (elements[key] && typeof elements[key].value !== 'undefined') {
                    projectData.inputs[key] = elements[key].value;
                }
            }
            // Salva o conte√∫do gerado (HTML interno das sec√ß√µes)
            const scriptSectionIds = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection']; // CTA is now part of conclusionSection
            scriptSectionIds.forEach(id => {
                const sectionElement = document.getElementById(id);
                if (sectionElement) {
                    projectData.outputs[id] = sectionElement.innerHTML;
                }
            });

            // Salva o conte√∫do do esbo√ßo
            projectData.outputs.strategicOutlineContent = elements.outlineContent.innerHTML;

            // Salva o conte√∫do dos cart√µes de recursos
            projectData.outputs.titlesThumbnailsContent = document.getElementById('titlesThumbnailsContent').innerHTML;
            projectData.outputs.videoDescriptionContent = document.getElementById('videoDescriptionContent').innerHTML;
            // Removed storyboardContent export
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(projectData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            const fileName = elements.videoTheme.value.trim().replace(/[^a-zA-Z0-9]/gi, '_').toLowerCase() || 'roteiro_viral';
            downloadAnchorNode.setAttribute("download", `${fileName}_projeto.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            document.body.removeChild(downloadAnchorNode);
            downloadAnchorNode.remove();
            window.showToast("Projeto exportado com sucesso!");
        };

        /**
         * Renderiza os prompts de imagem para uma sec√ß√£o espec√≠fica na UI.
         * Usado ap√≥s carregar um projeto.
         * @param {string} sectionElementId - O ID do elemento HTML da sec√ß√£o.
         */
        const renderImagePromptsForSection = (sectionElementId) => {
            const sectionElement = document.getElementById(sectionElementId);
            if (!sectionElement) return;

            const promptContainer = sectionElement.querySelector('.prompt-container');
            if (!promptContainer) return;

            // Re-cria a estrutura de pagina√ß√£o se ela n√£o existir
            if (!promptContainer.querySelector('.prompt-pagination-wrapper')) {
                promptContainer.innerHTML = `
                    <div class="prompt-pagination-wrapper space-y-4">
                        <div class="prompt-nav-container flex items-center justify-center gap-4">
                            <!-- Controles de navega√ß√£o ser√£o inseridos aqui -->
                        </div>
                        <div class="prompt-items-container space-y-4">
                            <!-- Os 4 prompts da p√°gina atual ser√£o inseridos aqui -->
                        </div>
                    </div>
                `;
            }

            // Renderiza a p√°gina atual de prompts
            renderPaginatedPrompts(sectionElementId);
        };

        /**
         * Importa um projeto de um ficheiro JSON.
         * @param {Event} event - O evento de mudan√ßa do input de ficheiro.
         */
        const importProject = (event) => {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const projectData = JSON.parse(e.target.result);
                    
                    resetApplicationState();

                    // Restaura os inputs
                    const inputIds = [
                        'channelName', 'videoTheme', 'videoDescription', 'targetAudience', 
                        'languageSelect', 'videoObjective', 'videoDuration', 'speakingPace', 
                        'narrativeGoal', 'narrativeStructure', 'narrativeTheme', 'narrativeTone', 
                        'narrativeVoice', 'centralQuestion', 'emotionalArc', 'shockingEndingHook', 'imageDescriptionEngine', 
                        'imageStyleSelect', 'customImageStyle'
                    ];
                    inputIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && projectData.inputs[id] !== undefined) {
                            element.value = projectData.inputs[id];
                        }
                    });
                    
                    const structureSelect = document.getElementById('narrativeStructure');
                    if (structureSelect && projectData.inputs['narrativeStructure']) {
                        structureSelect.value = projectData.inputs['narrativeStructure'];
                        // Ensure the tooltip is updated after setting the structure value
                        
                    }

                    // Restaura o conte√∫do gerado
                    const outputIds = [
                        'introSection', 'developmentSection', 'climaxSection', 'conclusionSection', // CTA is now part of conclusionSection
                        'outlineContent', 'titlesThumbnailsContent', 'videoDescriptionContent'
                    ];
                    outputIds.forEach(id => {
                        const element = document.getElementById(id);
                        if (element && projectData.outputs[id]) {
                            element.innerHTML = projectData.outputs[id]; 
                        }
                    });
                    
                    strategicOutline = projectData.memory.strategicOutline || null;
                    allImagePrompts = projectData.memory.allImagePrompts || {};
                    generatedTitlesAndThumbnails = projectData.memory.generatedTitlesAndThumbnails || null;
                    promptPaginationState = projectData.memory.promptPaginationState || {}; // Load pagination state

                    // Renderiza os prompts de imagem paginados ap√≥s carregar
                    const scriptSectionIds = ['introSection', 'developmentSection', 'climaxSection', 'conclusionSection'];
                    scriptSectionIds.forEach(id => {
                        if (allImagePrompts[id] && allImagePrompts[id].length > 0) {
                            renderImagePromptsForSection(id);
                        }
                    });

                    updateButtonStates();
                    
                    if (elements.outlineContent.textContent.trim().length > 100) markButtonAsCompleted('generateOutlineBtn');
                    if (document.getElementById('introSection').innerHTML.trim()) markButtonAsCompleted('generateIntroBtn');
                    if (document.getElementById('developmentSection').innerHTML.trim()) markButtonAsCompleted('generateDevelopmentBtn');
                    if (document.getElementById('climaxSection').innerHTML.trim()) markButtonAsCompleted('climaxBtn');
                    if (document.getElementById('conclusionSection').innerHTML.trim()) markButtonAsCompleted('conclusionBtn');
                    if (document.getElementById('videoDescriptionContent').innerHTML.includes('Hashtags')) markButtonAsCompleted('generateDescriptionBtn');
                    if (document.getElementById('titlesThumbnailsContent').innerHTML.includes('Analisar CTR')) markButtonAsCompleted('generateTitlesAndThumbnailsBtn');

                    updateProgressBar(); 
                    
                    elements.projectDashboard.classList.remove('hidden');
                    window.showToast("Projeto importado com sucesso!");

                } catch (err) {
                    window.showToast("Erro: Ficheiro de projeto inv√°lido ou corrompido.");
                    console.error("Erro ao importar projeto:", err);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        };



// =-==================================================================================
// >>>>> PASSO √öNICO: SUBSTITUA A SUA FUN√á√ÉO suggestStrategy INTEIRA POR ESTA VERS√ÉO <<<<<
// =-==================================================================================

const suggestStrategy = async (button) => {
    if (document.querySelector('#scriptSectionsContainer .accordion-item')) {
        const userConfirmed = await showConfirmationDialog(
            "Sugerir Nova Estrat√©gia?",
            "Isso limpar√° todo o roteiro e metadados j√° gerados para aplicar a nova sugest√£o. Deseja continuar?"
        );
        if (!userConfirmed) return;
    }

    resetProjectOutputs();

    const theme = document.getElementById('videoTheme')?.value.trim();
    const description = document.getElementById('videoDescription')?.value.trim();
    if (!theme || !description) {
        window.showToast("Preencha o Tema e a Descri√ß√£o do V√≠deo para receber sugest√µes.");
        return;
    }

    showButtonLoading(button);
    isSettingStrategy = true;

    const selectedLangCode = document.getElementById('languageSelect').value;
    const languageName = selectedLangCode === 'pt-br' ? 'Portugu√™s (Brasil)' : 'English';

    const validOptions = {
        narrative_goal: `['${Array.from(document.getElementById('narrativeGoal').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        narrative_tone: `['${Array.from(document.getElementById('narrativeTone').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        language_style: `['${Array.from(document.getElementById('languageStyle').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        video_objective: `['${Array.from(document.getElementById('videoObjective').options).map(o => o.value).filter(Boolean).join("', '")}']`,
        speaking_pace: `['${Array.from(document.getElementById('speakingPace').options).map(o => o.value).filter(Boolean).join("', '")}']`,
    };

// =========================================================================
// >>>>> PROMPT FINAL E BLINDADO PARA PREENCHIMENTO INICIAL <<<<<
// =========================================================================
const prompt = `Voc√™ √© uma API de Estrat√©gia de Conte√∫do Viral altamente especializada. Sua √∫nica fun√ß√£o √© gerar um objeto JSON contendo uma estrat√©gia de v√≠deo de EXCEPCIONAL qualidade com base em um tema e descri√ß√£o fornecidos.

**TAREFA PRINCIPAL:** Analisar o tema e a descri√ß√£o, e criar uma estrat√©gia de v√≠deo completa, envolvente e com alto potencial de engajamento.

**REGRAS CR√çTICAS DE SINTAXE E ESTRUTURA (ABSOLUTAMENTE INEGOCI√ÅVEIS):**
1.  **JSON PURO E PERFEITO:** Sua resposta inteira deve ser APENAS um objeto JSON v√°lido, come√ßando com \`{\` e terminando com \`}\`. NENHUM outro texto, coment√°rio ou explica√ß√£o √© permitido. Pense nisso como uma resposta de API pura e impec√°vel.
2.  **ASPAS DUPLAS, SEMPRE:** TODAS as chaves e valores de texto DEVEM usar obrigatoriamente aspas duplas (\`"\`).
3.  **PREENCHIMENTO TOTAL E EXATO:** Voc√™ DEVE preencher EXATAMENTE as chaves listadas no "MANUAL DE PREENCHIMENTO" abaixo. Nenhuma chave pode estar faltando, e nenhuma chave extra deve ser adicionada.
4.  **TIPOS DE DADOS EXATOS:**
    - Todas as chaves e valores devem ser strings.
    - Para campos com escolhas pr√©-definidas (como "narrative_goal", "narrative_structure", etc.), voc√™ DEVE escolher EXATAMENTE um dos valores permitidos listados.
5.  **IDIOMA:** Lembre-se, todos os valores de texto devem estar em **${languageName}**.

**MANUAL DE PREENCHIMENTO (SIGA ESTAS INSTRU√á√ïES PARA CADA CAMPO):**
-   **"target_audience" (P√∫blico-Alvo Espec√≠fico):** Defina um segmento CLARAMENTE caracterizado que se beneficiar√° M√ÅXIMO deste v√≠deo. Evite generalidades. Seja demogr√°fico, psicogr√°fico ou comportamental. (Ex: "Jovens em transi√ß√£o de carreira buscando prop√≥sito", "Pais de adolescentes com dificuldades escolares")
-   **"narrative_goal" (Objetivo Narrativo Central):** Escolha EXATAMENTE UM valor de: ${validOptions.narrative_goal}. Justifique sua escolha com base no tema.
-   **"narrative_structure" (Estrutura Narrativa Ideal):** Com base no "narrative_goal" escolhido, selecione uma estrutura compat√≠vel:
    -   Se 'storytelling', escolha de: ["documentary", "heroes_journey", "pixar_spine", "mystery_loop", "twist"].
    -   Se 'storyselling', escolha de: ["underdog_victory", "discovery_mentor", "if_not_found_create", "pas", "bab"].
    Explique brevemente por que esta estrutura se encaixa.
-   **"narrative_theme" (Tema Principal Profundo):** Defina o tema central de forma concisa, mas com profundidade. V√° al√©m do t√≥pico √≥bvio. (Ex: "N√£o √© sobre 'produtividade', √© sobre 'recuperar o controle do pr√≥prio tempo'")
-   **"narrative_tone" (Tom Emocional do V√≠deo):** Escolha EXATAMENTE UM valor de: ${validOptions.narrative_tone}. Este tom deve guiar toda a narrativa.
-   **"narrative_voice" (Personalidade do Narrador):** Descreva a voz do narrador de forma v√≠vida. Quem est√° falando com o espectador? (Ex: "Um mentor s√°bio e compassivo", "Um amigo curioso e um pouco sarc√°stico")
-   **"central_question" (A Pergunta que Tudo Conecta):** Formule uma pergunta poderosa e envolvente que ser√° o fio condutor l√≥gico e emocional do v√≠deo. Esta pergunta deve ser respondida ao longo do conte√∫do.
-   **"emotional_arc" (Jornada Emocional do Espectador):** Descreva a jornada emocional em 3 atos: Como o espectador deve se SENTIR no in√≠cio, no meio e no cl√≠max do v√≠deo? (Ex: "In√≠cio: Curioso e um pouco ansioso. Meio: Emp√°tico e intrigado. Cl√≠max: Inspirado e determinado.")
-   **"emotional_hook" (Hist√≥ria Pessoal Cativante):** Crie uma hist√≥ria pessoal (real ou fict√≠cia, mas plaus√≠vel) que servir√° como fio condutor emocional. Esta hist√≥ria deve ilustrar a "central_question".
-   **"shocking_ending_hook" (Frase de Impacto Inicial):** Crie uma frase curta, impactante e intrigante para ser usada como gancho inicial (hook) do v√≠deo. Deve prender a aten√ß√£o imediatamente.
-   **"language_style" (Estilo Lingu√≠stico):** Escolha EXATAMENTE UM valor de: ${validOptions.language_style}. Este estilo deve ser consistente em todo o roteiro.
-   **"video_objective" (Objetivo Final do V√≠deo):** Escolha EXATAMENTE UM valor de: ${validOptions.video_objective}. Qual √© o resultado desejado no espectador ap√≥s assistir?
-   **"speaking_pace" (Ritmo da Narra√ß√£o):** Escolha EXATAMENTE UM valor de: ${validOptions.speaking_pace}. Este ritmo deve refletir o "narrative_tone" e o "video_objective".
-   **"image_description_engine" (Palavras-Chave Visuais):** Sugira 3-5 palavras-chave que definam o estilo visual e os elementos principais para as imagens/anim√ß√µes do v√≠deo.
-   **"research_data" (Diretrizes de Pesquisa):** Liste 2-3 pontos ESPEC√çFICOS de dados, estat√≠sticas ou informa√ß√µes que DEVEM ser pesquisados para embasar o roteiro. N√ÉO invente dados; apenas direcione a pesquisa.

**DADOS DE ENTRADA PARA ANALISAR E ESTRATEGIZAR:**
- **Tema do V√≠deo:** "${theme}"
- **Descri√ß√£o:** "${description}"

**A√á√ÉO FINAL:** Gere AGORA o objeto JSON completo e sintaticamente PERFEITO, preenchendo todas as chaves com valores criativos, estrat√©gicos e totalmente alinhados com o tema e descri√ß√£o fornecidos. Responda APENAS com o objeto JSON.
`;
    try {
        const rawResult = await callGroqAPI(prompt, 4000);
        const strategy = cleanGeneratedText(rawResult, true);

        if (!strategy || typeof strategy !== 'object') {
            throw new Error("A IA n√£o retornou uma resposta em formato JSON v√°lido.");
        }

        // L√≥gica de preenchimento dos campos (permanece a mesma)
        const narrativeGoalSelect = document.getElementById('narrativeGoal');
        const narrativeStructureSelect = document.getElementById('narrativeStructure');
        if (narrativeGoalSelect && strategy.narrative_goal) {
            narrativeGoalSelect.value = strategy.narrative_goal;
            updateNarrativeStructureOptions();
        }
        if (narrativeStructureSelect && strategy.narrative_structure) {
            setTimeout(() => {
                if ([...narrativeStructureSelect.options].some(option => option.value === strategy.narrative_structure)) {
                    narrativeStructureSelect.value = strategy.narrative_structure;
                } else {
                    narrativeStructureSelect.selectedIndex = 0;
                    console.warn(`A estrutura '${strategy.narrative_structure}' n√£o foi encontrada. Usando fallback.`);
                }
                updateMainTooltip();
            }, 50);
        }
        
        const keyToElementIdMap = {
            'target_audience': 'targetAudience', 'narrative_theme': 'narrativeTheme',
            'narrative_tone': 'narrativeTone', 'narrative_voice': 'narrativeVoice',
            'central_question': 'centralQuestion', 'emotional_arc': 'emotionalArc',
            'emotional_hook': 'emotionalHook', 'shocking_ending_hook': 'shockingEndingHook',
            'language_style': 'languageStyle', 'video_objective': 'videoObjective',
            'speaking_pace': 'speakingPace', 'image_description_engine': 'imageDescriptionEngine',
            'research_data': 'researchData'
        };
        for (const key in keyToElementIdMap) {
            if (strategy[key]) {
                const element = document.getElementById(keyToElementIdMap[key]);
                if (element) { element.value = strategy[key]; }
            }
        }

        window.showToast("Estrat√©gia sugerida pela IA! Revise e edite como desejar.");
        document.querySelector('[data-tab="input-tab-estrategia"]')?.click();

    } catch (error) {
        console.error("Erro detalhado em suggestStrategy:", error);
        window.showToast(`Falha ao sugerir estrat√©gia: ${error.message}`);
    } finally {
        isSettingStrategy = false;
        hideButtonLoading(button);
    }
};


/**
 * Valida os inputs essenciais e avan√ßa para o painel de cria√ß√£o do roteiro.
 * N√£o utiliza a IA, apenas libera a pr√≥xima etapa.
 */
const startCrafting = () => {
    // Valida apenas os campos mais essenciais para garantir que h√° uma base para o roteiro.
    if (!validateInputs()) { // Reutilizamos a valida√ß√£o que j√° obriga os campos da aba "B√°sico"
        return;
    }
    
    const dashboard = document.getElementById('projectDashboard');
    if (dashboard) {
        dashboard.classList.remove('hidden');
        dashboard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        window.showToast("Estrat√©gia definida! Pronto para criar o esbo√ßo.");
    }
};

// =========================================================================
// >>>>> SUBSTITUA O SEU LISTENER DOMContentLoaded INTEIRO POR ESTE <<<<<
// =========================================================================
document.addEventListener('DOMContentLoaded', () => {
    // --- 1. MAPEAMENTO INICIAL DE ELEMENTOS ---
    document.querySelectorAll('[id]').forEach(el => {
        if (el.tagName === 'BUTTON') { buttons[el.id] = el; } 
        else { elements[el.id] = el; }
    });

    // --- 2. INICIALIZA√á√ÉO DE FUN√á√ïES DA INTERFACE ---
    setupInputTabs();
    setupGenreTabs();
    updateProgressBar();
    updateButtonStates();
    updateNarrativeStructureOptions();
    updateGoalPopover();

    // --- 3. EVENT LISTENERS ESPEC√çFICOS ---
    const goalSelect = document.getElementById('narrativeGoal');
    if (goalSelect) { goalSelect.addEventListener('change', updateNarrativeStructureOptions); }

    const structureSelect = document.getElementById('narrativeStructure');
    if (structureSelect) { structureSelect.addEventListener('change', updateMainTooltip); }
    
    const imageStyleSelect = document.getElementById('imageStyleSelect');
    if (imageStyleSelect) { imageStyleSelect.addEventListener('change', toggleCustomImageStyleVisibility); }
    
    const importInput = document.getElementById('importFileInput');
    if (importInput) { importInput.addEventListener('change', importProject); }
    
    const darkModeToggle = document.getElementById('darkModeToggle');
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            document.getElementById('moonIcon').classList.toggle('hidden', isDarkMode);
            document.getElementById('sunIcon').classList.toggle('hidden', !isDarkMode);
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
        });
    }

    if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');
        if(moonIcon) moonIcon.classList.add('hidden');
        if(sunIcon) sunIcon.classList.remove('hidden');
    }

    const speakingPaceSelect = document.getElementById('speakingPace');
    if (speakingPaceSelect) { speakingPaceSelect.addEventListener('change', updateAllReadingTimes); }
    
    // --- 4. O "GERENTE DE CLIQUES" (OBJETO 'actions' CORRIGIDO) ---
    const actions = {
        // A√ß√µes da Se√ß√£o de Inspira√ß√£o
            'investigate': (btn) => window.verifyFact(btn),
            'investigate': (btn) => window.verifyFact(btn),
    'generateIdeasFromReport': (btn) => generateIdeasFromReport(btn),
        'verify-idea': (btn) => {
            const card = btn.closest('.card');
            if (!card) return;

            const synopsisElement = card.querySelector('p.text-sm');
            const synopsisText = synopsisElement ? synopsisElement.textContent.replace(/"/g, '').trim() : '';

            const outputContainer = card.querySelector('.fact-check-output');

            if (synopsisText && outputContainer) {
                window.verifyFact(btn, synopsisText, outputContainer);
            } else {
                window.showToast("N√£o foi poss√≠vel encontrar a sinopse ou a √°rea de resultado.");
            }
        },
        'select-idea': (btn) => { 
            const ideaString = btn.dataset.idea;
            if(ideaString) selectIdea(JSON.parse(ideaString.replace(/"/g, '"')));
        },
        'select-enigma-idea': (btn) => { 
            const ideaString = btn.dataset.idea;
            if(ideaString) {
                const ideaObject = JSON.parse(ideaString.replace(/"/g, '"'));
                document.getElementById('videoTheme').value = ideaObject.title || '';
                document.getElementById('videoDescription').value = ideaObject.synopsis || ideaObject.enigma || '';
                document.getElementById('centralQuestion').value = ideaObject.hook_question || '';
                window.showToast("Enigma selecionado! Estrat√©gia pr√©-preenchida.");
                document.getElementById('inputTabsNav').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        },

        // A√ß√µes da Se√ß√£o de Estrat√©gia
        'suggestStrategy': (btn) => suggestStrategy(btn),
        'startCrafting': (btn) => startCrafting(),

        // A√ß√µes do Painel do Projeto (Roteiro)
        'generateOutline': (btn) => generateStrategicOutline(btn),
        'generateIntro': (btn) => handleGenerateSection(btn, 'intro', 'Introdu√ß√£o', 'intro'),
        'generateDevelopment': (btn) => handleGenerateSection(btn, 'development', 'Desenvolvimento', 'development'),
        'generateClimax': (btn) => handleGenerateSection(btn, 'climax', 'Cl√≠max', 'climax'),
        'generateConclusion': (btn) => generateConclusion(btn),
        'generateCta': (btn) => generateStrategicCta(btn),
        'suggestFinalStrategy': (btn) => suggestFinalStrategy(btn),
        'addDevelopmentChapter': (btn) => window.addDevelopmentChapter(btn),
        
        // A√ß√µes do Painel do Projeto (Recursos)
        'mapEmotions': (btn) => mapEmotionsAndPacing(btn),
        'generateTitlesAndThumbnails': (btn) => generateTitlesAndThumbnails(btn),
        'generateDescription': (btn) => generateVideoDescription(btn),
        'generateSoundtrack': (btn) => generateSoundtrack(btn),

        // A√ß√µes do Painel do Projeto (An√°lise)
        'analyzeScript': (btn) => analyzeFullScript(btn),
        'analyzeHooks': (btn) => analyzeRetentionHooks(btn),
        'suggestViralElements': (btn) => suggestViralElements(btn),

        // A√ß√µes do Painel do Projeto (Gerenciamento)
        'exportProject': () => exportProject(),
        'exportPdf': () => downloadPdf(),
        'exportTranscript': () => handleCopyAndDownloadTranscript(),
        'resetProject': async () => { 
            const confirmed = await showConfirmationDialog("Come√ßar um Novo Projeto?","Isso limpar√° todos os campos e o trabalho realizado. Esta a√ß√£o n√£o pode ser desfeita. Deseja continuar?");
            if (confirmed) { resetApplicationState(); }
        },

        // A√ß√µes dentro das Se√ß√µes de Roteiro Geradas
        'regenerate': (btn) => window.regenerateSection(btn.dataset.sectionId),
        'copy': (btn) => {
            const content = btn.closest('.accordion-item')?.querySelector('.generated-content-wrapper');
            if (content) {
                window.copyTextToClipboard(content.textContent);
                window.showCopyFeedback(btn);
            }
        },
        'generate-prompts': (btn) => window.generatePromptsForSection(btn, btn.dataset.sectionId),
        'analyzeRetention': (btn) => window.analyzeSectionRetention(btn, btn.dataset.sectionId),
        'refineStyle': (btn) => window.refineSectionStyle(btn),
        'enrichWithData': (btn) => window.enrichWithData(btn),
        'suggestPerformance': (btn) => window.suggestPerformance(btn, btn.dataset.sectionId),
        'optimizeGroup': (btn) => {
            const suggestionText = btn.dataset.suggestionText;
            if (suggestionText) window.optimizeGroup(btn, suggestionText);
        },
        'deleteParagraphGroup': (btn) => {
            const suggestionText = btn.dataset.suggestionText;
            if (suggestionText) window.deleteParagraphGroup(btn, suggestionText);
        },
        
        // A√ß√µes dos Relat√≥rios de An√°lise
        'applySuggestion': (btn) => window.applySuggestion(btn),
        'applyAllSuggestions': (btn) => applyAllSuggestions(btn),
        'applyHookSuggestion': (btn) => applyHookSuggestion(btn),
        'insertViralSuggestion': (btn) => insertViralSuggestion(btn)
    };

    // --- O "OUVINTE" GERAL DE CLIQUES ---
    document.addEventListener('click', function(event) {
        // L√≥gica do Acorde√£o
        const accordionHeader = event.target.closest('.accordion-header');
        if (accordionHeader && !event.target.closest('.header-buttons')) {
            const body = accordionHeader.nextElementSibling;
            const arrow = accordionHeader.querySelector('.accordion-arrow');
            if (body && arrow) { body.classList.toggle('open'); arrow.classList.toggle('open'); }
        }

        // L√≥gica dos Bot√µes de A√ß√£o
        const button = event.target.closest('button[data-action]');
        if (!button) return;

        const actionName = button.dataset.action;
        const action = actions[actionName];

        if (action) {
            event.preventDefault();
            action(button);
        }
    });

    const toneMenu = document.getElementById('tone-variation-menu');

    document.addEventListener('selectionchange', () => {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        
        if (selectedText.length > 10 && selection.anchorNode.parentElement.closest('.generated-content-wrapper')) {
            userSelectionRange = selection.getRangeAt(0).cloneRange();
            const rect = userSelectionRange.getBoundingClientRect();
            
            toneMenu.style.left = `${rect.left + window.scrollX}px`;
            toneMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
            toneMenu.classList.add('visible');
        } else {
            if (!toneMenu.contains(document.activeElement)) {
                 toneMenu.classList.remove('visible');
            }
        }
    });

    toneMenu.addEventListener('click', (event) => {
        const button = event.target.closest('button[data-tone]');
        if (button) {
            const tone = button.dataset.tone;
            varyTone(tone);
        }
    });

    const strategicInputIds = ['videoTheme', 'videoDescription', 'videoDuration', 'speakingPace', 'visualPacing', 'narrativeGoal', 'narrativeStructure', 'narrativeTheme', 'narrativeTone', 'narrativeVoice', 'centralQuestion', 'emotionalArc', 'shockingEndingHook', 'imageDescriptionEngine', 'imageStyleSelect', 'researchData', 'emotionalHook'];
    
    strategicInputIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            const eventType = (element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') ? 'change' : 'input';
            element.addEventListener(eventType, (e) => {
                if (!isSettingStrategy) {
                    resetGeneratedScriptContent(e.target.id);
                }
            });
        }
    });
});

</script>
</body>
</html>